! April 20, 2017 copied main_PACE_AC.f90 to main_PACE_Simulator.f90
! April 20, 2017 old main_PACE_Simulator has been deleted
! pay attention to PHIOUT in both STOKESOUT and MUPHIOUTASS
! Feb. 8, 2018 Added higher order contribution to inelastic scattering
! NOV. 26, 2018, CREATE AP_SELECT TO MAKE AP INDEPENDENT WITH OCEAN_CASE_SELECT

MODULE GLOBAL_DATA
INTEGER,PARAMETER :: NWV=36074,NWV_SEG1=27223,NWV_SEG2=8851
REAL*8,DIMENSION(NWV):: WV

LOGICAL :: ILS_FLAG,SNG_SCAT_EXACT,&
		   DIFFUSE_TRANSMITTANCE, ATMOS_ZERO,SUNGLINT_INPUT

!IF ATMOS_ZERO=.TRUE., NO ATMOSPHERE WILL BE PRESENT, i.e., TAUR=0, TAU_AEROSOL=0.

INTEGER :: NDET

REAL*8,PARAMETER :: WV_PACE_REF=550.0D0
REAL*8 :: CEXT_REF,TAU550

INTEGER,PARAMETER :: NFINEMODE=10
REAL*8,DIMENSION(NWV):: AW,BBW,BWRAMAN,BW
REAL*8,DIMENSION(NWV) ::BPTC,BBPTC,BBPTCfrac,APTC,ACDM
REAL*8,DIMENSION(NWV) ::BSTC,BBSTC,BBSTCfrac,ASTC

INTEGER,PARAMETER ::NWV_PF_LUT=2250
REAL*8,DIMENSION(NWV_PF_LUT) :: WV_PF_LUT,AW_PF_LUT,BW_PF_LUT

INTEGER,PARAMETER ::NWV_AW_LEE_LUT=144
REAL*8,DIMENSION(NWV_AW_LEE_LUT) :: WV_AW_LEE_LUT,AW_LEE_LUT

INTEGER,PARAMETER ::NWV_AW_MCF_LUT=131
REAL*8,DIMENSION(NWV_AW_MCF_LUT) :: WV_AW_MCF_LUT,AW_MCF_LUT


INTEGER, PARAMETER :: N_ALT_INIT=17
REAL*8,DIMENSION(N_ALT_INIT) :: ALT_LYRA_INIT= &
                                    (/100.0D0, 30.0D0, 20.0D0, 15.0d0, 12.5D0, &
                                       10.0D0,  8.0D0,  7.5d0,  6.0D0,  5.0D0, &
                                        4.0D0,  3.0D0,  2.5d0,  2.0D0,  1.0D0, &
                                        0.0D0,  0.0D0/)
REAL*8, ALLOCATABLE,DIMENSION(:) :: ALT_LYRA

REAL*8 :: OZONE_COLUMN ! OZONE IN THE WHOLE COLUMN IN DOBSON UNIT
REAL*8 :: H2O_COLUMN   ! WATER VAPOR IN THE WHOLE COLUMN IN CENTIMETERS.
REAL*8 :: PRESSURE_SURFACE ! SURFACE PRESSURE IN mb.

REAL*8,DIMENSION(:,:),ALLOCATABLE :: GAS_ABS_COEFF,GAS_ABS_COEFF_H2O,GAS_ABS_COEFF_CO2, &
		   GAS_ABS_COEFF_CH4,GAS_ABS_COEFF_O2, GAS_ABS_COEFF_O3,GAS_ABS_COEFF_NO2
REAL*8 :: CHLa

LOGICAL :: CHLA_HOMOGENEITY
REAL*8 :: CHLA_C0,CHLA_Slope,CHLA_Cmax, CHLA_Etamax,CHLA_DeltaEta
REAL*8 :: PHYTOPLANKTON_INDEX_REFRACTION,PHYTOPLANKTON_SPECTRAL_SLOPE, &
          SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE,        &
          SEDIMENT_CONCENTRATION

REAL*8 :: adg440_Case3,bbp660_Case3,Bp660_backscatteringfraction_Case3, &
          Sdg_Case3,Sbp_Case3,S_Bp_Case3

REAL*8,DIMENSION(NWV) :: RINDX_WATER
REAL*8 ::WNDSPD,THETA0
!REAL*8,PARAMETER :: DEPOL_A=0.0284D0
REAL*8,PARAMETER :: DEPOL_O=0.087D0
REAL*8,PARAMETER :: Xi_kok=25.6d0,Alpha_kok=4.0d0, T0_kok=0.25d0,Dpol90_Kok=0.67d0

!PURE SEA WATER Depolarization ratio value from Zhang X, OE, 2009,
    ! also see Jonasz and Fournier, 2007
REAL*8 :: NMBREINPUT,NMBIMINPUT
LOGICAL :: sngmode,OCEAN_RAMAN_FLAG,OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,&
           HYSPECTRAL_FLAG,OCEAN_PHMX_ONE,MONOCHROMATIC_FLAG

LOGICAL :: ABSORPTION_TAU_REDUCE_FLAG
REAL*8,DIMENSION(:), ALLOCATABLE ::TAU_REDUCE_ATMOS_PRESERVE,TAU_REDUCE_OCEAN_PRESERVE
REAL*8 :: ABSORPTION_TAU_REPLACE

!LOGICAL :: WATER_DET_FREE_LOCATION
!INTEGER,PARAMETER :: N_DET_INWATER_REPORT=21
!REAL*8 :: DET_INWATER_REPORT_DEPTH_INCREMENT
!REAL*8,DIMENSION(N_DET_INWATER_REPORT):: DET_INWATER_REPORT_DEPTH ! LARGEST WATER DETECT DEPTH REPORTED

INTEGER :: OCEAN_CASE_SELECT
                              !==0 no ocean water body
                              !==1 CASE 1 WATER IOPS
                              !==2 CASE 2 WATER IOPS
							  !==3 Bio-2 model in polarimeter fitting
INTEGER :: AP_SELECT       !=1 PHYTOPLANKTON ABSORPTION COEFFICIENTS OF BRICAUD
!=2 PHYTOPLANKTON ABSORPTION COEFFICIENT OF
!SF_Coff options from Ciotti, Lewis, and Cullen, LO, 47(2) 404-417, 2002
!Assessment of the relationships between dominant cell size in
!    natural phytoplankton communities and the spectral shape of
!    the absorption coefficient
INTEGER :: WV_SEG_FLAG !wv_seg_flag, 0: all; 1: seg1+3only; 2: seg2only; 3: seg1+2+3; 4: seg4only
REAL*8 :: AirSensor_Height
CHARACTER*360 :: aux_dir='00000'

CONTAINS
SUBROUTINE aux_dir_readin
IF(aux_dir=='00000')THEN
  OPEN(UNIT=1,FILE='./auxiliary_directory',STATUS='OLD',ACTION='READ')
  READ(1,'(A)')aux_dir
  CLOSE(1)
ELSE
  RETURN
ENDIF
ENDSUBROUTINE

ENDMODULE GLOBAL_DATA

MODULE DOUBLEKPARA
IMPLICIT NONE
INTEGER,PARAMETER :: NDK_CAL=7
LOGICAL :: DOUBLEK_FLAG
REAL*8,DIMENSION(NDK_CAL) :: IMS,DK,GK,EXPOCOEFF
REAL*8 :: EXPOFAC,ALPHAFAC,BETAFAC,GAMMAFAC

CONTAINS

SUBROUTINE DOUBLEKPARA_EVALUATION(NWV_SUB_CAL,TAU_TG_MAX,ErrFLAG)
INTEGER, INTENT(IN) :: NWV_SUB_CAL
REAL*8, INTENT(IN) :: TAU_TG_MAX
LOGICAL,INTENT(OUT) :: ErrFLAG

REAL*8 :: rtsafe
REAL*8 :: ALPHALW,ALPHAHI,XACC
REAL*8, DIMENSION(NDK_CAL) :: IMSABS
INTEGER :: IDK_CAL

EXTERNAL :: FUNCALPHA,rtsafe

REAL*8 :: RTMP, RTMP1,DRTMP
ErrFLAG=.FALSE.
IMSABS=ABS(IMS)

IF(IMSABS(1)<1.0D-10 .OR. IMSABS(2)<1.0D-10 .OR. IMSABS(3)<1.0D-10 )THEN
  DOUBLEK_FLAG=.FALSE.
  EXPOCOEFF=0.0D0
  RETURN
ENDIF

GK=IMSABS
DO IDK_CAL=1,NWV_SUB_CAL-1
  EXPOCOEFF(IDK_CAL)=-LOG(GK(IDK_CAL)/GK(IDK_CAL+1))/(DK(IDK_CAL)-DK(IDK_CAL+1))
  IF(EXPOCOEFF(IDK_CAL)<0.0d0)THEN
      EXPOCOEFF(IDK_CAL)=0.0d0
      ErrFLAG=.TRUE.
  ENDIF
ENDDO

IF(ErrFLAG)THEN
	DOUBLEK_FLAG=.FALSE.
	RETURN
ENDIF

!!testing
!write(*,*)'EXPOCOEFF=',EXPOCOEFF
!write(*,*)'GK=',GK
!write(*,*)'DK=',DK
!write(*,*)'TAU_TG_MAX=',TAU_TG_MAX

EXPOFAC=LOG(GK(1)/GK(2))/LOG(GK(2)/GK(3))
IF(EXPOFAC>12)THEN
	DOUBLEK_FLAG=.FALSE.
	RETURN
ENDIF
ALPHALW=0.0D0
ALPHAHI=MIN(TAU_TG_MAX,1.0D0)
XACC=1.0D-6

CALL FUNCALPHA(ALPHALW,RTMP,DRTMP)
CALL FUNCALPHA(ALPHAHI,RTMP1,DRTMP)

IF(RTMP*RTMP1<0.0D0)THEN
  DOUBLEK_FLAG=.TRUE.
  ALPHAFAC=rtsafe(FUNCALPHA,ALPHALW,ALPHAHI,XACC)
  BETAFAC=-LOG(GK(1)/GK(2))/LOG((DK(1)+ALPHAFAC)/(DK(2)+ALPHAFAC))
!  GAMMAFAC=IMS(1)*(DK(1)+ALPHAFAC)**BETAFAC
  GAMMAFAC=(DK(1)+ALPHAFAC)**BETAFAC

ELSE
  DOUBLEK_FLAG=.FALSE.
ENDIF

END SUBROUTINE DOUBLEKPARA_EVALUATION

REAL*8 FUNCTION DOUBLEKFUNC_EVALUATION(NWV_SUB_CAL,DK_VAL,DKP_VAL)
IMPLICIT NONE
INTEGER :: NWV_SUB_CAL
REAL*8,INTENT(IN) :: DK_VAL,DKP_VAL

INTEGER,DIMENSION(1) ::LOCINDXTMP

INTEGER :: IDK_CAL

LOCINDXTMP= MINLOC(ABS(DK_VAL-DK(1:NWV_SUB_CAL)))
IF(DK_VAL<DK(LOCINDXTMP(1)))THEN
  IDK_CAL=LOCINDXTMP(1)-1
ELSE
  IDK_CAL=LOCINDXTMP(1)
ENDIF
IF(IDK_CAL>NWV_SUB_CAL-1)IDK_CAL=NWV_SUB_CAL-1
IF(IDK_CAL<1)IDK_CAL=1

IF(DOUBLEK_FLAG .and. IDK_CAL <= 2)THEN
!  DOUBLEKFUNC_EVALUATION=GAMMAFAC/((DK_VAL+ALPHAFAC)**BETAFAC)
  DOUBLEKFUNC_EVALUATION=IMS(1)*GAMMAFAC/((DK_VAL+ALPHAFAC)**BETAFAC)

ELSE
  DOUBLEKFUNC_EVALUATION=IMS(IDK_CAL)*EXP(-EXPOCOEFF(IDK_CAL)*(DK_VAL-DK(IDK_CAL)))
ENDIF

!if(DK_VAL>50 .and. DOUBLEKFUNC_EVALUATION>1.0d0)write(*,*)'dk_evaluation',&
!             DOUBLEK_FLAG,DK_VAL,IDK_CAL,DK(IDK_CAL),                     &
!             EXPOCOEFF(IDK_CAL),DOUBLEKFUNC_EVALUATION

END FUNCTION DOUBLEKFUNC_EVALUATION

ENDMODULE DOUBLEKPARA

SUBROUTINE FUNCALPHA(ALPHA_VAL,FUNCALPHA_VAL,DFUNCALPHA_VAL)
USE DOUBLEKPARA
USE nrtype
IMPLICIT NONE
REAL*8, INTENT(IN) :: ALPHA_VAL
REAL*8, INTENT(OUT) :: FUNCALPHA_VAL,DFUNCALPHA_VAL

!write(*,*)'Test FUNCALPHA Line 01,', DK(1),DK(2),DK(3),ALPHA_VAL,EXPOFAC

FUNCALPHA_VAL=(DK(2)+ALPHA_VAL)**(EXPOFAC+1)-(DK(1)+ALPHA_VAL)*(DK(3)+ALPHA_VAL)**EXPOFAC
DFUNCALPHA_VAL= (EXPOFAC+1)*(DK(2)+ALPHA_VAL)**EXPOFAC-(DK(3)+ALPHA_VAL)**EXPOFAC &
              - EXPOFAC*(DK(1)+ALPHA_VAL)*(DK(3)+ALPHA_VAL)**(EXPOFAC-1)

!write(*,*)'Test FUNCALPHA Line 02',FUNCALPHA_VAL,DFUNCALPHA_VAL

END SUBROUTINE FUNCALPHA

PROGRAM SOSINT
USE GLOBAL_DATA
USE MIE_PHMX_PACE
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE IRRADSUNL
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX,PSEUDO_SPHERICAL_SHELL
USE Atmosphere_Profile
USE PACE_INSTRUMENT_DESIGN
USE DOUBLEKPARA
IMPLICIT NONE

REAL*8 :: LAMBDAEM
INTEGER:: Indx_Inelastic_Scattering ! index number to controll elastic or inelastic scattering calculations
!Indx_Inelastic_Scattering=0  ! elastic scattering calculation only
!Indx_Inelastic_Scattering=1  ! Raman scattering excitation field preparation only
!Indx_Inelastic_Scattering=2  ! Raman scattering emission field calculation.
!Indx_Inelastic_Scattering=3  ! Chla and CDOM flourescence excitation field preparation only
!Indx_Inelastic_Scattering=4  ! Chla and CDOM flourescence emission field calculation.
!Indx_Inelastic_Scattering=5  ! both Raman and "Chla and CDOM flourescence" emission field calculation.
!Indx_Inelastic_Scattering=6  ! both Raman and "Chla and CDOM flourescence" excitation field preparation.
!Indx_Inelastic_Scattering=7  ! both Raman and "Chla and CDOM flourescence" excitation field preparation,
                              ! with second order correction.

INTEGER:: NTLYER,NTLYERA,NTLYERO,NLYRML,IORDER_INELASTIC_SCATTERING,NORDER_INELASTIC_SCATTERING
REAL*8, ALLOCATABLE,DIMENSION(:,:) :: TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,TAU_RAY_Save,DEPOL_A_Save,&
						TAU_TG_Save, TAU_TG_H2O_Save,TAU_TG_CO2_Save,TAU_TG_CH4_Save,TAU_TG_O2_Save,&
						TAU_TG_O3_Save,TAU_TG_NO2_Save
REAL*8, ALLOCATABLE,DIMENSION(:) :: WAVELENGTH_Table_Save
REAL*8, ALLOCATABLE,DIMENSION(:) :: TAUR,DEPOL_A,TAU_TG,TAU_TG_H2O,TAU_TG_CO2,TAU_TG_CH4,TAU_TG_O2,TAU_TG_O3,&
									TAU_TG_NO2, PNDLY,ARSLND1_Save,ARSLND2_Save,&
                                    REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save
REAL*8, ALLOCATABLE,DIMENSION(:,:) ::MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save
! TAUR(ICALIPSO),  RAYLEIGH OPTICAL DEPTH AT WAVLENTGH WV(IWV) AT LAYER(ILAYER)
! TAU_TG(ILAYER): ABSORPTIVE OPTICAL DEPTH FOR TRACE GAS

! DATA TRANSFER TO RTSOS CALLABLE
INTEGER :: NREC,NCOLINPUT,NQUADAINPUT,NQUADOINPUT, MAXMORDINPUT_SAVE,&
           NUMMIEUSE,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,NWV_BAND_START,NWV_BAND_END
REAL*8 :: DELTATAUAINPUT,DELTATAUOINPUT
REAL*8,DIMENSION(:,:),ALLOCATABLE :: RECDATASTREAM
REAL*8,DIMENSION(:,:,:),ALLOCATABLE :: PHMXDATASTREAM !,COEFFDATASTREAM
INTEGER,DIMENSION(:),ALLOCATABLE :: NUMMIEANGINPUT

REAL*8 :: LBDO_LD,FLAM

INTEGER :: NTHETAOUT,NPHIOUT,ITHETA,IPHI,IMIE,IDET,IDK_CAL,ILS_AVG
REAL*8 :: MU_IN,WAVELENGTH_MICRON,WAVELENGTH_NANOMETER,TEMPERTURE,SALINITY,&
          AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,       &
          BBPTCfracLOCAL,APTCLOCAL,BSTCLOCAL,ASTCLOCAL,ACDMLOCAL,&
          RINDX_WATERLOCAL

REAL*8,DIMENSION(:),ALLOCATABLE :: PHIOUT,MUOUT

LOGICAL :: WLR_FLAG_INPUT,WCFLG_INPUT,GAS_ABS_FLAG,CLOUDFLAG
INTEGER :: DELTAM_INPUT
REAL*8,DIMENSION(:,:) ,ALLOCATABLE:: DIRAD  ! DIRAD(:,1) DOWNWELLING IRADIANCE
                                            ! DIRAD(:,2) UPWELLING IRADIANCE
                                            ! First dimension is detector label
REAL*8,DIMENSION(:,:,:,:),ALLOCATABLE :: DSTOKES
! DSTOKES(NWV,       NTHETAOUT,       NPHIOUT,         4)
! ITH WAVELENGTH , theta out index, phi out index, stokes parameters I Q U V

REAL*8,DIMENSION(:,:,:) ,ALLOCATABLE:: DIRADFULL  ! DIRAD(:,1) DOWNWELLING IRADIANCE
                                            ! DIRAD(:,2) UPWELLING IRADIANCE
                                            ! First dimenSion is detector label
REAL*8,DIMENSION(:,:,:,:,:),ALLOCATABLE :: DSTOKESFULL
! DSTOKES(NWV,       NTHETAOUT,       NPHIOUT,         4)
! ITH WAVELENGTH , theta out index, phi out index, stokes parameters I Q U V

INTEGER :: INDEX_PRIME_SCATTERING
REAL*8 :: FSUN_BAND_AVG
REAL*8,DIMENSION(:),ALLOCATABLE :: TAU_TG_DK,TAU_TG_DKP
REAL*8,DIMENSION(:,:),ALLOCATABLE::TAU_ARSL_Ext_TMP,TAU_ARSL_Scat_TMP,TAU_RAY_TMP,DEPOL_A_TMP
REAL*8,DIMENSION(:,:,:),ALLOCATABLE::DIRADTMP
REAL*8,DIMENSION(:,:,:,:,:),ALLOCATABLE::DSTOKESTMP

LOGICAL :: WVNUMRESET,ErrFLAG
REAL*8,DIMENSION(NDK_CAL) :: TAU_TG_DK_CAL,TAU_TG_INCR
REAL*8,DIMENSION(NDK_CAL) :: TAU_TG_DKP_STAT

REAL*8 :: TAU_TG_MAX,TAU_TG_MIN,DK_VAL,DKP_VAL,TAU_ABS_AVG
INTEGER :: NWV_SUB_CAL,NTAU_TG_DK,IWV_BAND,IWV_BAND_TEMP,IWV_SUB_START,IWV_SUB_END
INTEGER,DIMENSION(:),ALLOCATABLE :: INDX_WV_CAL

INTEGER :: N_AVG_SIZE
REAL*8,DIMENSION(:),ALLOCATABLE :: XK,YK
REAL*8,DIMENSION(:),ALLOCATABLE :: XU,YU,ZU,FSUN_BAND

REAL*8 :: POLINT_SIMPLE,ILS_INT_CONST,TRAPZOID

INTEGER,DIMENSION(1) ::LOCINDXTMP,LOCINDXTMP1
LOGICAL,DIMENSION(:),ALLOCATABLE :: MASKMINLOC
REAL*8 :: RTMP,RTMP1
!REAL,DIMENSION(5) :: RNDNMBR
INTEGER:: INTTMP,ICOM,IWV,IWV_CAL,IWV_SUB,IWVEX,IWVEXSTART,ILAYER,IPT, IAEROSOL,IRH, &
          IULO,MPL,KLO,INDEX_TAUPRIME,IREC_SHFT

LOGICAL :: file_e
integer time_array_0(8), time_array_1(8)
real start_time, finish_time

CHARACTER*360 :: CFILE1,CFILETMP,CFILE_AP

INTEGER :: NARGS,IARGC
CHARACTER(LEN=360) :: INFILE   ! Modification for scripting (MJG)
CHARACTER(LEN=360) :: OUTFILE  ! Modification for scripting (MJG)
! Read inputs from the command line
NARGS = IARGC()
IF(NARGS.LT.1) THEN
    WRITE(*,*) ''
    WRITE(*,*) '***ERROR***'
    WRITE(*,*) 'TOO FEW INPUTS'
    WRITE(*,*) '***ERROR***'
    WRITE(*,*) ''
    WRITE(*,*) 'USEAGE:'
    WRITE(*,*) 'rtsos_PACE_Simulator_DoubleK.exe input.file'
    WRITE(*,*) ''
    STOP
ENDIF

!  First argument is the input file
CALL GETARG(1,INFILE)

OPEN(unit=1,file=INFILE,status='old')

READ(1,*)WNDSPD
READ(1,*)THETA0
READ(1,*)TAU550
READ(1,*)IRH
READ(1,*)IAEROSOL

READ(1,*)OCEAN_CASE_SELECT
READ(1,*)WATER_DEPTH_MAX
READ(1,*)CHLa
READ(1,*)PHYTOPLANKTON_INDEX_REFRACTION
READ(1,*)PHYTOPLANKTON_SPECTRAL_SLOPE
READ(1,*)SEDIMENT_INDEX_REFRACTION
READ(1,*)SEDIMENT_SPECTRAL_SLOPE
READ(1,*)SEDIMENT_CONCENTRATION

READ(1,*)adg440_Case3
READ(1,*)bbp660_Case3
READ(1,*)Bp660_backscatteringfraction_Case3
READ(1,*)Sdg_Case3
READ(1,*)Sbp_Case3
READ(1,*)S_Bp_Case3

READ(1,*)NCOLINPUT
READ(1,*)NQUADAINPUT
READ(1,*)NQUADOINPUT
READ(1,*)MAXMORDINPUT_SAVE
READ(1,*)NTHETAOUT
READ(1,*)NPHIOUT

READ(1,*)INTTMP
IF(INTTMP==0)THEN
    CHLA_HOMOGENEITY=.FALSE.
ELSE
    CHLA_HOMOGENEITY=.TRUE.
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
   OCEAN_RAMAN_FLAG=.FALSE.
ELSE
   OCEAN_RAMAN_FLAG=.TRUE.
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
   OCEAN_FCHLA_FLAG=.FALSE.
ELSE
   OCEAN_FCHLA_FLAG=.TRUE.
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
   OCEAN_FCDOM_FLAG=.FALSE.
ELSE
   OCEAN_FCDOM_FLAG=.TRUE.
ENDIF

READ(1,*)AP_SELECT

READ(1,*)INTTMP
IF(INTTMP==0)THEN
   MONOCHROMATIC_FLAG=.FALSE.
ELSE
   MONOCHROMATIC_FLAG=.TRUE.
ENDIF


READ(1,*)INTTMP
IF(INTTMP==0)THEN
   HYSPECTRAL_FLAG=.FALSE.
ELSE
   HYSPECTRAL_FLAG=.TRUE.
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
   NPQ_FLAG=.FALSE.
ELSE
   NPQ_FLAG=.TRUE.
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
   OCEAN_PHMX_ONE=.FALSE. ! if true, only use one phase matrix for ocean waters
! However, single scattering abeldo change is still kept
ELSE
   OCEAN_PHMX_ONE=.TRUE.
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
  ATMOS_ZERO=.FALSE.
ELSE
  ATMOS_ZERO=.TRUE. ! NO ATMOSPHERE WILL BE PRESENT
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
	SUNGLINT_INPUT=.true.
ELSE
	SUNGLINT_INPUT=.false. ! NO Sun glint WILL BE PRESENT
ENDIF

READ(1,*)INTTMP
IF(INTTMP==0)THEN
   GAS_ABS_FLAG=.FALSE. ! if .false. not gas absorption is included
ELSE
   GAS_ABS_FLAG=.TRUE.  ! if .true. gas absorption is included
ENDIF

READ(1,*)OZONE_COLUMN ! OZONE IN THE WHOLE COLUMN IN DOBSON UNIT
READ(1,*)H2O_COLUMN   ! WATER VAPOR IN THE WHOLE COLUMN IN CENTIMETERS.
READ(1,*)PRESSURE_SURFACE ! surface pressure in mb
READ(1,*)WV_SEG_FLAG
READ(1,*)AirSensor_Height
READ(1,*)INTTMP
IF(INTTMP==1)THEN
	PSEUDO_SPHERICAL_SHELL=.TRUE.
ELSE
	PSEUDO_SPHERICAL_SHELL=.FALSE.
ENDIF
READ(1,*)CFIlE_AP    ! Atmosphere number density profile
READ(1,*)OUTFILE
CLOSE(1)

IF(WV_SEG_FLAG<0 .OR. WV_SEG_FLAG>4) STOP 'CHECK WV_SEG_FLAG INPUT'

write(*,*)'Wind speed=',WNDSPD
write(*,*)'Chlorophyll a concentration=',CHLa
write(*,*)'PHYTOPLANKTON_INDEX_REFRACTION=',PHYTOPLANKTON_INDEX_REFRACTION
write(*,*)'PHYTOPLANKTON_SPECTRAL_SLOPE=',PHYTOPLANKTON_SPECTRAL_SLOPE
WRITE(*,*)'CHLA_HOMOGENEITY,OCEAN_RAMAN_FLAG,OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG=',&
             CHLA_HOMOGENEITY,OCEAN_RAMAN_FLAG,OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG
WRITE(*,*)'HYSPECTRAL_FLAG,NPQ_FLAG,OCEAN_PHMX_ONE,GAS_ABS_FLAG=', &
           HYSPECTRAL_FLAG,NPQ_FLAG,OCEAN_PHMX_ONE,GAS_ABS_FLAG

WRITE(*,*)'adg440_Case3,bbp660_Case3,Bp660_backscatteringfraction_Case3=', &
           adg440_Case3,bbp660_Case3,Bp660_backscatteringfraction_Case3
WRITE(*,*)'Sdg_Case3,Sbp_Case3,S_Bp_Case3=',Sdg_Case3,Sbp_Case3,S_Bp_Case3
WRITE(*,*)'PSEUDO_SPHERICAL_SHELL IS', PSEUDO_SPHERICAL_SHELL

IF(ATMOS_ZERO)THEN
	TAU550=0.0D0
    SUNGLINT_INPUT=.false.
    GAS_ABS_FLAG=.false.
	WRITE(*,*)'ATMOS_ZERO IS TRUE,TAU550=',TAU550
    WRITE(*,*)'ATMOS_ZERO IS TRUE, NO GAS ABSORPTION IS INCLUDED'
ENDIF

IF(MONOCHROMATIC_FLAG)THEN
  HYSPECTRAL_FLAG=.FALSE.
  WRITE(*,*) 'HYSPECTRAL_FLAG IS RESET TO .FALSE. DUE TO MONOCHROMATIC_FLAG'
ENDIF

IF(OCEAN_CASE_SELECT==3 .AND. AP_SELECT .NE. 1)THEN
  AP_SELECT=1
  WRITE(*,*) 'AP_SELECT IS RESET TO 1, BECAUSE OCEAN_CASE_SELECT==3'
ENDIF

! check file existance

INTTMP=len_trim(OUTFILE)
IF(OUTFILE(INTTMP-2:INTTMP) .ne. '.h5') OUTFILE=TRIM(OUTFILE)//'.h5'
WRITE(*,*)'OUTPUT FILE IS:',OUTFILE

INQUIRE(FILE=OUTFILE, EXIST=file_e)
IF(file_e) then
!  write(*,*) 'warning, filename exist, a string is appended'
!  OUTFILE='new_'//TRIM(OUTFILE)
  stop 'warning, output filename exist, exiting'
ENDIF

IF(ABS(AirSensor_Height)<1.0E-6 .OR. ABS(AirSensor_Height)>=100.0D0)THEN
  WRITE(*,*)'AirSensor_Height ==0 .or. AirSensor_Height >=100 km'
  WRITE(*,*)'Default AirSensor_Height = 2 km is used'
  AirSensor_Height=2.0D0
ENDIF

NTLYERA=N_ALT_INIT
ALLOCATE(ALT_LYRA(NTLYERA))
ALT_LYRA_INIT(N_ALT_INIT)=AirSensor_Height
ALT_LYRA=ALT_LYRA_INIT
CALL sort2(NTLYERA,ALT_LYRA_INIT,ALT_LYRA)
CALL REMOVE_DUP(N_ALT_INIT,ALT_LYRA_INIT,NTLYERA,ALT_LYRA)
DO INTTMP=1,NTLYERA
   ALT_LYRA_INIT(INTTMP)=ALT_LYRA(NTLYERA-INTTMP+1)
ENDDO
DEALLOCATE(ALT_LYRA)

NTLYERA=NTLYERA-1
ALLOCATE(ALT_LYRA(NTLYERA+1))
ALT_LYRA(1:NTLYERA+1)=ALT_LYRA_INIT(1:NTLYERA+1)

!write(*,*)'NTLYERA,ALT_LYRA=',NTLYERA,ALT_LYRA

NDET=4

ABSORPTION_TAU_REDUCE_FLAG=.true. ! IF TRUE, USE THINNER OCEAN LAYERS BELOW ABSORPTION OPTICAL DEPTH OF 10.
! THIS WOULD EXPEDITE THE SIMULATION VERY MUCH WITHOUT SACRIFY THE ACCURACY AT TOO

LBDO_LD=0.0D0
FLAM=1.0
TEMPERTURE=20.0D0
SALINITY=37.0D0
CLOUDFLAG=.false.

ILS_FLAG=.true.
SNG_SCAT_EXACT=.FALSE.
DIFFUSE_TRANSMITTANCE=.false.

MU_IN=-1.0d0*ABS(COS(THETA0/180.D0*PI))
NORDER_INELASTIC_SCATTERING=1

call aux_dir_readin

CALL WV_LBL_SETUP
!CALL PACE_FWHM_INIT
CALL WV_PACE_SETUP(aux_dir)
!CALL ILS_INIT

CALL Atmosphere_Profile_READIN(CFIlE_AP)
CALL Surface_Pressure_Rescale(PRESSURE_SURFACE)
CALL GAS_COLUMN_RESCALE(OZONE_COLUMN,H2O_COLUMN)

!write(*,*)'Check Z_FIELD(1),Z_FIELD(NPGRID)=',Z_FIELD(1),Z_FIELD(NPGRID)
IF(Z_FIELD(NPGRID)>Z_FIELD(1))STOP 'WARNING,CHECK Z_FIELD'
IF(P_GRID(NPGRID)<P_GRID(1))STOP 'WARNING,CHECK P_GRID'

ALLOCATE(GAS_ABS_COEFF(NWV,NPGRID),GAS_ABS_COEFF_H2O(NWV,NPGRID), &
		 GAS_ABS_COEFF_CO2(NWV,NPGRID), GAS_ABS_COEFF_CH4(NWV,NPGRID),    &
		 GAS_ABS_COEFF_O2(NWV,NPGRID), GAS_ABS_COEFF_O3(NWV,NPGRID),&
		 GAS_ABS_COEFF_NO2(NWV,NPGRID))


IF(GAS_ABS_FLAG) CALL ABS_COEFF_INIT

! ASSIGN RTSOS PARAMETERS

ALLOCATE(MUOUT(NTHETAOUT),PHIOUT(NPHIOUT))
CALL MUPHIOUTASS(NTHETAOUT,NPHIOUT,MUOUT,PHIOUT)


NUMMIEUSE=1
MAXLORDINPUT=NQUADAINPUT
NMBREINPUT=1.338
NMBIMINPUT=0.0
IF(DIFFUSE_TRANSMITTANCE)THEN
  NCOLINPUT=20
  MAXMORDINPUT=1
  OCEAN_CASE_SELECT=0
  OCEAN_PHMX_ONE=.TRUE.
  OCEAN_RAMAN_FLAG=.false.
  OCEAN_FCHLA_FLAG=.false.
  OCEAN_FCDOM_FLAG=.FALSE.
  HYSPECTRAL_FLAG=.false.
ENDIF

WLR_FLAG_INPUT= .false.
WCFLG_INPUT = .true.
DELTAM_INPUT = 2

! NUMBER OF INPUT LINES INCLUDING DETECTORS AND ATMOSPEHRIC AND OCEANIC LAYERS,
! INTERFACE AND BOTTOM.
IF(OCEAN_CASE_SELECT==0)THEN
  NTLYERO=1
  OCEAN_PHMX_ONE=.TRUE.
  OCEAN_RAMAN_FLAG=.false.
  OCEAN_FCHLA_FLAG=.false.
  OCEAN_FCDOM_FLAG=.FALSE.
  HYSPECTRAL_FLAG=.false.
ELSE
  NTLYERO=NWATER_DEPTH-1
ENDIF

IF(NWATER_DEPTH<NTLYERO+1)STOP 'CHECK NTLYERO AND NWATER_DEPTH'

NTLYER=NTLYERA+NTLYERO

NREC=NTLYER+NDET+2

IF(OCEAN_PHMX_ONE)THEN
  NUMMIERT=NTLYERA+1
ELSE
  NUMMIERT=NTLYERA+NTLYERO
ENDIF

!write(*,*)'NREC,NUMMIERT=',NREC,NUMMIERT

ALLOCATE(TAUR(NTLYERA),DEPOL_A(NTLYERA),TAU_TG(NTLYERA),TAU_TG_H2O(NTLYERA),TAU_TG_CO2(NTLYERA), &
		 TAU_TG_CH4(NTLYERA),TAU_TG_O2(NTLYERA),TAU_TG_O3(NTLYERA),TAU_TG_NO2(NTLYERA))
ALLOCATE(TAU_TG_Save(NWV,NTLYERA),TAU_TG_H2O_Save(NWV,NTLYERA),TAU_TG_CO2_Save(NWV,NTLYERA),      &
		 TAU_TG_CH4_Save(NWV,NTLYERA),TAU_TG_O2_Save(NWV,NTLYERA),       &
         TAU_TG_O3_Save(NWV,NTLYERA),TAU_TG_NO2_Save(NWV,NTLYERA)  )
ALLOCATE(WAVELENGTH_Table_Save(NWV_BAND_SEG1P2_HYPO),TAU_ARSL_Ext_Save(NWV_BAND_SEG1P2_HYPO,NTLYERA), &
         TAU_ARSL_Scat_Save(NWV_BAND_SEG1P2_HYPO,NTLYERA),TAU_RAY_Save(NWV_BAND_SEG1P2_HYPO,NTLYERA),&
         DEPOL_A_Save(NWV_BAND_SEG1P2_HYPO,NTLYERA))
ALLOCATE(NUMMIEANGINPUT(NUMMIERT),PHMXDATASTREAM(NUMMIERT,NUMMIEANGMAX,0:6))

ALLOCATE(DIRAD(NDET,2),DSTOKES(NDET,NTHETAOUT,NPHIOUT,4))
ALLOCATE(DIRADFULL(NDET,NWV,2),DSTOKESFULL(NDET,NWV,NTHETAOUT,NPHIOUT,4))

ALLOCATE(RECDATASTREAM(NREC,7),PNDLY(NTLYERA),                                  &
         REFF1_Save(NUMMIEUSE),REFF2_Save(NUMMIEUSE),VEFF1_Save(NUMMIEUSE),     &
         VEFF2_Save(NUMMIEUSE),ARSLND1_Save(NUMMIEUSE),ARSLND2_Save(NUMMIEUSE),&
         MRR1_Save(NUMMIEUSE,NWV_BAND),MRI1_Save(NUMMIEUSE,NWV_BAND),           &
         MRR2_Save(NUMMIEUSE,NWV_BAND),MRI2_Save(NUMMIEUSE,NWV_BAND))

CALL SUNLREADIN

CALL WATER_ABSORPTION_READ
CALL WATER_ABSORPTION_LEE_READ
CALL WATER_ABSORPTION_MCF_READ

CALL Particle_PHMX_Assign(NUMMIEUSE,NWV_BAND,IAEROSOL,IRH,REFF1_Save,    &
          REFF2_Save,VEFF1_Save,VEFF2_Save,MRR1_Save,MRI1_Save,MRR2_Save,&
          MRI2_Save,ARSLND1_Save,ARSLND2_Save)
CALL ARSL_VERP_INIT(NTLYERA,PNDLY)

DIRADFULL=0.0d0
DSTOKESFULL=0.0d0

NQUADA_Inelas=12
NQUADO_Inelas=24
MAXLORD_Inelas=NQUADA_Inelas

  IF(OCEAN_FCDOM_FLAG)THEN
  ! N_FCDOM_TYPE=9 DEFIEND IN RTTYPE_SOS_RAO_DG.F90
  ! Hawes et al., SPIE Vol 1750, page 212-223, (1992).
  ! INCLUDES 9 SAMPLES: FA7, FA8, FA9, FA11, HA1, HA2, HA4, HA6, HA8.
  ! THIS IS ALSO THE ORDER OF MATRIX DATA IS ORGANIZED.
  ! HA5 AND HA10 ARE EXCLUDED BECAUSE OF MISSING DATA
  ! WEIGHT_CDOM_TYPE should be determined using Eq. 4 in
  ! Hawes et al., SPIE Vol 1750, page 212-223, (1992).
  ! I use 0.9 of FA7 and 0.1 of HA6, without specifing absorption coefficients
  ! of FA7 and HA6
      WEIGHT_CDOM_TYPE=(/0.9D0, 0.0D0, 0.0D0, 0.0D0, 0.0D0, &
                         0.0D0, 0.0D0,0.1D0,0.0D0/)
  ENDIF

  IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG .OR. OCEAN_RAMAN_FLAG) &
         CALL FFLRWVRGCAL(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,OCEAN_RAMAN_FLAG,HYSPECTRAL_FLAG)
  IF(OCEAN_RAMAN_FLAG) CALL XJOMAININIT(NQUADAINPUT,NQUADOINPUT)

  IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG) THEN
         ALLOCATE(DIIRAD_SCALAR_AGD(NFLRSCGRID,NWATER_DEPTH),         &
                  ABSORB_COEFF_CDOM_EX(NFLRSCGRID,NWATER_DEPTH),      &
                  ABSORB_COEFF_CHLA_EX(NFLRSCGRID,NWATER_DEPTH),      &
                  SOURCEFO_FLUORESCENCE_AGD(NWATER_DEPTH),            &
                  IPAR_SCALAR(NWATER_DEPTH),QUANTUM_YIELD_CHLA_PROFILE(NWATER_DEPTH))
  ENDIF
  ALLOCATE(CHLA_VERTICAL_PROFILE(NWATER_DEPTH))

  IF(OCEAN_RAMAN_FLAG .OR. OCEAN_FCHLA_FLAG  .OR. OCEAN_FCDOM_FLAG) &
        ALLOCATE(     TAU_INELASTIC_AGD(NWATER_DEPTH),              &
                      EXT_COEFF_INELASTIC_EM(NWATER_DEPTH)           )
  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    ALLOCATE(TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
    ALLOCATE(TAU_REDUCE_OCEAN_PRESERVE(NTLYERO+1))
  ENDIF

  IF(OCEAN_RAMAN_FLAG) THEN
     ALLOCATE(SOURCEFO_RAMAN_AGD_LUT(NFLRSCGRID,NQUADOINPUT+2,NWATER_DEPTH,0:2))
     ALLOCATE(SOURCEFO_RAMAN_AGD(NQUADOINPUT+2,NWATER_DEPTH,0:2))
  ENDIF

  CALL WATER_DEPTH_SETUP

  IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG .OR. OCEAN_RAMAN_FLAG)THEN
    DELTATAUAINPUT=0.05D0        ! ADJUST FOR ACCURATE OPTICAL INTEGRATION
    DELTATAUOINPUT=0.1D0

    IF(OCEAN_RAMAN_FLAG)THEN
      MAXMORDINPUT=min(2,MAXMORDINPUT_SAVE)
    ELSE
      MAXMORDINPUT=0
    ENDIF

    DO IORDER_INELASTIC_SCATTERING=1,NORDER_INELASTIC_SCATTERING

    DO IWVEX=1,NFLRSCGRID
       WAVELENGTH_NANOMETER=LAMBDAEXFLRSC(IWVEX)
       WAVELENGTH_MICRON=LAMBDAEXFLRSC(IWVEX)/1000.0D0

       IF(IORDER_INELASTIC_SCATTERING>1)THEN
         IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG)THEN
           CALL FFLRfuncjEXCAL(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,WAVELENGTH_NANOMETER)
           CALL SOURCEF_FLUORESCENCE_INTEGRATION(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,WAVELENGTH_NANOMETER)
           IF(OCEAN_FCDOM_FLAG)DEALLOCATE(fCDOMfuncjEX)
           IF(OCEAN_FCHLA_FLAG)DEALLOCATE(fCHLAfuncjEX)
         ENDIF
         IF(OCEAN_RAMAN_FLAG)THEN
           CALL FRFUNCJCAL(WAVELENGTH_NANOMETER)
           CALL SOURCEF_EM_INTEGRATION(NQUADOINPUT,MU_IN,MAXMORDINPUT_SAVE)
         ENDIF
       ENDIF

       CALL TAU_TG_INIT_INELASTIC(GAS_ABS_FLAG,NTLYERA,WAVELENGTH_NANOMETER,TAU_TG)
       CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,TAUR,DEPOL_A)

       IF(IORDER_INELASTIC_SCATTERING>1)THEN
            Indx_Inelastic_Scattering=7     ! INELASTIC EXCITING FIELD PREPARISON
            CALL PMARAMANCAL(MU_IN, NQUADA_Inelas,NQUADO_Inelas,LAMBDAEXFLRSC(IWVEX),TEMPERTURE,SALINITY)

       ELSE
           IF (OCEAN_RAMAN_FLAG) THEN
              Indx_Inelastic_Scattering=1     ! RAMAN EXCITING FIELD PREPARISON
              CALL PMARAMANCAL(MU_IN, NQUADA_Inelas,NQUADO_Inelas,LAMBDAEXFLRSC(IWVEX),TEMPERTURE,SALINITY)
           ENDIF

           IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
                Indx_Inelastic_Scattering=3 ! FLUORESCENCE EXCITING FIELD PREPARISON

           IF(OCEAN_RAMAN_FLAG .AND. (OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG)) &
             Indx_Inelastic_Scattering=6     ! RAMAN and FLUORESCENCE EXCITING FIELD PREPARISON
       ENDIF

       call date_and_time(values=time_array_0)
       start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                        + time_array_0 (7) + 0.001 * time_array_0 (8)

       CALL RTSOSINIT(Indx_Inelastic_Scattering,IWVEX,WAVELENGTH_MICRON,&
          NREC,NTLYERA,NTLYERO,PNDLY,TAUR,DEPOL_A,TAU_TG,RECDATASTREAM,NTLYER,NUMMIEUSE,    &
          NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT,PHMXDATASTREAM,LBDO_LD,FLAM,   &
          TEMPERTURE,SALINITY)

       call date_and_time(values=time_array_1)
       finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                      + time_array_1 (7) + 0.001 * time_array_1 (8)
       write(*,*)'rtsosinit elapsed time =', finish_time-start_time

       CALL RTSOS(NREC,NDET,RECDATASTREAM,NCOLINPUT,NQUADA_Inelas,NQUADO_Inelas,     &
            DELTATAUAINPUT,DELTATAUOINPUT,NUMMIERT,MAXLORD_Inelas,MAXMORDINPUT,    &
            NUMMIEANGINPUT,PHMXDATASTREAM,MU_IN,NTHETAOUT,                       &
            NPHIOUT,PHIOUT,MUOUT,DIRAD,DSTOKES,WLR_FLAG_INPUT,WCFLG_INPUT,DELTAM_INPUT)

       call date_and_time(values=time_array_0)
             start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                        + time_array_0 (7) + 0.001 * time_array_0 (8)
       write(*,*)'rtsos elapsed time =', start_time-finish_time

       IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
          CALL OCEAN_SCALAR_IRRAD_LUT_STORE(IWVEX,WAVELENGTH_MICRON,MU_IN)
       IF(OCEAN_RAMAN_FLAG) &
          CALL OCEAN_RAMAN_SOURCE_LUT_STORE(IWVEX,NQUADOINPUT,WAVELENGTH_MICRON,MU_IN,MAXMORDINPUT_SAVE)
       DEALLOCATE(TAU_INELASTIC_EX)
    ENDDO
    ENDDO
  ENDIF

DELTATAUAINPUT=0.05D0        ! ADJUST FOR ACCURATE OPTICAL INTEGRATION
DELTATAUOINPUT=0.1D0

IF(WV_SEG_FLAG==0 .or. WV_SEG_FLAG==3)THEN
	NWV_BAND_START=1
	NWV_BAND_END=NWV_BAND_SEG1P2_HYPO
ELSEIF(WV_SEG_FLAG==1)THEN
	NWV_BAND_START=1
	NWV_BAND_END=NWV_BAND_SEG1_HYPO
ELSEIF(WV_SEG_FLAG==2)THEN
	NWV_BAND_START=NWV_BAND_SEG1_HYPO+1
	NWV_BAND_END=NWV_BAND_SEG1P2_HYPO
ELSEIF(WV_SEG_FLAG==4)THEN
	NWV_BAND_START=NWV_BAND_SEG1P2_HYPO+NWV_BAND_SEG3+1
	NWV_BAND_END=NWV_BAND_HYPO
ENDIF

ALLOCATE(XK(NILS_PACE),YK(NILS_PACE))

DO IWV_BAND=NWV_BAND_START,NWV_BAND_END

  WAVELENGTH_NANOMETER=WV_BAND_HYPO(IWV_BAND)
  WAVELENGTH_MICRON=WAVELENGTH_NANOMETER/1000.0D0

  LOCINDXTMP= MINLOC(ABS(WV_BAND-WAVELENGTH_NANOMETER))

  XK=ILS_DeltaWaveLength(LOCINDXTMP(1),:)
  YK=ILS_PACE(LOCINDXTMP(1),:)

  IF(IWV_BAND <= NWV_BAND_SEG1_HYPO)THEN
     RTMP=0.5D0
  ELSE
     RTMP=1.0D0
  ENDIF

  LOCINDXTMP= MINLOC(ABS(WV_BAND_HYPO(IWV_BAND)-RTMP*PACE_FWHM_HYPO(IWV_BAND)-WV))
  LOCINDXTMP1=MINLOC(ABS(WV_BAND_HYPO(IWV_BAND)+RTMP*PACE_FWHM_HYPO(IWV_BAND)-WV))

  IWV_SUB_START=LOCINDXTMP(1)
  IWV_SUB_END  =LOCINDXTMP1(1)

  WRITE(*,*)'WV_BAND(IWV_BAND),IWV_BAND,IWV_SUB_START,IWV_SUB_END=', &
             WV_BAND_HYPO(IWV_BAND),IWV_BAND,IWV_SUB_START,IWV_SUB_END

! PAY ATTENTION TO IWV_SUB_START AND IWV_SUB_END LATER, MAKE SURE COVERS THE WHOLE SPECTRUM.

  ALLOCATE(TAU_TG_DK(IWV_SUB_END-IWV_SUB_START+1),TAU_TG_DKP(IWV_SUB_END-IWV_SUB_START+1))

  CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,TAUR,DEPOL_A)
  INDEX_TAUPRIME=INDEX_PRIME_SCATTERING(NTLYERA,TAUR,PNDLY,WAVELENGTH_NANOMETER)
!  write(*,*)'INDEX_TAUPRIME INFO',INDEX_TAUPRIME,NTLYERA
  DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
    CALL TAU_TG_INIT(GAS_ABS_FLAG,NTLYERA,WV(IWV_SUB),TAU_TG,TAU_TG_H2O, &
					 TAU_TG_CO2,TAU_TG_CH4,TAU_TG_O2,TAU_TG_O3,TAU_TG_NO2)
    TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)=SUM(TAU_TG)
    TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)=SUM(TAU_TG(1:INDEX_TAUPRIME))
    TAU_TG_Save(IWV_SUB,:)=TAU_TG(:)

	TAU_TG_H2O_Save(IWV_SUB,:)=TAU_TG_H2O(:)
	TAU_TG_CO2_Save(IWV_SUB,:)=TAU_TG_CO2(:)
	TAU_TG_CH4_Save(IWV_SUB,:)=TAU_TG_CH4(:)
	TAU_TG_O2_Save(IWV_SUB,:) =TAU_TG_O2(:)
	TAU_TG_O3_Save(IWV_SUB,:) =TAU_TG_O3(:)
	TAU_TG_NO2_Save(IWV_SUB,:)=TAU_TG_NO2(:)

  ENDDO
  DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
     IF(TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)<1.0E-12)THEN
        TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)=1.0d0
     ELSE
        TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)=TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1) / &
									TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)
	 ENDIF
  ENDDO
!  WRITE(*,*)'MINVAL(TAU_TG_DKP),INDEX_TAUPRIME,NTLYERA=',MINVAL(TAU_TG_DKP),INDEX_TAUPRIME,NTLYERA
  N_AVG_SIZE=IWV_SUB_END-IWV_SUB_START+1
  ALLOCATE(XU(N_AVG_SIZE),YU(N_AVG_SIZE),ZU(N_AVG_SIZE),FSUN_BAND(N_AVG_SIZE))
  XU(1:N_AVG_SIZE)=WV(IWV_SUB_START:IWV_SUB_END)-WAVELENGTH_NANOMETER

  DO ILS_AVG=1,N_AVG_SIZE
      YU(ILS_AVG)=POLINT_SIMPLE(NILS_PACE,XK,YK,XU(ILS_AVG),2)
      IF(YU(ILS_AVG)<0.0D0)YU(ILS_AVG)=0.0D0
      FSUN_BAND(ILS_AVG)=POLINT_SIMPLE(NSUNL,WVSUN,FSUN,WV(ILS_AVG+IWV_SUB_START-1)/1000.0d0,2)
  ENDDO

  ILS_INT_CONST=TRAPZOID(N_AVG_SIZE,XU,YU)
  ZU=FSUN_BAND*YU
  FSUN_BAND_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)
  FSUN_BAND_AVG=FSUN_BAND_AVG/ILS_INT_CONST

  ZU=EXP(-TAU_TG_DK)*YU
  TAU_ABS_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)
  TAU_ABS_AVG=TAU_ABS_AVG/ILS_INT_CONST
  TAU_ABS_AVG=-LOG(TAU_ABS_AVG)

  TAU_TG_MAX=MAXVAL(TAU_TG_DK)
  TAU_TG_MIN=MINVAL(TAU_TG_DK)

  NWV_SUB_CAL=1

  IF(TAU_ABS_AVG>0.01D0 .AND. TAU_TG_MIN<1.0D0 .AND. (TAU_TG_MAX-TAU_TG_MIN)>0.2D0)THEN
       IF(TAU_TG_MAX<0.5D0)THEN
           NWV_SUB_CAL=3
       ELSEIF(TAU_TG_MAX<5.0D0)THEN
           NWV_SUB_CAL=5
       ELSE
           NWV_SUB_CAL=NDK_CAL
       ENDIF
       IF(NWV_SUB_CAL>NDK_CAL)STOP 'NWV_SUB_CAL IS LARGER THAN NDK_CAL'

       TAU_TG_DK_CAL(1)=TAU_TG_MIN
       TAU_TG_DK_CAL(2)=TAU_TG_MIN+0.1D0
       TAU_TG_DK_CAL(3)=TAU_TG_MIN+0.5D0

       TAU_TG_DK_CAL(4)=TAU_TG_MIN+1.0D0
       TAU_TG_DK_CAL(5)=TAU_TG_MIN+3.0D0

       TAU_TG_DK_CAL(6)=TAU_TG_MIN+5.0D0
       TAU_TG_DK_CAL(7)=TAU_TG_MIN+10.0D0

       ALLOCATE(MASKMINLOC(IWV_SUB_END-IWV_SUB_START+1))
       WVNUMRESET=.FALSE.
       LOOP_IDK :DO IDK_CAL=1,NWV_SUB_CAL
         LOCINDXTMP= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK))
         IF(IDK_CAL==1) THEN
            TAU_TG_DK_CAL(1)=TAU_TG_DK(LOCINDXTMP(1))
         ELSEIF(ABS(TAU_TG_DK(LOCINDXTMP(1))-TAU_TG_DK_CAL(IDK_CAL-1))<1.0E-6) THEN
            MASKMINLOC=.TRUE.
            MASKMINLOC(LOCINDXTMP(1))=.FALSE.
            LOCINDXTMP1= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK),MASKMINLOC)
            IF(ABS(TAU_TG_DK(LOCINDXTMP1(1))-TAU_TG_DK_CAL(IDK_CAL-1))>1.0E-6)THEN
              TAU_TG_DK_CAL(IDK_CAL)=TAU_TG_DK(LOCINDXTMP1(1))
            ELSE
              MASKMINLOC(LOCINDXTMP1(1))=.FALSE.
              LOCINDXTMP1= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK),MASKMINLOC)
              IF(ABS(TAU_TG_DK(LOCINDXTMP1(1))-TAU_TG_DK_CAL(IDK_CAL-1))>1.0E-6)THEN
                 TAU_TG_DK_CAL(IDK_CAL)=TAU_TG_DK(LOCINDXTMP1(1))
              ELSE
                 WVNUMRESET=.TRUE.
                 EXIT LOOP_IDK
              ENDIF
            ENDIF
         ELSE
            TAU_TG_DK_CAL(IDK_CAL)=TAU_TG_DK(LOCINDXTMP(1))
         ENDIF
       ENDDO LOOP_IDK
       DEALLOCATE(MASKMINLOC)

       IF(WVNUMRESET) THEN
          NWV_SUB_CAL=1
       ELSE
          TAU_TG_INCR(1:NWV_SUB_CAL-1)=MIN(0.5d0*(TAU_TG_DK_CAL(2:NWV_SUB_CAL) - &
                                              TAU_TG_DK_CAL(1:NWV_SUB_CAL-1)),0.05D0)
          TAU_TG_INCR(NWV_SUB_CAL)=TAU_TG_INCR(NWV_SUB_CAL-1)
       ENDIF
  ENDIF
  IF(MONOCHROMATIC_FLAG)NWV_SUB_CAL=1

  WRITE(*,*)'NWV_SUB_CAL=',NWV_SUB_CAL

  ALLOCATE(INDX_WV_CAL(NWV_SUB_CAL))

  IF(NWV_SUB_CAL==1)THEN
     INDX_WV_CAL(1)=(IWV_SUB_START+IWV_SUB_END)/2
  ELSE
     DO IDK_CAL=1,NWV_SUB_CAL
       LOCINDXTMP= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK))
       INDX_WV_CAL(IDK_CAL)=LOCINDXTMP(1)+IWV_SUB_START-1
     ENDDO
  ENDIF

  ALLOCATE(TAU_ARSL_Ext_TMP(NWV_SUB_CAL,NTLYERA), &
           TAU_ARSL_Scat_TMP(NWV_SUB_CAL,NTLYERA),&
           TAU_RAY_TMP(NWV_SUB_CAL,NTLYERA),      &
		   DEPOL_A_TMP(NWV_SUB_CAL,NTLYERA))
  ALLOCATE(DIRADTMP(1:NDET,1:NWV_SUB_CAL,1:2),      &
           DSTOKESTMP(1:NDET,1:NWV_SUB_CAL,1:NTHETAOUT,1:NPHIOUT,1:4))

  DO IWV_CAL=1,NWV_SUB_CAL
        write(*,'("SUB WAVELENGTH INFO",I4,2x,E12.6,2x,E12.6)')IWV_CAL,WV(INDX_WV_CAL(IWV_CAL)),&
                              TAU_TG_DK(INDX_WV_CAL(IWV_CAL)-IWV_SUB_START+1)
        WAVELENGTH_NANOMETER=WV(INDX_WV_CAL(IWV_CAL))
        WAVELENGTH_MICRON=WAVELENGTH_NANOMETER/1000.0D0
        IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG)THEN
            CALL FFLRfuncjEXCAL(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,WAVELENGTH_NANOMETER)
            CALL SOURCEF_FLUORESCENCE_INTEGRATION(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,WAVELENGTH_NANOMETER)
            IF(OCEAN_FCDOM_FLAG)DEALLOCATE(fCDOMfuncjEX)
            IF(OCEAN_FCHLA_FLAG)DEALLOCATE(fCHLAfuncjEX)
        ENDIF
        IF(OCEAN_RAMAN_FLAG)THEN
            CALL FRFUNCJCAL(WAVELENGTH_NANOMETER)
            CALL SOURCEF_EM_INTEGRATION(NQUADOINPUT,MU_IN,MAXMORDINPUT_SAVE)
        ENDIF

        CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,TAUR,DEPOL_A)

        IF(NWV_SUB_CAL>1)THEN
             TAU_TG=TAU_TG_Save(INDX_WV_CAL(IWV_CAL),:)
        ELSE
             DO ILAYER=1,NTLYERA
                ZU=TAU_TG_Save(IWV_SUB_START:IWV_SUB_END,ILAYER)
                ZU=ZU*YU
                TAU_TG(ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)
             ENDDO
             TAU_TG=TAU_TG/ILS_INT_CONST
        ENDIF

        call date_and_time(values=time_array_0)
        start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                   + time_array_0 (7) + 0.001 * time_array_0 (8)

        MAXMORDINPUT=MIN(30,NQUADAINPUT,MAXMORDINPUT_SAVE)
        Indx_Inelastic_Scattering=0      ! Elastic scattering only

        IF(OCEAN_RAMAN_FLAG) Indx_Inelastic_Scattering=2  ! ELASTIC PART AND RAMAN EMISSION WAVELENGTH
        IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
             Indx_Inelastic_Scattering=4 ! ELASTIC PART AND FLUORESCENCE EMISSION WAVELENGTH
        IF(OCEAN_RAMAN_FLAG .AND. (OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG)) &
             Indx_Inelastic_Scattering=5
           ! ELASTIC PART; BOTH RAMAN AND FLUORESCENCE EMISSION WAVELENGTH
        IF(WAVELENGTH_MICRON>0.88) Indx_Inelastic_Scattering=0      ! Elastic scattering only

        CALL RTSOSINIT(Indx_Inelastic_Scattering,INDX_WV_CAL(IWV_CAL),&
           WAVELENGTH_MICRON,NREC,NTLYERA,NTLYERO,PNDLY,TAUR,DEPOL_A,TAU_TG,       &
           RECDATASTREAM,NTLYER,NUMMIEUSE,NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT, &
           PHMXDATASTREAM,LBDO_LD,FLAM,TEMPERTURE,SALINITY)

        DO ILAYER=1,NTLYERA
           IF(AirSensor_Height <= ALT_LYRA(ILAYER+1))THEN
               IREC_SHFT=1
           ELSE
               IREC_SHFT=2
           ENDIF
           TAU_ARSL_Ext_TMP(IWV_CAL,ILAYER)=RECDATASTREAM(ILAYER+IREC_SHFT,2)-TAUR(ILAYER)-TAU_TG(ILAYER)
           TAU_ARSL_Scat_TMP(IWV_CAL,ILAYER)=RECDATASTREAM(ILAYER+IREC_SHFT,2)*RECDATASTREAM(ILAYER+IREC_SHFT,3)-TAUR(ILAYER)
           TAU_RAY_TMP(IWV_CAL,ILAYER)=TAUR(ILAYER)
           DEPOL_A_TMP(IWV_CAL,ILAYER)=DEPOL_A(ILAYER)
        ENDDO

        call date_and_time(values=time_array_1)
              finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                   + time_array_1 (7) + 0.001 * time_array_1 (8)
        write(*,*)'rtsosinit elapsed time =', finish_time-start_time
!! testing rtsosinit
!open(unit=1,file='recdata_dk',Status='replace')
!write(1,*)'WV(',IWV_BAND,')=',WV_BAND(IWV_BAND)
!WRITE(1,*)'RECDATASTREAM'
!DO INTTMP=1,NREC
!IPT = RECDATASTREAM(INTTMP,1)
!WRITE(1,'(I5,6(2x,E13.6))')IPT,RECDATASTREAM(INTTMP,2:7)
!ENDDO
!close(1)
!
!open(unit=2,file='phmx_dk_001',Status='replace')
!IMIE=1
!WRITE(2,*)'PHMXDATASTREAM'
!DO ITHETA=1,NUMMIEANGINPUT(IMIE)
!WRITE(2,'(7(2x,E13.6))')PHMXDATASTREAM(IMIE,ITHETA,0:6)
!ENDDO
!close(2)
!open(unit=2,file='phmx_dk_002',Status='replace')
!IMIE=NTLYERA+1
!WRITE(2,*)'PHMXDATASTREAM'
!DO ITHETA=1,NUMMIEANGINPUT(IMIE)
!WRITE(2,'(7(2x,E13.6))')PHMXDATASTREAM(IMIE,ITHETA,0:6)
!ENDDO
!close(2)

        CALL RTSOS(NREC,NDET,RECDATASTREAM,NCOLINPUT,NQUADAINPUT,NQUADOINPUT, &
             DELTATAUAINPUT,DELTATAUOINPUT,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,    &
             NUMMIEANGINPUT,PHMXDATASTREAM,MU_IN,NTHETAOUT,&
             NPHIOUT,PHIOUT,MUOUT,DIRAD,DSTOKES,WLR_FLAG_INPUT,WCFLG_INPUT,DELTAM_INPUT)

        call date_and_time(values=time_array_1)
              start_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                   + time_array_1 (7) + 0.001 * time_array_1 (8)
        write(*,*)'rtsos elapsed time =', start_time-finish_time

        IF(NWV_SUB_CAL>1)THEN
           RTMP1=FSUN_BAND(INDX_WV_CAL(IWV_CAL)-IWV_SUB_START+1)/DIRAD(1,1)*abs(MU_IN)
        ELSE
           RTMP1=FSUN_BAND_AVG/DIRAD(1,1)*abs(MU_IN)
        ENDIF
        DIRADTMP(1:NDET,IWV_CAL,1:2)=DIRAD(1:NDET,1:2)*RTMP1
        DSTOKESTMP(1:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)= &
                                DSTOKES(1:NDET,1:NTHETAOUT,1:NPHIOUT,1:4)*RTMP1
!testing
!write(*,*)'WAVELENGTH_MICRON,RTMP1,DSTOKES(1,1,1,1)',WAVELENGTH_MICRON,RTMP1,DSTOKES(1,1,1,1)
        IF(NWV_SUB_CAL>1 .AND. SNG_SCAT_EXACT)THEN
            CALL RT_SINGLE_SCATTERING(NREC,NDET,RECDATASTREAM,DELTATAUAINPUT,&
                  DELTATAUOINPUT,NUMMIERT,NUMMIEANGINPUT,MAXLORDINPUT,       &
                  PHMXDATASTREAM,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,DIRAD,    &
                  DSTOKES,WCFLG_INPUT,DELTAM_INPUT)

        call date_and_time(values=time_array_1)
              finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                   + time_array_1 (7) + 0.001 * time_array_1 (8)
        write(*,*)'rt_single_scattering elapsed time =', finish_time-start_time

!write(*,*)'WV,DIRADTMP=',WV(INDX_WV_CAL(IWV_CAL)),DIRADTMP(1,IWV_CAL,1:2),DIRAD(1,1:2),rtmp1

!            DIRADTMP(1:NDET,IWV_CAL,1:2)=DIRADTMP(1:NDET,IWV_CAL,1:2)-DIRAD(1:NDET,1:2)*RTMP1
            DSTOKESTMP(1:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)=&
                   DSTOKESTMP(1:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4) - &
                   DSTOKES(1:NDET,1:NTHETAOUT,1:NPHIOUT,1:4)*RTMP1

        ENDIF
        IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
        !  idet==1, detector at the top of the atmosphere, not impacted by the rescale scheme.
        !  idet==2, det at bottom of the atmosphere
        !  idet==3, det at top of the ocean
        !  both share the same absorption optical depth rescale.
          DIRADTMP(2:NDET,IWV_CAL,1:2)=DIRADTMP(2:NDET,IWV_CAL,1:2)*EXP(-TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
          DSTOKESTMP(2:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)= &
              DSTOKESTMP(2:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)*EXP(-TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
        ENDIF

  ENDDO
  WAVELENGTH_Table_Save(IWV_BAND)=WV(INDX_WV_CAL(1))
  TAU_ARSL_Ext_Save(IWV_BAND,:)=TAU_ARSL_Ext_TMP(1,:)
  TAU_ARSL_Scat_Save(IWV_BAND,:)=TAU_ARSL_Scat_TMP(1,:)
  TAU_RAY_Save(IWV_BAND,:)=TAU_RAY_TMP(1,:)
  DEPOL_A_Save(IWV_BAND,:)=DEPOL_A_TMP(1,:)

  IF(NWV_SUB_CAL==1)THEN
     DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
         DIRADFULL(1:NDET,IWV_SUB,1:2)=DIRADTMP(1:NDET,1,1:2)
         DSTOKESFULL(1:NDET,IWV_SUB,1:NTHETAOUT,1:NPHIOUT,1:4)= &
                      DSTOKESTMP(1:NDET,1,1:NTHETAOUT,1:NPHIOUT,1:4)
     ENDDO
  ELSE

     DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
        WAVELENGTH_NANOMETER=WV(IWV_SUB)
        WAVELENGTH_MICRON=WAVELENGTH_NANOMETER/1000.0D0

        IF(SNG_SCAT_EXACT)THEN
          CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,TAUR,DEPOL_A)
          TAU_TG=TAU_TG_Save(IWV_SUB,:)
          Indx_Inelastic_Scattering=0
          CALL RTSOSINIT(Indx_Inelastic_Scattering,IWV_SUB,&
            WAVELENGTH_MICRON,NREC,NTLYERA,NTLYERO,PNDLY,TAUR,DEPOL_A,TAU_TG,      &
            RECDATASTREAM,NTLYER,NUMMIEUSE,NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT,&
            PHMXDATASTREAM,LBDO_LD,FLAM,TEMPERTURE,SALINITY)

          CALL RT_SINGLE_SCATTERING(NREC,NDET,RECDATASTREAM,DELTATAUAINPUT,  &
                DELTATAUOINPUT,NUMMIERT,NUMMIEANGINPUT,MAXLORDINPUT,         &
                PHMXDATASTREAM,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,DIRAD,   &
                DSTOKES,WCFLG_INPUT,DELTAM_INPUT)
          RTMP1=FSUN_BAND_AVG/DIRAD(1,1)*abs(MU_IN)
          DIRADFULL(1:NDET,IWV_SUB,1:2)=0.0d0 ! single scattering irradiance return is zero
          DIRADFULL(1,IWV_SUB,1)=DIRAD(1,1)*RTMP1 ! single scattering irradiance is exact for downwelling irradiance
          DSTOKESFULL(1:NDET,IWV_SUB,1:NTHETAOUT,1:NPHIOUT,1:4)= &
                        DSTOKES(1:NDET,1:NTHETAOUT,1:NPHIOUT,1:4)*RTMP1
        ELSE
          DIRADFULL(1,IWV_SUB,1)=DIRADTMP(1,1,1) ! no double k fitting for downwelling irradiance at TOA
        ENDIF

     ENDDO

     DK(1:NWV_SUB_CAL)=TAU_TG_DK(INDX_WV_CAL(1:NWV_SUB_CAL)-IWV_SUB_START+1)

     DO IDET=1,NDET
     DO ICOM=1,2
        IF(IDET == 1 .AND. ICOM == 1)CYCLE

        IMS(1:NWV_SUB_CAL)=DIRADTMP(IDET,1:NWV_SUB_CAL,ICOM)
!testing
!write(*,*)'idet,icom,ims=',idet, icom,IMS
        CALL DOUBLEKPARA_EVALUATION(NWV_SUB_CAL,TAU_TG_MAX,ErrFLAG)
!        IF(ErrFLAG)THEN
!           WRITE(*,*)IDET,ICOM,DK(1:NWV_SUB_CAL),IMS(1:NWV_SUB_CAL)
!           STOP 'CHECK EXPONENTIONAL FITTING IRRADIANCE'
!        ENDIF
        DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
           DK_VAL=TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)
           DKP_VAL=TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)
           RTMP=DOUBLEKFUNC_EVALUATION(NWV_SUB_CAL,DK_VAL,DKP_VAL)
           IF(SNG_SCAT_EXACT)THEN
              DIRADFULL(IDET,IWV_SUB,ICOM)=DIRADFULL(IDET,IWV_SUB,ICOM) + RTMP
           ELSE
              DIRADFULL(IDET,IWV_SUB,ICOM)=RTMP
           ENDIF
        ENDDO
     ENDDO ! LOOP ICOM
     ENDDO ! LOOP NDET

     DO IDET=1,NDET
     DO ITHETA=1,NTHETAOUT
     DO IPHI=1,NPHIOUT
	    IMS(1:NWV_SUB_CAL)=DSTOKESTMP(IDET,1:NWV_SUB_CAL,ITHETA,IPHI,1)
	    CALL DOUBLEKPARA_EVALUATION(NWV_SUB_CAL,TAU_TG_MAX,ErrFLAG)
!!testing
!        IF(ErrFLAG)THEN
!            WRITE(*,*)'dktest line 01,',IDET,itheta,iphi,WV(INDX_WV_CAL(1:NWV_SUB_CAL))
!            WRITE(*,*)'dktest line 02,',DK(1:NWV_SUB_CAL),IMS(1:NWV_SUB_CAL)
!            STOP 'CHECK EXPONENTIONAL FITTING RADIANCE'
!        ENDIF

     DO ICOM=1,4
        IMS(1:NWV_SUB_CAL)=DSTOKESTMP(IDET,1:NWV_SUB_CAL,ITHETA,IPHI,ICOM)
        DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
           DK_VAL=TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)
           DKP_VAL=TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)
           RTMP=DOUBLEKFUNC_EVALUATION(NWV_SUB_CAL,DK_VAL,DKP_VAL)

!testing
!if(idet==1 .and. icom==1 .and. itheta==1 .and. iphi==1 .and. abs(WV(IWV_SUB)-758.055d0)<1.0e-6) &
!   WRITE(*,*)'DOUBLE K DOUBLEKFUNC_EVALUATION:',WV(IWV_SUB),IWV_SUB,RTMP
           IF(SNG_SCAT_EXACT)THEN
              DSTOKESFULL(IDET,IWV_SUB,ITHETA,IPHI,ICOM)= &
                     DSTOKESFULL(IDET,IWV_SUB,ITHETA,IPHI,ICOM)+RTMP
           ELSE
              DSTOKESFULL(IDET,IWV_SUB,ITHETA,IPHI,ICOM)= RTMP
           ENDIF
        ENDDO
     ENDDO
     ENDDO
     ENDDO
     ENDDO

  ENDIF

    call date_and_time(values=time_array_0)
    start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
               + time_array_0 (7) + 0.001 * time_array_0 (8)
    write(*,*)'rtsos elapsed time =', start_time-finish_time
    DEALLOCATE(TAU_TG_DK,TAU_TG_DKP,TAU_ARSL_Ext_TMP,TAU_ARSL_Scat_TMP, &
               TAU_RAY_TMP, DEPOL_A_TMP, DIRADTMP,DSTOKESTMP,INDX_WV_CAL)
    DEALLOCATE(XU,YU,ZU,FSUN_BAND)
ENDDO ! WAVELENG LOOP


CALL STOKESOUT(OUTFILE,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,                  &
        DIRADFULL,DSTOKESFULL,WAVELENGTH_Table_Save,TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,           &
        TAU_RAY_Save, DEPOL_A_Save, TAU_TG_Save,TAU_TG_H2O_Save,              &
        TAU_TG_CO2_Save,TAU_TG_CH4_Save,TAU_TG_O2_Save,TAU_TG_O3_Save,        &
		TAU_TG_NO2_Save, NTLYERA,ARSLND1_Save,ARSLND2_Save,NUMMIEUSE,         &
        REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,                          &
        MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save,TEMPERTURE,SALINITY)
CALL PACE_FWHM_DEALLO
DEALLOCATE(XK,YK)
IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG .OR. OCEAN_RAMAN_FLAG) &
        DEALLOCATE(LAMBDAEXFLRSC)
IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG) &
  DEALLOCATE(DIIRAD_SCALAR_AGD,ABSORB_COEFF_CDOM_EX,  &
             ABSORB_COEFF_CHLA_EX,SOURCEFO_FLUORESCENCE_AGD,IPAR_SCALAR,&
             QUANTUM_YIELD_CHLA_PROFILE)
IF(OCEAN_RAMAN_FLAG .OR. OCEAN_FCHLA_FLAG  .OR. OCEAN_FCDOM_FLAG) &
       DEALLOCATE(TAU_INELASTIC_AGD,EXT_COEFF_INELASTIC_EM)
IF(ABSORPTION_TAU_REDUCE_FLAG) &
       DEALLOCATE(TAU_REDUCE_ATMOS_PRESERVE,TAU_REDUCE_OCEAN_PRESERVE)

IF(OCEAN_RAMAN_FLAG)DEALLOCATE(SOURCEFO_RAMAN_AGD,SOURCEFO_RAMAN_AGD_LUT,XJO_MAIN)
DEALLOCATE(CHLA_VERTICAL_PROFILE)

CLOSE(55)
DEALLOCATE(DIRAD,DSTOKES,DIRADFULL,DSTOKESFULL,                                &
          PNDLY,ARSLND1_Save,ARSLND2_Save,REFF1_Save,REFF2_Save,               &
          VEFF1_Save,VEFF2_Save,MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save,       &
          WAVELENGTH_Table_Save,TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,          &
          TAU_RAY_Save,DEPOL_A_Save,TAU_TG_Save,TAU_TG_H2O_Save,TAU_TG_CO2_Save,&
          TAU_TG_CH4_Save,TAU_TG_O2_Save,TAU_TG_O3_Save,TAU_TG_NO2_Save)
DEALLOCATE(PHIOUT,MUOUT,RECDATASTREAM,NUMMIEANGINPUT,PHMXDATASTREAM)
DEALLOCATE(TAUR,DEPOL_A,ALT_LYRA,TAU_TG)
DEALLOCATE(GAS_ABS_COEFF,GAS_ABS_COEFF_H2O,GAS_ABS_COEFF_CO2, &
           GAS_ABS_COEFF_CH4,GAS_ABS_COEFF_O2, GAS_ABS_COEFF_O3,&
           GAS_ABS_COEFF_NO2)
CALL DEALL_SUNL
CALL DEALLO_ATMOSPRF
ENDPROGRAM SOSINT

SUBROUTINE  STOKESOUT(CFILE1,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,         &
        DIRADFULL,DSTOKESFULL,WAVELENGTH_Table_Save,TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,        &
        TAU_RAY_Save,DEPOL_A_Save,TAU_TG_Save,TAU_TG_H2O_Save,TAU_TG_CO2_Save,         &
		TAU_TG_CH4_Save,TAU_TG_O2_Save,TAU_TG_O3_Save, TAU_TG_NO2_Save,    &
		NTLYERA,ARSLND1_Save,ARSLND2_Save,NUMMIEUSE,  &
        REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,             &
        MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save,TEMPERTURE,SALINITY)

USE GLOBAL_DATA
USE PACE_INSTRUMENT_DESIGN
USE SAVE_OCEAN_MOD,only:WATER_DEPTH,NWATER_DEPTH,IPAR_SCALAR,DIIRAD_SCALAR_AGD,&
                        CHLA_VERTICAL_PROFILE,QUANTUM_YIELD_CHLA_PROFILE
USE FLUORESCENCEDATA
USE MIE_PHMX_PACE,ONLY : BBFRAC_Plankton_BAND,BBFRAC_Mineral_BAND
USE HDF5
USE ISO_C_BINDING

IMPLICIT none
CHARACTER*360 :: CFILE1

INTEGER :: NTHETAOUT,NPHIOUT,NTLYERA,NUMMIEUSE,ICOM

REAL*8,DIMENSION(NDET,NWV,2) :: DIRADFULL  ! DIRADFULL(:,1) DOWNWELLING IRADIANCE
                                   ! DIRAD(:,2) UPWELLING IRADIANCE
REAL*8,DIMENSION(NDET,NWV,NTHETAOUT,NPHIOUT,4) :: DSTOKESFULL
REAL*8,DIMENSION(NWV_BAND_SEG1P2_HYPO) :: WAVELENGTH_Table_Save
REAL*8,DIMENSION(NWV_BAND_SEG1P2_HYPO,NTLYERA) ::TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save, &
                   TAU_RAY_Save,DEPOL_A_Save
REAL*8,DIMENSION(NWV,NTLYERA) ::TAU_TG_Save,TAU_TG_H2O_Save,TAU_TG_CO2_Save,      &
				   TAU_TG_CH4_Save,TAU_TG_O2_Save,TAU_TG_O3_Save,TAU_TG_NO2_Save

REAL*8,DIMENSION(NTHETAOUT) :: MUOUT
REAL*8,DIMENSION(NPHIOUT) :: PHIOUT

!REAL*8,DIMENSION(1:NTLYERA+1) ::ALT_LYRA
REAL*8,DIMENSION(NUMMIEUSE) ::REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,ARSLND1_Save,ARSLND2_Save
REAL*8,DIMENSION(NUMMIEUSE,NWV_BAND) ::MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save
REAL*8,INTENT(IN) :: TEMPERTURE,SALINITY

REAL*8,DIMENSION(NDET,NWV_BAND,2) :: DIRADFULL_AVG  ! DIRADFULL(:,1) DOWNWELLING IRADIANCE
! DIRAD(:,2) UPWELLING IRADIANCE
REAL*8,DIMENSION(NDET,NWV_BAND,NTHETAOUT,NPHIOUT,4) :: DSTOKESFULL_AVG
REAL*8,DIMENSION(NWV_BAND,NTLYERA) :: TAU_TG_AVG,TAU_TG_H2O_AVG,TAU_TG_CO2_AVG, &
                        TAU_TG_CH4_AVG,TAU_TG_O2_AVG,TAU_TG_O3_AVG,TAU_TG_NO2_AVG
REAL*8,DIMENSION(NWV_BAND,NTLYERA) ::TAU_ARSL_Ext_AVG,TAU_ARSL_Scat_AVG, &
				   TAU_RAY_AVG,DEPOL_A_AVG

REAL*8,DIMENSION(NWV_BAND) :: AW_AVG,BW_AVG,RINDX_WATER_AVG,APTC_AVG,BPTC_AVG,BBPTC_AVG, &
                              BBPTCfrac_AVG,BSTC_AVG,BBSTC_AVG,BBSTCfrac_AVG,ASTC_AVG,ACDM_AVG
REAL*8 :: MU_IN,RTMP
LOGICAL :: MUFLG
REAL*8,PARAMETER :: PI=3.141592653589793d0
REAL*8,PARAMETER :: FACTOR=PI/180.0d0
INTEGER:: MPLIN,NDETOUT,ITHETA,IPHI,IWV,ILAYER,IDET,IMIE

! HDF 5 DEFINITION
! This should map to REAL*8 on most modern processors
!INTEGER, PARAMETER :: real_kind_15 = SELECTED_REAL_KIND(Fortran_REAL_8)
CHARACTER(LEN=360) :: HDF5FILENAME
INTEGER(HID_T)  :: file, space, dset, attr ! Handles
INTEGER :: hdferr
INTEGER(hsize_t),   DIMENSION(1:2) :: dims
INTEGER(hsize_t),DIMENSION(1) :: dimscl
INTEGER(HSIZE_T), DIMENSION(1:2) :: maxdims
TYPE(C_PTR) :: f_ptr
REAL*4,DIMENSION(1),TARGET :: HDF5RTMP
INTEGER,DIMENSION(1),TARGET :: HDF5ITMP
REAL*4,DIMENSION(:),TARGET,ALLOCATABLE :: HDF5RARR
REAL*4,DIMENSION(:,:),TARGET,ALLOCATABLE :: HDF5RARR2DIM

INTEGER(hsize_t), DIMENSION(1:4) :: dims4
INTEGER(HSIZE_T), DIMENSION(1:4) :: maxdims4
REAL*4,DIMENSION(:,:,:,:),TARGET,ALLOCATABLE :: HDF5RARR4DIM

INTEGER :: NWV_START,NWV_END,NWV_OUTPUT,IWV_AVG,ILS_AVG

REAL*8 :: WAVELENGTH_BAND_LO,WAVELENGTH_BAND_HI,WAVELENGTH_MICRON
REAL*8 :: AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,   &
          BBPTCfracLOCAL,APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL,ASTCLOCAL,&
          BSTCLOCAL,BBSTCfracLOCAL
INTEGER,DIMENSION(1) ::LOCINDXTMP,LOCINDXTMP1,LOCINDXTMP2

INTEGER :: N_AVG_SIZE,MPL
REAL*8,DIMENSION(NILS_PACE) :: XK,YK
REAL*8,DIMENSION(:),ALLOCATABLE :: XU,YU,ZU,TempU
REAL*8 :: POLINT_SIMPLE,ILS_INT_CONST,TRAPZOID

IF(WV_SEG_FLAG==0 .OR. WV_SEG_FLAG==3)THEN
	NWV_START=1
	NWV_END=NWV
ELSEIF(WV_SEG_FLAG==1 .OR. WV_SEG_FLAG==4)THEN
	NWV_START=1
	NWV_END=NWV_SEG1
ELSEIF(WV_SEG_FLAG==2)THEN
	NWV_START=NWV_SEG1+1
	NWV_END=NWV
ENDIF

DO IWV_AVG=NWV_START,NWV_END
    WAVELENGTH_MICRON=WV(IWV_AVG)/1000.0d0
    LOCINDXTMP =MINLOC(ABS(WV(IWV_AVG)-WV_BAND))

    CALL HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLa,TEMPERTURE,SALINITY,   &
               AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,   &
               BBPTCfracLOCAL,APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)
    IF(OCEAN_CASE_SELECT==2) THEN
      CALL NAP_PARA_INIT(WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION, &
                         SEDIMENT_SPECTRAL_SLOPE,ASTCLOCAL,BSTCLOCAL,BBSTCfracLOCAL)
      BBPTCfrac(IWV_AVG)=BBFRAC_Plankton_BAND(LOCINDXTMP(1))
      BBPTC(IWV_AVG)= BPTCLOCAL * BBPTCfrac(IWV_AVG)

      BBSTCfrac(IWV_AVG)=BBFRAC_Mineral_BAND(LOCINDXTMP(1))
      BBSTC(IWV_AVG)= BSTCLOCAL * BBSTCfrac(IWV_AVG)

    ELSE
      ASTCLOCAL=0.0D0
      BSTCLOCAL=0.0D0

      BBPTCfrac(IWV_AVG)=BBPTCfracLOCAL
      BBPTC(IWV_AVG)= BPTCLOCAL * BBPTCfrac(IWV_AVG)

      BBSTCfrac(IWV_AVG)=0.0D0
      BBSTC(IWV_AVG)=0.0D0
    ENDIF
    AW(IWV_AVG)=AWLOCAL
    BW(IWV_AVG)=BWLOCAL
    BBW(IWV_AVG)=BBWLOCAL
    BWRAMAN(IWV_AVG)=BWRAMANLOCAL
    BPTC(IWV_AVG)=BPTCLOCAL
    APTC(IWV_AVG)=APTCLOCAL
    ACDM(IWV_AVG)=ACDMLOCAL
    ASTC(IWV_AVG)=ASTCLOCAL
    BSTC(IWV_AVG)=BSTCLOCAL
    RINDX_WATER(IWV_AVG)=RINDX_WATERLOCAL
ENDDO


IF(ILS_FLAG)THEN

  NWV_START=1
  NWV_END=NWV_BAND

  NWV_OUTPUT=NWV_END-NWV_START+1

  MPL=2
  DIRADFULL_AVG=0.0D0
  DSTOKESFULL_AVG=0.0D0
  TAU_TG_AVG=0.0D0
  TAU_TG_H2O_AVG=0.0d0
  TAU_TG_CO2_AVG=0.0d0
  TAU_TG_CH4_AVG=0.0d0
  TAU_TG_O2_AVG=0.0d0
  TAU_TG_O3_AVG=0.0d0
  TAU_TG_NO2_AVG=0.0d0
  ALLOCATE(TempU(NWV_BAND_SEG1P2_HYPO))
  DO IWV_AVG=NWV_START,NWV_END
     XK=ILS_DeltaWaveLength(IWV_AVG,:)
     YK=ILS_PACE(IWV_AVG,:)
     WAVELENGTH_BAND_LO=WV_BAND(IWV_AVG)-PACE_FWHM(IWV_AVG)
     WAVELENGTH_BAND_HI=WV_BAND(IWV_AVG)+PACE_FWHM(IWV_AVG)
     LOCINDXTMP =MINLOC(ABS(WAVELENGTH_BAND_LO-WV))
     LOCINDXTMP1=MINLOC(ABS(WAVELENGTH_BAND_HI-WV))
     N_AVG_SIZE=LOCINDXTMP1(1)-LOCINDXTMP(1)+1
     ALLOCATE(XU(N_AVG_SIZE),YU(N_AVG_SIZE),ZU(N_AVG_SIZE))
     XU(1:N_AVG_SIZE)=WV(LOCINDXTMP(1):LOCINDXTMP1(1))-WV_BAND(IWV_AVG)
     DO ILS_AVG=1,N_AVG_SIZE
        YU(ILS_AVG)=POLINT_SIMPLE(NILS_PACE,XK,YK,XU(ILS_AVG),MPL)
        IF(YU(ILS_AVG)<0.0D0)YU(ILS_AVG)=0.0D0
     ENDDO
     ILS_INT_CONST=TRAPZOID(N_AVG_SIZE,XU,YU)
     DO ILAYER=1,NTLYERA

        ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
        ZU=ZU*YU
        TAU_TG_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)

		ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_H2O_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
		ZU=ZU*YU
		TAU_TG_H2O_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)

		ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_CO2_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
		ZU=ZU*YU
		TAU_TG_CO2_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)

		ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_CH4_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
		ZU=ZU*YU
		TAU_TG_CH4_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)

		ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_O2_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
		ZU=ZU*YU
		TAU_TG_O2_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)

		ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_O3_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
		ZU=ZU*YU
		TAU_TG_O3_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)

		ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_NO2_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
		ZU=ZU*YU
		TAU_TG_NO2_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)

		IF(WV_BAND(IWV_AVG)<900.0d0)THEN
			TempU=TAU_ARSL_Ext_Save(:,ILAYER)
			TAU_ARSL_Ext_AVG(IWV_AVG,ILAYER)=POLINT_SIMPLE(NWV_BAND_SEG1P2_HYPO,WAVELENGTH_Table_Save,TempU,WV_BAND(IWV_AVG),3)
			TempU=TAU_ARSL_Scat_Save(:,ILAYER)
			TAU_ARSL_Scat_AVG(IWV_AVG,ILAYER)=POLINT_SIMPLE(NWV_BAND_SEG1P2_HYPO,WAVELENGTH_Table_Save,TempU,WV_BAND(IWV_AVG),3)
			TempU=TAU_RAY_Save(:,ILAYER)
			TAU_RAY_AVG(IWV_AVG,ILAYER)=POLINT_SIMPLE(NWV_BAND_SEG1P2_HYPO,WAVELENGTH_Table_Save,TempU,WV_BAND(IWV_AVG),4)
			TempU=DEPOL_A_Save(:,ILAYER)
			DEPOL_A_AVG(IWV_AVG,ILAYER)=POLINT_SIMPLE(NWV_BAND_SEG1P2_HYPO,WAVELENGTH_Table_Save,TempU,WV_BAND(IWV_AVG),3)
		ELSE
			LOCINDXTMP2=MINLOC(ABS(WV_BAND(IWV_AVG)-WAVELENGTH_Table_Save))
			TAU_ARSL_Ext_AVG(IWV_AVG,ILAYER)=TAU_ARSL_Ext_Save(LOCINDXTMP2(1),ILAYER)
			TAU_ARSL_Scat_AVG(IWV_AVG,ILAYER)=TAU_ARSL_Scat_Save(LOCINDXTMP2(1),ILAYER)
			TAU_RAY_AVG(IWV_AVG,ILAYER)=TAU_RAY_Save(LOCINDXTMP2(1),ILAYER)
			DEPOL_A_AVG(IWV_AVG,ILAYER)=DEPOL_A_Save(LOCINDXTMP2(1),ILAYER)
		ENDIF

     ENDDO

     DO IDET=1,NDET
     DO ICOM=1,2
       ZU(1:N_AVG_SIZE)=DIRADFULL(IDET,LOCINDXTMP(1):LOCINDXTMP1(1),ICOM)
       ZU=ZU*YU
       DIRADFULL_AVG(IDET,IWV_AVG,ICOM)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     ENDDO
     ENDDO

     DO IDET=1,NDET
     DO ICOM=1,4
     DO ITHETA=1,NTHETAOUT
     DO IPHI=1,NPHIOUT
       ZU(1:N_AVG_SIZE)=DSTOKESFULL(IDET,LOCINDXTMP(1):LOCINDXTMP1(1),ITHETA,IPHI,ICOM)
       ZU=ZU*YU
       DSTOKESFULL_AVG(IDET,IWV_AVG,ITHETA,IPHI,ICOM)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     ENDDO
     ENDDO
     ENDDO
     ENDDO

     ZU(1:N_AVG_SIZE)=AW(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     AW_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     AW_AVG(IWV_AVG)=AW_AVG(IWV_AVG)/ILS_INT_CONST

     ZU(1:N_AVG_SIZE)=BW(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BW_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     BW_AVG(IWV_AVG)=BW_AVG(IWV_AVG)/ILS_INT_CONST

     ZU(1:N_AVG_SIZE)=RINDX_WATER(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     RINDX_WATER_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     RINDX_WATER_AVG(IWV_AVG)=RINDX_WATER_AVG(IWV_AVG)/ILS_INT_CONST

     ZU(1:N_AVG_SIZE)=APTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     APTC_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     APTC_AVG(IWV_AVG)=APTC_AVG(IWV_AVG)/ILS_INT_CONST

     ZU(1:N_AVG_SIZE)=BPTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BPTC_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     BPTC_AVG(IWV_AVG)=BPTC_AVG(IWV_AVG)/ILS_INT_CONST

     ZU(1:N_AVG_SIZE)=BBPTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BBPTC_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     BBPTC_AVG(IWV_AVG)=BBPTC_AVG(IWV_AVG)/ILS_INT_CONST
     IF(BPTC_AVG(IWV_AVG)>0.0d0) THEN
        BBPTCfrac_AVG(IWV_AVG)=BBPTC_AVG(IWV_AVG)/BPTC_AVG(IWV_AVG)
     ELSE
        BBPTCfrac_AVG(IWV_AVG)=0.0d0
	 ENDIF
     ZU(1:N_AVG_SIZE)=BSTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BSTC_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     BSTC_AVG(IWV_AVG)=BSTC_AVG(IWV_AVG)/ILS_INT_CONST

     ZU(1:N_AVG_SIZE)=BBSTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BBSTC_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     BBSTC_AVG(IWV_AVG)=BBSTC_AVG(IWV_AVG)/ILS_INT_CONST
     IF(BSTC_AVG(IWV_AVG)>0.0d0) THEN
        BBSTCfrac_AVG(IWV_AVG)=BBSTC_AVG(IWV_AVG)/BSTC_AVG(IWV_AVG)
     ELSE
		BBSTCfrac_AVG(IWV_AVG)=0.0d0
     ENDIF

     ZU(1:N_AVG_SIZE)=ASTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     ASTC_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     ASTC_AVG(IWV_AVG)=ASTC_AVG(IWV_AVG)/ILS_INT_CONST

     ZU(1:N_AVG_SIZE)=ACDM(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     ACDM_AVG(IWV_AVG)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     ACDM_AVG(IWV_AVG)=ACDM_AVG(IWV_AVG)/ILS_INT_CONST

     TAU_TG_AVG(IWV_AVG,:)=TAU_TG_AVG(IWV_AVG,:)/ILS_INT_CONST
     TAU_TG_AVG(IWV_AVG,:)=-LOG(TAU_TG_AVG(IWV_AVG,:))

 	 TAU_TG_H2O_AVG(IWV_AVG,:)=TAU_TG_H2O_AVG(IWV_AVG,:)/ILS_INT_CONST
 	 TAU_TG_H2O_AVG(IWV_AVG,:)=-LOG(TAU_TG_H2O_AVG(IWV_AVG,:))

 	 TAU_TG_CO2_AVG(IWV_AVG,:)=TAU_TG_CO2_AVG(IWV_AVG,:)/ILS_INT_CONST
 	 TAU_TG_CO2_AVG(IWV_AVG,:)=-LOG(TAU_TG_CO2_AVG(IWV_AVG,:))

 	 TAU_TG_CH4_AVG(IWV_AVG,:)=TAU_TG_CH4_AVG(IWV_AVG,:)/ILS_INT_CONST
 	 TAU_TG_CH4_AVG(IWV_AVG,:)=-LOG(TAU_TG_CH4_AVG(IWV_AVG,:))

	 TAU_TG_O2_AVG(IWV_AVG,:)=TAU_TG_O2_AVG(IWV_AVG,:)/ILS_INT_CONST
	 TAU_TG_O2_AVG(IWV_AVG,:)=-LOG(TAU_TG_O2_AVG(IWV_AVG,:))

	 TAU_TG_O3_AVG(IWV_AVG,:)=TAU_TG_O3_AVG(IWV_AVG,:)/ILS_INT_CONST
	 TAU_TG_O3_AVG(IWV_AVG,:)=-LOG(TAU_TG_O3_AVG(IWV_AVG,:))

	 TAU_TG_NO2_AVG(IWV_AVG,:)=TAU_TG_NO2_AVG(IWV_AVG,:)/ILS_INT_CONST
	 TAU_TG_NO2_AVG(IWV_AVG,:)=-LOG(TAU_TG_NO2_AVG(IWV_AVG,:))


     DIRADFULL_AVG(:,IWV_AVG,:)=DIRADFULL_AVG(:,IWV_AVG,:)/ILS_INT_CONST
     DSTOKESFULL_AVG(:,IWV_AVG,:,:,:)=DSTOKESFULL_AVG(:,IWV_AVG,:,:,:) &
                                      /ILS_INT_CONST
     DEALLOCATE(XU,YU,ZU)
  ENDDO

ELSE
	NWV_START=1
	NWV_END=NWV
    NWV_OUTPUT=NWV_END-NWV_START+1

ENDIF
DEALLOCATE(TempU)

IMIE=1

CALL h5open_f(hdferr)
CALL h5fcreate_f(CFILE1, H5F_ACC_TRUNC_F, file, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'MU_SOLAR', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=MU_IN
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OZONE_COLUMN_DobsonUnit', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=OZONE_COLUMN
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'H2O_COLUMN_Centimeter', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=H2O_COLUMN
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Pressure_Surface_mb', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=PRESSURE_SURFACE/100.0d0
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_BAND /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WaveLength_PACE', H5T_IEEE_F32LE, space, dset, hdferr)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR=WV_BAND
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
DEALLOCATE(HDF5RARR)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_OUTPUT /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WaveLength_Simulation', H5T_IEEE_F32LE, space, dset, hdferr)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR(1:NWV_OUTPUT)=WV_BAND(NWV_START:NWV_END)
ELSE
  HDF5RARR(1:NWV_OUTPUT)=WV(NWV_START:NWV_END)
ENDIF
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
DEALLOCATE(HDF5RARR)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Rf', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF1_Save(IMIE)+1.0)
HDF5RTMP=REFF1_Save(IMIE)*EXP(-2.5*RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Vf', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF1_Save(IMIE)+1.0)
HDF5RTMP=SQRT(RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Rc', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF2_Save(IMIE)+1.0)
HDF5RTMP=REFF2_Save(IMIE)*EXP(-2.5*RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Vc', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF2_Save(IMIE)+1.0)
HDF5RTMP=SQRT(RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRR1_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mrf', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRI1_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mif', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRR2_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mrc', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRI2_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mic', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dims= (/NWV_BAND,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_BAND,NTLYERA ))
HDF5RARR2DIM=TAU_ARSL_Ext_AVG(1:NWV_BAND,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Aerosol_Extinction', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_BAND,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_BAND,NTLYERA ))
HDF5RARR2DIM=TAU_ARSL_Scat_AVG(1:NWV_BAND,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Aerosol_Scattering', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)


dims= (/NWV_BAND,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_BAND,NTLYERA ))
HDF5RARR2DIM=TAU_RAY_AVG(1:NWV_BAND,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Rayleigh_Extinction', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_BAND,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_BAND,NTLYERA ))
HDF5RARR2DIM=DEPOL_A_AVG(1:NWV_BAND,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Rayleigh_Depolization_Ratio', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Gas_Absorption_Total', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_H2O_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_H2O_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_H2O_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_CO2_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_CO2_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_CO2_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_CH4_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_CH4_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_CH4_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)


dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_O2_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_O2_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_O2_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)


dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_O3_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_O3_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_O3_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_NO2_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_NO2_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_NO2_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dimscl=(/ NTLYERA+1 /)
ALLOCATE(HDF5RARR(NTLYERA+1 ))
HDF5RARR=ALT_LYRA(1:NTLYERA+1)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Atmosphere_Layer_Altitudes', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
ALLOCATE(HDF5RARR(1 ))
HDF5RARR=AirSensor_Height
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'AirSensor_Height', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
ALLOCATE(HDF5RARR(1 ))
HDF5RARR=ARSLND1_Save
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Number_Density_FineMode', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

ALLOCATE(HDF5RARR(1))
HDF5RARR=ARSLND2_Save
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Number_Density_CoarseMode', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=AW_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=AW(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'aw_Ocean_Water_Absorption_Coefficient', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BW_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BW(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bw_Ocean_Water_Scattering_Coefficient', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=RINDX_WATER_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=RINDX_WATER(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Refractive_Index_Ocean_Water', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=APTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=APTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ap_Phytoplankton_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BPTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BPTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bp_Phytoplankton_Scattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BBPTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BBPTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bbp_Phytoplankton_Backscattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BBPTCfrac_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BBPTCfrac(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Bbp_Phytoplankton_Backscattering_fraction_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BSTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BSTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bp_SEDIMENT_Scattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BBSTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BBSTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bbp_SEDIMENT_Backscattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BBSTCfrac_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BBSTCfrac(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Bbp_SEDIMENT_Backscattering_fraction_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=ASTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=ASTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ap_SEDIMENT_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=ACDM_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=ACDM(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ay_CDOM_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'DEPOL90_KOK', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=Dpol90_Kok
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ABSORPTION_OPTICAL_DEPTH_REDUCTION_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_CASE_SELECT', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5ITMP=OCEAN_CASE_SELECT
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WAVEBAND_SEG_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5ITMP=WV_SEG_FLAG
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ATMOS_ZERO', H5T_IEEE_F32LE, space, dset, hdferr)
IF(ATMOS_ZERO)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'SUN_GLINT_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(SUNGLINT_INPUT)THEN
  HDF5ITMP=0
ELSE
  HDF5ITMP=1
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'NonPhotochemicalQuenching_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(NPQ_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_FCHLA_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_FCHLA_FLAG)THEN
HDF5ITMP=1
ELSE
HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_FCDOM_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_FCDOM_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_RAMAN_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_RAMAN_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)


dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'MONOCHROMATIC_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(MONOCHROMATIC_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_PHMX_ONE', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_PHMX_ONE)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'CHLA_HOMOGENEITY', H5T_IEEE_F32LE, space, dset, hdferr)
IF(CHLA_HOMOGENEITY)THEN
HDF5ITMP=1
ELSE
HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
HDF5RARR=WATER_DEPTH(1:NWATER_DEPTH)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WATER_DEPTH_LEVELS', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
IF(OCEAN_FCHLA_FLAG)THEN
   HDF5RARR=IPAR_SCALAR(1:NWATER_DEPTH)
ELSE
   HDF5RARR=-999
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'IPAR_SCALAR', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG)THEN
    dimscl=(/ NFLRSCGRID /)
    ALLOCATE(HDF5RARR(NFLRSCGRID))
    HDF5RARR=LAMBDAEXFLRSC
    CALL h5screate_simple_f(1, dimscl, space, hdferr)
    CALL h5dcreate_f(file, 'WAVELENGTH_EX_GRID', H5T_IEEE_F32LE, space, dset, hdferr)
    CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
    CALL h5dclose_f(dset , hdferr)
    CALL h5sclose_f(space, hdferr)
    DEALLOCATE(HDF5RARR)
ENDIF

IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG)THEN
    dims= (/NFLRSCGRID,NWATER_DEPTH /)
    ALLOCATE(HDF5RARR2DIM(NFLRSCGRID,NWATER_DEPTH))
    HDF5RARR2DIM=DIIRAD_SCALAR_AGD
    CALL h5screate_simple_f(2, dims, space, hdferr)
    CALL h5dcreate_f(file, 'DIIRAD_SCALAR_Ex', H5T_IEEE_F32LE, space, dset, hdferr)
    CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
    CALL h5dclose_f(dset , hdferr)
    CALL h5sclose_f(space, hdferr)
    DEALLOCATE(HDF5RARR2DIM)
ENDIF

dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
IF(OCEAN_FCHLA_FLAG)THEN
   HDF5RARR=QUANTUM_YIELD_CHLA_PROFILE(1:NWATER_DEPTH)
ELSE
   HDF5RARR=-999
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_PROFILE', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
HDF5RARR=CHLA_VERTICAL_PROFILE(1:NWATER_DEPTH)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'CHLA_VERTICAL_PROFILE', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_MIN', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_MIN
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_MAX', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_MAX
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_EK', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_EK
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_ET', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_ET
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_MLD', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_MLD
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_QI', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_QI
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)


dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(1,NWV_START:NWV_END,1)
ELSE
  HDF5RARR=DIRADFULL(1,NWV_START:NWV_END,1)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOA_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(1,NWV_START:NWV_END,2)
ELSE
  HDF5RARR=DIRADFULL(1,NWV_START:NWV_END,2)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOA_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(2,NWV_START:NWV_END,1)
ELSE
  HDF5RARR=DIRADFULL(2,NWV_START:NWV_END,1)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_AirSensor_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(2,NWV_START:NWV_END,2)
ELSE
  HDF5RARR=DIRADFULL(2,NWV_START:NWV_END,2)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_AirSensor_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(3,NWV_START:NWV_END,1)
ELSE
  HDF5RARR=DIRADFULL(3,NWV_START:NWV_END,1)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_BOA_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(3,NWV_START:NWV_END,2)
ELSE
  HDF5RARR=DIRADFULL(3,NWV_START:NWV_END,2)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_BOA_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(4,NWV_START:NWV_END,1)
ELSE
  HDF5RARR=DIRADFULL(4,NWV_START:NWV_END,1)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOO_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(4,NWV_START:NWV_END,2)
ELSE
  HDF5RARR=DIRADFULL(4,NWV_START:NWV_END,2)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOO_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NTHETAOUT /)
ALLOCATE(HDF5RARR(NTHETAOUT))
HDF5RARR=ACOS(MUOUT)/PI*180.D0
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ThetaV', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NPHIOUT /)
ALLOCATE(HDF5RARR(NPHIOUT))
HDF5RARR=PHIOUT*180.0d0/PI
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'PhiV', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
IF(ILS_FLAG)THEN
  HDF5RARR4DIM=DSTOKESFULL_AVG(1,NWV_START:NWV_END,:,:,:)
ELSE
  HDF5RARR4DIM=DSTOKESFULL(1,NWV_START:NWV_END,:,:,:)
ENDIF
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_TOA', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
IF(ILS_FLAG)THEN
  HDF5RARR4DIM=DSTOKESFULL_AVG(2,NWV_START:NWV_END,:,:,:)
ELSE
  HDF5RARR4DIM=DSTOKESFULL(2,NWV_START:NWV_END,:,:,:)
ENDIF
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_AirSensor', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
IF(ILS_FLAG)THEN
  HDF5RARR4DIM=DSTOKESFULL_AVG(3,NWV_START:NWV_END,:,:,:)
ELSE
  HDF5RARR4DIM=DSTOKESFULL(3,NWV_START:NWV_END,:,:,:)
ENDIF
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_BOA', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
IF(ILS_FLAG)THEN
  HDF5RARR4DIM=DSTOKESFULL_AVG(4,NWV_START:NWV_END,:,:,:)
ELSE
  HDF5RARR4DIM=DSTOKESFULL(4,NWV_START:NWV_END,:,:,:)
ENDIF
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_TOO', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)


CALL h5fclose_f(file , hdferr)
CALL h5close_f(hdferr)

RETURN

END SUBROUTINE  STOKESOUT


SUBROUTINE MUPHIOUTASS(NTHETAOUT,NPHIOUT,MUOUT,PHIOUT)
INTEGER :: NTHETAOUT,NPHIOUT
REAL*8,DIMENSION(NTHETAOUT) :: MUOUT
REAL*8,DIMENSION(NPHIOUT) :: PHIOUT
REAL*8,DIMENSION(:),ALLOCATABLE ::THETAOUT_FREE
INTEGER :: IANG
REAL*8 RTMP
ALLOCATE(THETAOUT_FREE(NTHETAOUT))

RTMP=180.0D0/(1.0D0*NTHETAOUT)
DO IANG=1,NTHETAOUT/2
  THETAOUT_FREE(IANG)=(IANG-1)*RTMP
  THETAOUT_FREE(NTHETAOUT-IANG+1)=180.0D0-THETAOUT_FREE(IANG)
ENDDO

RTMP=180.0d0/(NPHIOUT-1.0d0)
DO IANG=1,NPHIOUT
   PHIOUT(IANG)=(IANG-1)*RTMP
ENDDO

MUOUT=COS(THETAOUT_FREE/180.0d0*3.141592653589793d0)
PHIOUT=PHIOUT*3.141592653589793d0/180.0D0

DEALLOCATE(THETAOUT_FREE)

ENDSUBROUTINE MUPHIOUTASS


INTEGER FUNCTION INDEX_PRIME_SCATTERING(NTLYERA,TAUR,PNDLY,WAVELENGTH_NANOMETER)
USE MIE_PHMX_PACE, ONLY : CSCAT_ARSL_BAND
USE GLOBAL_DATA, ONLY : CEXT_REF,TAU550
USE PACE_INSTRUMENT_DESIGN, ONLY : WV_BAND
IMPLICIT NONE

INTEGER,INTENT(IN) :: NTLYERA
REAL*8,DIMENSION(NTLYERA),INTENT(IN) :: TAUR,PNDLY
REAL*8,INTENT(IN) :: WAVELENGTH_NANOMETER

INTEGER :: IWV_BAND,ITLYERA
REAL*8:: TAU_SCAT_TOTAL
REAL*8,DIMENSION(:),ALLOCATABLE :: TAULYR
REAL*8 :: TAUTMP,TAU_UPPER_LIM
INTEGER,DIMENSION(1) ::LOCINDXTMP

LOCINDXTMP =MINLOC(ABS(WAVELENGTH_NANOMETER-WV_BAND))
IWV_BAND=LOCINDXTMP(1)

ALLOCATE(TAULYR(NTLYERA))

DO ITLYERA=1,NTLYERA
  TAULYR(ITLYERA)=PNDLY(ITLYERA)*TAU550*CSCAT_ARSL_BAND(IWV_BAND)/CEXT_REF + &
                    TAUR(ITLYERA)
ENDDO
TAU_SCAT_TOTAL=SUM(TAULYR)

IF(TAU_SCAT_TOTAL > 2.0D0) THEN
  TAU_UPPER_LIM=1.0D0
ELSE
  TAU_UPPER_LIM=0.5D0*TAU_SCAT_TOTAL
ENDIF

TAUTMP=0.0D0
DO ITLYERA=1,NTLYERA
   TAUTMP=TAUTMP+TAULYR(ITLYERA)
   IF(TAUTMP>=TAU_UPPER_LIM) EXIT
ENDDO
INDEX_PRIME_SCATTERING=ITLYERA
!WRITE(*,*)'INDEX_PRIME_SCATTERING INFO',INDEX_PRIME_SCATTERING,TAUTMP,NTLYERA,TAU_SCAT_TOTAL
DEALLOCATE(TAULYR)
END FUNCTION INDEX_PRIME_SCATTERING


SUBROUTINE RTSOSINIT(Indx_Inelastic_Scattering,IWVSAVE,WAVELENGTH_MICRON,&
       NREC,NTLYERA,NTLYERO,PNDLY,TAUR,DEPOL_A,TAU_TG,RECDATASTREAM,NTLYER,NUMMIEUSE,NUMMIERT,  &
       MAXLORDINPUT,NUMMIEANGINPUT,PHMXDATASTREAM,LBDO_LD,FLAM,TEMPERTURE,SALINITY)

USE GLOBAL_DATA
USE SAVE_OCEAN_MOD
USE RTUTILITY, ONLY : NUMMIEANGMAX,PI
USE PACE_INSTRUMENT_DESIGN,ONLY : NWV_BAND,WV_BAND
USE MIE_PHMX_PACE, ONLY : NUM_SCAT_ANG,CEXT_ARSL_BAND,CSCAT_ARSL_BAND,&
                          PHMXMIE_ARSL_PACE,REFF_MINERAL,AREA_MINERAL,&
                          CSCAT_Mineral_BAND,PHMXMIE_Plankton_PACE,PHMXMIE_Mineral_PACE
IMPLICIT none

INTEGER,INTENT(IN) :: Indx_Inelastic_Scattering,IWVSAVE,NREC,NTLYER,&
                      NUMMIEUSE,NUMMIERT,MAXLORDINPUT,NTLYERA,NTLYERO
REAL*8,INTENT(IN)::WAVELENGTH_MICRON

REAL*8,DIMENSION(NTLYERA),INTENT(IN) :: TAUR,DEPOL_A,TAU_TG,PNDLY

INTEGER,DIMENSION(NUMMIERT),INTENT(OUT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6),INTENT(OUT) ::PHMXDATASTREAM

REAL*8,DIMENSION(NREC,7),INTENT(OUT) :: RECDATASTREAM

REAL*8,INTENT(INOUT):: LBDO_LD,FLAM,TEMPERTURE,SALINITY

REAL*8 :: WAVELENGTH_NANOMETER,CHLaLOCAL,AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,&
      BBPTCLOCAL,BBPTCfracLOCAL,APTCLOCAL,BSTCLOCAL,BSTC665LOCAL,BBSTCLOCAL,BBSTCfracLOCAL,&
      ASTCLOCAL,ASTC443LOCAL,ACDMLOCAL,RINDX_WATERLOCAL,TAURfracLOCAL,SEDIMENT_DENSITY

REAL*8,DIMENSION(:),ALLOCATABLE :: TAURfrac,TAULYR,LBDOLYR

!TAURfrac(ILAYER), RAYLEIGH SCATTERING FRACTION
!TAULYR(ILAYER): TOTAL OPTICAL DEPTH  AT WAVLENTGH WV(IWV) AT LAYER(ILAYER) 
!LBDOLYR(ILAYER): EFFECTIVE SINGLE SCATTERING ALBEDO

REAL*8:: BLANK
INTEGER ::INDXDETECTOR,INDXLAMB,INDXOCEAN,INDXOCEAN1

INTEGER :: IMIE, NANGMIE_LOCAL,IANG
INTEGER,DIMENSION(1) ::LOCINDXTMP

!integer time_array_0(8), time_array_1(8)
!real start_time, finish_time
      
INTEGER :: ITLYERA,ITLYER,IREC_SHFT,ITLYERW,IWV_BAND
REAL*8 :: RTMP,RTMP1,RTMP2,AEROSOL_ABSORB_FAC,AEROSOL_ALBEDO,OCEAN_ALBEDO, &
        ABSORPTION_TAU,SCATTERING_TAU,ABSORPTION_TAU_CUMMU,ABSORPTION_TAU_CUTOFF,&
        finemoderatio,LAYER_DEPTH_TMP,OCEAN_TAU_TMP,CSCAT_MINERAL,ExtX_AEROSOL,ScatX_AEROSOL

LOGICAL :: EMISSION_FLAG

REAL*8 :: POLINT_SIMPLE

WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0d0
LOCINDXTMP =MINLOC(ABS(WAVELENGTH_NANOMETER-WV_BAND))
IWV_BAND=LOCINDXTMP(1)

IF(WAVELENGTH_NANOMETER<890D0)THEN
	ExtX_AEROSOL=POLINT_SIMPLE(NWV_BAND,WV_BAND,CEXT_ARSL_BAND,WAVELENGTH_NANOMETER,3)
	ScatX_AEROSOL=POLINT_SIMPLE(NWV_BAND,WV_BAND,CSCAT_ARSL_BAND,WAVELENGTH_NANOMETER,3)
ELSE
	ExtX_AEROSOL=CEXT_ARSL_BAND(IWV_BAND)
	ScatX_AEROSOL=CSCAT_ARSL_BAND(IWV_BAND)
ENDIF

! SYSTEM PARAMETER DEFINITIONS
BLANK=0.0
INDXDETECTOR=-1000
INDXLAMB=-200
INDXOCEAN=-100
INDXOCEAN1=-101
ABSORPTION_TAU_CUTOFF=10.0D0
ABSORPTION_TAU_REPLACE=0.1D0

! SYSTEM PARAMETER DEFINITION OVER

RECDATASTREAM=BLANK
PHMXDATASTREAM=0.0D0

IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  TAU_REDUCE_OCEAN_PRESERVE=0.0D0
  TAU_REDUCE_ATMOS_PRESERVE=0.0D0
ENDIF

ALLOCATE(TAURfrac(NTLYERA),TAULYR(NTLYERA),LBDOLYR(NTLYERA))

AEROSOL_ALBEDO=ScatX_AEROSOL/ExtX_AEROSOL
IF(AEROSOL_ALBEDO>1.0D0)THEN
    WRITE(*,*)'CHECK, AEROSOL_ALBEDO=',AEROSOL_ALBEDO
    AEROSOL_ALBEDO=1.0D0
ENDIF

IF(AEROSOL_ALBEDO<0.0D0)THEN
    WRITE(*,*)'CHECK, AEROSOL_ALBEDO=',AEROSOL_ALBEDO
    AEROSOL_ALBEDO=0.0D0
ENDIF
AEROSOL_ABSORB_FAC=1.0D0-AEROSOL_ALBEDO

!IF(AEROSOL_ABSORB_FAC<0.0D0 .or. AEROSOL_ABSORB_FAC>1.0D0)THEN
!   WRITE(*,*)'AEROSOL_ABSORB_FAC=',AEROSOL_ABSORB_FAC
!   STOP 'CHECK AEROSOL_ABSORB_FAC'
!ENDIF
! BELOW THIS LINE I HAVE ASSUMED ONE MIE FOR ALL LAYERS
! OTHERWISE NEED TO DO APPROPERIATE CHANGES !!!!!!!!!!!!!!!!

ABSORPTION_TAU_CUMMU=0.0D0

!DETECTOR AT THE TOA
RECDATASTREAM(1,1)=INDXDETECTOR
NUMMIEANGINPUT=NUM_SCAT_ANG(1)

IREC_SHFT=1
IMIE=1
DO ITLYERA=1,NTLYERA
   TAULYR(ITLYERA)=PNDLY(ITLYERA)*TAU550*ExtX_AEROSOL/CEXT_REF
   IF(TAULYR(ITLYERA)<1.0D-6)THEN
      RECDATASTREAM(ITLYERA+IREC_SHFT,1)=1
   ELSE
      RECDATASTREAM(ITLYERA+IREC_SHFT,1)=ITLYERA
   ENDIF
! total optical depth=aerosol+rayleigh+gas absorption
   ABSORPTION_TAU=TAU_TG(ITLYERA)+TAULYR(ITLYERA)*AEROSOL_ABSORB_FAC
   SCATTERING_TAU=TAUR(ITLYERA)+TAULYR(ITLYERA)*AEROSOL_ALBEDO

   TAULYR(ITLYERA)=SCATTERING_TAU+ABSORPTION_TAU
   LBDOLYR(ITLYERA)=SCATTERING_TAU/TAULYR(ITLYERA)
   TAURfrac(ITLYERA)=TAUR(ITLYERA)/SCATTERING_TAU

   RECDATASTREAM(ITLYERA+IREC_SHFT,2)=TAULYR(ITLYERA)


  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    IF(ABSORPTION_TAU_CUMMU >= ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(ITLYERA+IREC_SHFT,2)=ABSORPTION_TAU_REPLACE
       TAU_REDUCE_ATMOS_PRESERVE(ITLYERA+1)=ABSORPTION_TAU - &
                             ABSORPTION_TAU_REPLACE*(1.0D0-LBDOLYR(ITLYERA))
    ELSEIF(ABSORPTION_TAU_CUMMU + ABSORPTION_TAU>ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(ITLYERA+IREC_SHFT,2) = &
              (ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)/(1.0D0-LBDOLYR(ITLYERA))
       IF(RECDATASTREAM(ITLYERA+IREC_SHFT,2)<0.0D0) STOP 'CHECK REDUCE TAU ATMOS I'
       TAU_REDUCE_ATMOS_PRESERVE(ITLYERA+1)= ABSORPTION_TAU - &
                    (ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)
       IF(TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)<0.0D0) THEN
          WRITE(*,*)ABSORPTION_TAU,ABSORPTION_TAU_CUMMU,ABSORPTION_TAU_CUTOFF
          STOP 'CHECK REDUCE TAU ATMOS II'
       ENDIF
    ENDIF
  ENDIF
  ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU + ABSORPTION_TAU

  RECDATASTREAM(ITLYERA+IREC_SHFT,3)= LBDOLYR(ITLYERA)     ! ALBEDOR
  RECDATASTREAM(ITLYERA+IREC_SHFT,4)=WAVELENGTH_MICRON
  RECDATASTREAM(ITLYERA+IREC_SHFT,5)=TEMPERTURE
  RECDATASTREAM(ITLYERA+IREC_SHFT,6)=0
  RECDATASTREAM(ITLYERA+IREC_SHFT,7)= ALT_LYRA(ITLYERA)

  NUMMIEANGINPUT(ITLYERA)=NUM_SCAT_ANG(1)
  PHMXDATASTREAM(ITLYERA,1:NUMMIEANGMAX,0)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,0)

  IF(RECDATASTREAM(ITLYERA+IREC_SHFT,1)==1 .OR. abs(1.0d0-TAURfrac(ITLYERA))<1.0e-8)THEN
    CALL RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,ITLYERA,DEPOL_A(ITLYERA))
  ELSE
    PHMXDATASTREAM(ITLYERA,1:NUMMIEANGMAX,1:6)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,1:6)
    CALL PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYERA,TAURfrac(ITLYERA),DEPOL_A(ITLYERA))
  ENDIF
  IF(ABS(AirSensor_Height-ALT_LYRA(ITLYERA+1))<1.0E-6)THEN
      IREC_SHFT=2
!DETECTOR AT THE AIRPLANE LEVEL
      RECDATASTREAM(ITLYERA+IREC_SHFT,1)=INDXDETECTOR
  ENDIF

ENDDO ! LAYER LOOP
IREC_SHFT=3

CALL WATER_REFRACTIVE_INDEX(WAVELENGTH_NANOMETER,TEMPERTURE,SALINITY,RINDX_WATERLOCAL)

! detector just above ocean surface
    RECDATASTREAM(NTLYERA+IREC_SHFT,1)=INDXDETECTOR
    RECDATASTREAM(NTLYERA+IREC_SHFT,2)=BLANK
    RECDATASTREAM(NTLYERA+IREC_SHFT,3)=BLANK
! OCEAN INTERFACE
    IREC_SHFT=4
    RECDATASTREAM(NTLYERA+IREC_SHFT,1)=INDXOCEAN
    RECDATASTREAM(NTLYERA+IREC_SHFT,2)=WNDSPD
    RECDATASTREAM(NTLYERA+IREC_SHFT,3)=RINDX_WATERLOCAL

	IF(SUNGLINT_INPUT)THEN
		RECDATASTREAM(NTLYERA+IREC_SHFT,5)=0
    ELSE
        RECDATASTREAM(NTLYERA+IREC_SHFT,5)=1
    ENDIF
! Dectector just below OCEAN INTERFACE
IREC_SHFT=5
RECDATASTREAM(NTLYERA+IREC_SHFT,1)=INDXDETECTOR
RECDATASTREAM(NTLYERA+IREC_SHFT,2)=BLANK
RECDATASTREAM(NTLYERA+IREC_SHFT,3)=BLANK
DEALLOCATE(TAURfrac,TAULYR,LBDOLYR)

EMISSION_FLAG=(Indx_Inelastic_Scattering == 0) .OR. &
              (Indx_Inelastic_Scattering == 2) .OR. &
              (Indx_Inelastic_Scattering == 4) .OR. &
              (Indx_Inelastic_Scattering == 5)
! hydrosol LAYERS
IF(Indx_Inelastic_Scattering>0)TAU_INELASTIC_AGD=0.0d0
IF(OCEAN_CASE_SELECT==0) ABSORPTION_TAU_REPLACE=1.0D-12

IF(OCEAN_CASE_SELECT .NE. 2)THEN
  ASTCLOCAL=0.0d0
  BSTCLOCAL=0.0d0
  BBSTCfracLOCAL=0.0d0
ENDIF

!LOOP_LAYERS: DO ITLYERW=1,NWATER_DEPTH
LOOP_LAYERS: DO ITLYERW=1,NTLYERO+1
  CALL CHLAPROFILE(WATER_DEPTH(ITLYERW),CHLa,CHLaLOCAL)
  CHLA_VERTICAL_PROFILE(ITLYERW)=CHLaLOCAL
  CALL HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLaLOCAL,TEMPERTURE,SALINITY,   &
               AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL, &
               BBPTCfracLOCAL,APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)

  IF(OCEAN_CASE_SELECT==2 .AND. ITLYERW==1)THEN
      CALL NAP_PARA_INIT(WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION, &
                         SEDIMENT_SPECTRAL_SLOPE,ASTCLOCAL,BSTCLOCAL,BBSTCfracLOCAL)
  ENDIF

  RTMP= BWLOCAL + BPTCLOCAL
  RTMP1=AWLOCAL + APTCLOCAL + ACDMLOCAL

  IF(OCEAN_CASE_SELECT==2)THEN
    RTMP= RTMP+BSTCLOCAL
    RTMP1=RTMP1+ASTCLOCAL
  ENDIF

  RTMP2=0.5D0*BWLOCAL+BBPTCLOCAL+ BSTCLOCAL*BBSTCfracLOCAL
  LBDO_LD=0.33d0*RTMP2/(RTMP2+RTMP1)

  IF(ITLYERW==NWATER_DEPTH) THEN

    IF(Indx_Inelastic_Scattering>0)THEN
        EXT_COEFF_INELASTIC_EM(ITLYERW)=RTMP+RTMP1
        IF(Indx_Inelastic_Scattering==3 .or. Indx_Inelastic_Scattering==6) THEN
           ABSORB_COEFF_CDOM_EX(IWVSAVE,ITLYERW)=ACDMLOCAL
           ABSORB_COEFF_CHLA_EX(IWVSAVE,ITLYERW)=APTCLOCAL
        ENDIF
    ENDIF
    EXIT LOOP_LAYERS
  ENDIF

  OCEAN_ALBEDO=RTMP/(RTMP+RTMP1)

  IF(OCEAN_PHMX_ONE) THEN
    RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,1)=NTLYERA+1
  ELSE
    RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,1)=NTLYERA+ITLYERW
  ENDIF

  ABSORPTION_TAU=RTMP1*(WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW))
  LAYER_DEPTH_TMP=WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW)
  RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,2)= LAYER_DEPTH_TMP * (RTMP+RTMP1) ! TAU testing

!write(*,*)'dk wv_micron,depth,chla,BW,AW, OCEAN TAU=', &
!WAVELENGTH_MICRON,WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW),CHLaLOCAL,RTMP,RTMP1,&
!RECDATASTREAM(NTLYERA+4+ITLYERW,2)

  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    IF(ABSORPTION_TAU_CUMMU >= ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,2)= ABSORPTION_TAU_REPLACE
       LAYER_DEPTH_TMP=ABSORPTION_TAU_REPLACE/(RTMP+RTMP1)
    ELSEIF(ABSORPTION_TAU_CUMMU+ABSORPTION_TAU>ABSORPTION_TAU_CUTOFF)THEN
       LAYER_DEPTH_TMP=(ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)/RTMP1
       IF(LAYER_DEPTH_TMP<0.0D0)STOP 'WARNING, CHECK LAYER_DEPTH_TMP'
       RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,2)= LAYER_DEPTH_TMP * (RTMP+RTMP1) ! TAU testing
    ENDIF
    OCEAN_TAU_TMP=(WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW)-LAYER_DEPTH_TMP)*RTMP1
    IF(OCEAN_TAU_TMP<0.0D0)THEN
         WRITE(*,*)ABSORPTION_TAU_CUMMU,ABSORPTION_TAU,ABSORPTION_TAU_CUTOFF,RTMP1
         WRITE(*,*)WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW),LAYER_DEPTH_TMP,RTMP1,OCEAN_TAU_TMP
         STOP 'MAIN_PACE_Simulator.F90 CHECK OCEAN_TAU_TMP'
    ENDIF
    IF(ITLYERW<=NTLYERO) &
    TAU_REDUCE_OCEAN_PRESERVE(ITLYERW+1)=TAU_REDUCE_OCEAN_PRESERVE(ITLYERW) &
                                        +OCEAN_TAU_TMP
  ENDIF
  ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+RTMP1* &
                       (WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW))

  IF(OCEAN_CASE_SELECT==0)THEN
    RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,3)=0.0D0           ! ALBEDOO
  ELSE
    RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,3)=RTMP/(RTMP+RTMP1)           ! ALBEDOO
  ENDIF
  RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,4)=WAVELENGTH_MICRON
  RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,5)=TEMPERTURE
  RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,6)=Indx_Inelastic_Scattering

  IF(Indx_Inelastic_Scattering>0) THEN
     EXT_COEFF_INELASTIC_EM(ITLYERW)=RTMP+RTMP1
     TAU_INELASTIC_AGD(ITLYERW+1)=TAU_INELASTIC_AGD(ITLYERW) &
                                    + RECDATASTREAM(NTLYERA+NDET+1+ITLYERW,2)

     SCATT_COEFF_RAMAN_EX=BWRAMANLOCAL
  ENDIF

  IF(Indx_Inelastic_Scattering==3 .or. Indx_Inelastic_Scattering==6) THEN
    ABSORB_COEFF_CDOM_EX(IWVSAVE,ITLYERW)=ACDMLOCAL
    ABSORB_COEFF_CHLA_EX(IWVSAVE,ITLYERW)=APTCLOCAL
  ENDIF

  IF(OCEAN_PHMX_ONE .AND. ITLYERW>1)CYCLE
  IF(OCEAN_CASE_SELECT==0)THEN
     NUMMIEANGINPUT(NTLYERA+1)=NUM_SCAT_ANG(1)
     PHMXDATASTREAM(NTLYERA+1,1:NUMMIEANGMAX,0)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,0)

     CALL RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,NTLYERA+1,DEPOL_O)
  ELSEIF(OCEAN_CASE_SELECT==1 .or. OCEAN_CASE_SELECT==3)THEN
     NUMMIEANGINPUT(NTLYERA+ITLYERW)=NUM_SCAT_ANG(1)
     PHMXDATASTREAM(NTLYERA+ITLYERW,1:NUMMIEANGMAX,0)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,0)
     CALL HYDRSL_PHMX_ASSIGN(CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL,NTLYERA,&
            NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,ITLYERW,PHMXDATASTREAM)
  ELSE
     PHMXDATASTREAM(NTLYERA+ITLYERW,1:NUMMIEANGMAX,0)=PHMXMIE_Plankton_PACE(IWV_BAND,1:NUMMIEANGMAX,0)
     finemoderatio=BPTCLOCAL/(BPTCLOCAL+BSTCLOCAL)
     PHMXDATASTREAM(NTLYERA+ITLYERW,1:NUMMIEANGMAX,1:6)=&
                   (1.0d0-finemoderatio)*PHMXMIE_Mineral_PACE(IWV_BAND,1:NUMMIEANGMAX,1:6)&
                         +finemoderatio *PHMXMIE_Plankton_PACE(IWV_BAND,1:NUMMIEANGMAX,1:6)
     TAURfracLOCAL=BWLOCAL/(BPTCLOCAL+BSTCLOCAL+BWLOCAL)
     ITLYER=NTLYERA+ITLYERW
     NUMMIEANGINPUT(ITLYER)=NUM_SCAT_ANG(2)
     CALL PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYER,TAURfracLOCAL,DEPOL_O)
  ENDIF
ENDDO LOOP_LAYERS

IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  ABSORPTION_TAU_CUMMU=0.0D0
  DO ITLYERA =1,NTLYERA+1
    ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)
    TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)=ABSORPTION_TAU_CUMMU
  ENDDO

  DO ITLYERW=1,NTLYERO+1
    ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)
    TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)=ABSORPTION_TAU_CUMMU
!     write(*,*)'tsp_TAU_INELASTIC_AGD',WATER_DEPTH(ITLYERW),&
!                            TAU_INELASTIC_AGD(ITLYERW),&
!                            TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)
  ENDDO
ENDIF

IF(OCEAN_CASE_SELECT==0) LBDO_LD=0.0d0
IF(DIFFUSE_TRANSMITTANCE)LBDO_LD=1.0d0
! BOTTOM LAYERS
RECDATASTREAM(NTLYERA+NDET+2+NTLYERO,1)=INDXLAMB
RECDATASTREAM(NTLYERA+NDET+2+NTLYERO,2)=LBDO_LD
RECDATASTREAM(NTLYERA+NDET+2+NTLYERO,3)=FLAM
RECDATASTREAM(NTLYERA+NDET+2+NTLYERO,4)=NMBREINPUT
RECDATASTREAM(NTLYERA+NDET+2+NTLYERO,5)=NMBIMINPUT

END SUBROUTINE RTSOSINIT

SUBROUTINE TAURCAL(WAVELENGTH_MICRON,NTLYERA,TAUR,DEPOL_A)
USE GLOBAL_DATA, ONLY : ATMOS_ZERO,ALT_LYRA
USE RTUTILITY, ONLY : PI
USE Atmosphere_Profile, ONLY : NPGRID,P_GRID,Z_FIELD,TEM_FIELD,  &
			NUMDEN_TOTAL_FIELD,VMR_OZONE_FIELD,VMR_OXYGEN_FIELD,     &
			VMR_H2O_FIELD,VMR_CO2_FIELD,VMR_NO2_FIELD,VMR_CH4_FIELD

IMPLICIT NONE
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON
INTEGER,INTENT(IN) ::NTLYERA
!REAL*8,DIMENSION(1:NTLYERA+1),INTENT(IN) ::ALT_LYRA
REAL*8,DIMENSION(NTLYERA),INTENT(OUT) :: TAUR,DEPOL_A

REAL*8,DIMENSION(:),ALLOCATABLE :: TAUR_GRID,TAUR_CUMSUM,DEPOL_GRID

REAL*8, PARAMETER :: C1=400.,C2=450.   !unit ppmv
REAL*8, PARAMETER :: nas_coeff1=5792105D0, nas_coeff2=238.0185D0, &
                     nas_coeff3=167917D0,nas_coeff4=57.362D0
REAL*8, PARAMETER :: nws_coeff0=1.022D0,nws_coeff1=295.235D0,     &
		nws_coeff2=2.6422D0,nws_coeff3=-0.032380D0,nws_coeff4=0.004028D0
REAL*8, PARAMETER :: Mw=0.018015         !unit kg/mol
REAL*8, PARAMETER :: R_Universal=8.31451 !unit: J/mol/K
REAL*8, PARAMETER :: AvogadroNumber=6.022E23
REAL*8 :: n_asn1e8,n_asn1,nwsn1e8,nwsn1,rho_ws
REAL*8, DIMENSION(:),ALLOCATABLE :: naxsn1,Ma_profile,Z_func

REAL*8, PARAMETER :: Z_func_a0=1.58123e-6,Z_func_a1=-2.9331e-8,      &
        Z_func_a2=1.1043e-10,Z_func_b0=5.707e-6,Z_func_b1=-2.051e-8, &
        Z_func_c0=1.9898e-4,Z_func_c1=-2.376e-6,                     &
        Z_func_d0=1.83e-11,Z_func_d1=-7.65e-9

REAL*8, PARAMETER :: pressure_standard=101325.,temperature_standard=288.15 ! Kelvin
REAL*8, DIMENSION(:),ALLOCATABLE :: water_mole_number,water_vapor_partial_pressure, &
                                    rho_axs,rho_a,rho_w,rho_w_ratio,rho_a_ratio,    &
                                    n_refractive_index,King_Factor
REAL*8 :: F1_N2,F2_O2,F3_Ar,F4_CO2,F5_H2O

INTEGER:: ILYERA,IHEIGHT
REAL*8 :: RAY_SCALE_HEIGHT_SUB,RTMP
REAL*8,DIMENSION(:),ALLOCATABLE :: MOLEXT

REAL*8 :: POLINT_SIMPLE

IF(ATMOS_ZERO)THEN
    TAUR=1.0D-12
    DEPOL_A=0.0284d0
	RETURN
ENDIF

ALLOCATE(MOLEXT(NPGRID))
ALLOCATE(TAUR_GRID(NPGRID),TAUR_CUMSUM(NPGRID),DEPOL_GRID(NPGRID))

!INITIALIZE MOLEXT THE EXTINCTION COEFFICIENT
ALLOCATE(naxsn1(NPGRID),Ma_profile(NPGRID),Z_func(NPGRID), &
         water_vapor_partial_pressure(NPGRID),water_mole_number(NPGRID),&
         rho_axs(NPGRID),rho_a(NPGRID),rho_w(NPGRID),rho_w_ratio(NPGRID), &
         rho_a_ratio(NPGRID),n_refractive_index(NPGRID),King_Factor(NPGRID))
n_asn1e8=nas_coeff1/(nas_coeff2-WAVELENGTH_MICRON**(-2))+nas_coeff3/(nas_coeff4-WAVELENGTH_MICRON**(-2))
n_asn1=n_asn1e8*1.0e-8
naxsn1=n_asn1*(1.0+0.534e-6*(1.0E6*VMR_CO2_FIELD-C2))

nwsn1e8=nws_coeff0*(nws_coeff1+nws_coeff2*WAVELENGTH_MICRON**(-2) &
		+nws_coeff3*WAVELENGTH_MICRON**(-4)+nws_coeff4*WAVELENGTH_MICRON**(-6))
nwsn1=nwsn1e8*1.0e-8

Ma_profile=1.0e-3*(28.9635+12.011e-6*(1.0E6*VMR_CO2_FIELD-C1)) !unit kg/mol

Z_func=1.0-(P_GRID/TEM_FIELD)*                                              &
  (  Z_func_a0+Z_func_a1*(TEM_FIELD-273.15)+Z_func_a2*(TEM_FIELD-273.15)**2 &
   +(Z_func_b0+Z_func_b1*(TEM_FIELD-273.15))*VMR_H2O_FIELD                  &
   +(Z_func_c0+Z_func_c1*(TEM_FIELD-273.15))*VMR_H2O_FIELD**2)              &
   +((P_GRID/TEM_FIELD)**2) * (Z_func_d0+Z_func_d1*VMR_H2O_FIELD**2);

water_mole_number=VMR_H2O_FIELD*NUMDEN_TOTAL_FIELD/AvogadroNumber
water_vapor_partial_pressure=R_Universal*TEM_FIELD*water_mole_number
rho_axs=Ma_profile*pressure_standard/temperature_standard/R_Universal/Z_func
rho_a=Ma_profile*(P_GRID-water_vapor_partial_pressure)/TEM_FIELD/R_Universal/Z_func

rho_ws=Mw*1333/R_Universal/293.15
rho_w=Mw * water_mole_number
rho_w_ratio=rho_w/rho_ws
rho_a_ratio=rho_a/rho_axs

n_refractive_index=1.0+rho_a_ratio*naxsn1+rho_w_ratio*nwsn1

! King factor calculation
F1_N2=1.034+3.17e-4*WAVELENGTH_MICRON**(-2)
F2_O2=1.096+1.385e-3*WAVELENGTH_MICRON**(-2)+1.448e-4*WAVELENGTH_MICRON**(-4)
F3_Ar=1.0
F4_CO2=1.15
F5_H2O=1.001

King_Factor=(0.78084*F1_N2+0.20946*F2_O2+0.0093*F3_Ar +                       &
             VMR_CO2_FIELD*F4_CO2+water_vapor_partial_pressure/P_GRID*F5_H2O) &
		   /(0.999640+VMR_CO2_FIELD +water_vapor_partial_pressure/P_GRID)

MOLEXT=24*PI**3*King_Factor*(n_refractive_index**2-1.)**2 &
		/(WAVELENGTH_MICRON*1.0e-6)**4 / NUMDEN_TOTAL_FIELD**2 &
		/(n_refractive_index**2+2.)**2;

DEPOL_GRID=6.0*(King_Factor-1.0)/(7.0*King_Factor+3.0)

!MOLEXT=4.5102D-27*(WAVELENGTH_MICRON/0.550D0)**(-4.025D0-0.05627D0*(WAVELENGTH_MICRON/0.550D0)**(-1.647D0))*1.0D-4

! INITIALIZE TAUR VALUES
TAUR=0.0D0
IF(ALT_LYRA(1)>Z_FIELD(1)) THEN
	WRITE(*,*)'TAURCAL CHECK, ALT_LYRA(1),Z_FIELD(1)=',ALT_LYRA(1),Z_FIELD(1)
	STOP 'WARNING, ALT_LYRA DATA RANGE LARGER THAN Z_FIELD'
ENDIF
! Z_FIELD IS IN KM
! MULTIPLY BY 1000 TO INTEGRATE AND GET TAUR_GRID
TAUR_CUMSUM=0.0D0
TAUR_GRID=0.0D0
DO IHEIGHT=2,NPGRID
	RAY_SCALE_HEIGHT_SUB=-((Z_FIELD(IHEIGHT-1)-Z_FIELD(IHEIGHT))*1000.0D0)     &
                 /LOG(NUMDEN_TOTAL_FIELD(IHEIGHT-1)/NUMDEN_TOTAL_FIELD(IHEIGHT))
	TAUR_GRID(IHEIGHT)=RAY_SCALE_HEIGHT_SUB                                    &
			*0.5d0*(MOLEXT(IHEIGHT)+MOLEXT(IHEIGHT-1))                         &
			*      (NUMDEN_TOTAL_FIELD(IHEIGHT)-NUMDEN_TOTAL_FIELD(IHEIGHT-1))
	TAUR_CUMSUM(IHEIGHT)=TAUR_CUMSUM(IHEIGHT-1)+TAUR_GRID(IHEIGHT)
ENDDO

DO IHEIGHT=1,NTLYERA
   TAUR(IHEIGHT)=POLINT_SIMPLE(NPGRID,Z_FIELD,TAUR_CUMSUM,ALT_LYRA(IHEIGHT+1),3)
   RTMP=0.5d0*(ALT_LYRA(IHEIGHT)+ALT_LYRA(IHEIGHT+1))
   DEPOL_A(IHEIGHT)=POLINT_SIMPLE(NPGRID,Z_FIELD,DEPOL_GRID,RTMP,2)

IF(DEPOL_A(IHEIGHT)<0 .OR. DEPOL_A(IHEIGHT)>1)THEN
write(*,*)'WAVELENGTH_MICRON=',WAVELENGTH_MICRON
write(*,*)'NPGRID=',NPGRID
write(*,*)'Z_FIELD=',Z_FIELD
write(*,*)'DEPOL_GRID=',DEPOL_GRID
WRITE(*,*)'RTMP=',RTMP
stop
ENDIF

ENDDO

DO IHEIGHT=NTLYERA,2,-1
    TAUR(IHEIGHT)=TAUR(IHEIGHT)-TAUR(IHEIGHT-1)
ENDDO

DEALLOCATE(TAUR_GRID,TAUR_CUMSUM,DEPOL_GRID,MOLEXT,naxsn1, &
           Ma_Profile,Z_func,water_vapor_partial_pressure,water_mole_number,&
           rho_axs,rho_a,rho_w,rho_w_ratio,rho_a_ratio,n_refractive_index,King_Factor)

END SUBROUTINE TAURCAL

SUBROUTINE ARSL_VERP_INIT(NTLYERA,PNDLY)
USE GLOBAL_DATA, ONLY : WV_PACE_REF,CEXT_REF,ALT_LYRA
USE PACE_INSTRUMENT_DESIGN,ONLY : NWV_BAND,WV_BAND
USE MIE_PHMX_PACE, ONLY : CEXT_ARSL_BAND
IMPLICIT NONE

INTEGER :: NTLYERA
!REAL*8,DIMENSION(1:NTLYERA+1),INTENT(IN)::ALT_LYRA
REAL*8,DIMENSION(NTLYERA),INTENT(OUT)::PNDLY
! aerosol profile is given by Braslau, JAM, 1973
REAL*8,DIMENSION(8) ::   &
  PND=(/0.0013,0.0727,0.6761,0.8619,0.3735,0.3769,0.9235,193.7308/),&
  HEIGHT=(/45.2205,25.1867,21.8404,20.3539,12.0843,8.0429,4.9380,0./)
!REAL*8,DIMENSION(8) ::   &
!PND=(/0.0013,0.0727,0.6761,0.8619,0.3735,100.0,0.9235,0.8/),&
!HEIGHT=(/45.2205,25.1867,21.8404,20.3539,12.0843,8.0429,4.9380,0./)

REAL*8,DIMENSION(7) :: AEXPFAC,BEXPFAC
REAL*8 :: ALTMID,TAU_REF
INTEGER :: ILYERA,IHEIGHT

INTEGER,DIMENSION(1) ::LOCINDXTMP


DO IHEIGHT=1,7
  AEXPFAC(IHEIGHT)=-LOG(PND(IHEIGHT)/PND(IHEIGHT+1))/(HEIGHT(IHEIGHT)-HEIGHT(IHEIGHT+1))
  BEXPFAC(IHEIGHT)=PND(IHEIGHT+1)
!  IF(AEXPFAC(IHEIGHT)<0) then
!    WRITE(*,*)IHEIGHT,AEXPFAC(IHEIGHT),LOG(PND(IHEIGHT)/PND(IHEIGHT+1))
!    STOP 'CHECK AEXPFAC'
!  endif
ENDDO

DO ILYERA=1,NTLYERA
 ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
 IF(ALTMID>HEIGHT(1)) THEN
   PNDLY(ILYERA)=BEXPFAC(1)*EXP(-AEXPFAC(1)*(ALTMID-HEIGHT(2)))
 ELSE IF(ALTMID>HEIGHT(8)) THEN
   DO IHEIGHT=1,7
     IF(ALTMID<HEIGHT(IHEIGHT) .AND. ALTMID>HEIGHT(IHEIGHT+1)) EXIT
   ENDDO
   PNDLY(ILYERA)=BEXPFAC(IHEIGHT)*EXP(-AEXPFAC(IHEIGHT)*(ALTMID-HEIGHT(IHEIGHT+1)))
 ELSE
   STOP 'WARNING ALTMID<0' 
 ENDIF
!  WRITE(*,*)ALTMID,PNDLY(ILYERA)
ENDDO

DO ILYERA=1,NTLYERA
  PNDLY(ILYERA)=PNDLY(ILYERA)*(ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1))
ENDDO

LOCINDXTMP =MINLOC(ABS(WV_PACE_REF-WV_BAND))
CEXT_REF=CEXT_ARSL_BAND(LOCINDXTMP(1))
TAU_REF=SUM(PNDLY*CEXT_REF)
PNDLY=PNDLY*CEXT_REF/TAU_REF
! in the unit of #/micron^2, which is the column number concentration
      !  = (Number of aerosols)/micron^2/km *km where km is the unit of altitude.
!WRITE(*,*)'LAYER INTEGRATED NUMBER DENSITY'
!DO ILYERA=1,NTLYERA
!   ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
!   WRITE(*,*)ALTMID,PNDLY(ILYERA),ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1)
!ENDDO

END SUBROUTINE ARSL_VERP_INIT

SUBROUTINE RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,ITLYER,DEPOL_LOCAL)
USE RTUTILITY,ONLY : FACTOR
IMPLICIT NONE
INTEGER ::    NUMMIERT, NUMMIEANGMAX,ITLYER,ISCATANG
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM

REAL*8 :: DEPOL_LOCAL,MUF,DELTA_DEPOL,DELTA_DEPOLP

DELTA_DEPOL=(1.0D0-DEPOL_LOCAL)/(1.0D0+DEPOL_LOCAL/2.0D0)
DELTA_DEPOLP=(1.0D0-2.0D0*DEPOL_LOCAL)/(1.0D0-DEPOL_LOCAL)
   
DO ISCATANG=1,NUMMIEANGINPUT(ITLYER)
  MUF=COS(PHMXDATASTREAM(ITLYER,ISCATANG,0)*FACTOR)
  PHMXDATASTREAM(ITLYER,ISCATANG,1)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF) &
                                    +1.0D0-DELTA_DEPOL
  PHMXDATASTREAM(ITLYER,ISCATANG,2)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)
  PHMXDATASTREAM(ITLYER,ISCATANG,3)=1.5D0*DELTA_DEPOL*MUF
  PHMXDATASTREAM(ITLYER,ISCATANG,4)=1.5D0*DELTA_DEPOL*DELTA_DEPOLP*MUF
  
  PHMXDATASTREAM(ITLYER,ISCATANG,5)=-0.75D0*DELTA_DEPOL*(1.0D0-MUF*MUF)
  PHMXDATASTREAM(ITLYER,ISCATANG,6)=0.0D0
ENDDO

END SUBROUTINE RAYPHMXASSIGN

SUBROUTINE PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYER,TAURfracLOCAL,DEPOL_LOCAL)
USE RTUTILITY,ONLY : FACTOR
IMPLICIT NONE
INTEGER ::    NUMMIERT, NUMMIEANGMAX,ITLYER,ISCATANG
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM
REAL*8 :: TAURfracLOCAL

REAL*8 :: DEPOL_LOCAL,MUF,DELTA_DEPOL,DELTA_DEPOLP
REAL*8,DIMENSION(6):: RAYPHMX_LOCAL

DELTA_DEPOL=(1.0D0-DEPOL_LOCAL)/(1.0D0+DEPOL_LOCAL/2.0D0)
DELTA_DEPOLP=(1.0D0-2.0D0*DEPOL_LOCAL)/(1.0D0-DEPOL_LOCAL)

DO ISCATANG=1,NUMMIEANGINPUT(ITLYER)
  MUF=COS(PHMXDATASTREAM(ITLYER,ISCATANG,0)*FACTOR)
  RAYPHMX_LOCAL(1)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)+1.0D0-DELTA_DEPOL

  RAYPHMX_LOCAL(2)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)
  RAYPHMX_LOCAL(3)=1.5D0*DELTA_DEPOL*MUF
  RAYPHMX_LOCAL(4)=1.5D0*DELTA_DEPOL*DELTA_DEPOLP*MUF
  
  RAYPHMX_LOCAL(5)=-0.75D0*DELTA_DEPOL*(1.0D0-MUF*MUF)
  RAYPHMX_LOCAL(6)=0.0D0
  PHMXDATASTREAM(ITLYER,ISCATANG,1:6)=TAURfracLOCAL*RAYPHMX_LOCAL(1:6) + &
              (1.0D0-TAURfracLOCAL)*PHMXDATASTREAM(ITLYER,ISCATANG,1:6)
ENDDO

END SUBROUTINE PHMXMIXING


SUBROUTINE NAP_PARA_INIT(WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION, &
                         SEDIMENT_SPECTRAL_SLOPE,ASTCLOCAL,BSTCLOCAL,BBSTCfracLOCAL)
USE PACE_INSTRUMENT_DESIGN,ONLY : NWV_BAND,WV_BAND
USE MIE_PHMX_PACE, ONLY : AREA_MINERAL,REFF_MINERAL,CSCAT_Mineral_BAND,BBFRAC_Mineral_BAND
USE GLOBAL_DATA, ONLY : SEDIMENT_INDEX_REFRACTION
IMPLICIT NONE

REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION,SEDIMENT_SPECTRAL_SLOPE
REAL*8,INTENT(OUT):: ASTCLOCAL,BSTCLOCAL,BBSTCfracLOCAL

REAL*8 :: ASTC443LOCAL,SEDIMENT_DENSITY,CSCAT_MINERAL,BSTC665LOCAL,WAVELENGTH_NANOMETER
INTEGER,DIMENSION(1) ::LOCINDXTMP

!Babin et al., JGR, Vol. 108, 3211, 2003, Table 5
! Variations in the light absorption coefficients of phytoplankton,
! nonalgal particles, and dissolved organic matterin coastal waters around Europe

WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0D0
ASTC443LOCAL=0.041D0*SEDIMENT_CONCENTRATION
ASTCLOCAL=ASTC443LOCAL*0.75d0*EXP(-0.0123d0*(WAVELENGTH_NANOMETER-443.0d0))
SEDIMENT_DENSITY=6.779D6*SEDIMENT_INDEX_REFRACTION+5.232D6

LOCINDXTMP =MINLOC(ABS(665.0d0-WV_BAND))
CSCAT_MINERAL=CSCAT_Mineral_BAND(LOCINDXTMP(1))

BSTC665LOCAL=1.5D0*CSCAT_MINERAL/AREA_MINERAL/(REFF_MINERAL*1.D-6)/ &
             SEDIMENT_DENSITY*SEDIMENT_CONCENTRATION
BSTCLOCAL=BSTC665LOCAL*(WAVELENGTH_MICRON/0.665D0)**(-(SEDIMENT_SPECTRAL_SLOPE-3)) &
          -ASTCLOCAL*(1.0D0-TANH(0.5D0*(SEDIMENT_SPECTRAL_SLOPE-3)**2))

LOCINDXTMP =MINLOC(ABS(WAVELENGTH_NANOMETER-WV_BAND))

BBSTCfracLOCAL=BBFRAC_Mineral_BAND(LOCINDXTMP(1))

END SUBROUTINE NAP_PARA_INIT


SUBROUTINE HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLaVal,TMPTR,SALINITY,         &
    AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,BBPTCfracLOCAL,&
    APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)
USE GLOBAL_DATA
IMPLICIT NONE
LOGICAL :: FCDOM_ACOEF_FREE
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,CHLaVal,TMPTR,SALINITY
REAL*8,INTENT(OUT)::AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,&
                    BBPTCfracLOCAL,APTCLOCAL,   &
                    ACDMLOCAL,RINDX_WATERLOCAL
INTEGER,PARAMETER :: NWV_Aph1_ZPLee=81,NWV_AP_BIOSOPE=226,NWV_AP_COMPONENTS=151
REAL*8 :: BPTC_exp_coeff,BPTC660,Ap_Bricaud,Ep_Bricaud
REAL*8 :: S_cdm,WAVELENGTH_NANOMETER,BWFUNC,APTC440,ACDM440, CPTC550, CPTCLOCAL

INTEGER :: IREAD
REAL*8 :: RTMP,RTMP1,RTMP2
REAL,DIMENSION(5) :: RNDNMBR
! Ap_Bricaud and Ep_Bricaud are obtained through interpolation of 
! Bricaud's table values See
!Bricaud A,Morel A,Babin M,Allali K,Claustre H. Variations of light
!absorption by suspended particles with chlorophylla concentration
!in oceanic(case1) waters: analysis and implications for bio-optical
!models. J Geophys Res 1998;103:310334

INTEGER :: I_AP_UV ! =1, USE ZP LEE'S UV DATA, AS IT WAS IN ZHAI ET AL. OE, 2015
                   ! =2, USE BRICAUD BIOSCOPE 20 PERCENTILE
                   ! =3, USE BRICAUD BIOSCOPE 50 PERCENTILE
                   ! =4, USE BRICAUD BIOSCOPE 80 PERCENTILE

INTEGER :: I_AW_UV ! =1 USE ZP LEE 2015 doi.org/10.1364/AO.54.000546
				   ! =2 USE Mason, Cone, Fry 2016
INTEGER :: BIOCASE1_SELECT !==1 SCATTERING COEFFICIENT MODELED AS A POWER LAW
                           !==2 EXTINCTION COEFFICIENT MODELED AS A POWER LAW

REAL*8,DIMENSION(NWV_Aph1_ZPLee),PARAMETER :: WV_Aph1_ZPLee=(/350.0d0,355.0d0,360.0d0,  &
             365.0d0,370.0d0,375.0d0,380.0d0,385.0d0,390.0d0,395.0d0,400.0d0, &
             405.0d0,410.0d0,415.0d0,420.0d0,425.0d0,430.0d0,435.0d0,440.0d0, &
             445.0d0,450.0d0,455.0d0,460.0d0,465.0d0,470.0d0,475.0d0,480.0d0, &
             485.0d0,490.0d0,495.0d0,500.0d0,505.0d0,510.0d0,515.0d0,520.0d0, &
             525.0d0,530.0d0,535.0d0,540.0d0,545.0d0,550.0d0,555.0d0,560.0d0, &
             565.0d0,570.0d0,575.0d0,580.0d0,585.0d0,590.0d0,595.0d0,600.0d0, &
             605.0d0,610.0d0,615.0d0,620.0d0,625.0d0,630.0d0,635.0d0,640.0d0, &
             645.0d0,650.0d0,655.0d0,660.0d0,665.0d0,670.0d0,675.0d0,680.0d0, &
             685.0d0,690.0d0,695.0d0,700.0d0,705.0d0,710.0d0,715.0d0,720.0d0, &
             725.0d0,730.0d0,735.0d0,740.0d0,745.0d0,750.0d0/)

REAL*8,DIMENSION(NWV_Aph1_ZPLee),PARAMETER :: Aph1_ZPLee=(/0.001555842d0,0.00181407d0,  &
             0.001888311d0,0.001929814d0,0.002001448d0,0.002095922d0,0.002190711d0,&
             0.002272435d0,0.002343792d0,0.002420293d0,0.002518258d0,0.002641678d0,&
             0.002780294d0,0.002921886d0,0.003062716d0,0.003200315d0,0.003319054d0,&
             0.003392452d0,0.003404776d0,0.003365358d0,0.003295404d0,0.003205327d0,&
             0.003091601d0,0.00295154d0,0.002793768d0,0.002632409d0,0.002472467d0, &
             0.002303613d0,0.002110266d0,0.00188762d0,0.001647957d0,0.001413061d0, &
             0.001201222d0,0.001019811d0,0.000867002d0,0.000737812d0,0.000628256d0,&
             0.000535732d0,0.000458072d0,0.000393474d0,0.000340909d0,0.000300215d0,&
             0.000271662d0,0.000255023d0,0.000248825d0,0.000250241d0,0.000255381d0,&
             0.000259823d0,0.000260164d0,0.000256607d0,0.000253508d0,0.000255765d0,&
             0.000264538d0,0.000277018d0,0.000289617d0,0.00030019d0,0.000307799d0, &
             0.000312941d0,0.000320181d0,0.000341222d0,0.000394337d0,0.000494746d0,&
             0.000635514d0,0.000774211d0,0.000846711d0,0.000806908d0,0.000660216d0,&
             0.000459487d0,0.000268371d0,0.00012758d0,0.00012758d0,0.00012758d0,   &
             0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0,     &
             0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0/)

REAL*8, DIMENSION(NWV_AP_BIOSOPE) :: WV_AP_BIOSOPE,AP_BIOSOPE_UV20P,AP_BIOSOPE_UV50P,&
                                     AP_BIOSOPE_UV80P,AP_BIOSOPE_USE
REAL*8, DIMENSION(NWV_AP_COMPONENTS) :: WV_AP_COMPONENTS, AP_PICO_BASE, AP_MICRO_BASE
REAL*8 :: ACDM400,SF_COEFF,AP_PICO_SPECIFIC676NM=0.023D0,AP_MICRO_SPECIFIC676NM=0.0086D0
REAL*8 :: POLINT_SIMPLE

WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0d0
BIOCASE1_SELECT=2
I_AP_UV=3
I_AW_UV=1          ! =1 USE ZP LEE 2015 doi.org/10.1364/AO.54.000546
				   ! =2 USE Mason, Cone, Fry 2016

IF(BIOCASE1_SELECT .NE. 1)THEN
  CALL RANDOM_SEED()
  CALL RANDOM_NUMBER(RNDNMBR)
ENDIF

IF(WAVELENGTH_NANOMETER<350.0D0 .and. I_AP_UV==1)THEN
  WRITE(*,*) 'warning, WAVELENGTH_NANOMETER=',WAVELENGTH_NANOMETER,'RANGE OUT OF APH ABSORPTION TABLE FROM ZP Lee'
  STOP
ENDIF

IF(WAVELENGTH_NANOMETER<300.0D0 .and. I_AP_UV>1)THEN
  write(*,*)'warning, WAVELENGTH_NANOMETER=',WAVELENGTH_NANOMETER,'RANGE OUT OF APH ABSORPTION TABLE FROM biosope'
  write(*,*)'extrapolation is used instead'
ENDIF

IF(AP_SELECT==1)THEN

  CALL AP_BRICAUD_LUT_SEARCH(440.0D0,CHLaVal, APTC440)

ELSEIF(AP_SELECT==2)THEN
!SF_Coff options from Ciotti, Lewis, and Cullen, LO, 47(2) 404-417, 2002
!    Assessment of the relationships between dominant cell size in
!    natural phytoplankton communities and the spectral shape of
!    the absorption coefficient
! 1.000 0.663 0.598 0.369 0.558 0.491 0.664 0.287
! 0.370 0.266 0.151 0.442 0.002 0.014 0.025 0.000

  SF_COEFF=0.287d0
  call aux_dir_readin
  OPEN(UNIT=1,FILE=TRIM(aux_dir)//'/ap_PicoMicro.txt',STATUS='OLD',ACTION='READ')
  READ(1,*)
  DO IREAD=1,NWV_AP_COMPONENTS
     READ(1,*)WV_AP_COMPONENTS(IREAD), AP_PICO_BASE(IREAD), AP_MICRO_BASE(IREAD)
  ENDDO
  CLOSE(1)
  RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,676.0D0,2)
  RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,676.0D0,2)
  AP_PICO_BASE=AP_PICO_BASE/RTMP1*AP_PICO_SPECIFIC676NM
  AP_MICRO_BASE=AP_MICRO_BASE/RTMP2*AP_MICRO_SPECIFIC676NM

  RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,440.0D0,2)
  RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,440.0D0,2)
  APTC440=CHLaVal*(SF_COEFF*RTMP1+(1.0D0-SF_COEFF)*RTMP2)
ELSE
  WRITE(*,*)'WARNING! AP SELECTION OUT OF CURRENT RANGE'
ENDIF

IF(OCEAN_CASE_SELECT==0) APTC440=1.0d-6  ! no ocean body, does not matter

IF(WAVELENGTH_NANOMETER<400.0D0)THEN
    IF(I_AP_UV==1)THEN
      APTCLOCAL=POLINT_SIMPLE(NWV_Aph1_ZPLee,WV_Aph1_ZPLee,Aph1_ZPLee,WAVELENGTH_NANOMETER,2)
      RTMP =    POLINT_SIMPLE(NWV_Aph1_ZPLee,WV_Aph1_ZPLee,Aph1_ZPLee,440.0d0,2)
      APTCLOCAL=APTCLOCAL/RTMP*APTC440
    ELSE
      OPEN(UNIT=1,FILE=TRIM(aux_dir)//'/ap_UV_biosope.dat',STATUS='OLD',ACTION='READ')
      DO IREAD=1,5
        READ(1,*)
      ENDDO
      DO IREAD=1,NWV_AP_BIOSOPE
         READ(1,*)WV_AP_BIOSOPE(IREAD),AP_BIOSOPE_UV20P(IREAD),AP_BIOSOPE_UV50P(IREAD),AP_BIOSOPE_UV80P(IREAD)
      ENDDO
      CLOSE(1)
      IF(I_AP_UV==2)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV20P
      ELSEIF(I_AP_UV==3)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV50P
      ELSEIF(I_AP_UV==4)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV80P
      ENDIF

      APTCLOCAL=POLINT_SIMPLE(NWV_AP_BIOSOPE,WV_AP_BIOSOPE,AP_BIOSOPE_USE,WAVELENGTH_NANOMETER,2)
      RTMP=POLINT_SIMPLE(NWV_AP_BIOSOPE,WV_AP_BIOSOPE,AP_BIOSOPE_USE,440.0D0,2)
      APTCLOCAL=APTCLOCAL/RTMP*APTC440
    ENDIF

ELSEIF(WAVELENGTH_NANOMETER<700.0D0)THEN

  IF(AP_SELECT==1)THEN
    CALL AP_BRICAUD_LUT_SEARCH(WAVELENGTH_NANOMETER,CHLaVal, APTCLOCAL)
  ELSE IF(AP_SELECT==2)THEN! USE CASE 2 AP MODEL
    RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,WAVELENGTH_NANOMETER,2)
    RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,WAVELENGTH_NANOMETER,2)
    APTCLOCAL=CHLaVal*(SF_COEFF*RTMP1+(1.0D0-SF_COEFF)*RTMP2)
  ELSE ! no ocean water body
    WRITE(*,*)'WARNING! AP SELECTION OUT OF CURRENT RANGE'
  ENDIF

  IF(OCEAN_CASE_SELECT==0) APTC440=1.0d-6  ! no ocean body, does not matter

ELSE
  APTCLOCAL=0.0d0 ! negligible absorption for ap at wavelength > 700 nm
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN
  IF(BIOCASE1_SELECT==1) THEN
        ! See Eq.14 in Morel and Maritorena, JGR, 2001
        IF(CHLaVal>2 .OR. CHLaVal<0.001D0)THEN
             BPTC_exp_coeff=0.0D0
        ELSE
             BPTC_exp_coeff=0.5*(LOG10(CHLaVal)-0.3)
        ENDIF
        ! See Eq.12 in Morel and Maritorena, JGR, 2001
        !  BPTC550=0.416*CHLa**0.766
        BPTC660=0.347*CHLaVal**0.766
        ! See Eq.13 in Morel and Maritorena, JGR, 2001
        BPTCLOCAL=BPTC660*(WAVELENGTH_MICRON/0.66)**BPTC_exp_coeff
        CPTCLOCAL=BPTCLOCAL+APTCLOCAL
  ELSE
    ! the random number bio-optical model scheme with RNDNMBR-0.5d0
        RNDNMBR=0.5d0
        RTMP=(0.6D0-0.06D0)*RNDNMBR(1)+0.06D0
        CPTC550=RTMP*CHLaVal**0.57D0  ! EQ. 11 in lee_data.pdf
        RTMP1=-0.4D0+(1.6D0+1.2D0*RNDNMBR(2))/(1.0D0+SQRT(CHLaVal))
        CPTCLOCAL=CPTC550*(550.0D0/WAVELENGTH_NANOMETER)**RTMP1
        BPTCLOCAL=CPTCLOCAL-APTCLOCAL
  ENDIF

ELSEIF(OCEAN_CASE_SELECT==2)THEN
!K. J. Voss, A spectral model of the beam attenuation coefficient
!       in the ocean and coastal areas, Limnol. Oceanogr. 37, 501-509 (1992).
    CPTC550=0.3D0*CHLaVal**0.62D0
    CPTCLOCAL=CPTC550*(550.0D0/WAVELENGTH_NANOMETER)**(PHYTOPLANKTON_SPECTRAL_SLOPE-3.0D0)
    BPTCLOCAL=CPTCLOCAL-APTCLOCAL

ELSE IF(OCEAN_CASE_SELECT==3)THEN

   BBPTCfracLOCAL=Bp660_backscatteringfraction_Case3 * &
                  (WAVELENGTH_NANOMETER/660D0)**(-S_Bp_Case3)
   BBPTCLOCAL=bbp660_Case3*(WAVELENGTH_NANOMETER/660D0)**(-Sbp_Case3)
   BPTCLOCAL=BBPTCLOCAL/BBPTCfracLOCAL
   CPTCLOCAL=BPTCLOCAL+APTCLOCAL
ENDIF

IF(OCEAN_CASE_SELECT .NE. 0)THEN
IF(BPTCLOCAL<0.0D0) THEN
    WRITE(*,*)'WARNING CPTCLOCAL<APTCLOCAL'
    WRITE(*,*)'CPTCLOCAL,APTCLOCAL=',CPTCLOCAL,APTCLOCAL
    WRITE(*,*)'SWTICH TO BIOOPTICAL MODEL CPTCLOCAL=BPTCLOCAL+APTCLOCAL'
    ! See Eq.14 in Morel and Maritorena, JGR, 2001
    IF(CHLaVal>2 .OR. CHLaVal<0.001D0)THEN
         BPTC_exp_coeff=0.0D0
    ELSE
         BPTC_exp_coeff=0.5*(LOG10(CHLaVal)-0.3)
    ENDIF
    ! See Eq.12 in Morel and Maritorena, JGR, 2001
    !  BPTC550=0.416*CHLa**0.766
    BPTC660=0.347*CHLaVal**0.766
    ! See Eq.13 in Morel and Maritorena, JGR, 2001
    BPTCLOCAL=BPTC660*(WAVELENGTH_MICRON/0.66)**BPTC_exp_coeff
    CPTCLOCAL=BPTCLOCAL+APTCLOCAL
ENDIF
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN
    IF(abs(CHLaVal)<0.001D0)THEN
      BBPTCfracLOCAL=0.0d0
      BBPTCLOCAL=0.0d0
    ELSE
      BBPTCfracLOCAL=0.002+0.01*(0.5-0.25*log10(CHLaVal))
   !BBPTCfracLOCAL=0.01d0; ! used in Westberry, Boss, and Lee 2013
      BBPTCLOCAL=BBPTCfracLOCAL*BPTCLOCAL
    ENDIF

    IF(BBPTCfracLOCAL<1E-6)THEN
      WRITE(*,*)'CHLaVal,BBPTCfracLOCAL=',CHLaVal,BBPTCfracLOCAL
      STOP
    ENDIF
ELSEIF(OCEAN_CASE_SELECT==2) THEN
    BBPTCfracLOCAL=0.0D0 ! NOT USED IN CASE 2 WATER BIOOPTICAL MODELS
    BBPTCLOCAL=0.0D0     ! NOT USED IN CASE 2 WATER BIOOPTICAL MODELS
ENDIF

!S_cdm is suggested by Morel and Gentili, RSE, 2009.
S_cdm=0.018

FCDOM_ACOEF_FREE=.FALSE.

IF(FCDOM_ACOEF_FREE)THEN
    CALL RANDOM_SEED()
    CALL RANDOM_NUMBER(RNDNMBR)
!    RNDNMBR=0.5d0 !testing random number bio-optical model algorithm
    RTMP=0.3D0+5.7D0*RNDNMBR(1)*APTC440/(0.02D0+APTC440) ! EQ.9 in lee_data.pdf
    ACDM440=RTMP*APTC440
    ACDMLOCAL=ACDM440*exp(-S_cdm*(WAVELENGTH_MICRON-0.44d0)*1000.)
ELSEIF(OCEAN_CASE_SELECT==1 .OR. OCEAN_CASE_SELECT==2)THEN
! See Eq.1 in Morel and Gentili, RSE, 2009
    ACDM400=0.065*CHLaVal**0.63
    ACDMLOCAL=ACDM400*exp(-S_cdm*(WAVELENGTH_MICRON-0.40d0)*1000.)
ELSEIF(OCEAN_CASE_SELECT==3)THEN
    ACDMLOCAL=adg440_Case3*exp(-Sdg_Case3*(WAVELENGTH_MICRON-0.44d0)*1000.)
ELSE
    ACDMLOCAL=0.0D0
ENDIF

IF(WAVELENGTH_NANOMETER> 550.0D0) THEN
  AWLOCAL=  POLINT_SIMPLE(NWV_PF_LUT,WV_PF_LUT,AW_PF_LUT,WAVELENGTH_NANOMETER,2)
ELSE
  ! I_AW_UV==1 USE ZP LEE 2015 doi.org/10.1364/AO.54.000546
		 ! ==2 USE Mason, Cone, Fry 2016
	IF(I_AW_UV ==1) THEN
	  IF(WAVELENGTH_NANOMETER<350.0D0)THEN
		 AWLOCAL=  POLINT_SIMPLE(NWV_PF_LUT,WV_PF_LUT,AW_PF_LUT,WAVELENGTH_NANOMETER,2)
	  ELSE
		 AWLOCAL=  POLINT_SIMPLE(NWV_AW_LEE_LUT,WV_AW_LEE_LUT,AW_LEE_LUT,WAVELENGTH_NANOMETER,2)
	  ENDIF
	ELSE
	   AWLOCAL=  POLINT_SIMPLE(NWV_AW_MCF_LUT,WV_AW_MCF_LUT,AW_MCF_LUT,WAVELENGTH_NANOMETER,2)
	ENDIF
ENDIF

BWLOCAL=0.00193D0*(550.0d0/WAVELENGTH_NANOMETER)**4.32  !BWFUNC(WAVELENGTH_NANOMETER,TMPTR,SALINITY)
BBWLOCAL=0.5D0*BWLOCAl
!BWRAMANLOCAL=2.6d-4*(488.0d0/WAVELENGTH_NANOMETER)**5.5
!BWRAMANLOCAL=2.6d-4*(488.0d0/WAVELENGTH_NANOMETER)**4.8
BWRAMANLOCAL=2.7d-4*(488.0d0/WAVELENGTH_NANOMETER)**5.3

IF(OCEAN_CASE_SELECT==0)THEN
  CPTCLOCAL=APTCLOCAL
  BPTCLOCAL=0.0D0
  BBPTCfracLOCAL=0.0D0 ! BLACK OCEAN
  BBPTCLOCAL=0.0D0     ! BLACK OCEAN
  AWLOCAL=1.0D-6
  BWLOCAL=0.0D0
  BBWLOCAL=0.0D0
ENDIF

CALL WATER_REFRACTIVE_INDEX(WAVELENGTH_NANOMETER,TMPTR,SALINITY,RINDX_WATERLOCAL)

END SUBROUTINE HYDRSL_PARA_INIT

SUBROUTINE AP_BRICAUD_LUT_SEARCH(WAVELENGTH_NM,CHLaVal,AP)
IMPLICIT NONE
REAL*8, INTENT(IN) :: WAVELENGTH_NM,CHLaVal
REAL*8, INTENT(OUT) :: AP

INTEGER,PARAMETER :: NWV_Bricaud=151
REAL*8,DIMENSION(NWV_Bricaud),PARAMETER :: &
WV_Bricaud=(/400.0d0,402.0d0,404.0d0,406.0d0,408.0d0,410.0d0,412.0d0,&
             414.0d0,416.0d0,418.0d0,420.0d0,422.0d0,424.0d0,426.0d0,&
             428.0d0,430.0d0,432.0d0,434.0d0,436.0d0,438.0d0,440.0d0,&
             442.0d0,444.0d0,446.0d0,448.0d0,450.0d0,452.0d0,454.0d0,&
             456.0d0,458.0d0,460.0d0,462.0d0,464.0d0,466.0d0,468.0d0,&
             470.0d0,472.0d0,474.0d0,476.0d0,478.0d0,480.0d0,482.0d0,&
             484.0d0,486.0d0,488.0d0,490.0d0,492.0d0,494.0d0,496.0d0,&
             498.0d0,500.0d0,502.0d0,504.0d0,506.0d0,508.0d0,510.0d0,&
             512.0d0,514.0d0,516.0d0,518.0d0,520.0d0,522.0d0,524.0d0,&
             526.0d0,528.0d0,530.0d0,532.0d0,534.0d0,536.0d0,538.0d0,&
             540.0d0,542.0d0,544.0d0,546.0d0,548.0d0,550.0d0,552.0d0,&
             554.0d0,556.0d0,558.0d0,560.0d0,562.0d0,564.0d0,566.0d0,&
             568.0d0,570.0d0,572.0d0,574.0d0,576.0d0,578.0d0,580.0d0,&
             582.0d0,584.0d0,586.0d0,588.0d0,590.0d0,592.0d0,594.0d0,&
             596.0d0,598.0d0,600.0d0,602.0d0,604.0d0,606.0d0,608.0d0,&
             610.0d0,612.0d0,614.0d0,616.0d0,618.0d0,620.0d0,622.0d0,&
             624.0d0,626.0d0,628.0d0,630.0d0,632.0d0,634.0d0,636.0d0,&
             638.0d0,640.0d0,642.0d0,644.0d0,646.0d0,648.0d0,650.0d0,&
             652.0d0,654.0d0,656.0d0,658.0d0,660.0d0,662.0d0,664.0d0,&
             666.0d0,668.0d0,670.0d0,672.0d0,674.0d0,676.0d0,678.0d0,&
             680.0d0,682.0d0,684.0d0,686.0d0,688.0d0,690.0d0,692.0d0,&
             694.0d0,696.0d0,698.0d0,700.0d0/), &
Ap_Bricaud_LUT=(/0.043321d0,0.043805d0,0.044307d0,0.045064d0,0.045812d0,&
             0.046699d0,0.047328d0,0.047969d0,0.048595d0,0.049069d0,&
             0.049477d0,0.049611d0,0.049713d0,0.050096d0,0.050561d0,&
             0.051299d0,0.051568d0,0.051726d0,0.051950d0,0.052003d0,&
             0.052019d0,0.051398d0,0.050464d0,0.049508d0,0.048558d0,&
             0.047932d0,0.047111d0,0.046229d0,0.045566d0,0.044945d0,&
             0.044552d0,0.043937d0,0.043282d0,0.042681d0,0.042065d0,&
             0.041530d0,0.040727d0,0.039861d0,0.039079d0,0.038357d0,&
             0.037742d0,0.037013d0,0.036276d0,0.035576d0,0.034834d0,&
             0.034124d0,0.033205d0,0.032170d0,0.031089d0,0.029954d0,&
             0.028819d0,0.027624d0,0.026434d0,0.025281d0,0.024201d0,&
             0.023181d0,0.022189d0,0.021248d0,0.020406d0,0.019624d0,&
             0.018943d0,0.018252d0,0.017583d0,0.017065d0,0.016484d0,&
             0.015987d0,0.015469d0,0.014994d0,0.014524d0,0.014103d0,&
             0.013722d0,0.013316d0,0.012954d0,0.012554d0,0.012194d0,&
             0.011825d0,0.011423d0,0.011049d0,0.010677d0,0.010317d0,&
             0.010031d0,0.0097641d0,0.0094984d0,0.0092848d0,0.0091161d0,&
             0.0090396d0,0.0089222d0,0.0088270d0,0.0087804d0,0.0087719d0,&
             0.0088089d0,0.0088272d0,0.0088963d0,0.0089011d0,0.0089057d0,&
             0.0089436d0,0.0088958d0,0.0088117d0,0.0087399d0,0.0086249d0,&
             0.0085428d0,0.0084855d0,0.0084262d0,0.0084156d0,0.0084456d0,&
             0.0085282d0,0.0086012d0,0.0087063d0,0.0087977d0,0.0088983d0,&
             0.0089570d0,0.0089865d0,0.0090377d0,0.0091362d0,0.0091923d0,&
             0.0093245d0,0.0094377d0,0.0095348d0,0.0096250d0,0.0096807d0,&
             0.0097295d0,0.0098384d0,0.0098896d0,0.0100020d0,0.0100940d0,&
             0.0102980d0,0.0105460d0,0.0109600d0,0.0115510d0,0.0123180d0,&
             0.0133350d0,0.0145240d0,0.0159410d0,0.0174420d0,0.0188000d0,&
             0.0198900d0,0.0205370d0,0.0206550d0,0.0203380d0,0.0195500d0,&
             0.0183000d0,0.0165610d0,0.0145490d0,0.0124000d0,0.0103630d0,&
             0.0086832d0,0.0072437d0,0.0060441d0,0.0051813d0,0.0044349d0,&
             0.0039342d0/), &
Ep_Bricaud_LUT=(/0.70264700d0,0.70008400d0,0.69713200d0,0.69402600d0,0.69163300d0,&
             0.68817200d0,0.68624500d0,0.68156700d0,0.67822900d0,0.67464400d0,&
             0.67119500d0,0.66492600d0,0.65893100d0,0.65573900d0,0.65366800d0,&
             0.65427700d0,0.64998700d0,0.64512700d0,0.64008100d0,0.63579800d0,&
             0.63496500d0,0.62975200d0,0.62319900d0,0.61863100d0,0.61437300d0,&
             0.61509600d0,0.61305600d0,0.61005500d0,0.60961700d0,0.60956400d0,&
             0.61235800d0,0.61281800d0,0.61205500d0,0.61191600d0,0.61194100d0,&
             0.61293800d0,0.61114800d0,0.60839400d0,0.60664900d0,0.60518700d0,&
             0.60653300d0,0.60642900d0,0.60721900d0,0.60974100d0,0.61350600d0,&
             0.62002600d0,0.62504300d0,0.63075200d0,0.63776800d0,0.64575000d0,&
             0.65574300d0,0.66499400d0,0.67451100d0,0.68439000d0,0.69450800d0,&
             0.70600400d0,0.71550900d0,0.72468700d0,0.73496500d0,0.74470400d0,&
             0.75513100d0,0.76437800d0,0.77428800d0,0.77583700d0,0.78423400d0,&
             0.79197900d0,0.79929700d0,0.80430600d0,0.81154700d0,0.81623700d0,&
             0.82177600d0,0.82706000d0,0.83034000d0,0.83412900d0,0.83580700d0,&
             0.83854200d0,0.84213100d0,0.84192300d0,0.84380100d0,0.84359000d0,&
             0.84125400d0,0.83924600d0,0.83881500d0,0.83976200d0,0.84005900d0,&
             0.83642500d0,0.83564600d0,0.83547000d0,0.83259200d0,0.82952900d0,&
             0.82763100d0,0.82648500d0,0.81994200d0,0.82021400d0,0.81737600d0,&
             0.81172600d0,0.81085800d0,0.80851800d0,0.80388600d0,0.80434600d0,&
             0.80494400d0,0.80574300d0,0.81047500d0,0.81555500d0,0.82024700d0,&
             0.82480800d0,0.83032200d0,0.83401100d0,0.83820100d0,0.83972600d0,&
             0.84380800d0,0.84618200d0,0.84668000d0,0.84434200d0,0.84656800d0,&
             0.84554300d0,0.84563600d0,0.84497200d0,0.84295600d0,0.84116400d0,&
             0.83738800d0,0.82956800d0,0.82599800d0,0.81902800d0,0.81820600d0,&
             0.81423600d0,0.81486100d0,0.81376400d0,0.81490400d0,0.82011500d0,&
             0.82296500d0,0.82755100d0,0.82416800d0,0.81972200d0,0.81759900d0,&
             0.81774200d0,0.81659000d0,0.81882300d0,0.82229100d0,0.82725000d0,&
             0.83522900d0,0.85007600d0,0.86755500d0,0.88844400d0,0.91245670d0,&
             0.93138840d0,0.94421240d0,0.96783410d0,0.98167950d0,1.00265734d0,&
             1.0131636d0/)

INTEGER :: IULO,MPL,KLO
REAL*8 :: Ap_Bricaud,Ep_Bricaud,RTMP

IF(WAVELENGTH_NM<400.0D0 .OR. WAVELENGTH_NM>700.0D0)THEN
  STOP 'WAVELENGTH OUT RANGE OF BRICAUD TABLE'
ENDIF

MPL=3
IULO=INT(FLOAT(NWV_Bricaud)*ABS((WAVELENGTH_NM-WV_Bricaud(1))/(WV_Bricaud(NWV_Bricaud)-WV_Bricaud(1))))

call hunt(WV_Bricaud,NWV_Bricaud,WAVELENGTH_NM,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NWV_Bricaud-MPL)
CALL POLINT(WV_Bricaud(KLO),Ap_Bricaud_LUT(KLO),MPL,WAVELENGTH_NM,Ap_Bricaud,RTMP)
CALL POLINT(WV_Bricaud(KLO),Ep_Bricaud_LUT(KLO),MPL,WAVELENGTH_NM,Ep_Bricaud,RTMP)
AP=Ap_Bricaud*CHLaVal**Ep_Bricaud

ENDSUBROUTINE AP_BRICAUD_LUT_SEARCH


SUBROUTINE HYDRSL_PHMX_ASSIGN(CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL, &
       NTLYERA,NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,ITLYERW,PHMXDATASTREAM)
USE RTUTILITY, ONLY : PI
USE GLOBAL_DATA, ONLY : DEPOL_O, Xi_kok, Alpha_kok, T0_kok,Dpol90_Kok
IMPLICIT NONE

REAL*8 :: CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL
INTEGER :: NTLYERA,NUMMIERT, NUMMIEANGMAX,ITLYERW
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM

INTEGER :: IANG
REAL*8 :: RTMP,RTMP1,ANGLE,NU,DLT90,XW,MUF,NORM,FFPH

IF(BBPTCfracLOCAL>0.0001D0)CALL FFPFCOEFF(BBPTCfracLOCAL,NU,DLT90)
DO IANG=1,NUMMIEANGINPUT(NTLYERA+ITLYERW)
  ANGLE=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,0)
  XW=(1.0D0-DEPOL_O)/(1.0D0+DEPOL_O)
  NORM=3.0D0/(3.0D0+XW)
  MUF=cos(ANGLE*pi/180.0d0)
  RTMP=NORM*(1.0D0+XW*MUF*MUF)
  IF(BBPTCfracLOCAL>0.0001D0) THEN
     RTMP1=FFPH(NU,DLT90,ANGLE)
     PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)= (BWLOCAL*RTMP +  &
       BPTCLOCAL*RTMP1)/ &
      (BWLOCAL + BPTCLOCAL)
  ELSE
     PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)= RTMP
  ENDIF
  RTMP1=Xi_kok*EXP(-Alpha_kok*ANGLE/180.0D0*PI)
  RTMP=1.0D0+Dpol90_Kok*(cos(ANGLE/180.0D0*PI-T0_kok))**2 + RTMP1
  
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2)= &
     (Dpol90_Kok*(1.0D0+(cos(ANGLE/180.0D0*PI-T0_kok))**2) + RTMP1)/RTMP
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)= &
     (2.0D0*Dpol90_Kok*MUF + RTMP1)/(1.0D0+Dpol90_Kok*MUF*MUF + RTMP1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5)=- Dpol90_Kok*((sin(ANGLE/180.0D0*PI))**2) &
          /(1.0d0+Dpol90_Kok*MUF*MUF)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6)=0.0d0

  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
ENDDO


END SUBROUTINE HYDRSL_PHMX_ASSIGN

MODULE FOURNIER_FORAND
IMPLICIT NONE
REAL*8 :: BACKSCATTERING_FRACTION
END MODULE

SUBROUTINE FFPFCOEFF(BB,NU,DLT90)
USE FOURNIER_FORAND, ONLY : BACKSCATTERING_FRACTION
USE RTSEC_WRAPPER
IMPLICIT NONE
real*8 BB,NU,DLT90
real*8 NURTLW,NURTHI,XACC,RTMP
real*8 FNU
EXTERNAL FNU
BACKSCATTERING_FRACTION=BB
NURTLW=-1.0D0
NURTHI=0.0D0
XACC=1.0E-12
NU=rtsec(FNU,NURTLW,NURTHI,XACC)
RTMP=(0.01D0-0.3084D0*NU)*(0.01D0-0.3084D0*NU)
DLT90=2.0D0/3.0D0/RTMP
END SUBROUTINE

REAL*8 FUNCTION FNU(NU)
USE FOURNIER_FORAND
IMPLICIT NONE
real*8 NU,BB
real*8 DLTTMP,RTMP,DLTPNU
BB=BACKSCATTERING_FRACTION
RTMP=(0.01D0-0.3084D0*NU)**2
DLTTMP=2.0D0/3.0D0/RTMP
DLTPNU=DLTTMP**NU
FNU=1.0D0-BB-(0.5D0-DLTTMP*DLTPNU+0.5D0*DLTPNU)/(DLTPNU-DLTTMP*DLTPNU)
END FUNCTION FNU

REAL*8 FUNCTION FFPH(NU,DLT90,ANG)
IMPLICIT NONE
real*8 NU,DLT90,ANG
real*8 ANGTMP,ANGD2,SINANGD2,COSANG,DLT,DLTPNU,OMDLT,OMDLTPNU
real*8 FCT1,TRM1,TRM2,DLT180,DLT180PNU,OMDLT180,OMDLT180PNU

ANGTMP=ANG/180.d0*3.1415926535897932d0
IF(ANGTMP<1.0E-4)ANGTMP=1.0E-4
ANGD2=0.5d0*ANGTMP
SINANGD2=SIN(ANGD2)
SINANGD2=SINANGD2*SINANGD2
COSANG=COS(ANGTMP)

DLT180=2.0d0*DLT90
DLT=DLT180*SINANGD2
DLTPNU=DLT**NU
OMDLT=1.0d0-DLT
OMDLTPNU=1.0d0-DLTPNU
FCT1=1.0d0/OMDLT/OMDLT/DLTPNU
TRM1=NU*OMDLT-OMDLTPNU
TRM2=DLT*OMDLTPNU-NU*OMDLT

DLT180PNU=DLT180**NU
OMDLT180=1.0d0-DLT180
OMDLT180PNU=1.0D0-DLT180PNU
FFPH=FCT1*(TRM1+TRM2/SINANGD2)-  &
       0.25d0*OMDLT180PNU/OMDLT180/DLT180PNU*(3.0d0*COSANG*COSANG-1.0d0)
END FUNCTION FFPH

!SEA WATER SCATTERING COEFFICIENTS BASED ON BUITEVELD 1994 OOXII
REAL*8 FUNCTION BWFUNC(WAVELENGTH_NANOMETER,TMPTR,SALINITY)
USE GLOBAL_DATA, only : DEPOL_O
USE RTUTILITY, ONLY : PI
IMPLICIT NONE

REAL*8 WAVELENGTH_NANOMETER,TMPTR,SALINITY
REAL*8 WAVELENGTH_NANOMETER2,WAVELENGTH_NANOMETER4,WAVELENGTH_NANOMETERM,&
       WAVELENGTH_NANOMETERM4,TEM2,BETA90,TMPABSLT,BOLZMANK,BETAT, &
       INDX,INDXDP,INDXDP20,INDXDP633,INDXDPDNM

BOLZMANK=1.38054D-23
TMPABSLT=TMPTR+273.15D0
WAVELENGTH_NANOMETERM=WAVELENGTH_NANOMETER*1.0E-9 
WAVELENGTH_NANOMETERM4=WAVELENGTH_NANOMETERM**4
WAVELENGTH_NANOMETER2=WAVELENGTH_NANOMETER*WAVELENGTH_NANOMETER
WAVELENGTH_NANOMETER4=WAVELENGTH_NANOMETER2*WAVELENGTH_NANOMETER2
TEM2=TMPTR*TMPTR
BETAT=(5.062271D0-0.03179D0*TMPTR+0.000407D0*TEM2)*1.0D-10
INDX=1.3247D0+3300.0D0/WAVELENGTH_NANOMETER2-3.2D7/WAVELENGTH_NANOMETER4-2.5D-6*TEM2 !&
! +(5.0D0-0.02D0*TMPTR)*4.0D-5*SALINITY
INDXDP20=(-0.000156d0*WAVELENGTH_NANOMETER+1.5989D0)*1.0D-10
INDXDP633=(1.61857D0-0.005785*TMPTR)*1.0D-10
INDXDPDNM=(-0.000156d0*633.0D0+1.5989D0)*1.0D-10
!INDXDPDNM=1.5014D-010
INDXDP=INDXDP20*INDXDP633/INDXDPDNM
!write(*,*)'INDXDP=',INDXDP20,INDXDP633,INDXDPDNM,INDXDP
BETA90=2.0D0*PI*PI*BOLZMANK/WAVELENGTH_NANOMETERM4/BETAT*TMPABSLT*INDX*INDX*          &
INDXDP*INDXDP*6.0D0*(1.0D0+DEPOL_O)/(6.0D0-7.0D0*DEPOL_O)
!write(*,*)'BETA90=',BETA90
BWFUNC=8.0D0*PI/3.0D0*BETA90*(2.0D0+DEPOL_O)/(1.0D0+DEPOL_O)
BWFUNC=BWFUNC*(1.0d0+0.3d0*SALINITY/37.0D0)

END FUNCTION BWFUNC

SUBROUTINE CLOUDMODELSELECTION(WAVELENGTH_MICRON,NUMMIEUSE,           &
             REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2)
USE GLOBAL_DATA
USE RTUTILITY, ONLY : PI
IMPLICIT NONE

INTEGER,INTENT(IN) :: NUMMIEUSE
REAL*8,INTENT(IN)::WAVELENGTH_MICRON
REAL*8,DIMENSION(NUMMIEUSE),INTENT(OUT)::REFF1,VEFF1,REFF2, &
                                    VEFF2,MRR1,MRI1,MRR2,MRI2
REAL*8 :: RADIUS_CLOUDS=10.0D0,VARIANCE_CLOUDS=0.1D0,&
          TMPTR=-20.0D0,SALINITY=0.0D0,WAVELENGTH_NANOMETER
REAL*8 :: RTMP,RTMP1,RINDX_WATERLOCAL
WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0d0
CALL WATER_REFRACTIVE_INDEX(WAVELENGTH_NANOMETER,TMPTR,SALINITY,RINDX_WATERLOCAL)

REFF1(:)=RADIUS_CLOUDS
REFF2(:)=RADIUS_CLOUDS
VEFF1(:)=VARIANCE_CLOUDS
VEFF2(:)=VARIANCE_CLOUDS
MRR1(:)=RINDX_WATERLOCAL
MRI1(:)=0.0d0
MRR2(:)=0.0d0
MRI2(:)=0.0d0

END SUBROUTINE CLOUDMODELSELECTION

SUBROUTINE WATER_ABSORPTION_LEE_READ
USE GLOBAL_DATA
IMPLICIT NONE
INTEGER :: IREAD

call aux_dir_readin

OPEN(UNIT=1,FILE=trim(aux_dir)//'/aw_seawater.txt',STATUS='OLD',ACTION='READ')
DO IREAD=1,4
READ(1,*)
ENDDO
DO IREAD=1,NWV_AW_LEE_LUT
READ(1,*)WV_AW_LEE_LUT(IREAD),AW_LEE_LUT(IREAD)
ENDDO
CLOSE(1)
RETURN
ENDSUBROUTINE WATER_ABSORPTION_LEE_READ

SUBROUTINE WATER_ABSORPTION_MCF_READ
USE GLOBAL_DATA
IMPLICIT NONE
INTEGER :: IREAD
REAL*8 :: RTMP
call aux_dir_readin

OPEN(UNIT=1,FILE=trim(aux_dir)//'/mason_2015.txt',STATUS='OLD',ACTION='READ')
DO IREAD=1,10
READ(1,*)
ENDDO
DO IREAD=1,NWV_AW_MCF_LUT
READ(1,*)WV_AW_MCF_LUT(IREAD),AW_MCF_LUT(IREAD),RTMP
ENDDO
CLOSE(1)
!testing MCF reading
write(*,*)'MCF AW Data',WV_AW_MCF_LUT(1),AW_MCF_LUT(1)
write(*,*)'MCF AW Data',WV_AW_MCF_LUT(131),AW_MCF_LUT(131)
RETURN
ENDSUBROUTINE WATER_ABSORPTION_MCF_READ

SUBROUTINE WATER_ABSORPTION_READ
USE GLOBAL_DATA
IMPLICIT NONE
INTEGER :: IREAD
call aux_dir_readin
OPEN(UNIT=1,FILE=TRIM(aux_dir)//'/water_coef.txt',STATUS='OLD',ACTION='READ')
DO IREAD=1,30
  READ(1,*)
ENDDO
DO IREAD=1,NWV_PF_LUT
  READ(1,*)WV_PF_LUT(IREAD),AW_PF_LUT(IREAD),BW_PF_LUT(IREAD)
ENDDO
CLOSE(1)
RETURN
ENDSUBROUTINE WATER_ABSORPTION_READ

SUBROUTINE SOURCEF_FLUORESCENCE_INTEGRATION(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,LAMBDAEM)
USE IRRADSUNL
USE RAMANDATA
USE SAVE_OCEAN_MOD
USE FLUORESCENCEDATA
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE

LOGICAL, INTENT(IN):: OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG
REAL*8, INTENT(IN) :: LAMBDAEM
REAL*8,PARAMETER :: IPAR_WV_BEG=400.0D0,IPAR_WV_END=700.0D0
REAL*8, PARAMETER :: PLANK_CONSTANT_TIMES_C=1.98644568D-16  ! UNIT (J nm)
REAL*8, PARAMETER :: Avogadro_Constant=6.02214085774D23
REAL*8 :: NPQ_ADJUST,PSII_RC_FRAC,QUANTUM_YIELD_CHLA_LOCAL,IPAR_AVG

REAL*8 :: INTWEIGHT
INTEGER :: IWVEX,ILAYERW

SOURCEFO_FLUORESCENCE_AGD=0.0D0
IF(OCEAN_FCDOM_FLAG)THEN
  DO IWVEX=1,NFLRSCGRID
    IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
      INTWEIGHT=0.5D0
    ELSE
      INTWEIGHT=1.0D0
    ENDIF
    DO ILAYERW=1,NWATER_DEPTH
       SOURCEFO_FLUORESCENCE_AGD(ILAYERW)= SOURCEFO_FLUORESCENCE_AGD(ILAYERW)+ &
          DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)*ABSORB_COEFF_CDOM_EX(IWVEX,ILAYERW)  &
              *fCDOMfuncjEX(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
    ENDDO
  ENDDO
ENDIF

IF(OCEAN_FCHLA_FLAG)THEN

DO ILAYERW=1,NWATER_DEPTH
  IPAR_SCALAR(ILAYERW)=0.0D0
  DO IWVEX=1,NFLRSCGRID
	 IF(LAMBDAEXFLRSC(IWVEX)<IPAR_WV_BEG .OR.  &
	  LAMBDAEXFLRSC(IWVEX)>IPAR_WV_END)         CYCLE
	 IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
	   INTWEIGHT=0.5D0/1000.0D0 ! mean to conert irradiance unit from W/m^2/micron to W/m^2/nm
	 ELSE
	   INTWEIGHT=1.0D0/1000.0D0 ! mean to conert irradiance unit from W/m^2/micron to W/m^2/nm
	 ENDIF
	 IPAR_SCALAR(ILAYERW)=IPAR_SCALAR(ILAYERW) + DIIRAD_SCALAR_AGD(IWVEX, ILAYERW) * &
						LAMBDAEXFLRSC(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
  ENDDO

ENDDO
! IPAR_SCALAR UNIT=MICRO MOL QUANTA m^{-2} s^{-1}
IPAR_SCALAR=IPAR_SCALAR/PLANK_CONSTANT_TIMES_C/Avogadro_Constant*1.0D6

QUANTUM_YIELD_CHLA_PROFILE=0.0D0
IF(NPQ_FLAG)THEN
  CALL PHOTOCHEMICAL_QUENCHING_IPAR_AVG_CAL(NWATER_DEPTH,WATER_DEPTH,IPAR_SCALAR,IPAR_AVG)
! the following subroutine calculate ET based on Morrison & Goodwin
! but it causes problems which needes to be addressed.
! now ET is set to a fixed value in rttype_sos_rao_dg.f90.
!  CALL PHOTOCHEMICAL_QUENCHING_ET_CAL(IPAR_AVG) ! SET QUANTUM_YIELD_CHLA_ET
ENDIF


DO ILAYERW=1,NWATER_DEPTH
    IF(NPQ_FLAG)THEN

! QUANTUM YIELD MODEL FOLLOWS: J. Ruairidh Morrison,
!    'In situ determination of the quantum yield of phytoplankton
!     chlorophyll a fluorescence: A simple algorithm, observations, and a model,'
!     Limnol. Oceanogr. Vol. 48, Page 618-631, (2003)

! 'Phytoplankton photocompensation from space_based fluorescence measurements'
! J. Ruairidh Morrison and Deborah S. Goodwin, Geophysical Research Letters
! Vol. 37, L06603, 2010.

      PSII_RC_FRAC=EXP(-IPAR_SCALAR(ILAYERW)/QUANTUM_YIELD_CHLA_EK)
      QUANTUM_YIELD_CHLA_LOCAL=PSII_RC_FRAC  * QUANTUM_YIELD_CHLA_MIN + &
               (1.0D0-PSII_RC_FRAC) * QUANTUM_YIELD_CHLA_MAX
      NPQ_ADJUST=QUANTUM_YIELD_CHLA_QI*EXP(-IPAR_SCALAR(ILAYERW)/QUANTUM_YIELD_CHLA_ET)
      QUANTUM_YIELD_CHLA_LOCAL=QUANTUM_YIELD_CHLA_LOCAL*NPQ_ADJUST
    ELSE
      QUANTUM_YIELD_CHLA_LOCAL=0.02D0
    ENDIF
    QUANTUM_YIELD_CHLA_PROFILE(ILAYERW)=QUANTUM_YIELD_CHLA_LOCAL

    DO IWVEX=1,NFLRSCGRID
      IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
        INTWEIGHT=0.5D0
      ELSE
        INTWEIGHT=1.0D0
      ENDIF

     SOURCEFO_FLUORESCENCE_AGD(ILAYERW)= SOURCEFO_FLUORESCENCE_AGD(ILAYERW)     + &
          DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)*ABSORB_COEFF_CHLA_EX(IWVEX,ILAYERW) * &
          QUANTUM_YIELD_CHLA_LOCAL *fCHLAfuncjEX(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
    ENDDO
  ENDDO

ENDIF

SOURCEFO_FLUORESCENCE_AGD=SOURCEFO_FLUORESCENCE_AGD/(4*PI) !phase function is isotropic

ENDSUBROUTINE SOURCEF_FLUORESCENCE_INTEGRATION

SUBROUTINE SOURCEF_EM_INTEGRATION(NQUADOINPUT,MU_IN,MAXMORDINPUT_SAVE)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: NQUADOINPUT,MAXMORDINPUT_SAVE
REAL*8,INTENT(IN) :: MU_IN
REAL*8 :: WAVELENGTH_MICRON
INTEGER :: MAXM_LOCAL,IQUAD,MVAR,ICOM,ILAYERW

REAL*8 :: RTMP1
REAL*8,DIMENSION(:),ALLOCATABLE :: SOURCEOTMP

INTEGER :: IKPP,IWVEX
REAL*8 :: POLINT_SIMPLE
MAXM_LOCAL=MIN(MAXMORDINPUT_SAVE,2)
DO ICOM=1,4
   SOURCEFO_RAMAN_AGD(1:NQUADOINPUT+2,1:NWATER_DEPTH,0:2)%VRAD(ICOM)=0.0D0
ENDDO

ALLOCATE(SOURCEOTMP(NFLRSCGRID))
DO IQUAD=1,NQUADOINPUT+2
DO MVAR=0,MAXM_LOCAL
DO ILAYERW=1,NWATER_DEPTH

DO ICOM=1,4

  DO IWVEX=1,NFLRSCGRID
    SOURCEOTMP(IWVEX)=SOURCEFO_RAMAN_AGD_LUT(IWVEX,IQUAD,ILAYERW,MVAR)%VRAD(ICOM)
  ENDDO
DO IKPP=1,NKGRID
  WAVELENGTH_MICRON=LAMBDAEX(IKPP)/1000.0D0
  IF(LAMBDAEX(IKPP)>LAMBDAEXFLRSC(1) .AND. LAMBDAEX(IKPP)<LAMBDAEXFLRSC(NFLRSCGRID))THEN
     RTMP1=POLINT_SIMPLE(NFLRSCGRID,LAMBDAEXFLRSC,SOURCEOTMP,LAMBDAEX(IKPP),2)
  ELSE
     RTMP1=0.0D0
  ENDIF
  SCATT_COEFF_RAMAN_EX=2.7d-4*(488.0d0/LAMBDAEX(IKPP))**5.3
  SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)= &
  SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)+ &
                       RTMP1*SCATT_COEFF_RAMAN_EX*fRfuncjEX(IKPP)*KppWeight(IKPP)

!if(mvar==0 .and. icom==1 .and. ILAYERW==1 .and. IQUAD==1) then
!  write(*,*)'DK source_em_integration_tsp1',IKPP,LAMBDAEX(IKPP),RTMP1,SCATT_COEFF_RAMAN_EX
!  DO IWVEX=1,NFLRSCGRID
!    write(*,*)'source_em_integration_tsp1,LAMBDAEXFLRSC,SOURCEOTMP ',&
!               LAMBDAEXFLRSC(IWVEX),SOURCEOTMP(IWVEX)
!  ENDDO
!endif

ENDDO

ENDDO

ENDDO
ENDDO
ENDDO

!testing Raman Scattering Source Integration
!DO ILAYERW=1,NWATER_DEPTH
!write(*,*)'tsp_Raman_Integration',WATER_DEPTH(ILAYERW),SOURCEFO_RAMAN_AGD(1,ILAYERW,0)%VRAD(1),&
!          SOURCEFO_RAMAN_AGD(NQUADOINPUT+2,ILAYERW,0)%VRAD(1)
!ENDDO

DEALLOCATE(SOURCEOTMP)

END SUBROUTINE SOURCEF_EM_INTEGRATION


SUBROUTINE OCEAN_RAMAN_SOURCE_LUT_STORE(IWVEX,NQUADOINPUT,WAVELENGTH_MICRON,MU_IN,MAXMORDINPUT_SAVE)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE GLOBAL_DATA, ONLY : ABSORPTION_TAU_REDUCE_FLAG,TAU_REDUCE_OCEAN_PRESERVE
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: IWVEX,NQUADOINPUT,MAXMORDINPUT_SAVE
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,MU_IN

REAL*8 :: POLINT_SIMPLE
INTEGER :: MAXM_LOCAL,ITAU,IQUAD,MVAR,I,ICOM,ILAYERW
REAL*8 :: ESUN_EX

INTEGER :: IULO,MPL,KLO
REAL*8 :: RTMP,RTMP1,RTMP2
REAL*8,DIMENSION(:,:,:),ALLOCATABLE :: SOURCEOTMP
REAL*8,DIMENSION(3)::QSRC,ELCOEFF
REAL*8 :: SQRTSIGN,TAUDIFF,TAUDIFF1

REAL*8, ALLOCATABLE, DIMENSION(:) :: RARRAYTMP
!NUMTOTALTAUEX==NTTAU-OLYR(1)%ITAUS+1
!OITAU_EX==OITAU_PRSV
!IRRAD_SUN_EX==ESUN
!TAU_INELASTIC_EX(1:NUMTOTALTAUEX)==TAU_PRSV(OLYR(1)%ITAUS:NTTAU)-OITAU_PRSV
MAXM_LOCAL=MIN(MAXMORDINPUT_SAVE,2)

MPL=3
IULO=INT(FLOAT(NSUNL)*ABS((WAVELENGTH_MICRON-WVSUN(1))/(WVSUN(NSUNL)-WVSUN(1))))
call hunt(WVSUN,NSUNL,WAVELENGTH_MICRON,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NSUNL-MPL)
CALL POLINT(WVSUN(KLO),FSUN(KLO),MPL,WAVELENGTH_MICRON,ESUN_EX,RTMP)

ALLOCATE(RARRAYTMP(NXJO_Inelas))
ALLOCATE(SOURCEOTMP(1:NUMTOTALTAUEX,1:4,0:2))
DO IQUAD=1,NQUADOINPUT+2
DO MVAR=0,MAXM_LOCAL
DO ICOM=1,4
DO ITAU=1,NUMTOTALTAUEX

    RARRAYTMP=SOURCEFO_RAMAN_TGD(:,ITAU,MVAR)%VRAD(ICOM)
    RTMP=POLINT_SIMPLE(NXJO_Inelas,XJO_Inelas,RARRAYTMP,XJO_MAIN(IQUAD),3)

!   SOURCEOTMP(ITAU,ICOM,MVAR)=ESUN_EX*SOURCEFO_RAMAN_TGD(IQUAD,ITAU,MVAR)%VRAD(ICOM)/IRRAD_SUN_EX(1)
    SOURCEOTMP(ITAU,ICOM,MVAR)=ESUN_EX*RTMP/IRRAD_SUN_EX(1)

!   if(mvar==0 .and. icom==1 .and. SOURCEOTMP(ITAU,ICOM,MVAR)<0.0d0) &
!      write(*,*)'maintsp1',itau,SOURCEOTMP(ITAU,ICOM,MVAR)
ENDDO
ENDDO
ENDDO
DO MVAR=0,MAXM_LOCAL
DO ILAYERW=1,NWATER_DEPTH
  IULO=INT(FLOAT(NUMTOTALTAUEX)*ABS((TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(1))/ &
                   (TAU_INELASTIC_EX(NUMTOTALTAUEX)-TAU_INELASTIC_EX(1))))
  call hunt(TAU_INELASTIC_EX,NUMTOTALTAUEX,TAU_INELASTIC_AGD(ILAYERW),IULO)
  KLO=min(max(IULO-(MPL-1)/2,1),NUMTOTALTAUEX-MPL)
  QSRC(1:3)=SOURCEOTMP(KLO:KLO+2,1,0)
  TAUDIFF=TAU_INELASTIC_EX(KLO+2)-TAU_INELASTIC_EX(KLO)
  RTMP2=(QSRC(2)/QSRC(3))**2-QSRC(1)/QSRC(3)
  IF(RTMP2<0.0D0)RTMP2=0.0D0

  IF(QSRC(1)<QSRC(2) .AND. QSRC(2)<QSRC(3))THEN
     SQRTSIGN=1.0D0
     ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
                                  SQRTSIGN*SQRT(RTMP2))
  ELSE IF(QSRC(1)>QSRC(2) .AND. QSRC(2)>QSRC(3))THEN
     SQRTSIGN=-1.0D0
     ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
                                  SQRTSIGN*SQRT(RTMP2))
  ELSE
     WRITE(*,*)'EM_INTEGRATION, QSRC=',QSRC
     ELCOEFF(1)=0.0d0
  ENDIF
  IF(ELCOEFF(1)>1.0D32)ELCOEFF(1)=0.0D0
  TAUDIFF1=TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(KLO)
  DO ICOM=1,4
     ELCOEFF(2)=SOURCEOTMP(KLO+2,ICOM,MVAR)*EXP(ELCOEFF(1)*TAUDIFF) - SOURCEOTMP(KLO,ICOM,MVAR)
     ELCOEFF(2)=ELCOEFF(2)/TAUDIFF
     ELCOEFF(3)=SOURCEOTMP(KLO,ICOM,MVAR)

     RTMP1=EXP(-ELCOEFF(1)*TAUDIFF1)*(ELCOEFF(3)+ELCOEFF(2)*TAUDIFF1)

! INTERPOLATED VALUE TIMES ABSORPTION DUE TO RESCALED OPTICAL DEPTH
     IF(ABSORPTION_TAU_REDUCE_FLAG)RTMP1=RTMP1*EXP(-TAU_REDUCE_OCEAN_PRESERVE(ILAYERW))
     SOURCEFO_RAMAN_AGD_LUT(IWVEX,IQUAD,ILAYERW,MVAR)%VRAD(ICOM) = RTMP1

!if(mvar==0 .and. icom==1 .and. RTMP1<0.0d0) then
!  write(*,*)'maintsp2',itau,rtmp1,QSRC
!  stop
!endif
   ENDDO

ENDDO
ENDDO
ENDDO

DEALLOCATE(SOURCEOTMP,RARRAYTMP)

DEALLOCATE(XJO_Inelas,PMORAMAN,SPMORAMAN,SOURCEFO_RAMAN_TGD)

END SUBROUTINE OCEAN_RAMAN_SOURCE_LUT_STORE


SUBROUTINE OCEAN_SCALAR_IRRAD_LUT_STORE(IWVEX,WAVELENGTH_MICRON,MU_IN)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE GLOBAL_DATA, ONLY : ABSORPTION_TAU_REDUCE_FLAG,TAU_REDUCE_OCEAN_PRESERVE
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: IWVEX
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,MU_IN
INTEGER :: ITAU,ILAYERW
REAL*8 :: ESUN_EX

INTEGER :: IULO,MPL,KLO
REAL*8 :: RTMP,RTMP1,RTMP2
REAL*8,DIMENSION(3)::QSRC,ELCOEFF
REAL*8 :: SQRTSIGN,TAUDIFF,TAUDIFF1

!NUMTOTALTAUEX==NTTAU-OLYR(1)%ITAUS+1
!OITAU_EX==OITAU_PRSV
!IRRAD_SUN_EX==ESUN
!TAU_INELASTIC_EX(1:NUMTOTALTAUEX)==TAU_PRSV(OLYR(1)%ITAUS:NTTAU)-OITAU_PRSV

MPL=3
IULO=INT(FLOAT(NSUNL)*ABS((WAVELENGTH_MICRON-WVSUN(1))/(WVSUN(NSUNL)-WVSUN(1))))
call hunt(WVSUN,NSUNL,WAVELENGTH_MICRON,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NSUNL-MPL)
CALL POLINT(WVSUN(KLO),FSUN(KLO),MPL,WAVELENGTH_MICRON,ESUN_EX,RTMP)

!write(*,*)'testing DIIRAD_SCALAR_TGD',WAVELENGTH_MICRON,ESUN_EX,IRRAD_SUN_EX(1),DIIRAD_SCALAR_TGD(1)

DIIRAD_SCALAR_TGD=ESUN_EX*DIIRAD_SCALAR_TGD/IRRAD_SUN_EX(1)
DO ILAYERW=1,NWATER_DEPTH
  IULO=INT(FLOAT(NUMTOTALTAUEX)*ABS((TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(1))/ &
     (TAU_INELASTIC_EX(NUMTOTALTAUEX)-TAU_INELASTIC_EX(1))))
  call hunt(TAU_INELASTIC_EX,NUMTOTALTAUEX,TAU_INELASTIC_AGD(ILAYERW),IULO)
  KLO=min(max(IULO-(MPL-1)/2,1),NUMTOTALTAUEX-MPL)
!  CALL POLINT(TAU_INELASTIC_EX(KLO),RARRAYTMP(KLO),MPL,TAU_INELASTIC_AGD(ILAYERW),RTMP1,RTMP)
  QSRC(1:3)=DIIRAD_SCALAR_TGD(KLO:KLO+2)
  TAUDIFF=TAU_INELASTIC_EX(KLO+2)-TAU_INELASTIC_EX(KLO)
  RTMP2=(QSRC(2)/QSRC(3))**2-QSRC(1)/QSRC(3)
  IF(RTMP2<0.0D0)RTMP2=0.0D0

  IF(QSRC(1)<QSRC(2) .AND. QSRC(2)<QSRC(3))THEN
    SQRTSIGN=1.0D0
    ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
             SQRTSIGN*SQRT(RTMP2))
  ELSE IF(QSRC(1)>QSRC(2) .AND. QSRC(2)>QSRC(3))THEN
    SQRTSIGN=-1.0D0
    ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
              SQRTSIGN*SQRT(RTMP2))
  ELSE
    WRITE(*,*)'IRRAD_LUT_STORE,QSRC=',QSRC
    ELCOEFF(1)=0.0d0
  ENDIF
  IF(ELCOEFF(1)>1.0D32)ELCOEFF(1)=0.0D0
  TAUDIFF1=TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(KLO)
  ELCOEFF(2)=DIIRAD_SCALAR_TGD(KLO+2)*EXP(ELCOEFF(1)*TAUDIFF) - DIIRAD_SCALAR_TGD(KLO)
  ELCOEFF(2)=ELCOEFF(2)/TAUDIFF
  ELCOEFF(3)=DIIRAD_SCALAR_TGD(KLO)

  RTMP1=EXP(-ELCOEFF(1)*TAUDIFF1)*(ELCOEFF(3)+ELCOEFF(2)*TAUDIFF1)
  IF(ABSORPTION_TAU_REDUCE_FLAG)RTMP1=RTMP1*EXP(-TAU_REDUCE_OCEAN_PRESERVE(ILAYERW))

  DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)= RTMP1
!if(RTMP1<0.0d0) then
!write(*,*)'maintsp3',ILAYERW,rtmp1,QSRC
!stop
!endif

ENDDO

DEALLOCATE(DIIRAD_SCALAR_TGD)

END SUBROUTINE OCEAN_SCALAR_IRRAD_LUT_STORE

SUBROUTINE WATER_DEPTH_SETUP
USE GLOBAL_DATA
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
IMPLICIT NONE

INTEGER :: INTTMP,IWVEX,IWV,IWVEXSTART
REAL*8 RTMP

!WATER_DET_FREE_LOCATION=.false.

!IF(WATER_DET_FREE_LOCATION)THEN
!  DET_INWATER_REPORT_DEPTH_INCREMENT=4.0D0
!  DO INTTMP=1,N_DET_INWATER_REPORT
!    DET_INWATER_REPORT_DEPTH(INTTMP)=(INTTMP-1)*DET_INWATER_REPORT_DEPTH_INCREMENT
!  ENDDO
!ENDIF

write(*,*)'WATER_DEPTH_MAX=',WATER_DEPTH_MAX

!IF(WATER_DET_FREE_LOCATION .AND. DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT)>WATER_DEPTH_MAX) THEN
!  WRITE(*,*) 'DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT),WATER_DEPTH_MAX=', &
!  DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT),WATER_DEPTH_MAX
!  WRITE(*,*) 'WARNING, DETECTOR DEPTH IS LARGER THAN WATER_DEPTH_MAX'
!  WRITE(*,*) 'INCREASE WATER_DEPTH_MAX OR WATER_OD_MAX, AND RERUN'
!  STOP
!ENDIF
!WRITE(*,*)'NWATER_DEPTH,WATER_DEPTH_MAX=',NWATER_DEPTH,WATER_DEPTH_MAX

RTMP=WATER_DEPTH_MAX/(NWATER_DEPTH-1.0D0)
WATER_DEPTH(1)=0.0D0
DO INTTMP=2,NWATER_DEPTH
  WATER_DEPTH(INTTMP)=WATER_DEPTH(INTTMP-1)+RTMP
ENDDO

END SUBROUTINE WATER_DEPTH_SETUP

SUBROUTINE CHLAPROFILE(WATER_DEPTH_Val,CHLaVal,CHLaLOCAL)

USE GLOBAL_DATA, ONLY : CHLA_HOMOGENEITY,CHLA_C0,CHLA_Slope,CHLA_Cmax, &
                        CHLA_Etamax,CHLA_DeltaEta
IMPLICIT NONE

REAL*8,INTENT(IN) :: WATER_DEPTH_Val,CHLaVal
REAL*8,INTENT(OUT) :: CHLaLOCAL

REAL*8 :: ChlaZeu,ChlaZeuAvg,Zeu,ChlaD0,chla_eta,eta

IF(CHLaVal<1.0E-6 .OR. CHLA_HOMOGENEITY) THEN
   CHLaLOCAL=CHLaVal
   RETURN
ENDIF

CHLA_C0=0.471d0
CHLA_Slope=0.135d0
CHLA_Cmax=1.572d0
CHLA_Etamax=0.969d0
CHLA_DeltaEta=0.393d0


IF(CHLaVal<1.0d0)THEN
   ChlaZeu=36.1D0*CHLaVal**0.357D0
  !Table 4, Uitz et al, J. GEOPHYSICAL RESEARCH,
  ! VOL. 111, C08005, doi:10.1029/2005JC003207, 2006
ELSE
   ChlaZeu=37.7D0*CHLaVal**0.615D0
  ! Table 4, Uitz et al, J. GEOPHYSICAL RESEARCH,
  ! VOL. 111, C08005, doi:10.1029/2005JC003207, 2006
ENDIF
Zeu=568.2d0*ChlaZeu**(-0.746d0)
IF(Zeu>102.0D0)Zeu=200.D0*ChlaZeu**(-0.293D0);
eta=WATER_DEPTH_Val/Zeu;
ChlaZeuAvg=ChlaZeu/Zeu;
chla_eta=CHLA_C0-CHLA_Slope*eta+CHLA_Cmax*exp(-(eta-CHLA_Etamax)**2/CHLA_DeltaEta**2);
ChlaD0=CHLA_C0+CHLA_Cmax*exp(-CHLA_Etamax**2/CHLA_DeltaEta**2)
CHLaLOCAL=chla_eta/ChlaD0*CHLaVal
IF(CHLaLOCAL<0.0d0)CHLaLOCAL=0.0d0
!write(*,*)'WATER_DEPTH_Val,CHLaLOCAL=',WATER_DEPTH_Val,CHLaLOCAL
RETURN
END SUBROUTINE CHLAPROFILE

SUBROUTINE ABS_COEFF_INIT
USE GLOBAL_DATA, ONLY :NWV,WV,GAS_ABS_COEFF,GAS_ABS_COEFF_H2O,GAS_ABS_COEFF_CO2, &
				GAS_ABS_COEFF_CH4,GAS_ABS_COEFF_O2, GAS_ABS_COEFF_O3,GAS_ABS_COEFF_NO2
USE Atmosphere_Profile, ONLY :NPGRID,P_GRID,Z_FIELD,TEM_FIELD,             &
				NUMDEN_TOTAL_FIELD,VMR_OZONE_FIELD,VMR_OXYGEN_FIELD,&
				VMR_H2O_FIELD,VMR_CO2_FIELD,VMR_NO2_FIELD,VMR_CH4_FIELD
USE H2O_ABS_DATA
USE CO2_ABS_DATA
USE CH4_ABS_DATA
USE OXYGEN2_ABS_DATA
USE OZONE_ABS_DATA
USE NO2_ABS_DATA
USE O4_ABS_DATA
IMPLICIT NONE

INTEGER,DIMENSION(7) :: GAS_INDX_FLAG=(/1,1,1,1,1,1,1/)

integer :: iwv,ipgrid
real*8 :: rtmp

GAS_ABS_COEFF=0.0D0
GAS_ABS_COEFF_H2O=0.0d0
GAS_ABS_COEFF_CO2=0.0d0
GAS_ABS_COEFF_CH4=0.0d0
GAS_ABS_COEFF_O2=0.0d0
GAS_ABS_COEFF_O3=0.0d0
GAS_ABS_COEFF_NO2=0.0d0

IF(GAS_INDX_FLAG(1)>0)THEN
  CALL H2O_ABS_READIN
  CALL H2O_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_H2O_FIELD,GAS_ABS_COEFF_H2O)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init H2O'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init H2O'
!ENDIF
!enddo
!enddo


IF(GAS_INDX_FLAG(2)>0)THEN
  CALL CO2_ABS_READIN
  CALL CO2_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_CO2_FIELD,GAS_ABS_COEFF_CO2)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CO2'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CO2'
!ENDIF
!enddo
!enddo


IF(GAS_INDX_FLAG(3)>0)THEN
  CALL CH4_ABS_READIN
  CALL CH4_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_CH4_FIELD,GAS_ABS_COEFF_CH4)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CH4'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CH4'
!ENDIF
!enddo
!enddo

IF(GAS_INDX_FLAG(4)>0)THEN
  CALL OXYGEN2_ABS_READIN
  CALL OXYGEN2_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_OXYGEN_FIELD,GAS_ABS_COEFF_O2)
ENDIF

!rtmp=0.0d0
!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O2'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O2'
!ENDIF
!rtmp=rtmp+GAS_ABS_COEFF(iwv,ipgrid)
!enddo
!enddo

IF(GAS_INDX_FLAG(5)>0)THEN
  CALL OZONE_ABS_READIN
  CALL OZONE_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_OZONE_FIELD,GAS_ABS_COEFF_O3)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init OZONE'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init OZONE'
!ENDIF
!
!enddo
!enddo


IF(GAS_INDX_FLAG(6)>0)THEN
  CALL NO2_ABS_READIN
  CALL NO2_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_NO2_FIELD,GAS_ABS_COEFF_NO2)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init NO2'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init NO2'
!ENDIF
!enddo
!enddo

IF(GAS_INDX_FLAG(7)>0)THEN
  CALL O4_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_OXYGEN_FIELD,GAS_ABS_COEFF_O2)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O4'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O4'
!ENDIF
!enddo
!enddo

GAS_ABS_COEFF=  GAS_ABS_COEFF_H2O + GAS_ABS_COEFF_CO2  &
			  + GAS_ABS_COEFF_CH4 + GAS_ABS_COEFF_O2   &
			  + GAS_ABS_COEFF_O3  + GAS_ABS_COEFF_NO2


END SUBROUTINE ABS_COEFF_INIT


SUBROUTINE TAU_TG_INIT_INELASTIC(GAS_ABS_FLAG,NTLYERA,WAVELENGTH_NANOMETER,TAU_TG)
USE GLOBAL_DATA, ONLY :NWV,WV,GAS_ABS_COEFF,ALT_LYRA
USE Atmosphere_Profile, ONLY : NPGRID,Z_FIELD

USE FLUORESCENCEDATA,ONLY : DELTALAMBDAEXFLRSC
IMPLICIT NONE
LOGICAL, INTENT(IN) :: GAS_ABS_FLAG
INTEGER,INTENT(IN) :: NTLYERA
!REAL*8,DIMENSION(1:NTLYERA+1),INTENT(IN)::ALT_LYRA
REAL*8,INTENT(IN) :: WAVELENGTH_NANOMETER
REAL*8,DIMENSION(NTLYERA),INTENT(OUT)::TAU_TG

INTEGER :: N_INT_SIZE
REAL*8 :: POLINT_SIMPLE,ILS_INT_CONST,TRAPZOID
REAL*8,DIMENSION(:),ALLOCATABLE :: XU,YU,ZU

REAL*8,DIMENSION(:,:),ALLOCATABLE :: TAU_ABS_GRID,TAU_ABS_CUMSUM,TAU_TG_TEMP

INTEGER :: INTTMP,ILAYER,IWV_AVG,IWV_START,IWV_END

INTEGER,DIMENSION(1) ::LOCINDXTMP,LOCINDXTMP1
REAL*8 :: RTMP,WV_TMP,GAS_ABS_TMP
REAL*8,DIMENSION(:),ALLOCATABLE :: RARRAYTMP

IF(.NOT. GAS_ABS_FLAG)THEN
  TAU_TG=0.0D0
  RETURN
ENDIF


LOCINDXTMP=MINLOC(ABS(WAVELENGTH_NANOMETER-0.5D0*DELTALAMBDAEXFLRSC-WV))
LOCINDXTMP1=MINLOC(ABS(WAVELENGTH_NANOMETER+0.5D0*DELTALAMBDAEXFLRSC-WV))

IWV_START=LOCINDXTMP(1)
IWV_END  =LOCINDXTMP1(1)
IF(IWV_END<=IWV_START)THEN
   WRITE(*,*)WV(1),WV(NWV),WAVELENGTH_NANOMETER,DELTALAMBDAEXFLRSC
   STOP 'CHECK WV AND WAVELENGTH_NANOMETER AND DELTALAMBDAEXFLRSC'
ENDIF

N_INT_SIZE=IWV_END-IWV_START+1
ALLOCATE(  TAU_ABS_GRID(IWV_START:IWV_END,1:NPGRID), &
         TAU_ABS_CUMSUM(IWV_START:IWV_END,1:NPGRID), &
         TAU_TG_TEMP(IWV_START:IWV_END,1:NTLYERA),   &
         XU(N_INT_SIZE),YU(N_INT_SIZE),ZU(NTLYERA))

XU(1:N_INT_SIZE)=WV(IWV_START:IWV_END)

IF(ALT_LYRA(1)>Z_FIELD(1))THEN
	WRITE(*,*)'TAU_TG_INIT_INELASTIC CHECK, ALT_LYRA(1),Z_FIELD(1)=',ALT_LYRA(1),Z_FIELD(1)
	STOP 'WARNING, ALT_LYRA DATA RANGE LARGER THAN Z_FIELD'
ENDIF
! Z_FIELD IS IN KM
! MULTIPLY BY 1000 TO INTEGRATE AND GET TAU_ABS_GRID
TAU_ABS_CUMSUM=0.0D0
TAU_ABS_GRID=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(IWV_START:IWV_END,INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF(IWV_START:IWV_END,INTTMP-1) + GAS_ABS_COEFF(IWV_START:IWV_END,INTTMP))
  TAU_ABS_CUMSUM(IWV_START:IWV_END,INTTMP) = &
     TAU_ABS_CUMSUM(IWV_START:IWV_END,INTTMP-1)+TAU_ABS_GRID(IWV_START:IWV_END,INTTMP)
ENDDO

DO IWV_AVG=IWV_START,IWV_END
ZU=TAU_ABS_CUMSUM(IWV_AVG,:)
DO INTTMP=1,NTLYERA
   TAU_TG_TEMP(IWV_AVG,INTTMP)=POLINT_SIMPLE(NPGRID,Z_FIELD,ZU,ALT_LYRA(INTTMP+1),3)
ENDDO
DO INTTMP=NTLYERA,2,-1
   TAU_TG_TEMP(IWV_AVG,INTTMP)=TAU_TG_TEMP(IWV_AVG,INTTMP)-TAU_TG_TEMP(IWV_AVG,INTTMP-1)
ENDDO
ENDDO

DO INTTMP=1,NTLYERA
  YU(1:N_INT_SIZE)=EXP(-TAU_TG_TEMP(IWV_START:IWV_END,INTTMP) )
  TAU_TG(INTTMP)=TRAPZOID(N_INT_SIZE,XU,YU)/(WV(IWV_END)-WV(IWV_START))
ENDDO

TAU_TG=-LOG(TAU_TG)

DEALLOCATE(TAU_ABS_GRID,TAU_ABS_CUMSUM,TAU_TG_TEMP,XU,YU,ZU)

ENDSUBROUTINE TAU_TG_INIT_INELASTIC


SUBROUTINE TAU_TG_INIT(GAS_ABS_FLAG,NTLYERA,WAVELENGTH_NANOMETER,TAU_TG, &
                TAU_TG_H2O,TAU_TG_CO2,TAU_TG_CH4,TAU_TG_O2,TAU_TG_O3,TAU_TG_NO2)
USE GLOBAL_DATA, ONLY :NWV,WV,GAS_ABS_COEFF,ALT_LYRA, &
              GAS_ABS_COEFF_H2O,GAS_ABS_COEFF_CO2,GAS_ABS_COEFF_CH4, &
              GAS_ABS_COEFF_O2, GAS_ABS_COEFF_O3,GAS_ABS_COEFF_NO2
USE Atmosphere_Profile, ONLY : NPGRID,Z_FIELD

IMPLICIT NONE
LOGICAL, INTENT(IN) :: GAS_ABS_FLAG
INTEGER,INTENT(IN) :: NTLYERA
!REAL*8,DIMENSION(1:NTLYERA+1),INTENT(IN)::ALT_LYRA
REAL*8,INTENT(IN) :: WAVELENGTH_NANOMETER
REAL*8,DIMENSION(NTLYERA),INTENT(OUT)::TAU_TG, TAU_TG_H2O,TAU_TG_CO2,TAU_TG_CH4, &
                                       TAU_TG_O2,TAU_TG_O3,TAU_TG_NO2

REAL*8 :: POLINT_SIMPLE

REAL*8,DIMENSION(:),ALLOCATABLE ::TAU_ABS_GRID,TAU_ABS_CUMSUM, TAU_ABS_H2O_CUMSUM, &
                           TAU_ABS_CO2_CUMSUM, TAU_ABS_CH4_CUMSUM, TAU_ABS_O2_CUMSUM, &
                           TAU_ABS_O3_CUMSUM,TAU_ABS_NO2_CUMSUM

INTEGER :: INTTMP,ILAYER,IWV_INDX
INTEGER,DIMENSION(1) ::LOCINDXTMP
REAL*8 :: RTMP

IF(.NOT. GAS_ABS_FLAG)THEN
  TAU_TG=0.0D0
  TAU_TG_H2O=0.0D0
  TAU_TG_CO2=0.0D0
  TAU_TG_CH4=0.0D0
  TAU_TG_O2=0.0D0
  TAU_TG_O3=0.0D0
  TAU_TG_NO2=0.0D0
  RETURN
ENDIF

IF(ALT_LYRA(1)>Z_FIELD(1)) THEN
  WRITE(*,*)'TAU_TG_INIT CHECK, ALT_LYRA(1),Z_FIELD(1)=',ALT_LYRA(1),Z_FIELD(1)
  STOP 'WARNING, ALT_LYRA DATA RANGE LARGER THAN Z_FIELD'
ENDIF

ALLOCATE(TAU_ABS_GRID(NPGRID),TAU_ABS_CUMSUM(NPGRID), TAU_ABS_H2O_CUMSUM(NPGRID), &
		TAU_ABS_CO2_CUMSUM(NPGRID), TAU_ABS_CH4_CUMSUM(NPGRID), TAU_ABS_O2_CUMSUM(NPGRID), &
		TAU_ABS_O3_CUMSUM(NPGRID),TAU_ABS_NO2_CUMSUM(NPGRID))


LOCINDXTMP=MINLOC(ABS(WAVELENGTH_NANOMETER-WV))
IWV_INDX=LOCINDXTMP(1)
! Z_FIELD IS IN KM
! MULTIPLY BY 1000 TO INTEGRATE AND GET TAU_ABS_GRID
TAU_ABS_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF(IWV_INDX,INTTMP-1)+GAS_ABS_COEFF(IWV_INDX,INTTMP))
  TAU_ABS_CUMSUM(INTTMP)=TAU_ABS_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO

TAU_ABS_H2O_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF_H2O(IWV_INDX,INTTMP-1)+GAS_ABS_COEFF_H2O(IWV_INDX,INTTMP))
  TAU_ABS_H2O_CUMSUM(INTTMP)=TAU_ABS_H2O_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO

TAU_ABS_CO2_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF_CO2(IWV_INDX,INTTMP-1)+GAS_ABS_COEFF_CO2(IWV_INDX,INTTMP))
  TAU_ABS_CO2_CUMSUM(INTTMP)=TAU_ABS_CO2_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO

TAU_ABS_CH4_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF_CH4(IWV_INDX,INTTMP-1)+GAS_ABS_COEFF_CH4(IWV_INDX,INTTMP))
  TAU_ABS_CH4_CUMSUM(INTTMP)=TAU_ABS_CH4_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO

TAU_ABS_O2_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF_O2(IWV_INDX,INTTMP-1)+GAS_ABS_COEFF_O2(IWV_INDX,INTTMP))
  TAU_ABS_O2_CUMSUM(INTTMP)=TAU_ABS_O2_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO

TAU_ABS_O3_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF_O3(IWV_INDX,INTTMP-1)+GAS_ABS_COEFF_O3(IWV_INDX,INTTMP))
  TAU_ABS_O3_CUMSUM(INTTMP)=TAU_ABS_O3_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO

TAU_ABS_NO2_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF_NO2(IWV_INDX,INTTMP-1)+GAS_ABS_COEFF_NO2(IWV_INDX,INTTMP))
  TAU_ABS_NO2_CUMSUM(INTTMP)=TAU_ABS_NO2_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO

!write(*,*)'Z_field,TAU_ABS_GRID,TAU_ABS_CUMSUM'
!DO INTTMP=1,NPGRID
!write(*,*)INTTMP,Z_FIELD(INTTMP),TAU_ABS_GRID(INTTMP),TAU_ABS_CUMSUM(INTTMP)
!ENDDO

DO INTTMP=1,NTLYERA
   TAU_TG(INTTMP)=POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_CUMSUM,ALT_LYRA(INTTMP+1),3)

   TAU_TG_H2O(INTTMP)=POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_H2O_CUMSUM,ALT_LYRA(INTTMP+1),3)
   TAU_TG_CO2(INTTMP)=POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_CO2_CUMSUM,ALT_LYRA(INTTMP+1),3)
   TAU_TG_CH4(INTTMP)=POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_CH4_CUMSUM,ALT_LYRA(INTTMP+1),3)
   TAU_TG_O2(INTTMP) =POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_O2_CUMSUM, ALT_LYRA(INTTMP+1),3)
   TAU_TG_O3(INTTMP) =POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_O3_CUMSUM, ALT_LYRA(INTTMP+1),3)
   TAU_TG_NO2(INTTMP)=POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_NO2_CUMSUM,ALT_LYRA(INTTMP+1),3)
ENDDO

DO INTTMP=NTLYERA,2,-1
	TAU_TG(INTTMP)=TAU_TG(INTTMP)-TAU_TG(INTTMP-1)

	TAU_TG_H2O(INTTMP)=TAU_TG_H2O(INTTMP)- TAU_TG_H2O(INTTMP-1)
	TAU_TG_CO2(INTTMP)=TAU_TG_CO2(INTTMP)- TAU_TG_CO2(INTTMP-1)
	TAU_TG_CH4(INTTMP)=TAU_TG_CH4(INTTMP)- TAU_TG_CH4(INTTMP-1)
	TAU_TG_O2(INTTMP) =TAU_TG_O2(INTTMP) - TAU_TG_O2(INTTMP-1)
	TAU_TG_O3(INTTMP) =TAU_TG_O3(INTTMP) - TAU_TG_O3(INTTMP-1)
	TAU_TG_NO2(INTTMP)=TAU_TG_NO2(INTTMP)- TAU_TG_NO2(INTTMP-1)

ENDDO

!write(*,*)'ALT_LYRA,TAU_TG'
!DO INTTMP=1,NTLYERA
!write(*,*)INTTMP,ALT_LYRA(INTTMP+1),TAU_TG(INTTMP)
!ENDDO
DEALLOCATE( TAU_ABS_GRID,TAU_ABS_CUMSUM, TAU_ABS_H2O_CUMSUM, &
			TAU_ABS_CO2_CUMSUM, TAU_ABS_CH4_CUMSUM, TAU_ABS_O2_CUMSUM, &
			TAU_ABS_O3_CUMSUM,TAU_ABS_NO2_CUMSUM)

ENDSUBROUTINE TAU_TG_INIT


SUBROUTINE WV_LBL_SETUP
USE GLOBAL_DATA, ONLY : NWV, WV,NWV_SEG1,NWV_SEG2
IMPLICIT NONE
INTEGER,PARAMETER :: N_BAND_INDX=25
REAL*8, DIMENSION(N_BAND_INDX):: WAVELENGTH_STEP= &
             (/1.0d0,   0.5d0, 0.01d0,   0.5d0, 0.005d0,   0.5d0,  0.01d0,  &
			   0.5d0, 0.005d0, 0.01d0,   0.5d0, 0.005d0,  0.01d0,   0.2d0,  &
               0.1d0,  0.02d0,  0.1d0,                                      &
               1.0d0,                                                       &
               0.1d0,                                                       &
               0.1d0,  0.02d0,  0.1d0,                                      &
               0.1d0,                                                       &
               0.05d0,                                                      &
               1.0d0/)
REAL*8, DIMENSION(N_BAND_INDX):: WAVELENGTH_BAND_START=                     &
           (/299.0d0, 349.5d0, 586.d0, 606.0d0, 627.0d0, 637.0d0, 641.0d0,  &
             666.0d0, 686.0d0, 700.d0, 751.0d0, 758.0d0, 780.0d0, 856.0d0,  &
	         896d0,     918d0, 962.7d0,                                     &
			 985.0d0,                                                       &
			 1220.d0,                                                       &
			 1348d0, 1363.1d0, 1393.2d0,                                    &
			 1540.0d0,                                                      &
			 2080.0d0,                                                      &
			 2185.0d0/)
INTEGER, DIMENSION(N_BAND_INDX):: WAVELENGTH_BAND_SIZE=                     &
              (/  50,     474,   2000,      42,    2000,       8,    2500,  &
                  40,    2800,   5100,      14,    4400,    7600,     195,  &
			      219,   2230,   220,                                       &
				  130,                                                      &
				  600,                                                      &
				  150,   1500,   150,                                       &
				  1501,                                                     &
				  2001,                                                     &
				  150/)

INTEGER :: IWV,I_BAND_INDX,I_WV_DSPLC

IF(NWV .NE. NWV_SEG1+NWV_SEG2) STOP 'NWV .NE. NWV_SEG1+NWV_SEG2'
IWV=SUM(WAVELENGTH_BAND_SIZE(1:14))
IF(NWV_SEG1 .NE. IWV) STOP 'CHECK NWV_SEG1'

I_WV_DSPLC=0
DO I_BAND_INDX=1,N_BAND_INDX
  IF(I_BAND_INDX>1)I_WV_DSPLC=I_WV_DSPLC+WAVELENGTH_BAND_SIZE(I_BAND_INDX-1)
  DO IWV=1,WAVELENGTH_BAND_SIZE(I_BAND_INDX)
    WV(I_WV_DSPLC+IWV)=WAVELENGTH_BAND_START(I_BAND_INDX) + &
                         IWV*WAVELENGTH_STEP(I_BAND_INDX)
  ENDDO
ENDDO

IF(I_WV_DSPLC+WAVELENGTH_BAND_SIZE(N_BAND_INDX) .NE. NWV)STOP 'CHECK WV ASSIGNMENT'
END SUBROUTINE WV_LBL_SETUP

SUBROUTINE Particle_PHMX_Assign(NUMMIEUSE,NWV_PHMX,IAEROSOL,IRH,REFF1_Save,    &
                 REFF2_Save,VEFF1_Save,VEFF2_Save,MRR1_Save,MRI1_Save,MRR2_Save,&
                 MRI2_Save,ARSLND1_Save,ARSLND2_Save)
USE MIE_PHMX_PACE
USE GLOBAL_DATA,ONLY : OCEAN_CASE_SELECT,                                   &
                PHYTOPLANKTON_INDEX_REFRACTION,PHYTOPLANKTON_SPECTRAL_SLOPE,&
                SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE
IMPLICIT NONE
INTEGER, INTENT(IN)::NUMMIEUSE,NWV_PHMX,IAEROSOL,IRH
REAL*8,DIMENSION(NUMMIEUSE),INTENT(OUT) :: REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,&
                                           ARSLND1_Save,ARSLND2_Save
REAL*8,DIMENSION(NUMMIEUSE,NWV_PHMX),INTENT(OUT) ::MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save

REAL*8::REFF1_LOCAL,VEFF1_LOCAL,REFF2_LOCAL,VEFF2_LOCAL,ARSLND1_LOCAL,ARSLND2_LOCAL
REAL*8,DIMENSION(:),ALLOCATABLE::MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL

INTEGER :: FREEFORMFLAG
FREEFORMFLAG=1

IF(NWV_PHMX .NE. NWV_BAND)STOP 'CHECK NWV_PHMX'
ALLOCATE(MRR1_LOCAL(NWV_PHMX),MRI1_LOCAL(NWV_PHMX),MRR2_LOCAL(NWV_PHMX),MRI2_LOCAL(NWV_PHMX))

IF(FREEFORMFLAG==0)THEN
    REFF1_LOCAL=0.1D0
    REFF2_LOCAL=0.1D0
    VEFF1_LOCAL=1.D0
    VEFF2_LOCAL=0.5D0
    MRR1_LOCAL=1.45D0
    MRI1_LOCAL=0.0D0
    MRR2_LOCAL=1.45D0
    MRI2_LOCAL=0.0D0
    ARSLND1_LOCAL=0.99d0
    ARSLND2_LOCAL=0.01d0
ENDIF

CALL PHMXMIE_PACE_INIT(FREEFORMFLAG,IAEROSOL,IRH,REFF1_LOCAL,VEFF1_LOCAL,      &
          REFF2_LOCAL,VEFF2_LOCAL,MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL, &
          ARSLND1_LOCAL,ARSLND2_LOCAL,PHYTOPLANKTON_INDEX_REFRACTION,&
          PHYTOPLANKTON_SPECTRAL_SLOPE,SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE)

REFF1_Save=REFF1_LOCAL
REFF2_Save=REFF2_LOCAL
VEFF1_Save=VEFF1_LOCAL
VEFF2_Save=VEFF2_LOCAL
ARSLND1_Save=ARSLND1_LOCAL
ARSLND2_Save=ARSLND2_LOCAL

MRR1_Save(1,:)=MRR1_LOCAL
MRI1_Save(1,:)=MRI1_LOCAL
MRR2_Save(1,:)=MRR2_LOCAL
MRI2_Save(1,:)=MRI2_LOCAL

IF(OCEAN_CASE_SELECT==2)THEN
  DO FREEFORMFLAG=2,3
    CALL PHMXMIE_PACE_INIT(FREEFORMFLAG,IAEROSOL,IRH,REFF1_LOCAL,VEFF1_LOCAL,  &
          REFF2_LOCAL,VEFF2_LOCAL,MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL, &
          ARSLND1_LOCAL,ARSLND2_LOCAL,PHYTOPLANKTON_INDEX_REFRACTION,&
          PHYTOPLANKTON_SPECTRAL_SLOPE,SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE)
  ENDDO
ENDIF
DEALLOCATE(MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL)

END SUBROUTINE Particle_PHMX_Assign

