! pay attention to PHIOUT in both STOKESOUT and MUPHIOUTASS
MODULE GLOBAL_DATA
LOGICAL :: SEG3ONLY
INTEGER :: NDET
INTEGER,PARAMETER :: NOPT=7,NWNDSPD=3,NCHLa=8,NWV=128,NWV_SEG2=6,NWV_SEG3=13

INTEGER, PARAMETER :: NWV_CHANNEL_AVG=5
REAL*8,PARAMETER :: WV_START=0.350D0,WV_END=1.D0,WV_CHANNEL_WIDTH=0.005D0
REAL*8 :: WV_AVG_RESOLUTION
REAL*8,DIMENSION(NWV_CHANNEL_AVG)::ILS_PACE

REAL*8,DIMENSION(NWV):: WV
REAL*8,DIMENSION(NOPT) :: TAU550=(/0.0d0, 0.05d0, 0.10d0, 0.15D0, 0.2d0,0.30d0,0.5D0/)

INTEGER,PARAMETER :: NTHETA0=6,NFINEMODE=10
REAL*8,DIMENSION(NWV):: AW,BBW,BWRAMAN,BW
REAL*8,DIMENSION(NWV) ::BPTC,BBPTC,BBPTCfrac,APTC,ACDM
REAL*8,DIMENSION(NWV) ::BSTC,ASTC

INTEGER,PARAMETER ::NWV_PF_LUT=2250
REAL*8,DIMENSION(NWV_PF_LUT) :: WV_PF_LUT,AW_PF_LUT,BW_PF_LUT

INTEGER,PARAMETER ::NWV_AW_LEE_LUT=144
REAL*8,DIMENSION(NWV_AW_LEE_LUT) :: WV_AW_LEE_LUT,AW_LEE_LUT

!REAL*8,DIMENSION(NCHLa) :: CHLa=(/0.0,0.03, 0.1, 0.3, 1.0, 1.35, 1.71, 1.65, 2.43, 3.0/)
REAL*8,DIMENSION(NCHLa) :: CHLa=(/0.0d0,0.03d0,0.05d0, 0.1d0, 0.3d0, 1.0d0, 3.0d0, 10.0d0/)
LOGICAL :: CHLA_HOMOGENEITY
REAL*8 :: CHLA_C0,CHLA_Slope,CHLA_Cmax, CHLA_Etamax,CHLA_DeltaEta
REAL*8 :: PHYTOPLANKTON_INDEX_REFRACTION,PHYTOPLANKTON_SPECTRAL_SLOPE, &
          SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE,        &
          SEDIMENT_CONCENTRATION,ACDM400

! Atmospheric Gas absorption data
INTEGER,PARAMETER :: NPGRID=200
INTEGER,PARAMETER :: NWV_GAS_ABS_TABLE=1950
REAL*8,DIMENSION(NWV_GAS_ABS_TABLE)::WV_GAS_ABS_TABLE
REAL*8,DIMENSION(NWV_GAS_ABS_TABLE,NPGRID):: GAS_ABS_COEFF_TABLE
REAL*8,DIMENSION(NPGRID):: P_GRID,Z_FIELD,TEM_FIELD,O2VMR_FIELD,H2OVMR_FIELD

REAL*8,DIMENSION(NWV) :: RINDX_WATER
REAL*8,DIMENSION(NWNDSPD)::WNDSPD=(/0.0D0,5.0D0,10.0D0/)
REAL*8,DIMENSION(NTHETA0)::THETA0=(/0.d0,15.0d0,30.d0,45.0d0,60.0d0,75.0d0/)
REAL*8,PARAMETER :: DEPOL_A=0.0284D0, DEPOL_O=0.087D0
REAL*8,PARAMETER :: Xi_kok=25.6d0,Alpha_kok=4.0d0, T0_kok=0.25d0,Dpol90_Kok=0.67d0

!PURE SEA WATER Depolarization ratio value from Zhang X, OE, 2009,
    ! also see Jonasz and Fournier, 2007
REAL*8 :: NMBREINPUT,NMBIMINPUT
LOGICAL :: sngmode,OCEAN_RAMAN_FLAG,OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,&
           HYSPECTRAL_FLAG,OCEAN_PHMX_ONE

LOGICAL :: ABSORPTION_TAU_REDUCE_FLAG
REAL*8,DIMENSION(:), ALLOCATABLE ::TAU_REDUCE_ATMOS_PRESERVE,TAU_REDUCE_OCEAN_PRESERVE

REAL*8,PARAMETER :: ABSORPTION_TAU_REPLACE=0.1D0
LOGICAL :: WATER_DET_FREE_LOCATION
INTEGER,PARAMETER :: N_DET_INWATER_REPORT=21
REAL*8 :: DET_INWATER_REPORT_DEPTH_INCREMENT
REAL*8,DIMENSION(N_DET_INWATER_REPORT):: DET_INWATER_REPORT_DEPTH ! LARGEST WATER DETECT DEPTH REPORTED

INTEGER :: OCEAN_CASE_SELECT
                              !==0 no ocean water body
                              !==1 CASE 1 WATER IOPS
                              !==2 CASE 2 WATER IOPS

ENDMODULE GLOBAL_DATA

PROGRAM SOSINT
USE GLOBAL_DATA
USE AEROSOL_MICROPHYSICAL_MODEL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE IRRADSUNL
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE

REAL*8 :: LAMBDAEM
INTEGER:: Indx_Inelastic_Scattering ! index number to controll elastic or inelastic scattering calculations
!Indx_Inelastic_Scattering=0  ! elastic scattering calculation only
!Indx_Inelastic_Scattering=1  ! Raman scattering excitation field preparation only
!Indx_Inelastic_Scattering=2  ! Raman scattering emission field calculation.
!Indx_Inelastic_Scattering=3  ! Chla and CDOM flourescence excitation field preparation only
!Indx_Inelastic_Scattering=4  ! Chla and CDOM flourescence emission field calculation.
!Indx_Inelastic_Scattering=5  ! both Raman and "Chla and CDOM flourescence" emission field calculation.
!Indx_Inelastic_Scattering=6  ! both Raman and "Chla and CDOM flourescence" excitation field preparation.

INTEGER:: NTLYER,NTLYERA,NTLYERO,NLYRML
REAL*8, ALLOCATABLE,DIMENSION(:,:) :: TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,TAU_RAY_Save,TAU_TG_Save

REAL*8, ALLOCATABLE,DIMENSION(:) :: ALT_LYRA,TAUR,TAU_TG,PNDLY,ARSLND1,ARSLND2,&
                                    REFF1,REFF2,VEFF1,VEFF2,MRR1,MRI1,MRR2,MRI2
REAL*8, ALLOCATABLE,DIMENSION(:,:) ::MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save
! TAUR(ICALIPSO),  RAYLEIGH OPTICAL DEPTH AT WAVLENTGH WV(IWV) AT LAYER(ILAYER)
! TAU_TG(ILAYER): ABSORPTIVE OPTICAL DEPTH FOR TRACE GAS

! DATA TRANSFER TO RTSOS CALLABLE
INTEGER :: NREC,NCOLINPUT,NQUADAINPUT,NQUADOINPUT, &
           NUMMIEUSE,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,NWV_START
REAL*8 :: DELTATAUAINPUT,DELTATAUOINPUT
REAL*8,DIMENSION(:,:),ALLOCATABLE :: RECDATASTREAM
REAL*8,DIMENSION(:,:,:),ALLOCATABLE :: PHMXDATASTREAM !,COEFFDATASTREAM
INTEGER,DIMENSION(:),ALLOCATABLE :: NUMMIEANGINPUT

REAL*8 :: LBDO_LD,FLAM

INTEGER :: NTHETAOUT,NPHIOUT,ITHETA,ITHETA0,IMIE
REAL*8 :: MU_IN,WAVELENGTH_MICRON,TEMPERTURE,SALINITY,&
          AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,       &
          BBPTCfracLOCAL,APTCLOCAL,BSTCLOCAL,ASTCLOCAL,ACDMLOCAL,&
          RINDX_WATERLOCAL

REAL*8,DIMENSION(:),ALLOCATABLE :: PHIOUT,MUOUT

LOGICAL :: WLR_FLAG_INPUT,WCFLG_INPUT,GAS_ABS_FLAG
integer :: DELTAM_INPUT

REAL*8,DIMENSION(:,:) ,ALLOCATABLE:: DIRAD  ! DIRAD(:,1) DOWNWELLING IRADIANCE
                                            ! DIRAD(:,2) UPWELLING IRADIANCE
                                            ! First dimention is detector label
REAL*8,DIMENSION(:,:,:,:),ALLOCATABLE :: DSTOKES
! DSTOKES(NWV,       NTHETAOUT,       NPHIOUT,         4)
! ITH WAVELENGTH , theta out index, phi out index, stokes parameters I Q U V

REAL*8,DIMENSION(:,:,:) ,ALLOCATABLE:: DIRADFULL  ! DIRAD(:,1) DOWNWELLING IRADIANCE
                                            ! DIRAD(:,2) UPWELLING IRADIANCE
                                            ! First dimention is detector label
REAL*8,DIMENSION(:,:,:,:,:),ALLOCATABLE :: DSTOKESFULL
! DSTOKES(NWV,       NTHETAOUT,       NPHIOUT,         4)
! ITH WAVELENGTH , theta out index, phi out index, stokes parameters I Q U V

LOGICAL :: CLOUDFLAG

REAL*8 :: RTMP,RTMP1
!REAL,DIMENSION(5) :: RNDNMBR
INTEGER:: INTTMP,ICOM,IWV,IWVEX,IWVEXSTART,ILAYER,IPT, IAEROSOL,IRH, IOPT,IWNDSPD,&
          ICHLA,IULO,MPL,KLO

LOGICAL :: file_e
integer time_array_0(8), time_array_1(8)
real start_time, finish_time

CHARACTER*160 :: CFILE1,CFILETMP

SEG3ONLY=.true.
CHLA_HOMOGENEITY=.false.
OCEAN_RAMAN_FLAG=.true.
OCEAN_FCHLA_FLAG=.true.
OCEAN_FCDOM_FLAG=.true.

OCEAN_CASE_SELECT=1
HYSPECTRAL_FLAG=.true.
NPQ_FLAG=.false.


PHYTOPLANKTON_INDEX_REFRACTION=1.06D0
PHYTOPLANKTON_SPECTRAL_SLOPE=4.D0
SEDIMENT_INDEX_REFRACTION=1.2D0
SEDIMENT_SPECTRAL_SLOPE=4.0D0
SEDIMENT_CONCENTRATION=10.0D0

ABSORPTION_TAU_REDUCE_FLAG=.true. ! IF TRUE, USE THINNER OCEAN LAYERS BELOW ABSORPTION OPTICAL DEPTH OF 10.
                    ! THIS WOULD EXPEDITE THE SIMULATION VERY MUCH WITHOUT SACRIFY THE ACCURACY AT TOO
OCEAN_PHMX_ONE=.true.  ! if true, only use one phase matrix for ocean waters
                       ! However, single scattering abeldo change is still kept
GAS_ABS_FLAG=.true.

CALL WV_PACE_SETUP

IF(GAS_ABS_FLAG)CALL SPECTRAL_AGENDA_READIN

LBDO_LD=0.0
FLAM=1.0
TEMPERTURE=20.0D0
SALINITY=37.0D0
CLOUDFLAG=.false.

! ASSIGN RTSOS PARAMETERS

NTHETAOUT=45*2
NPHIOUT=37
ALLOCATE(MUOUT(NTHETAOUT),PHIOUT(NPHIOUT))
CALL MUPHIOUTASS(NTHETAOUT,NPHIOUT,MUOUT,PHIOUT)

NCOLINPUT=20
NQUADAINPUT=40
NQUADOINPUT=60

NUMMIEUSE=1
MAXLORDINPUT=NQUADAINPUT
NMBREINPUT=1.338
NMBIMINPUT=0.0

WLR_FLAG_INPUT= .true.
WCFLG_INPUT = .true.
DELTAM_INPUT = 2

! One Layer of Rayleigh above a mix layer of Rayleigh and Aerosol
!NTLYERA=2

! One Layer of Rayleigh above two mix layer of Rayleigh and Aerosol
!NTLYERA=3

NTLYERA=10      ! use CALIPSIO vertical grids for the atmosphere
                ! aerosol profile will be given by Braslau, JAM, 1973
NTLYERO=NWATER_DEPTH-1

NTLYER=NTLYERA+NTLYERO
IF(OCEAN_PHMX_ONE)THEN
  NUMMIERT=NTLYERA+1
ELSE
  NUMMIERT=NTLYERA+NTLYERO
ENDIF

NDET=3
! NUMBER OF INPUT LINES INCLUDING DETECTORS AND ATMOSPEHRIC AND OCEANIC LAYERS,
! INTERFACE AND BOTTOM.
  NREC=NTLYER+NDET+2
!write(*,*)'NREC,NUMMIERT=',NREC,NUMMIERT

ALLOCATE(TAUR(NTLYERA), ALT_LYRA(NTLYERA+1),TAU_TG(NTLYERA))
ALLOCATE(TAU_ARSL_Ext_Save(NWV,NTLYERA),TAU_ARSL_Scat_Save(NWV,NTLYERA),&
         TAU_RAY_Save(NWV,NTLYERA),TAU_TG_Save(NWV,NTLYERA))
ALLOCATE(NUMMIEANGINPUT(NUMMIERT),PHMXDATASTREAM(NUMMIERT,NUMMIEANGMAX,0:6))

ALLOCATE(DIRAD(NDET,2),DSTOKES(NDET,NTHETAOUT,NPHIOUT,4))
ALLOCATE(DIRADFULL(NDET,NWV,2),DSTOKESFULL(NDET,NWV,NTHETAOUT,NPHIOUT,4))

ALLOCATE(RECDATASTREAM(NREC,7),PNDLY(NTLYERA),ARSLND1(NTLYERA),ARSLND2(NTLYERA), &
         REFF1(NUMMIEUSE),REFF2(NUMMIEUSE),VEFF1(NUMMIEUSE),         &
         VEFF2(NUMMIEUSE), MRR1(NUMMIEUSE),MRI1(NUMMIEUSE),          &
         MRR2(NUMMIEUSE),MRI2(NUMMIEUSE),MRR1_Save(NUMMIEUSE,NWV),   &
         MRI1_Save(NUMMIEUSE,NWV),MRR2_Save(NUMMIEUSE,NWV),MRI2_Save(NUMMIEUSE,NWV))

ARSLND1=0.0d0
ARSLND2=0.0d0
REFF1=0.0d0
REFF2=0.0d0
VEFF1=0.0d0
VEFF2=0.0d0
MRR1=1.0d0
MRR2=1.0d0
MRI1=1.0d0
MRI2=1.0d0
TAU_ARSL_Ext_Save=0.0D0
TAU_ARSL_Scat_Save=0.0D0
ALT_LYRA=(/40.0d0,20.0D0,10.0D0,8.0D0,6.0D0,5.0D0,4.0D0,3.0D0,2.0D0,1.0D0,0.0D0/)

CALL SUNLREADIN

CALL WATER_ABSORPTION_READ
CALL WATER_ABSORPTION_LEE_READ

IRH=3
IAEROSOL=16

DO IWNDSPD=2,2 !NWNDSPD
DO ITHETA0=4,4 ! 1,NTHETA0,3
   MU_IN=COS((180.0D0-THETA0(ITHETA0))/180.D0*PI)
DO IOPT=4,4 !4,NOPT,2
DO ICHLA=2,NCHLa,2

! check file existance
IF(WLR_FLAG_INPUT)THEN
  WRITE(CFILE1,'(A20,I1,A4)')'Rad_PACE_AC_wlr_Case',OCEAN_CASE_SELECT,'_WND'
ELSE
  WRITE(CFILE1,'(A20,I1,A4)')'Rad_PACE_AC_ttr_Case',OCEAN_CASE_SELECT,'_WND'
ENDIF
IF(WNDSPD(IWNDSPD)<10.0D0)THEN
  WRITE(CFILETMP,'(f3.1)')WNDSPD(IWNDSPD)
ELSE
  WRITE(CFILETMP,'(f4.1)')WNDSPD(IWNDSPD)
ENDIF
CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'TS'
IF(ACOS(abs(MU_IN))/PI*180.<10.)THEN
  WRITE(CFILETMP,'(f4.2)')ACOS(abs(MU_IN))/PI*180.
ELSE
  WRITE(CFILETMP,'(f5.2)')ACOS(abs(MU_IN))/PI*180.
ENDIF
CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'Chla'
IF(CHLa(ICHLA)>9.999)THEN
  WRITE(CFILETMP,'(f4.1)')CHLa(ICHLA)
ELSE
  WRITE(CFILETMP,'(f4.2)')CHLa(ICHLA)
ENDIF

IF(OCEAN_CASE_SELECT==2)THEN
  CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'SEDIMENTC_'
  IF(SEDIMENT_CONCENTRATION>9.999)THEN
    WRITE(CFILETMP,'(f4.1)')SEDIMENT_CONCENTRATION
  ELSE
    WRITE(CFILETMP,'(f4.2)')SEDIMENT_CONCENTRATION
  ENDIF
ENDIF

CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'Dpol90_Kok_'
WRITE(CFILETMP,'(f4.2)')Dpol90_Kok

IF(TAU550(IOPT)<10.0D0)THEN
 CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'TAU0'
 WRITE(CFILETMP,'(f4.2)')TAU550(IOPT)
ELSE
 CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'TAU'
 WRITE(CFILETMP,'(f4.1)')TAU550(IOPT)
ENDIF
CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)


IF(OCEAN_FCHLA_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wFCHLA'
ELSE
  CFILE1=TRIM(CFILE1)//'noFCHLA'
ENDIF

IF(NPQ_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wNPQ'
ELSE
  CFILE1=TRIM(CFILE1)//'noNPQ'
ENDIF

IF(OCEAN_FCDOM_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wFCDOM'
ELSE
  CFILE1=TRIM(CFILE1)//'noFCDOM'
ENDIF

IF(OCEAN_RAMAN_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wRAMAN.h5'
ELSE
  CFILE1=TRIM(CFILE1)//'noRAMAN.h5'
ENDIF

INQUIRE(FILE=CFILE1, EXIST=file_e)
IF(file_e)CYCLE

  IF(OCEAN_FCDOM_FLAG)THEN
  ! N_FCDOM_TYPE=9 DEFIEND IN RTTYPE_SOS_RAO_DG.F90
  ! Hawes et al., SPIE Vol 1750, page 212-223, (1992).
  ! INCLUDES 9 SAMPLES: FA7, FA8, FA9, FA11, HA1, HA2, HA4, HA6, HA8.
  ! THIS IS ALSO THE ORDER OF MATRIX DATA IS ORGANIZED.
  ! HA5 AND HA10 ARE EXCLUDED BECAUSE OF MISSING DATA
  ! WEIGHT_CDOM_TYPE should be determined using Eq. 4 in
  ! Hawes et al., SPIE Vol 1750, page 212-223, (1992).
  ! I use 0.9 of FA7 and 0.1 of HA6, without specifing absorption coefficients
  ! of FA7 and HA6
      WEIGHT_CDOM_TYPE=(/0.9D0, 0.0D0, 0.0D0, 0.0D0, 0.0D0, &
                         0.0D0, 0.0D0,0.1D0,0.0D0/)
  ENDIF

  IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG .OR. OCEAN_RAMAN_FLAG) &
         CALL FFLRWVRGCAL(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,OCEAN_RAMAN_FLAG,HYSPECTRAL_FLAG)
  IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG) THEN
         ALLOCATE(DIIRAD_SCALAR_AGD(NFLRSCGRID,NWATER_DEPTH),         &
                  ABSORB_COEFF_CDOM_EX(NFLRSCGRID,NWATER_DEPTH),      &
                  ABSORB_COEFF_CHLA_EX(NFLRSCGRID,NWATER_DEPTH),      &
                  SOURCEFO_FLUORESCENCE_AGD(NWATER_DEPTH),            &
                  IPAR_SCALAR(NWATER_DEPTH),QUANTUM_YIELD_CHLA_PROFILE(NWATER_DEPTH))
  ENDIF
  ALLOCATE(CHLA_VERTICAL_PROFILE(NWATER_DEPTH))

  IF(OCEAN_RAMAN_FLAG .OR. OCEAN_FCHLA_FLAG  .OR. OCEAN_FCDOM_FLAG) &
        ALLOCATE(     TAU_INELASTIC_AGD(NWATER_DEPTH),              &
                      EXT_COEFF_INELASTIC_EM(NWATER_DEPTH)           )
  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    ALLOCATE(TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
    ALLOCATE(TAU_REDUCE_OCEAN_PRESERVE(NWATER_DEPTH))
  ENDIF

  IF(OCEAN_RAMAN_FLAG) THEN
     ALLOCATE(SOURCEFO_RAMAN_AGD_LUT(NFLRSCGRID,NQUADOINPUT+2,NWATER_DEPTH,0:2))
     ALLOCATE(SOURCEFO_RAMAN_AGD(NQUADOINPUT+2,NWATER_DEPTH,0:2))
  ENDIF

  CALL WATER_DEPTH_SETUP

  IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG .OR. OCEAN_RAMAN_FLAG)THEN
    DO IWVEX=1,NFLRSCGRID
       WAVELENGTH_MICRON=LAMBDAEXFLRSC(IWVEX)/1000.0D0
       IF(GAS_ABS_FLAG)THEN
          CALL TAU_TG_INIT(NTLYERA,ALT_LYRA,WAVELENGTH_MICRON,TAU_TG)
       ELSE
          TAU_TG=0.0D0
       ENDIF
       CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,ALT_LYRA,TAUR)
       CALL PARTICLEMODELSELECTION(CLOUDFLAG,IAEROSOL,IRH,IOPT,              &
                WAVELENGTH_MICRON,NUMMIEUSE,NTLYERA,ALT_LYRA,PNDLY,              &
                REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2,ARSLND1,ARSLND2)

       DELTATAUAINPUT=0.05D0        ! ADJUST FOR ACCURATE OPTICAL INTEGRATION
       DELTATAUOINPUT=0.1D0

       IF (OCEAN_RAMAN_FLAG) THEN
          Indx_Inelastic_Scattering=1     ! RAMAN EXCITING FIELD PREPARISON
          CALL PMARAMANCAL(MU_IN, NQUADAINPUT,NQUADOINPUT,LAMBDAEXFLRSC(IWVEX),TEMPERTURE,SALINITY)
       ENDIF

       IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
            Indx_Inelastic_Scattering=3 ! FLUORESCENCE EXCITING FIELD PREPARISON

       IF(OCEAN_RAMAN_FLAG .AND. (OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG)) &
         Indx_Inelastic_Scattering=6     ! RAMAN and FLUORESCENCE EXCITING FIELD PREPARISON

       IF(OCEAN_RAMAN_FLAG)THEN
          MAXMORDINPUT=2
       ELSE
          MAXMORDINPUT=0
       ENDIF

       call date_and_time(values=time_array_0)
       start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                        + time_array_0 (7) + 0.001 * time_array_0 (8)

       CALL RTSOSINIT(IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWVEX,WAVELENGTH_MICRON,&
          ARSLND1,ARSLND2,REFF1,REFF2,VEFF1,VEFF2,MRR1,MRR2,MRI1,MRI2,        &
          NREC,NTLYERA,NTLYERO,TAUR,TAU_TG,RECDATASTREAM,NTLYER,NUMMIEUSE,    &
          NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT,PHMXDATASTREAM,LBDO_LD,FLAM,   &
          TEMPERTURE,SALINITY)

       call date_and_time(values=time_array_1)
       finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                      + time_array_1 (7) + 0.001 * time_array_1 (8)
       write(*,*)'rtsosinit elapsed time =', finish_time-start_time

       CALL RTSOS(NREC,NDET,RECDATASTREAM,NCOLINPUT,NQUADAINPUT,NQUADOINPUT,     &
            DELTATAUAINPUT,DELTATAUOINPUT,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,    &
            NUMMIEANGINPUT,PHMXDATASTREAM,MU_IN,NTHETAOUT,                       &
            NPHIOUT,PHIOUT,MUOUT,DIRAD,DSTOKES,WLR_FLAG_INPUT,WCFLG_INPUT,DELTAM_INPUT)

       call date_and_time(values=time_array_0)
             start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                        + time_array_0 (7) + 0.001 * time_array_0 (8)
       write(*,*)'rtsos elapsed time =', start_time-finish_time

       IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
          CALL OCEAN_SCALAR_IRRAD_LUT_STORE(IWVEX,WAVELENGTH_MICRON,MU_IN)
       IF(OCEAN_RAMAN_FLAG) &
          CALL OCEAN_RAMAN_SOURCE_LUT_STORE(IWVEX,NQUADOINPUT,WAVELENGTH_MICRON,MU_IN)
       DEALLOCATE(TAU_INELASTIC_EX)
    ENDDO
  ENDIF
IF(SEG3ONLY)THEN
  NWV_START=NWV-NWV_SEG3+1
ELSE
  NWV_START=1
ENDIF
DO IWV=NWV_START, NWV
  LAMBDAEM=WV(IWV)*1000.0D0
  WAVELENGTH_MICRON=WV(IWV)
  WRITE(*,*)'WV',WAVELENGTH_MICRON

  IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG)THEN
    CALL FFLRfuncjEXCAL(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,LAMBDAEM)    !(LAMBDAEM,LAMBDAEX,fRfuncjEX)
    CALL SOURCEF_FLUORESCENCE_INTEGRATION(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,LAMBDAEM)
    IF(OCEAN_FCDOM_FLAG)DEALLOCATE(fCDOMfuncjEX)
    IF(OCEAN_FCHLA_FLAG)DEALLOCATE(fCHLAfuncjEX)
  ENDIF
  IF(OCEAN_RAMAN_FLAG)THEN
    CALL FRFUNCJCAL(LAMBDAEM)    !(LAMBDAEM,LAMBDAEX,fRfuncjEX)
    CALL SOURCEF_EM_INTEGRATION(NQUADOINPUT,MU_IN)
  ENDIF

  IF(GAS_ABS_FLAG)THEN
    CALL TAU_TG_INIT(NTLYERA,ALT_LYRA,WAVELENGTH_MICRON,TAU_TG)
  ELSE
    TAU_TG=0.0D0
  ENDIF
  CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,ALT_LYRA,TAUR)
  CALL PARTICLEMODELSELECTION(CLOUDFLAG,IAEROSOL,IRH,IOPT,              &
            WAVELENGTH_MICRON,NUMMIEUSE,NTLYERA,ALT_LYRA,PNDLY,         &
            REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2,ARSLND1,ARSLND2)

  DELTATAUAINPUT=0.05D0        ! ADJUST FOR ACCURATE OPTICAL INTEGRATION
  DELTATAUOINPUT=0.1D0

call date_and_time(values=time_array_0)
start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
           + time_array_0 (7) + 0.001 * time_array_0 (8)

    MAXMORDINPUT=MIN(30,NQUADAINPUT)
    Indx_Inelastic_Scattering=0      ! Elastic scattering only

    IF(OCEAN_RAMAN_FLAG) Indx_Inelastic_Scattering=2  ! ELASTIC PART AND RAMAN EMISSION WAVELENGTH
    IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
         Indx_Inelastic_Scattering=4 ! ELASTIC PART AND FLUORESCENCE EMISSION WAVELENGTH
    IF(OCEAN_RAMAN_FLAG .AND. (OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG)) &
         Indx_Inelastic_Scattering=5
       ! ELASTIC PART; BOTH RAMAN AND FLUORESCENCE EMISSION WAVELENGTH
    IF(WAVELENGTH_MICRON>0.88) Indx_Inelastic_Scattering=0      ! Elastic scattering only

    IMIE=1
    MRR1_Save(IMIE,IWV)=MRR1(IMIE)
    MRI1_Save(IMIE,IWV)=MRI1(IMIE)
    MRR2_Save(IMIE,IWV)=MRR2(IMIE)
    MRI2_Save(IMIE,IWV)=MRI2(IMIE)

    CALL RTSOSINIT(IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWV,WAVELENGTH_MICRON,&
       ARSLND1,ARSLND2,REFF1,REFF2,VEFF1,VEFF2,MRR1,MRR2,MRI1,MRI2,        &
       NREC,NTLYERA,NTLYERO,TAUR,TAU_TG,RECDATASTREAM,NTLYER,NUMMIEUSE,    &
       NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT,PHMXDATASTREAM,LBDO_LD,FLAM,   &
       TEMPERTURE,SALINITY)

! SAVE OPTICAL DEPTH INFO
  DO ILAYER=1,NTLYERA
    TAU_ARSL_Ext_Save(IWV,ILAYER)=RECDATASTREAM(ILAYER+1,2)-TAUR(ILAYER)-TAU_TG(ILAYER)
    TAU_ARSL_Scat_Save(IWV,ILAYER)=RECDATASTREAM(ILAYER+1,2)*RECDATASTREAM(ILAYER+1,3)-TAUR(ILAYER)
    TAU_RAY_Save(IWV,ILAYER)=TAUR(ILAYER)
    TAU_TG_Save(IWV,ILAYER)=TAU_TG(ILAYER)
  ENDDO

!WRITE(*,*) 'sum(arslnd)=',SUM(ARSLND1),SUM(ARSLND2),SUM(TAU_ARSL_Ext_Save(:)),TAU550(IOPT)
!IF(ABS(WV(IWV)-550D0)<0.01D0 .and. ABS(SUM(TAU_ARSL_Ext_Save(IWV,1:NTLYERA))-TAU550(IOPT))>1.0E-4) then
!   write(*,*) sum(TAU_ARSL_Ext_Save(IWV,1:NTLYERA)),TAU550(IOPT)
!   STOP 'CHECK TAU_ARSL_Ext_Save(5,1:NTLYERA) AND TAU550'
!ENDIF
! open(unit=1,file='recdata',POSITION='append')
! write(1,*)'WV(',IWV,')=',WV(IWV)
! WRITE(1,*)'RECDATASTREAM'
! DO INTTMP=1,NREC
!  IPT = RECDATASTREAM(INTTMP,1)
!  WRITE(1,'(I5,6(2x,E13.6))')IPT,RECDATASTREAM(INTTMP,2:7)
! ENDDO
! IMIE=NTLYERA+1
! WRITE(1,*)'PHMXDATASTREAM'
! DO ITHETA=1,NUMMIEANGINPUT(IMIE)
!    WRITE(1,'(7(2x,E13.6))')PHMXDATASTREAM(IMIE,ITHETA,0:6)
! ENDDO
! close(1)

call date_and_time(values=time_array_1)
      finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
           + time_array_1 (7) + 0.001 * time_array_1 (8)
write(*,*)'rtsosinit elapsed time =', finish_time-start_time

CALL RTSOS(NREC,NDET,RECDATASTREAM,NCOLINPUT,NQUADAINPUT,NQUADOINPUT, &
     DELTATAUAINPUT,DELTATAUOINPUT,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,    &
     NUMMIEANGINPUT,PHMXDATASTREAM,MU_IN,NTHETAOUT,&
     NPHIOUT,PHIOUT,MUOUT,DIRAD,DSTOKES,WLR_FLAG_INPUT,WCFLG_INPUT,DELTAM_INPUT)
!WRITE(*,*)'WV=',WAVELENGTH_MICRON,' UP DIRAD TOA=',DIRAD(1,2)
  MPL=3
  IULO=INT(FLOAT(NSUNL)*ABS((WAVELENGTH_MICRON-WVSUN(1))/(WVSUN(NSUNL)-WVSUN(1))))
  call hunt(WVSUN,NSUNL,WAVELENGTH_MICRON,IULO)
  KLO=min(max(IULO-(MPL-1)/2,1),NSUNL-MPL)
  CALL POLINT(WVSUN(KLO),FSUN(KLO),MPL,WAVELENGTH_MICRON,RTMP,RTMP1)
  RTMP1=RTMP/DIRAD(1,1)*abs(MU_IN)
  DIRADFULL(1:NDET,IWV,1:2)=DIRAD(1:NDET,1:2)*RTMP1
  DSTOKESFULL(1:NDET,IWV,1:NTHETAOUT,1:NPHIOUT,1:4)= &
                        DSTOKES(1:NDET,1:NTHETAOUT,1:NPHIOUT,1:4)*RTMP1

IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
!  idet==1, detector at the top of the atmosphere, not impacted by the rescale scheme.

!  idet==2, det at bottom of the atmosphere
!  idet==3, det at top of the ocean
!  both share the same absorption optical depth rescale.
  DIRADFULL(2:3,IWV,1:2)=DIRADFULL(2:3,IWV,1:2)*EXP(-TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
  DSTOKESFULL(2:3,IWV,1:NTHETAOUT,1:NPHIOUT,1:4)= &
      DSTOKESFULL(2:3,IWV,1:NTHETAOUT,1:NPHIOUT,1:4)*EXP(-TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
ENDIF

call date_and_time(values=time_array_0)
start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
           + time_array_0 (7) + 0.001 * time_array_0 (8)
write(*,*)'rtsos elapsed time =', start_time-finish_time

ENDDO ! WAVELENG LOOP


CALL STOKESOUT(CFILE1,ICHLA,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,              &
        DIRADFULL,DSTOKESFULL,ALT_LYRA,TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,   &
        TAU_RAY_Save,TAU_TG_Save,                                              &
        NTLYERA,ARSLND1,ARSLND2,NUMMIEUSE,REFF1,REFF2,VEFF1,VEFF2,             &
        MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save)
IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG .OR. OCEAN_RAMAN_FLAG) &
        DEALLOCATE(LAMBDAEXFLRSC)
IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG) &
  DEALLOCATE(DIIRAD_SCALAR_AGD,ABSORB_COEFF_CDOM_EX,  &
             ABSORB_COEFF_CHLA_EX,SOURCEFO_FLUORESCENCE_AGD,IPAR_SCALAR,&
             QUANTUM_YIELD_CHLA_PROFILE)
DEALLOCATE(CHLA_VERTICAL_PROFILE)

IF(OCEAN_RAMAN_FLAG .OR. OCEAN_FCHLA_FLAG  .OR. OCEAN_FCDOM_FLAG) &
       DEALLOCATE(TAU_INELASTIC_AGD,EXT_COEFF_INELASTIC_EM)
IF(ABSORPTION_TAU_REDUCE_FLAG) &
       DEALLOCATE(TAU_REDUCE_ATMOS_PRESERVE,TAU_REDUCE_OCEAN_PRESERVE)

IF(OCEAN_RAMAN_FLAG)DEALLOCATE(SOURCEFO_RAMAN_AGD,SOURCEFO_RAMAN_AGD_LUT)

ENDDO ! NCHLa LOOP
ENDDO ! NOPT LOOP
ENDDO ! NTHETA0 LOOP
ENDDO ! NWNDSPD LOOP
CLOSE(55)
DEALLOCATE(DIRAD,DSTOKES,PNDLY,ARSLND1,ARSLND2,REFF1,REFF2,VEFF1,VEFF2,&
          MRR1,MRI1,MRR2,MRI2,MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save, &
          TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,TAU_RAY_Save,TAU_TG_Save)
DEALLOCATE(PHIOUT,MUOUT,RECDATASTREAM,PHMXDATASTREAM)
DEALLOCATE(TAUR,ALT_LYRA)
CALL DEALL_SUNL

ENDPROGRAM SOSINT

SUBROUTINE  STOKESOUT(CFILE1,ICHLA,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,       &
        DIRADFULL,DSTOKESFULL,ALT_LYRA,TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,   &
        TAU_RAY_Save,TAU_TG_Save, &
        NTLYERA,ARSLND1,ARSLND2,NUMMIEUSE,REFF1,REFF2,VEFF1,VEFF2,             &
        MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save)

USE GLOBAL_DATA
USE SAVE_OCEAN_MOD,only:WATER_DEPTH,NWATER_DEPTH,IPAR_SCALAR,&
                        CHLA_VERTICAL_PROFILE,QUANTUM_YIELD_CHLA_PROFILE
USE FLUORESCENCEDATA
USE HDF5
USE ISO_C_BINDING

IMPLICIT none
CHARACTER*160 :: CFILE1

INTEGER :: ICHLA, NTHETAOUT,NPHIOUT,NTLYERA,NUMMIEUSE,ICOM

REAL*8,DIMENSION(NDET,NWV,2) :: DIRADFULL  ! DIRADFULL(:,1) DOWNWELLING IRADIANCE
                                   ! DIRAD(:,2) UPWELLING IRADIANCE
REAL*8,DIMENSION(NDET,NWV,NTHETAOUT,NPHIOUT,4) :: DSTOKESFULL

REAL*8,DIMENSION(NWV,NTLYERA) ::TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,TAU_RAY_Save,TAU_TG_Save
REAL*8,DIMENSION(NTHETAOUT) :: MUOUT
REAL*8,DIMENSION(NPHIOUT) :: PHIOUT

REAL*8,DIMENSION(NTLYERA) ::ALT_LYRA,ARSLND1,ARSLND2
REAL*8,DIMENSION(NUMMIEUSE) ::REFF1,REFF2,VEFF1,VEFF2
REAL*8,DIMENSION(NUMMIEUSE,NWV) ::MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save

REAL*8 :: MU_IN,RTMP
LOGICAL :: MUFLG
REAL*8,PARAMETER :: PI=3.141592653589793d0
REAL*8,PARAMETER :: FACTOR=PI/180.0d0
INTEGER:: MPLIN,NDETOUT,ITHETA,IPHI,IWV,ILAYER,IDET,IMIE

! HDF 5 DEFINITION
! This should map to REAL*8 on most modern processors
INTEGER, PARAMETER :: real_kind_15 = SELECTED_REAL_KIND(Fortran_REAL_8)
CHARACTER(LEN=180) :: HDF5FILENAME
CHARACTER(LEN=20)  :: dataset
CHARACTER(LEN=20) , PARAMETER :: attribute = "A1"
INTEGER   :: dim0, dim1
INTEGER(HID_T)  :: file, space, dset, attr ! Handles
INTEGER :: hdferr
INTEGER(hsize_t),   DIMENSION(1:2) :: dims
INTEGER(hsize_t),DIMENSION(1) :: dimscl
INTEGER(HSIZE_T), DIMENSION(1:2) :: maxdims
TYPE(C_PTR) :: f_ptr
REAL*4,DIMENSION(1),TARGET :: HDF5RTMP
INTEGER,DIMENSION(1),TARGET :: HDF5ITMP
REAL*4,DIMENSION(:),TARGET,ALLOCATABLE :: HDF5RARR
REAL*4,DIMENSION(:,:),TARGET,ALLOCATABLE :: HDF5RARR2DIM

INTEGER(hsize_t), DIMENSION(1:4) :: dims4
INTEGER(HSIZE_T), DIMENSION(1:4) :: maxdims4
REAL*4,DIMENSION(:,:,:,:),TARGET,ALLOCATABLE :: HDF5RARR4DIM

INTEGER :: NWV_OUTPUT

IF(SEG3ONLY)THEN
  NWV_OUTPUT=NWV_SEG3
ELSE
  NWV_OUTPUT=NWV
ENDIF

IMIE=1

CALL h5open_f(hdferr)
CALL h5fcreate_f(CFILE1, H5F_ACC_TRUNC_F, file, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'MU_SOLAR', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=MU_IN
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)


dimscl=(/ NWV_OUTPUT /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WaveLength', H5T_IEEE_F32LE, space, dset, hdferr)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR(1:NWV_OUTPUT)=WV(NWV-NWV_OUTPUT+1:NWV)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
DEALLOCATE(HDF5RARR)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Rf', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF1(IMIE)+1.0)
HDF5RTMP=REFF1(IMIE)*EXP(-2.5*RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Vf', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF1(IMIE)+1.0)
HDF5RTMP=SQRT(RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Rc', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF2(IMIE)+1.0)
HDF5RTMP=REFF2(IMIE)*EXP(-2.5*RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Vc', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF2(IMIE)+1.0)
HDF5RTMP=SQRT(RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)



dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR(1:NWV_OUTPUT)=MRR1_Save(IMIE,NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mrf', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR(1:NWV_OUTPUT)=MRI1_Save(IMIE,NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mif', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR(1:NWV_OUTPUT)=MRR2_Save(IMIE,NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mrc', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR(1:NWV_OUTPUT)=MRI2_Save(IMIE,NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mic', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
HDF5RARR2DIM=TAU_ARSL_Ext_Save(NWV-NWV_OUTPUT+1:NWV,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Aerosol_Extinction', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
HDF5RARR2DIM=TAU_ARSL_Scat_Save(NWV-NWV_OUTPUT+1:NWV,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Aerosol_Scattering', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)


dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
HDF5RARR2DIM=TAU_RAY_Save(NWV-NWV_OUTPUT+1:NWV,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Rayleigh_Extinction', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
HDF5RARR2DIM=TAU_TG_Save(NWV-NWV_OUTPUT+1:NWV,1:NTLYERA)
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Trace_Gas_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)


dimscl=(/ NTLYERA /)
ALLOCATE(HDF5RARR(NTLYERA ))
HDF5RARR=ALT_LYRA
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Atmosphere_Layer_Altitudes', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NTLYERA /)
ALLOCATE(HDF5RARR(NTLYERA ))
HDF5RARR=ARSLND1
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Number_Density_FineMode', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

ALLOCATE(HDF5RARR(NTLYERA ))
HDF5RARR=ARSLND2
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Number_Density_CoarseMode', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=AW(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'aw_Ocean_Water_Absorption_Coefficient', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=BW(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bw_Ocean_Water_Scattering_Coefficient', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=RINDX_WATER(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Refractive_Index_Ocean_Water', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)



dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=APTC(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ap_Phytoplankton_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=BPTC(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bp_Phytoplankton_Scattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=BBPTC(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bbp_Phytoplankton_Backscattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=BBPTCfrac(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Bbp_Phytoplankton_Backscattering_fraction_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=BSTC(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bp_SEDIMENT_Scattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=ASTC(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ap_SEDIMENT_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=ACDM(NWV-NWV_OUTPUT+1:NWV)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ay_CDOM_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'DEPOL90_KOK', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=Dpol90_Kok
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ABSORPTION_OPTICAL_DEPTH_REDUCTION_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'NonPhotochemicalQuenching_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(NPQ_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_FCHLA_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_FCHLA_FLAG)THEN
HDF5ITMP=1
ELSE
HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_FCDOM_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_FCDOM_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_RAMAN_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_RAMAN_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'CHLA_HOMOGENEITY', H5T_IEEE_F32LE, space, dset, hdferr)
IF(CHLA_HOMOGENEITY)THEN
HDF5ITMP=1
ELSE
HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
HDF5RARR=WATER_DEPTH(1:NWATER_DEPTH)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WATER_DEPTH_LEVELS', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
IF(OCEAN_FCHLA_FLAG)THEN
   HDF5RARR=IPAR_SCALAR(1:NWATER_DEPTH)
ELSE
   HDF5RARR=-999
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'IPAR_SCALAR', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
IF(OCEAN_FCHLA_FLAG)THEN
   HDF5RARR=QUANTUM_YIELD_CHLA_PROFILE(1:NWATER_DEPTH)
ELSE
   HDF5RARR=-999
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_PROFILE', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)


dimscl=(/ NWATER_DEPTH /)
ALLOCATE(HDF5RARR(NWATER_DEPTH))
HDF5RARR=CHLA_VERTICAL_PROFILE(1:NWATER_DEPTH)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'CHLA_VERTICAL_PROFILE', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_MIN', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_MIN
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_MAX', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_MAX
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_EK', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_EK
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_ET', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_ET
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_MLD', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_MLD
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_QI', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_QI
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=DIRADFULL(1,NWV-NWV_OUTPUT+1:NWV,1)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOA_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=DIRADFULL(1,NWV-NWV_OUTPUT+1:NWV,2)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOA_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)


dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=DIRADFULL(2,NWV-NWV_OUTPUT+1:NWV,1)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_BOA_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=DIRADFULL(2,NWV-NWV_OUTPUT+1:NWV,2)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_BOA_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=DIRADFULL(3,NWV-NWV_OUTPUT+1:NWV,1)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOO_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
HDF5RARR=DIRADFULL(3,NWV-NWV_OUTPUT+1:NWV,2)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOO_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NTHETAOUT /)
ALLOCATE(HDF5RARR(NTHETAOUT))
HDF5RARR=ACOS(MUOUT)/PI*180.D0
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ThetaV', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NPHIOUT /)
ALLOCATE(HDF5RARR(NPHIOUT))
HDF5RARR=PHIOUT*180.0d0/PI
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'PhiV', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
HDF5RARR4DIM=DSTOKESFULL(1,NWV-NWV_OUTPUT+1:NWV,:,:,:)
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_TOA', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
HDF5RARR4DIM=DSTOKESFULL(2,NWV-NWV_OUTPUT+1:NWV,:,:,:)
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_BOA', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
HDF5RARR4DIM=DSTOKESFULL(3,NWV-NWV_OUTPUT+1:NWV,:,:,:)
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_TOO', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)


CALL h5fclose_f(file , hdferr)
CALL h5close_f(hdferr)

RETURN

END SUBROUTINE  STOKESOUT

SUBROUTINE SPHER_INTERFACE(NDISTR,REFFI,VEFFI,LAM,MRR,MRI,AA1,BB1,AA2,BB2,GAMMAI,&
              REFFO,VEFFO,AREA,CEXT,CSCAT,NANGMIE_LOCAL,PHMXMIE_LOCAL)

USE RTUTILITY,ONLY : NUMMIEANGMAX,PI

IMPLICIT REAL*8 (A-H,O-Z)                           
INTEGER ::  NANGMIE_LOCAL
REAL*8,DIMENSION(NUMMIEANGMAX,0:6)::PHMXMIE_LOCAL

INTEGER,PARAMETER:: NMIE=10000, NPL=2*NMIE
INTEGER NDISTR,LMAXI,IL
REAL*8 REFFI,VEFFI,LAM,MRR,MRI,AA1,BB1,AA2,BB2,GAMMAI,REFFO,VEFFO,AREA,CEXT,CSCAT
REAL*8 AL1(NPL),AL2(NPL),AL3(NPL),AL4(NPL),BET1(NPL),BET2(NPL)

!      CHARACTER*40 :: CFILE1,CHARTMP
!      open (6, file='spher.coeff')
!      AA=0.6D0
!      BB=0.2 D0
!      AA1=0.17D0
!      AA2=3.44D0
!      BB1=DLOG(1.96D0)*DLOG(1.96D0)
!      BB2=DLOG(2.37D0)*DLOG(2.37D0)
!      GAM=1D0                                                               
!      LAM=0.63D0                                            
!      MRR=1.53 D0                                               
!      MRI=0.008 D0                                            
!      NDISTR=3
!      NK=100
!      N=100
!      NP=4
      R1=0.0D0
      R2=20.0D0    

       IF(NDISTR==1) THEN
!     NDISTR = 1 - modified gamma distribution                         
!          [Eq. (5.242) of Ref. 1]                                        
!              AA=alpha                                                
!              BB=r_c                                                  
!              GAM=gamma                                               

            AA=GAMMAI-1
            BB=AA*REFFI/(GAMMAI+2.0D0)
            GAM=1.0D0
            
       ELSE IF(NDISTR==2) THEN
!C     NDISTR = 2 - log normal distribution                             
!C          [Eq. (5.243) of Ref. 1]                                        
!C              AA=r_g                                                  
!C              BB=[ln(sigma_g)]**2                                      
            BB=log(VEFFI+1.0D0)
            AA=REFFI*EXP(-2.5d0*BB)

       ELSE IF(NDISTR==3) THEN
!C     NDISTR = 3 - power law distribution                              
!C          [Eq. (5.244) of Ref. 1]                                        
!C               AA=r_eff (effective radius)                            
!C               BB=v_eff (effective variance)                          
!C               Parameters R1 and R2 (see below) are calculated        
!C               automatically for given AA and BB                      
                AA=REFFI
                BB=VEFFI

       ELSE IF(NDISTR==4) THEN
!C     NDISTR = 4 - gamma distribution                                  
!C          [Eq. (5.245) of Ref. 1]                                        
!C               AA=a                                                   
!C               BB=b      
!http://www.ess.uci.edu/~cmclinden/link/xx/node22.html
!HANSEN AND TRAVIS 1974 EQ. 2.56
                AA=REFFI  
                BB=VEFFI
                                                     
       ELSE IF(NDISTR==5) THEN
!C     NDISTR = 5 - modified power law distribution                     
!C          [Eq. (5.246) of Ref. 1]                                        
!C              BB=alpha          
               BB=GAMMAI
       ELSE IF(NDISTR==6) THEN
!C     NDISTR = 6 - bimodal volume log normal distribution              
!C              [Eq. (5.247) of Ref. 1]             
!C              AA1=r_g1                                                
!C              BB1=[ln(sigma_g1)]**2                                   
!C              AA2=r_g2                                                
!C              BB2=[ln(sigma_g2)]**2                                   
!C              GAM=gamma                                               
               GAM=GAMMAI
!C
       ELSE IF(NDISTR==7) THEN
!C    Added by Zhai, Pengwang Oct. 29 2008
!C     NDISTR = 7 - Junge distribution                              
!C          [n(r)=Constant*r^{-s}; s=4]
!C               Parameters R1 and R2 (see below)
!C               BB=JUNGE EXPONENTIAL FACTOR s                           
                BB=GAMMAI
                R1=0.1D0
                R2=50.0D0
       ELSE
          STOP 'NDISTR<1 OR > 7'
       ENDIF
       NK=20
       N=100
       NP=4
       WVNM=LAM*1000
       DDELT=1D-7

      CALL SPHER (AA,BB,GAM,LAM,MRR,MRI,R1,R2,N,NP,NDISTR,             &
            NK,L1,AL1,AL2,AL3,AL4,BET1,BET2,CEXT,CSCAT,AREA,VOL,RVW,  &
            RMEAN,REFFO,VEFFO,AA1,BB1,AA2,BB2,DDELT)
      QE=CEXT/AREA
      LMAX=L1-1

      LMAXI=LMAX
      CALL MATR (AL1,AL2,AL3,AL4,BET1,BET2,LMAX,NUMMIEANGMAX,NANGMIE_LOCAL,PHMXMIE_LOCAL)
      

!      WRITE (*,1001) AREA,VOL,RVW,RMEAN
! 1001 FORMAT ('<G> = ',D12.6,'  <V> = ',D12.6,'  Rvw = ',D12.6,&
!             &'  <R> = ',D12.6)
!write(*,*)'testing'
!  DO INTTMP=1,LMAXI+1
!      write(*,*)AL1(INTTMP),AL2(INTTMP),AL3(INTTMP),AL4(INTTMP),&
!             BET1(INTTMP),BET2(INTTMP)
!  ENDDO
!write(*,*)'testing over'
  
      RETURN
      END SUBROUTINE SPHER_INTERFACE

SUBROUTINE MUPHIOUTASS(NTHETAOUT,NPHIOUT,MUOUT,PHIOUT)
INTEGER :: NTHETAOUT,NPHIOUT
REAL*8,DIMENSION(NTHETAOUT) :: MUOUT
REAL*8,DIMENSION(NPHIOUT) :: PHIOUT
REAL*8,DIMENSION(:),ALLOCATABLE ::THETAOUT_FREE
INTEGER :: IANG
REAL*8 RTMP
ALLOCATE(THETAOUT_FREE(NTHETAOUT))

RTMP=180.0D0/(1.0D0*NTHETAOUT)
DO IANG=1,NTHETAOUT/2
  THETAOUT_FREE(IANG)=(IANG-1)*RTMP
  THETAOUT_FREE(NTHETAOUT-IANG+1)=180.0D0-THETAOUT_FREE(IANG)
ENDDO

RTMP=180.0d0/(NPHIOUT-1.0d0)
DO IANG=1,NPHIOUT
   PHIOUT(IANG)=(IANG-1)*RTMP
ENDDO

MUOUT=COS(THETAOUT_FREE/180.*3.141592653589793d0)
PHIOUT=PHIOUT*3.141592653589793d0/180.0D0

DEALLOCATE(THETAOUT_FREE)

ENDSUBROUTINE MUPHIOUTASS


SUBROUTINE RTSOSINIT(IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWVSAVE,WAVELENGTH_MICRON,ARSLND1,ARSLND2, &
       REFF1,REFF2,VEFF1,VEFF2,MRR1,MRR2,MRI1,MRI2,NREC,NTLYERA,NTLYERO,&
       TAUR,TAU_TG,RECDATASTREAM,NTLYER,NUMMIEUSE,NUMMIERT,  &
       MAXLORDINPUT,NUMMIEANGINPUT,PHMXDATASTREAM,LBDO_LD,FLAM,TEMPERTURE,SALINITY)

USE GLOBAL_DATA
USE SAVE_OCEAN_MOD
USE RTUTILITY, ONLY : NUMMIEANGMAX,PI
IMPLICIT none

INTEGER,INTENT(IN) :: IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWVSAVE,NREC,NTLYER,&
                      NUMMIEUSE,NUMMIERT,MAXLORDINPUT,NTLYERA,NTLYERO
REAL*8,INTENT(IN)::WAVELENGTH_MICRON
REAL*8,DIMENSION(NUMMIEUSE),INTENT(IN)::REFF1,REFF2,VEFF1,VEFF2
REAL*8,DIMENSION(NUMMIEUSE),INTENT(IN) ::MRR1,MRR2,MRI1,MRI2

REAL*8,DIMENSION(NTLYERA),INTENT(IN) :: ARSLND1,ARSLND2

REAL*8,DIMENSION(NTLYERA),INTENT(INOUT) :: TAUR,TAU_TG

INTEGER,DIMENSION(NUMMIERT),INTENT(OUT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6),INTENT(OUT) ::PHMXDATASTREAM

REAL*8,DIMENSION(NREC,7),INTENT(OUT) :: RECDATASTREAM

REAL*8,INTENT(IN):: LBDO_LD,FLAM,TEMPERTURE,SALINITY

REAL*8 :: WVLN,CHLaLOCAL,AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,&
      BBPTCLOCAL,BBPTCfracLOCAL,APTCLOCAL,BSTCLOCAL,BSTC665LOCAL,        &
      ASTCLOCAL,ASTC443LOCAL,ACDMLOCAL,RINDX_WATERLOCAL,TAURfracLOCAL,SEDIMENT_DENSITY

REAL*8,DIMENSION(:),ALLOCATABLE :: TAURfrac,TAULYR,LBDOLYR
!TAURfrac(ILAYER), RAYLEIGH SCATTERING FRACTION
!TAULYR(ILAYER): TOTAL OPTICAL DEPTH  AT WAVLENTGH WV(IWV) AT LAYER(ILAYER) 
!LBDOLYR(ILAYER): EFFECTIVE SINGLE SCATTERING ALBEDO

REAL*8:: BLANK
INTEGER ::INDXDETECTOR,INDXLAMB,INDXOCEAN,INDXOCEAN1

INTEGER :: IMIE, NANGMIE_LOCAL,IANG
REAL*8,DIMENSION(NUMMIEANGMAX,0:6):: PHMXMIE_LOCAL1,PHMXMIE_LOCAL2
REAL*8,DIMENSION(:,:,:),ALLOCATABLE:: PHMXDATA_TMP1,PHMXDATA_TMP2
! MIE CALCULATION RELATED PARAMETERS
! if possible, do not modify NMIE and NPL. 
! If it is necessary, change it all through spher.f 
INTEGER :: NDISTR
REAL*8 :: AA1,BB1,AA2,BB2,GAMMAI,REFFI,VEFFI,REFFO,MRLOCAL,MILOCAL,VEFFO, &
          AREA,CEXT1,CSCAT1,CEXT2,CSCAT2,REFFO1,REFFO2

!integer time_array_0(8), time_array_1(8)
!real start_time, finish_time
      
INTEGER :: ITLYERA,ITLYER,ITLYERW
REAL*8 :: finemoderatio,RTMP,RTMP1,OCEAN_ALBEDO,ABSORPTION_TAU,SCATTERING_TAU,&
        ABSORPTION_TAU_CUMMU,ABSORPTION_TAU_CUTOFF,LAYER_DEPTH_TMP,OCEAN_TAU_TMP


LOGICAL :: EMISSION_FLAG

ALLOCATE(PHMXDATA_TMP1(NUMMIEUSE,NUMMIEANGMAX,0:6),&
         PHMXDATA_TMP2(NUMMIEUSE,NUMMIEANGMAX,0:6))

! SYSTEM PARAMETER DEFINITIONS
BLANK=0.0
INDXDETECTOR=-1000
INDXLAMB=-200
INDXOCEAN=-100
INDXOCEAN1=-101
ABSORPTION_TAU_CUTOFF=10.0D0

! SYSTEM PARAMETER DEFINITION OVER

RECDATASTREAM=BLANK
PHMXDATASTREAM=0.0D0

IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  TAU_REDUCE_OCEAN_PRESERVE=0.0D0
  TAU_REDUCE_ATMOS_PRESERVE=0.0D0
ENDIF

ALLOCATE(TAURfrac(NTLYERA),TAULYR(NTLYERA),LBDOLYR(NTLYERA))

NDISTR=2
DO IMIE=1,NUMMIEUSE
  CALL SPHER_INTERFACE(NDISTR,REFF1(IMIE),VEFF1(IMIE),WAVELENGTH_MICRON,   &
       MRR1(IMIE),MRI1(IMIE),AA1,BB1,AA2,BB2,GAMMAI,     &
       REFFO,VEFFO,AREA,CEXT1,CSCAT1,NANGMIE_LOCAL,PHMXMIE_LOCAL1)
  PHMXDATA_TMP1(IMIE,1:NUMMIEANGMAX,0:6)=PHMXMIE_LOCAL1(1:NUMMIEANGMAX,0:6)
  IF(sngmode)THEN
     PHMXMIE_LOCAL2=PHMXMIE_LOCAL1
     CEXT2=CEXT1
     CSCAT2=CSCAT1
  ELSE
    CALL SPHER_INTERFACE(NDISTR,REFF2(IMIE),VEFF2(IMIE),WAVELENGTH_MICRON,&
       MRR2(IMIE),MRI2(IMIE),AA1,BB1,AA2,BB2,GAMMAI, &
       REFFO,VEFFO,AREA,CEXT2,CSCAT2,NANGMIE_LOCAL,PHMXMIE_LOCAL2)
  ENDIF
  PHMXDATA_TMP2(IMIE,1:NUMMIEANGMAX,0:6)=PHMXMIE_LOCAL2(1:NUMMIEANGMAX,0:6)
ENDDO

! BELOW THIS LINE I HAVE ASSUMED ONE MIE FOR ALL LAYERS 
! OTHERWISE NEED TO DO APPROPERIATE CHANGES !!!!!!!!!!!!!!!!

NUMMIEANGINPUT=NANGMIE_LOCAL
IMIE=1
DO ITLYER=1,NUMMIERT
  PHMXDATASTREAM(ITLYER,1:NUMMIEANGMAX,0)=PHMXDATA_TMP1(IMIE,1:NUMMIEANGMAX,0)
ENDDO
!call date_and_time(values=time_array_0)
!start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
!           + time_array_0 (7) + 0.001 * time_array_0 (8)
ABSORPTION_TAU_CUMMU=0.0D0

!DETECTOR AT THE TOA
RECDATASTREAM(1,1)=INDXDETECTOR

IMIE=1
DO ITLYERA=1,NTLYERA
!  write(*,*)'arslnd1and 2',ITLYERA,ARSLND1(ITLYERA),ARSLND2(ITLYERA)
  IF(ABS(ARSLND1(ITLYERA))<1.0E-32 .AND.ABS(ARSLND2(ITLYERA))<1.0E-32) THEN
     RECDATASTREAM(ITLYERA+1,1)=1
     ABSORPTION_TAU=TAU_TG(ITLYERA)
     SCATTERING_TAU=TAUR(ITLYERA)
     TAULYR(ITLYERA)=SCATTERING_TAU+ABSORPTION_TAU
     LBDOLYR(ITLYERA)=SCATTERING_TAU/TAULYR(ITLYERA)
  ELSE
     RECDATASTREAM(ITLYERA+1,1)=ITLYERA
     TAULYR(ITLYERA)=CEXT1*ARSLND1(ITLYERA)+CEXT2*ARSLND2(ITLYERA)
! total optical depth=aerosol+rayleigh+gas absorption
     TAULYR(ITLYERA)=TAULYR(ITLYERA)+TAUR(ITLYERA)+TAU_TG(ITLYERA)
     SCATTERING_TAU=CSCAT1*ARSLND1(ITLYERA)+CSCAT2*ARSLND2(ITLYERA)+TAUR(ITLYERA)

     finemoderatio=CSCAT1*ARSLND1(ITLYERA)/ &
                  (CSCAT1*ARSLND1(ITLYERA)+CSCAT2*ARSLND2(ITLYERA))
     IF(finemoderatio>1.0D0)finemoderatio=1.0D0

     ABSORPTION_TAU=TAU_TG(ITLYERA)+(CEXT1-CSCAT1)*ARSLND1(ITLYERA) &
                                   +(CEXT2-CSCAT2)*ARSLND2(ITLYERA)
     TAURfrac(ITLYERA)=TAUR(ITLYERA)/SCATTERING_TAU
     LBDOLYR(ITLYERA)=SCATTERING_TAU/TAULYR(ITLYERA)
  ENDIF

  RECDATASTREAM(ITLYERA+1,2)=TAULYR(ITLYERA)

  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    IF(ABSORPTION_TAU_CUMMU >= ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(ITLYERA+1,2)=ABSORPTION_TAU_REPLACE
       TAU_REDUCE_ATMOS_PRESERVE(ITLYERA+1)=ABSORPTION_TAU - &
                             ABSORPTION_TAU_REPLACE*(1.0D0-LBDOLYR(ITLYERA))
    ELSEIF(ABSORPTION_TAU_CUMMU + ABSORPTION_TAU>=ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(ITLYERA+1,2) = &
              (ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)/(1.0D0-LBDOLYR(ITLYERA))
       IF(RECDATASTREAM(ITLYERA+1,2)<0.0D0) STOP 'CHECK REDUCE TAU ATMOS I'
       TAU_REDUCE_ATMOS_PRESERVE(ITLYERA+1)= ABSORPTION_TAU - &
                    (ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)
       IF(TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)<0.0D0) THEN
          WRITE(*,*)ABSORPTION_TAU,ABSORPTION_TAU_CUMMU,ABSORPTION_TAU_CUTOFF
          STOP'CHECK REDUCE TAU ATMOS II'
       ENDIF
    ENDIF
  ENDIF
  ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU + ABSORPTION_TAU

  RECDATASTREAM(ITLYERA+1,3)= LBDOLYR(ITLYERA)     ! ALBEDOR
  RECDATASTREAM(ITLYERA+1,4)=WAVELENGTH_MICRON
  RECDATASTREAM(ITLYERA+1,5)=TEMPERTURE
  RECDATASTREAM(ITLYERA+1,6)=0

  IF(RECDATASTREAM(ITLYERA+1,1)==1 .OR. abs(1.0d0-TAURfrac(ITLYERA))<1.0e-8)THEN
    CALL RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,ITLYERA)
  ELSE
    PHMXDATASTREAM(ITLYERA,1:NUMMIEANGMAX,1:6)=&
          (1.0d0-finemoderatio)*PHMXDATA_TMP2(IMIE,1:NUMMIEANGMAX,1:6)&
                +finemoderatio *PHMXDATA_TMP1(IMIE,1:NUMMIEANGMAX,1:6)
       CALL PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYERA,TAURfrac(ITLYERA),DEPOL_A)
  ENDIF

ENDDO ! LAYER LOOP

WVLN=WAVELENGTH_MICRON*1000.0d0
CALL WATER_REFRACTIVE_INDEX(WVLN,TEMPERTURE,SALINITY,RINDX_WATERLOCAL)

! detector just above ocean surface
    RECDATASTREAM(NTLYERA+2,1)=INDXDETECTOR
    RECDATASTREAM(NTLYERA+2,2)=BLANK
    RECDATASTREAM(NTLYERA+2,3)=BLANK
! OCEAN INTERFACE 
    RECDATASTREAM(NTLYERA+3,1)=INDXOCEAN
    RECDATASTREAM(NTLYERA+3,2)=WNDSPD(IWNDSPD)
    RECDATASTREAM(NTLYERA+3,3)=RINDX_WATERLOCAL

! Dectector just below OCEAN INTERFACE
RECDATASTREAM(NTLYERA+4,1)=INDXDETECTOR
RECDATASTREAM(NTLYERA+4,2)=BLANK
RECDATASTREAM(NTLYERA+4,3)=BLANK
DEALLOCATE(TAURfrac,TAULYR,LBDOLYR,PHMXDATA_TMP1,PHMXDATA_TMP2)
ALLOCATE(TAULYR(NTLYERO),LBDOLYR(NTLYERO))

EMISSION_FLAG=(Indx_Inelastic_Scattering == 0) .OR. &
              (Indx_Inelastic_Scattering == 2) .OR. &
              (Indx_Inelastic_Scattering == 4) .OR. &
              (Indx_Inelastic_Scattering == 5)
! hydrosol LAYERS
IF(Indx_Inelastic_Scattering>0)TAU_INELASTIC_AGD=0.0d0

LOOP_LAYERS: DO ITLYERW=1,NWATER_DEPTH
  CALL CHLAPROFILE(WATER_DEPTH(ITLYERW),CHLa(ICHLA),CHLaLOCAL)
  CHLA_VERTICAL_PROFILE(ITLYERW)=CHLaLOCAL
  CALL HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLaLOCAL,TEMPERTURE,SALINITY,   &
               AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL, &
               BBPTCfracLOCAL,APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)

  IF(OCEAN_CASE_SELECT==2 .AND. ITLYERW==1)THEN
!Babin et al., JGR, Vol. 108, 3211, 2003, Table 5
! Variations in the light absorption coefficients of phytoplankton,
! nonalgal particles, and dissolved organic matterin coastal waters around Europe
      ASTC443LOCAL=0.041D0*SEDIMENT_CONCENTRATION
      ASTCLOCAL=ASTC443LOCAL*0.75d0*EXP(-0.0123d0*(WVLN-443.0d0))
      SEDIMENT_DENSITY=6.779D6*SEDIMENT_INDEX_REFRACTION+5.232D6

      NDISTR=7
      REFFI=0.0D0
      VEFFI=0.0D0
      MRLOCAL=PHYTOPLANKTON_INDEX_REFRACTION
      MILOCAL=0.0D0
      GAMMAI=PHYTOPLANKTON_SPECTRAL_SLOPE

      CALL SPHER_INTERFACE(NDISTR,REFFI,VEFFI,WAVELENGTH_MICRON,        &
                MRLOCAL,MILOCAL,AA1,BB1,AA2,BB2,GAMMAI,                 &
                REFFO1,VEFFO,AREA,CEXT1,CSCAT1,NANGMIE_LOCAL,PHMXMIE_LOCAL1)

      REFFI=0.0D0
      VEFFI=0.0D0
      MRLOCAL=SEDIMENT_INDEX_REFRACTION
      MILOCAL=0.0D0
      GAMMAI=SEDIMENT_SPECTRAL_SLOPE

      CALL SPHER_INTERFACE(NDISTR,REFFI,VEFFI,0.6650D0,        &
                MRLOCAL,MILOCAL,AA1,BB1,AA2,BB2,GAMMAI,                 &
                REFFO2,VEFFO,AREA,CEXT2,CSCAT2,NANGMIE_LOCAL,PHMXMIE_LOCAL2)

      BSTC665LOCAL=1.5D0*CSCAT2/AREA/(REFFO2*1.D-6)/ &
                SEDIMENT_DENSITY*SEDIMENT_CONCENTRATION
      BSTCLOCAL=BSTC665LOCAL*(WAVELENGTH_MICRON/0.665D0)**(-(SEDIMENT_SPECTRAL_SLOPE-3)) &
                -ASTCLOCAL*(1.0D0-TANH(0.5D0*(SEDIMENT_SPECTRAL_SLOPE-3)**2))

      NDISTR=7
      MRLOCAL=SEDIMENT_INDEX_REFRACTION
      MILOCAL=0.0D0
      GAMMAI=SEDIMENT_SPECTRAL_SLOPE
      CALL SPHER_INTERFACE(NDISTR,REFFI,VEFFI,WAVELENGTH_MICRON,        &
                MRLOCAL,MILOCAL,AA1,BB1,AA2,BB2,GAMMAI,                 &
                REFFO2,VEFFO,AREA,CEXT2,CSCAT2,NANGMIE_LOCAL,PHMXMIE_LOCAL2)

  ENDIF


  IF(ITLYERW==1 .AND. EMISSION_FLAG)THEN
    AW(IWVSAVE)=AWLOCAL
    BW(IWVSAVE)=BWLOCAL
    BBW(IWVSAVE)=BBWLOCAL
    BWRAMAN(IWVSAVE)=BWRAMANLOCAL
    BPTC(IWVSAVE)=BPTCLOCAL
    BBPTC(IWVSAVE)=BBPTCLOCAL
    BBPTCfrac(IWVSAVE)=BBPTCfracLOCAL
    APTC(IWVSAVE)=APTCLOCAL
    ACDM(IWVSAVE)=ACDMLOCAL
    ASTC(IWVSAVE)=ASTCLOCAL
    BSTC(IWVSAVE)=BSTCLOCAL
    RINDX_WATER(IWVSAVE)=RINDX_WATERLOCAL
  ENDIF

  RTMP= BWLOCAL + BPTCLOCAL
  RTMP1=AWLOCAL + APTCLOCAL + ACDMLOCAL

  IF(OCEAN_CASE_SELECT==2)THEN
    RTMP= RTMP+BSTCLOCAL
    RTMP1=RTMP1+ASTCLOCAL
  ENDIF

  IF(ITLYERW==NWATER_DEPTH) THEN
    IF(Indx_Inelastic_Scattering>0)THEN
        EXT_COEFF_INELASTIC_EM(ITLYERW)=RTMP+RTMP1
        IF(Indx_Inelastic_Scattering==3 .or. Indx_Inelastic_Scattering==6) THEN
           ABSORB_COEFF_CDOM_EX(IWVSAVE,ITLYERW)=ACDMLOCAL
           ABSORB_COEFF_CHLA_EX(IWVSAVE,ITLYERW)=APTCLOCAL
        ENDIF
    ENDIF
    EXIT LOOP_LAYERS
  ENDIF

  OCEAN_ALBEDO=RTMP/(RTMP+RTMP1)

  IF(OCEAN_PHMX_ONE) THEN
    RECDATASTREAM(NTLYERA+4+ITLYERW,1)=NTLYERA+1
  ELSE
    RECDATASTREAM(NTLYERA+4+ITLYERW,1)=NTLYERA+ITLYERW
  ENDIF

  ABSORPTION_TAU=RTMP1*(WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW))
  LAYER_DEPTH_TMP=WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW)
  RECDATASTREAM(NTLYERA+4+ITLYERW,2)= LAYER_DEPTH_TMP * (RTMP+RTMP1) ! TAU testing

  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    IF(ABSORPTION_TAU_CUMMU >= ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(NTLYERA+4+ITLYERW,2)= ABSORPTION_TAU_REPLACE
       LAYER_DEPTH_TMP=ABSORPTION_TAU_REPLACE/(RTMP+RTMP1)
    ELSEIF(ABSORPTION_TAU_CUMMU+ABSORPTION_TAU>ABSORPTION_TAU_CUTOFF)THEN
         LAYER_DEPTH_TMP=(ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)/RTMP1
         IF(LAYER_DEPTH_TMP<0.0D0)STOP 'WARNING, CHECK LAYER_DEPTH_TMP'
         RECDATASTREAM(NTLYERA+4+ITLYERW,2)= LAYER_DEPTH_TMP * (RTMP+RTMP1) ! TAU testing
    ENDIF
    OCEAN_TAU_TMP=(WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW)-LAYER_DEPTH_TMP)*RTMP1
    IF(OCEAN_TAU_TMP<0.0D0)STOP 'MAIN_PACE_AC.F90 CHECK OCEAN_TAU_TMP'
    TAU_REDUCE_OCEAN_PRESERVE(ITLYERW+1)=TAU_REDUCE_OCEAN_PRESERVE(ITLYERW) &
                                        +OCEAN_TAU_TMP
  ENDIF
  ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+RTMP1* &
                       (WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW))

  IF(OCEAN_CASE_SELECT==0)THEN
    RECDATASTREAM(NTLYERA+4+ITLYERW,3)=0.0D0           ! ALBEDOO
  ELSE
    RECDATASTREAM(NTLYERA+4+ITLYERW,3)=RTMP/(RTMP+RTMP1)           ! ALBEDOO
  ENDIF
  RECDATASTREAM(NTLYERA+4+ITLYERW,4)=WAVELENGTH_MICRON
  RECDATASTREAM(NTLYERA+4+ITLYERW,5)=TEMPERTURE
  RECDATASTREAM(NTLYERA+4+ITLYERW,6)=Indx_Inelastic_Scattering

  IF(Indx_Inelastic_Scattering>0) THEN
     EXT_COEFF_INELASTIC_EM(ITLYERW)=RTMP+RTMP1
     TAU_INELASTIC_AGD(ITLYERW+1)=TAU_INELASTIC_AGD(ITLYERW) &
                                    + RECDATASTREAM(NTLYERA+4+ITLYERW,2)

     SCATT_COEFF_RAMAN_EX=BWRAMANLOCAL
  ENDIF

  IF(Indx_Inelastic_Scattering==3 .or. Indx_Inelastic_Scattering==6) THEN
    ABSORB_COEFF_CDOM_EX(IWVSAVE,ITLYERW)=ACDMLOCAL
    ABSORB_COEFF_CHLA_EX(IWVSAVE,ITLYERW)=APTCLOCAL
  ENDIF

  IF(OCEAN_PHMX_ONE .AND. ITLYERW>1)CYCLE
  IF(OCEAN_CASE_SELECT<2)THEN
     CALL HYDRSL_PHMX_ASSIGN(CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL,NTLYERA,&
            NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,ITLYERW,PHMXDATASTREAM)
  ELSE
     finemoderatio=BPTCLOCAL/(BPTCLOCAL+BSTCLOCAL)
     PHMXDATASTREAM(NTLYERA+ITLYERW,1:NUMMIEANGMAX,1:6)=&
                   (1.0d0-finemoderatio)*PHMXMIE_LOCAL2(1:NUMMIEANGMAX,1:6)&
                         +finemoderatio *PHMXMIE_LOCAL1(1:NUMMIEANGMAX,1:6)
     TAURfracLOCAL=BWLOCAL/(BPTCLOCAL+BSTCLOCAL+BWLOCAL)
     ITLYER=NTLYERA+ITLYERW
     CALL PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYER,TAURfracLOCAL,DEPOL_O)
  ENDIF
ENDDO LOOP_LAYERS

IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  ABSORPTION_TAU_CUMMU=0.0D0
  DO ITLYERA =1,NTLYERA+1
    ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)
    TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)=ABSORPTION_TAU_CUMMU
  ENDDO

  DO ITLYERW=1,NWATER_DEPTH
    ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)
    TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)=ABSORPTION_TAU_CUMMU
!     write(*,*)'tsp_TAU_INELASTIC_AGD',WATER_DEPTH(ITLYERW),&
!                            TAU_INELASTIC_AGD(ITLYERW),&
!                            TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)
  ENDDO
ENDIF

! BOTTOM LAYERS
RECDATASTREAM(NTLYERA+5+NWATER_DEPTH-1,1)=INDXLAMB
RECDATASTREAM(NTLYERA+5+NWATER_DEPTH-1,2)=LBDO_LD
RECDATASTREAM(NTLYERA+5+NWATER_DEPTH-1,3)=FLAM
RECDATASTREAM(NTLYERA+5+NWATER_DEPTH-1,4)=NMBREINPUT
RECDATASTREAM(NTLYERA+5+NWATER_DEPTH-1,5)=NMBIMINPUT

END SUBROUTINE RTSOSINIT


SUBROUTINE TAURCAL(WVLENGTH,NLAYER,ALT_LYRA,TAUR)
IMPLICIT NONE
REAL*8,INTENT(IN) :: WVLENGTH
INTEGER,INTENT(IN)::NLAYER
REAL*8,DIMENSION(NLAYER+1), INTENT(IN) ::ALT_LYRA
REAL*8,DIMENSION(NLAYER), INTENT(OUT) ::TAUR

REAL*8 MOLEXT
INTEGER,PARAMETER :: N_ALT_MOL=30  ! do not use the two levels below sea surface
real*8,DIMENSION(N_ALT_MOL+1) :: ALT_MOL_PROFILE=(/39.7957,37.9994,35.9037,33.8080,32.0117, &
                        29.9760,28.0000,26.0241,24.0482,21.8926,20.0365,19.0785,   &
                        18.0606,17.0427,16.0248,15.0667,14.0489,13.0310,12.0729,   &
                        11.0550,10.0371,9.0791,8.0762,7.0583,6.0703,5.0824,4.0645, &
                        3.0466,2.0586,1.0407,0.0528/), &
MOLND_PROFILE=(/5.5629665058380875e+22,7.1144259529897572e+22,9.5963916831909919e+22, &
             1.3309563639241767e+23,1.7852263518577093e+23,2.5435797469192681e+23, &
             3.6294257195399695e+23,5.2257918195840461e+23,7.5338750993963792e+23, &
             1.1245916291652714e+24,1.5746098947913931e+24,1.8645787324568639e+24, &
             2.2195233438182151e+24,2.6392448499159020e+24,3.1016911770161213e+24, &
             3.6114510968223964e+24,4.2168196264715797e+24,4.9237651523626446e+24, &
             5.7105314692429076e+24,6.6968517812087991e+24,7.8683295574322933e+24, &
             9.1299375487391800e+24,1.0589030617491678e+25,1.2187198877962643e+25, &
             1.3845407831629019e+25,1.5668705921383059e+25,1.7738628908952063e+25, &
             2.0089060004434922e+25,2.2839358865360574e+25,2.5917599330742616e+25, &
             3.0919125003365726e+25 /)
REAL*8,DIMENSION(:),ALLOCATABLE :: MOLND_tmp,AEXPFACMOL,BEXPFACMOL

INTEGER:: ILYERA,IHEIGHT
REAL*8 :: ALTMID

ALLOCATE(MOLND_tmp(NLAYER),AEXPFACMOL(N_ALT_MOL),BEXPFACMOL(N_ALT_MOL))

! EQUATION (4.17) CALIPSO ATBD RELEASE 1.0
MOLEXT=4.5102D-27*(WVLENGTH/0.550D0)**(-4.025D0-0.05627D0*(WVLENGTH/0.550D0)**(-1.647D0))*1.0D-4

DO IHEIGHT=1,N_ALT_MOL
  AEXPFACMOL(IHEIGHT)=-LOG(MOLND_PROFILE(IHEIGHT)/MOLND_PROFILE(IHEIGHT+1)) &
             /(ALT_MOL_PROFILE(IHEIGHT)-ALT_MOL_PROFILE(IHEIGHT+1))
  BEXPFACMOL(IHEIGHT)=MOLND_PROFILE(IHEIGHT+1)
  IF(AEXPFACMOL(IHEIGHT)<0) then
    WRITE(*,*)IHEIGHT,AEXPFACMOL(IHEIGHT),LOG(MOLND_PROFILE(IHEIGHT)/MOLND_PROFILE(IHEIGHT+1))
    STOP 'CHECK AEXPFACMOL'
  ENDIF
ENDDO

DO ILYERA=1,NLAYER
 ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
 IF(ALTMID>ALT_MOL_PROFILE(1)) THEN
   MOLND_tmp(ILYERA)=BEXPFACMOL(1)*EXP(-AEXPFACMOL(1)*(ALTMID-ALT_MOL_PROFILE(2)))
 ELSE IF(ALTMID>ALT_MOL_PROFILE(N_ALT_MOL+1)) THEN
   DO IHEIGHT=1,N_ALT_MOL
     IF(ALTMID<ALT_MOL_PROFILE(IHEIGHT) .AND. ALTMID>ALT_MOL_PROFILE(IHEIGHT+1)) EXIT
   ENDDO
   MOLND_tmp(ILYERA)=BEXPFACMOL(IHEIGHT)*EXP(-AEXPFACMOL(IHEIGHT)*(ALTMID-ALT_MOL_PROFILE(IHEIGHT+1)))
 ELSE
   STOP 'WARNING ALTMID<0' 
 ENDIF
! WRITE(*,*)ALTMID,MOLND_tmp(ILYERA)
ENDDO

DO ILYERA=1,NLAYER
  MOLND_tmp(ILYERA)=MOLND_tmp(ILYERA)*(ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1))*1000.0D0
  TAUR(ILYERA)=MOLND_tmp(ILYERA)*MOLEXT
ENDDO
DEALLOCATE(MOLND_tmp,AEXPFACMOL,BEXPFACMOL)
WRITE(*,*)'WV, TOTAL RAYLEIGH TAU=',WVLENGTH, SUM(TAUR)
END SUBROUTINE TAURCAL

SUBROUTINE ARSL_VERP_INIT(NTLYERA,ALT_LYRA,PNDLY)
IMPLICIT NONE
INTEGER :: NTLYERA
REAL*8,DIMENSION(NTLYERA+1)::ALT_LYRA
REAL*8,DIMENSION(NTLYERA)::PNDLY
REAL*8,DIMENSION(8) ::   &
  PND=(/0.0013,0.0727,0.6761,0.8619,0.3735,0.3769,0.9235,193.7308/),&
  HEIGHT=(/45.2205,25.1867,21.8404,20.3539,12.0843,8.0429,4.9380,0./)
REAL*8,DIMENSION(7) :: AEXPFAC,BEXPFAC
REAL*8 :: ALTMID
INTEGER :: ILYERA,IHEIGHT

DO IHEIGHT=1,7
  AEXPFAC(IHEIGHT)=-LOG(PND(IHEIGHT)/PND(IHEIGHT+1))/(HEIGHT(IHEIGHT)-HEIGHT(IHEIGHT+1))
  BEXPFAC(IHEIGHT)=PND(IHEIGHT+1)
!  IF(AEXPFAC(IHEIGHT)<0) then
!    WRITE(*,*)IHEIGHT,AEXPFAC(IHEIGHT),LOG(PND(IHEIGHT)/PND(IHEIGHT+1))
!    STOP 'CHECK AEXPFAC'
!  endif
ENDDO

DO ILYERA=1,NTLYERA
 ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
 IF(ALTMID>HEIGHT(1)) THEN
   PNDLY(ILYERA)=BEXPFAC(1)*EXP(-AEXPFAC(1)*(ALTMID-HEIGHT(2)))
 ELSE IF(ALTMID>HEIGHT(8)) THEN
   DO IHEIGHT=1,7
     IF(ALTMID<HEIGHT(IHEIGHT) .AND. ALTMID>HEIGHT(IHEIGHT+1)) EXIT
   ENDDO
   PNDLY(ILYERA)=BEXPFAC(IHEIGHT)*EXP(-AEXPFAC(IHEIGHT)*(ALTMID-HEIGHT(IHEIGHT+1)))
 ELSE
   STOP 'WARNING ALTMID<0' 
 ENDIF
!  WRITE(*,*)ALTMID,PNDLY(ILYERA)
ENDDO

DO ILYERA=1,NTLYERA
  PNDLY(ILYERA)=PNDLY(ILYERA)*(ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1))
ENDDO

! in the unit of #/micron^2, which is the column number concentration
      !  = (Number of aerosols)/micron^2/km *km where km is the unit of altitude.
!WRITE(*,*)'LAYER INTEGRATED NUMBER DENSITY'
!DO ILYERA=1,NTLYERA
!   ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
!   WRITE(*,*)ALTMID,PNDLY(ILYERA),ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1)
!ENDDO

END SUBROUTINE ARSL_VERP_INIT

SUBROUTINE RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,ITLYER)
USE RTUTILITY,ONLY : FACTOR
USE GLOBAL_DATA,ONLY : DEPOL_A
IMPLICIT NONE
INTEGER ::    NUMMIERT, NUMMIEANGMAX,ITLYER,ISCATANG
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM

REAL*8 :: MUF,DELTA_DEPOL,DELTA_DEPOLP

DELTA_DEPOL=(1.0D0-DEPOL_A)/(1.0D0+DEPOL_A/2.0D0)
DELTA_DEPOLP=(1.0D0-2.0D0*DEPOL_A)/(1.0D0-DEPOL_A)
   
DO ISCATANG=1,NUMMIEANGINPUT(ITLYER)
  MUF=COS(PHMXDATASTREAM(ITLYER,ISCATANG,0)*FACTOR)
  PHMXDATASTREAM(ITLYER,ISCATANG,1)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF) &
                                    +1.0D0-DELTA_DEPOL
  PHMXDATASTREAM(ITLYER,ISCATANG,2)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)
  PHMXDATASTREAM(ITLYER,ISCATANG,3)=1.5D0*DELTA_DEPOL*MUF
  PHMXDATASTREAM(ITLYER,ISCATANG,4)=1.5D0*DELTA_DEPOL*DELTA_DEPOLP*MUF
  
  PHMXDATASTREAM(ITLYER,ISCATANG,5)=-0.75D0*DELTA_DEPOL*(1.0D0-MUF*MUF)
  PHMXDATASTREAM(ITLYER,ISCATANG,6)=0.0D0
ENDDO

END SUBROUTINE RAYPHMXASSIGN

SUBROUTINE PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYER,TAURfracLOCAL,DEPOL_LOCAL)
USE RTUTILITY,ONLY : FACTOR
IMPLICIT NONE
INTEGER ::    NUMMIERT, NUMMIEANGMAX,ITLYER,ISCATANG
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM
REAL*8 :: TAURfracLOCAL

REAL*8 :: DEPOL_LOCAL,MUF,DELTA_DEPOL,DELTA_DEPOLP
REAL*8,DIMENSION(6):: RAYPHMX_LOCAL

DELTA_DEPOL=(1.0D0-DEPOL_LOCAL)/(1.0D0+DEPOL_LOCAL/2.0D0)
DELTA_DEPOLP=(1.0D0-2.0D0*DEPOL_LOCAL)/(1.0D0-DEPOL_LOCAL)

DO ISCATANG=1,NUMMIEANGINPUT(ITLYER)
  MUF=COS(PHMXDATASTREAM(ITLYER,ISCATANG,0)*FACTOR)
  RAYPHMX_LOCAL(1)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)+1.0D0-DELTA_DEPOL

  RAYPHMX_LOCAL(2)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)
  RAYPHMX_LOCAL(3)=1.5D0*DELTA_DEPOL*MUF
  RAYPHMX_LOCAL(4)=1.5D0*DELTA_DEPOL*DELTA_DEPOLP*MUF
  
  RAYPHMX_LOCAL(5)=-0.75D0*DELTA_DEPOL*(1.0D0-MUF*MUF)
  RAYPHMX_LOCAL(6)=0.0D0
  PHMXDATASTREAM(ITLYER,ISCATANG,1:6)=TAURfracLOCAL*RAYPHMX_LOCAL(1:6) + &
              (1.0D0-TAURfracLOCAL)*PHMXDATASTREAM(ITLYER,ISCATANG,1:6)
ENDDO

END SUBROUTINE PHMXMIXING

SUBROUTINE HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLaVal,TMPTR,SALINITY,         &
    AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,BBPTCfracLOCAL,&
    APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)
USE GLOBAL_DATA
IMPLICIT NONE
LOGICAL :: FCDOM_ACOEF_FREE
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,CHLaVal,TMPTR,SALINITY
REAL*8,INTENT(OUT)::AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,&
                    BBPTCfracLOCAL,APTCLOCAL,   &
                    ACDMLOCAL,RINDX_WATERLOCAL
INTEGER,PARAMETER :: NWV_Aph1_ZPLee=81,NWV_AP_BIOSOPE=226,NWV_AP_COMPONENTS=151
REAL*8 :: BPTC_exp_coeff,BPTC660,Ap_Bricaud,Ep_Bricaud
REAL*8 :: S_cdm,WVLN,BWFUNC,APTC440,ACDM440, CPTC550, CPTCLOCAL

INTEGER :: IREAD
REAL*8 :: RTMP,RTMP1,RTMP2
REAL,DIMENSION(5) :: RNDNMBR
! Ap_Bricaud and Ep_Bricaud are obtained through interpolation of 
! Bricaud's table values See
!Bricaud A,Morel A,Babin M,Allali K,Claustre H. Variations of light
!absorption by suspended particles with chlorophylla concentration
!in oceanic(case1) waters: analysis and implications for bio-optical
!models. J Geophys Res 1998;103:31033–4

INTEGER :: I_AP_UV ! =1, USE ZP LEE'S UV DATA, AS IT WAS IN ZHAI ET AL. OE, 2015
                   ! =2, USE BRICAUD BIOSCOPE 20 PERCENTILE
                   ! =3, USE BRICAUD BIOSCOPE 50 PERCENTILE
                   ! =4, USE BRICAUD BIOSCOPE 80 PERCENTILE

REAL*8,DIMENSION(NWV_Aph1_ZPLee),PARAMETER :: WV_Aph1_ZPLee=(/350.0d0,355.0d0,360.0d0,  &
             365.0d0,370.0d0,375.0d0,380.0d0,385.0d0,390.0d0,395.0d0,400.0d0, &
             405.0d0,410.0d0,415.0d0,420.0d0,425.0d0,430.0d0,435.0d0,440.0d0, &
             445.0d0,450.0d0,455.0d0,460.0d0,465.0d0,470.0d0,475.0d0,480.0d0, &
             485.0d0,490.0d0,495.0d0,500.0d0,505.0d0,510.0d0,515.0d0,520.0d0, &
             525.0d0,530.0d0,535.0d0,540.0d0,545.0d0,550.0d0,555.0d0,560.0d0, &
             565.0d0,570.0d0,575.0d0,580.0d0,585.0d0,590.0d0,595.0d0,600.0d0, &
             605.0d0,610.0d0,615.0d0,620.0d0,625.0d0,630.0d0,635.0d0,640.0d0, &
             645.0d0,650.0d0,655.0d0,660.0d0,665.0d0,670.0d0,675.0d0,680.0d0, &
             685.0d0,690.0d0,695.0d0,700.0d0,705.0d0,710.0d0,715.0d0,720.0d0, &
             725.0d0,730.0d0,735.0d0,740.0d0,745.0d0,750.0d0/)

REAL*8,DIMENSION(NWV_Aph1_ZPLee),PARAMETER :: Aph1_ZPLee=(/0.001555842d0,0.00181407d0,  &
             0.001888311d0,0.001929814d0,0.002001448d0,0.002095922d0,0.002190711d0,&
             0.002272435d0,0.002343792d0,0.002420293d0,0.002518258d0,0.002641678d0,&
             0.002780294d0,0.002921886d0,0.003062716d0,0.003200315d0,0.003319054d0,&
             0.003392452d0,0.003404776d0,0.003365358d0,0.003295404d0,0.003205327d0,&
             0.003091601d0,0.00295154d0,0.002793768d0,0.002632409d0,0.002472467d0, &
             0.002303613d0,0.002110266d0,0.00188762d0,0.001647957d0,0.001413061d0, &
             0.001201222d0,0.001019811d0,0.000867002d0,0.000737812d0,0.000628256d0,&
             0.000535732d0,0.000458072d0,0.000393474d0,0.000340909d0,0.000300215d0,&
             0.000271662d0,0.000255023d0,0.000248825d0,0.000250241d0,0.000255381d0,&
             0.000259823d0,0.000260164d0,0.000256607d0,0.000253508d0,0.000255765d0,&
             0.000264538d0,0.000277018d0,0.000289617d0,0.00030019d0,0.000307799d0, &
             0.000312941d0,0.000320181d0,0.000341222d0,0.000394337d0,0.000494746d0,&
             0.000635514d0,0.000774211d0,0.000846711d0,0.000806908d0,0.000660216d0,&
             0.000459487d0,0.000268371d0,0.00012758d0,0.00012758d0,0.00012758d0,   &
             0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0,     &
             0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0/)

REAL*8, DIMENSION(NWV_AP_BIOSOPE) :: WV_AP_BIOSOPE,AP_BIOSOPE_UV20P,AP_BIOSOPE_UV50P,&
                                     AP_BIOSOPE_UV80P,AP_BIOSOPE_USE
REAL*8, DIMENSION(NWV_AP_COMPONENTS) :: WV_AP_COMPONENTS, AP_PICO_BASE, AP_MICRO_BASE
REAL*8 :: SF_COEFF,AP_PICO_SPECIFIC676NM=0.023D0,AP_MICRO_SPECIFIC676NM=0.0086D0
REAL*8 :: POLINT_SIMPLE

WVLN=WAVELENGTH_MICRON*1000.0d0
CALL RANDOM_SEED()
CALL RANDOM_NUMBER(RNDNMBR)

I_AP_UV=3
IF(WVLN<350.0D0 .and. I_AP_UV==1)THEN
  WRITE(*,*) 'warning, WVLN=',WVLN,'RANGE OUT OF APH ABSORPTION TABLE FROM ZP Lee'
  STOP
ENDIF

IF(WVLN<300.0D0 .and. I_AP_UV>1)THEN
  write(*,*)'warning, WVLN=',WVLN,'RANGE OUT OF APH ABSORPTION TABLE FROM biosope'
  write(*,*)'extrapolation is used instead'
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN

  CALL AP_BRICAUD_LUT_SEARCH(440.0D0,CHLaVal, APTC440)

ELSEIF(OCEAN_CASE_SELECT==2)THEN
!SF_Coff options from Ciotti, Lewis, and Cullen, LO, 47(2) 404-417, 2002
!    Assessment of the relationships between dominant cell size in
!    natural phytoplankton communities and the spectral shape of
!    the absorption coefficient
! 1.000 0.663 0.598 0.369 0.558 0.491 0.664 0.287
! 0.370 0.266 0.151 0.442 0.002 0.014 0.025 0.000

  SF_COEFF=0.287d0
  OPEN(UNIT=1,FILE='ap_PicoMicro.txt',STATUS='OLD',ACTION='READ')
  READ(1,*)
  DO IREAD=1,NWV_AP_COMPONENTS
     READ(1,*)WV_AP_COMPONENTS(IREAD), AP_PICO_BASE(IREAD), AP_MICRO_BASE(IREAD)
  ENDDO
  CLOSE(1)
  RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,676.0D0,2)
  RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,676.0D0,2)
  AP_PICO_BASE=AP_PICO_BASE/RTMP1*AP_PICO_SPECIFIC676NM
  AP_MICRO_BASE=AP_MICRO_BASE/RTMP2*AP_MICRO_SPECIFIC676NM

  RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,440.0D0,2)
  RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,440.0D0,2)
  APTC440=CHLaVal*(SF_COEFF*RTMP1+(1.0D0-SF_COEFF)*RTMP2)
ELSE
  STOP 'CHECK OCEAN_CASE_SELECT VALUE'
ENDIF

IF(WVLN<400.0D0)THEN
    IF(I_AP_UV==1)THEN
      APTCLOCAL=POLINT_SIMPLE(NWV_Aph1_ZPLee,WV_Aph1_ZPLee,Aph1_ZPLee,WVLN,2)
      RTMP =    POLINT_SIMPLE(NWV_Aph1_ZPLee,WV_Aph1_ZPLee,Aph1_ZPLee,440.0d0,2)
      APTCLOCAL=APTCLOCAL/RTMP*APTC440
    ELSE
      OPEN(UNIT=1,FILE='ap_UV_biosope.dat',STATUS='OLD',ACTION='READ')
      DO IREAD=1,5
        READ(1,*)
      ENDDO
      DO IREAD=1,NWV_AP_BIOSOPE
         READ(1,*)WV_AP_BIOSOPE(IREAD),AP_BIOSOPE_UV20P(IREAD),AP_BIOSOPE_UV50P(IREAD),AP_BIOSOPE_UV80P(IREAD)
      ENDDO
      CLOSE(1)
      IF(I_AP_UV==2)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV20P
      ELSEIF(I_AP_UV==3)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV50P
      ELSEIF(I_AP_UV==4)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV80P
      ENDIF

      APTCLOCAL=POLINT_SIMPLE(NWV_AP_BIOSOPE,WV_AP_BIOSOPE,AP_BIOSOPE_USE,WVLN,2)
      RTMP=POLINT_SIMPLE(NWV_AP_BIOSOPE,WV_AP_BIOSOPE,AP_BIOSOPE_USE,440.0D0,2)
      APTCLOCAL=APTCLOCAL/RTMP*APTC440
    ENDIF

ELSEIF(WVLN<700.0D0)THEN

  IF(OCEAN_CASE_SELECT==1)THEN
    CALL AP_BRICAUD_LUT_SEARCH(WVLN,CHLaVal, APTCLOCAL)
  ELSE ! USE CASE 2 AP MODEL
    RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,WVLN,2)
    RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,WVLN,2)
    APTCLOCAL=CHLaVal*(SF_COEFF*RTMP1+(1.0D0-SF_COEFF)*RTMP2)
  ENDIF

ELSE
  APTCLOCAL=0.0d0 ! negligible absorption for ap at wavelength > 700 nm
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN
! Testing the random number bio-optical model scheme with RNDNMBR-0.5d0
  RNDNMBR=0.5d0
  RTMP=(0.6D0-0.06D0)*RNDNMBR(1)+0.06D0
  CPTC550=RTMP*CHLaVal**0.57D0  ! EQ. 11 in lee_data.pdf
  RTMP1=-0.4D0+(1.6D0+1.2D0*RNDNMBR(2))/(1.0D0+SQRT(CHLaVal))
  CPTCLOCAL=CPTC550*(550.0D0/WVLN)**RTMP1
ELSEIF(OCEAN_CASE_SELECT==2)THEN
!K. J. Voss, “A spectral model of the beam attenuation coefficient
!       in the ocean and coastal areas,” Limnol. Oceanogr. 37, 501-509 (1992).
  CPTC550=0.3D0*CHLaVal**0.62D0
  CPTCLOCAL=CPTC550*(550.0D0/WVLN)**(PHYTOPLANKTON_SPECTRAL_SLOPE-3.0D0)
ENDIF

BPTCLOCAL=CPTCLOCAL-APTCLOCAL

IF(BPTCLOCAL<0.0D0) THEN
    WRITE(*,*)'WARNING CPTCLOCAL<APTCLOCAL'
    WRITE(*,*)'CPTCLOCAL,APTCLOCAL=',CPTCLOCAL,APTCLOCAL
    WRITE(*,*)'SWTICH TO BIOOPTICAL MODEL CPTCLOCAL=BPTCLOCAL+APTCLOCAL'
    ! See Eq.14 in Morel and Maritorena, JGR, 2001
    IF(CHLaVal>2 .OR. CHLaVal<0.001D0)THEN
         BPTC_exp_coeff=0.0D0
    ELSE
         BPTC_exp_coeff=0.5*(LOG10(CHLaVal)-0.3)
    ENDIF
    ! See Eq.12 in Morel and Maritorena, JGR, 2001
    !  BPTC550(ICHLA)=0.416*CHLa(ICHLA)**0.766
    BPTC660=0.347*CHLaVal**0.766
    ! See Eq.13 in Morel and Maritorena, JGR, 2001
    BPTCLOCAL=BPTC660*(WAVELENGTH_MICRON/0.66)**BPTC_exp_coeff
    CPTCLOCAL=BPTCLOCAL+APTCLOCAL
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN
    IF(abs(CHLaVal)<0.001D0)THEN
      BBPTCfracLOCAL=0.0d0
      BBPTCLOCAL=0.0d0
    ELSE
      BBPTCfracLOCAL=0.002+0.01*(0.5-0.25*log10(CHLaVal))
    IF(BBPTCfracLOCAL<1E-6)THEN
      WRITE(*,*)'CHLaVal,BBPTCfracLOCAL=',CHLaVal,BBPTCfracLOCAL
      STOP
    ENDIF
    !BBPTCfracLOCAL=0.01d0; ! used in Westberry, Boss, and Lee 2013
      BBPTCLOCAL=BBPTCfracLOCAL*BPTCLOCAL
    ENDIF
ELSE
    BBPTCfracLOCAL=0.0D0 ! NOT USED IN CASE 2 WATER BIOOPTICAL MODELS
    BBPTCLOCAL=0.0D0     ! NOT USED IN CASE 2 WATER BIOOPTICAL MODELS
ENDIF

!S_cdm is suggested by Morel and Gentili, RSE, 2009.
S_cdm=0.018

FCDOM_ACOEF_FREE=.true.
IF(FCDOM_ACOEF_FREE)THEN
    CALL RANDOM_NUMBER(RNDNMBR)
    RNDNMBR=0.5d0 !testing random number bio-optical model algorithm
    RTMP=0.3D0+5.7D0*RNDNMBR(1)*APTC440/(0.02D0+APTC440) ! EQ.9 in lee_data.pdf
    ACDM440=RTMP*APTC440
    ACDMLOCAL=ACDM440*exp(-S_cdm*(WAVELENGTH_MICRON-0.44d0)*1000.)
ELSE
! See Eq.1 in Morel and Gentili, RSE, 2009
    ACDM400=0.065*CHLaVal**0.63
    ACDMLOCAL=ACDM400*exp(-S_cdm*(WAVELENGTH_MICRON-0.40d0)*1000.)
ENDIF

IF(WVLN<350.0D0 .OR. WVLN> 550.0D0)THEN
  AWLOCAl=  POLINT_SIMPLE(NWV_PF_LUT,WV_PF_LUT,AW_PF_LUT,WVLN,2)
ELSE
  AWLOCAl=  POLINT_SIMPLE(NWV_AW_LEE_LUT,WV_AW_LEE_LUT,AW_LEE_LUT,WVLN,2)
ENDIF

BWLOCAL=0.00193D0*(550.0d0/WVLN)**4.32  !BWFUNC(WVLN,TMPTR,SALINITY)
BBWLOCAL=0.5D0*BWLOCAl
!BWRAMANLOCAL=2.6d-4*(488.0d0/WVLN)**5.5
!BWRAMANLOCAL=2.6d-4*(488.0d0/WVLN)**4.8
BWRAMANLOCAL=2.7d-4*(488.0d0/WVLN)**5.3

IF(OCEAN_CASE_SELECT==0)THEN
  CPTCLOCAL=APTCLOCAL
  BPTCLOCAL=0.0D0
  BBPTCfracLOCAL=0.0D0 ! BLACK OCEAN
  BBPTCLOCAL=0.0D0     ! BLACK OCEAN
ENDIF

CALL WATER_REFRACTIVE_INDEX(WVLN,TMPTR,SALINITY,RINDX_WATERLOCAL)

END SUBROUTINE HYDRSL_PARA_INIT

SUBROUTINE AP_BRICAUD_LUT_SEARCH(WAVELENGTH_NM,CHLaVal,AP)
IMPLICIT NONE
REAL*8, INTENT(IN) :: WAVELENGTH_NM,CHLaVal
REAL*8, INTENT(OUT) :: AP

INTEGER,PARAMETER :: NWV_Bricaud=151
REAL*8,DIMENSION(NWV_Bricaud),PARAMETER :: &
WV_Bricaud=(/400.0d0,402.0d0,404.0d0,406.0d0,408.0d0,410.0d0,412.0d0,&
             414.0d0,416.0d0,418.0d0,420.0d0,422.0d0,424.0d0,426.0d0,&
             428.0d0,430.0d0,432.0d0,434.0d0,436.0d0,438.0d0,440.0d0,&
             442.0d0,444.0d0,446.0d0,448.0d0,450.0d0,452.0d0,454.0d0,&
             456.0d0,458.0d0,460.0d0,462.0d0,464.0d0,466.0d0,468.0d0,&
             470.0d0,472.0d0,474.0d0,476.0d0,478.0d0,480.0d0,482.0d0,&
             484.0d0,486.0d0,488.0d0,490.0d0,492.0d0,494.0d0,496.0d0,&
             498.0d0,500.0d0,502.0d0,504.0d0,506.0d0,508.0d0,510.0d0,&
             512.0d0,514.0d0,516.0d0,518.0d0,520.0d0,522.0d0,524.0d0,&
             526.0d0,528.0d0,530.0d0,532.0d0,534.0d0,536.0d0,538.0d0,&
             540.0d0,542.0d0,544.0d0,546.0d0,548.0d0,550.0d0,552.0d0,&
             554.0d0,556.0d0,558.0d0,560.0d0,562.0d0,564.0d0,566.0d0,&
             568.0d0,570.0d0,572.0d0,574.0d0,576.0d0,578.0d0,580.0d0,&
             582.0d0,584.0d0,586.0d0,588.0d0,590.0d0,592.0d0,594.0d0,&
             596.0d0,598.0d0,600.0d0,602.0d0,604.0d0,606.0d0,608.0d0,&
             610.0d0,612.0d0,614.0d0,616.0d0,618.0d0,620.0d0,622.0d0,&
             624.0d0,626.0d0,628.0d0,630.0d0,632.0d0,634.0d0,636.0d0,&
             638.0d0,640.0d0,642.0d0,644.0d0,646.0d0,648.0d0,650.0d0,&
             652.0d0,654.0d0,656.0d0,658.0d0,660.0d0,662.0d0,664.0d0,&
             666.0d0,668.0d0,670.0d0,672.0d0,674.0d0,676.0d0,678.0d0,&
             680.0d0,682.0d0,684.0d0,686.0d0,688.0d0,690.0d0,692.0d0,&
             694.0d0,696.0d0,698.0d0,700.0d0/), &
Ap_Bricaud_LUT=(/0.043321d0,0.043805d0,0.044307d0,0.045064d0,0.045812d0,&
             0.046699d0,0.047328d0,0.047969d0,0.048595d0,0.049069d0,&
             0.049477d0,0.049611d0,0.049713d0,0.050096d0,0.050561d0,&
             0.051299d0,0.051568d0,0.051726d0,0.051950d0,0.052003d0,&
             0.052019d0,0.051398d0,0.050464d0,0.049508d0,0.048558d0,&
             0.047932d0,0.047111d0,0.046229d0,0.045566d0,0.044945d0,&
             0.044552d0,0.043937d0,0.043282d0,0.042681d0,0.042065d0,&
             0.041530d0,0.040727d0,0.039861d0,0.039079d0,0.038357d0,&
             0.037742d0,0.037013d0,0.036276d0,0.035576d0,0.034834d0,&
             0.034124d0,0.033205d0,0.032170d0,0.031089d0,0.029954d0,&
             0.028819d0,0.027624d0,0.026434d0,0.025281d0,0.024201d0,&
             0.023181d0,0.022189d0,0.021248d0,0.020406d0,0.019624d0,&
             0.018943d0,0.018252d0,0.017583d0,0.017065d0,0.016484d0,&
             0.015987d0,0.015469d0,0.014994d0,0.014524d0,0.014103d0,&
             0.013722d0,0.013316d0,0.012954d0,0.012554d0,0.012194d0,&
             0.011825d0,0.011423d0,0.011049d0,0.010677d0,0.010317d0,&
             0.010031d0,0.0097641d0,0.0094984d0,0.0092848d0,0.0091161d0,&
             0.0090396d0,0.0089222d0,0.0088270d0,0.0087804d0,0.0087719d0,&
             0.0088089d0,0.0088272d0,0.0088963d0,0.0089011d0,0.0089057d0,&
             0.0089436d0,0.0088958d0,0.0088117d0,0.0087399d0,0.0086249d0,&
             0.0085428d0,0.0084855d0,0.0084262d0,0.0084156d0,0.0084456d0,&
             0.0085282d0,0.0086012d0,0.0087063d0,0.0087977d0,0.0088983d0,&
             0.0089570d0,0.0089865d0,0.0090377d0,0.0091362d0,0.0091923d0,&
             0.0093245d0,0.0094377d0,0.0095348d0,0.0096250d0,0.0096807d0,&
             0.0097295d0,0.0098384d0,0.0098896d0,0.0100020d0,0.0100940d0,&
             0.0102980d0,0.0105460d0,0.0109600d0,0.0115510d0,0.0123180d0,&
             0.0133350d0,0.0145240d0,0.0159410d0,0.0174420d0,0.0188000d0,&
             0.0198900d0,0.0205370d0,0.0206550d0,0.0203380d0,0.0195500d0,&
             0.0183000d0,0.0165610d0,0.0145490d0,0.0124000d0,0.0103630d0,&
             0.0086832d0,0.0072437d0,0.0060441d0,0.0051813d0,0.0044349d0,&
             0.0039342d0/), &
Ep_Bricaud_LUT=(/0.70264700d0,0.70008400d0,0.69713200d0,0.69402600d0,0.69163300d0,&
             0.68817200d0,0.68624500d0,0.68156700d0,0.67822900d0,0.67464400d0,&
             0.67119500d0,0.66492600d0,0.65893100d0,0.65573900d0,0.65366800d0,&
             0.65427700d0,0.64998700d0,0.64512700d0,0.64008100d0,0.63579800d0,&
             0.63496500d0,0.62975200d0,0.62319900d0,0.61863100d0,0.61437300d0,&
             0.61509600d0,0.61305600d0,0.61005500d0,0.60961700d0,0.60956400d0,&
             0.61235800d0,0.61281800d0,0.61205500d0,0.61191600d0,0.61194100d0,&
             0.61293800d0,0.61114800d0,0.60839400d0,0.60664900d0,0.60518700d0,&
             0.60653300d0,0.60642900d0,0.60721900d0,0.60974100d0,0.61350600d0,&
             0.62002600d0,0.62504300d0,0.63075200d0,0.63776800d0,0.64575000d0,&
             0.65574300d0,0.66499400d0,0.67451100d0,0.68439000d0,0.69450800d0,&
             0.70600400d0,0.71550900d0,0.72468700d0,0.73496500d0,0.74470400d0,&
             0.75513100d0,0.76437800d0,0.77428800d0,0.77583700d0,0.78423400d0,&
             0.79197900d0,0.79929700d0,0.80430600d0,0.81154700d0,0.81623700d0,&
             0.82177600d0,0.82706000d0,0.83034000d0,0.83412900d0,0.83580700d0,&
             0.83854200d0,0.84213100d0,0.84192300d0,0.84380100d0,0.84359000d0,&
             0.84125400d0,0.83924600d0,0.83881500d0,0.83976200d0,0.84005900d0,&
             0.83642500d0,0.83564600d0,0.83547000d0,0.83259200d0,0.82952900d0,&
             0.82763100d0,0.82648500d0,0.81994200d0,0.82021400d0,0.81737600d0,&
             0.81172600d0,0.81085800d0,0.80851800d0,0.80388600d0,0.80434600d0,&
             0.80494400d0,0.80574300d0,0.81047500d0,0.81555500d0,0.82024700d0,&
             0.82480800d0,0.83032200d0,0.83401100d0,0.83820100d0,0.83972600d0,&
             0.84380800d0,0.84618200d0,0.84668000d0,0.84434200d0,0.84656800d0,&
             0.84554300d0,0.84563600d0,0.84497200d0,0.84295600d0,0.84116400d0,&
             0.83738800d0,0.82956800d0,0.82599800d0,0.81902800d0,0.81820600d0,&
             0.81423600d0,0.81486100d0,0.81376400d0,0.81490400d0,0.82011500d0,&
             0.82296500d0,0.82755100d0,0.82416800d0,0.81972200d0,0.81759900d0,&
             0.81774200d0,0.81659000d0,0.81882300d0,0.82229100d0,0.82725000d0,&
             0.83522900d0,0.85007600d0,0.86755500d0,0.88844400d0,0.91245670d0,&
             0.93138840d0,0.94421240d0,0.96783410d0,0.98167950d0,1.00265734d0,&
             1.0131636d0/)

INTEGER :: IULO,MPL,KLO
REAL*8 :: Ap_Bricaud,Ep_Bricaud,RTMP

IF(WAVELENGTH_NM<400.0D0 .OR. WAVELENGTH_NM>700.0D0)THEN
  STOP 'WAVELENGTH OUT RANGE OF BRICAUD TABLE'
ENDIF

MPL=3
IULO=INT(FLOAT(NWV_Bricaud)*ABS((WAVELENGTH_NM-WV_Bricaud(1))/(WV_Bricaud(NWV_Bricaud)-WV_Bricaud(1))))

call hunt(WV_Bricaud,NWV_Bricaud,WAVELENGTH_NM,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NWV_Bricaud-MPL)
CALL POLINT(WV_Bricaud(KLO),Ap_Bricaud_LUT(KLO),MPL,WAVELENGTH_NM,Ap_Bricaud,RTMP)
CALL POLINT(WV_Bricaud(KLO),Ep_Bricaud_LUT(KLO),MPL,WAVELENGTH_NM,Ep_Bricaud,RTMP)
AP=Ap_Bricaud*CHLaVal**Ep_Bricaud

ENDSUBROUTINE AP_BRICAUD_LUT_SEARCH


SUBROUTINE HYDRSL_PHMX_ASSIGN(CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL, &
       NTLYERA,NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,ITLYERW,PHMXDATASTREAM)
USE RTUTILITY, ONLY : PI
USE GLOBAL_DATA, ONLY : DEPOL_A, DEPOL_O, Xi_kok, Alpha_kok, T0_kok,Dpol90_Kok
IMPLICIT NONE

REAL*8 :: CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL
INTEGER :: NTLYERA,NUMMIERT, NUMMIEANGMAX,ITLYERW
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM

INTEGER :: IANG
REAL*8 :: RTMP,RTMP1,ANGLE,NU,DLT90,XW,MUF,NORM,FFPH

IF(CHLaLOCAL>0.001D0)CALL FFPFCOEFF(BBPTCfracLOCAL,NU,DLT90)
DO IANG=1,NUMMIEANGINPUT(NTLYERA+ITLYERW)
  ANGLE=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,0)
  XW=(1.0D0-DEPOL_O)/(1.0D0+DEPOL_O)
  NORM=3.0D0/(3.0D0+XW)
  MUF=cos(ANGLE*pi/180.0d0)
  RTMP=NORM*(1.0D0+XW*MUF*MUF)
  IF(CHLaLOCAL>0.001D0) THEN
     RTMP1=FFPH(NU,DLT90,ANGLE)
     PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)= (BWLOCAL*RTMP +  &
       BPTCLOCAL*RTMP1)/ &
      (BWLOCAL + BPTCLOCAL)
  ELSE
     PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)= RTMP
  ENDIF
  RTMP1=Xi_kok*EXP(-Alpha_kok*ANGLE/180.0D0*PI)
  RTMP=1.0D0+Dpol90_Kok*(cos(ANGLE/180.0D0*PI-T0_kok))**2 + RTMP1
  
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2)= &
     (Dpol90_Kok*(1.0D0+(cos(ANGLE/180.0D0*PI-T0_kok))**2) + RTMP1)/RTMP
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)= &
     (2.0D0*Dpol90_Kok*MUF + RTMP1)/(1.0D0+Dpol90_Kok*MUF*MUF + RTMP1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5)=- Dpol90_Kok*((sin(ANGLE/180.0D0*PI))**2) &
          /(1.0d0+Dpol90_Kok*MUF*MUF)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6)=0.0d0

  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
ENDDO


END SUBROUTINE HYDRSL_PHMX_ASSIGN


SUBROUTINE FFPFCOEFF(BB,NU,DLT90)
IMPLICIT NONE
real*8 BB,NU,DLT90
real*8 NURTLW,NURTHI,XACC,RTMP
real*8 FNU,rtsec
EXTERNAL FNU
NURTLW=-1.0D0
NURTHI=0.0D0
XACC=1.0E-12
NU=rtsec(FNU,BB,NURTLW,NURTHI,XACC)
RTMP=(0.01D0-0.3084D0*NU)*(0.01D0-0.3084D0*NU)
DLT90=2.0D0/3.0D0/RTMP
END SUBROUTINE

REAL*8 FUNCTION FNU(NU,BB)
IMPLICIT NONE
real*8 NU,BB
real*8 DLTTMP,RTMP,DLTPNU

RTMP=(0.01D0-0.3084D0*NU)**2
DLTTMP=2.0D0/3.0D0/RTMP
DLTPNU=DLTTMP**NU
FNU=1.0D0-BB-(0.5D0-DLTTMP*DLTPNU+0.5D0*DLTPNU)/(DLTPNU-DLTTMP*DLTPNU)
END FUNCTION FNU

REAL*8 FUNCTION FFPH(NU,DLT90,ANG)
IMPLICIT NONE
real*8 NU,DLT90,ANG
real*8 ANGTMP,ANGD2,SINANGD2,COSANG,DLT,DLTPNU,OMDLT,OMDLTPNU
real*8 FCT1,TRM1,TRM2,DLT180,DLT180PNU,OMDLT180,OMDLT180PNU

ANGTMP=ANG/180.d0*3.1415926535897932d0
IF(ANGTMP<1.0E-4)ANGTMP=1.0E-4
ANGD2=0.5d0*ANGTMP
SINANGD2=SIN(ANGD2)
SINANGD2=SINANGD2*SINANGD2
COSANG=COS(ANGTMP)

DLT180=2.0d0*DLT90
DLT=DLT180*SINANGD2
DLTPNU=DLT**NU
OMDLT=1.0d0-DLT
OMDLTPNU=1.0d0-DLTPNU
FCT1=1.0d0/OMDLT/OMDLT/DLTPNU
TRM1=NU*OMDLT-OMDLTPNU
TRM2=DLT*OMDLTPNU-NU*OMDLT

DLT180PNU=DLT180**NU
OMDLT180=1.0d0-DLT180
OMDLT180PNU=1.0D0-DLT180PNU
FFPH=FCT1*(TRM1+TRM2/SINANGD2)-  &
       0.25d0*OMDLT180PNU/OMDLT180/DLT180PNU*(3.0d0*COSANG*COSANG-1.0d0)
END FUNCTION FFPH

!SEA WATER SCATTERING COEFFICIENTS BASED ON BUITEVELD 1994 OOXII
REAL*8 FUNCTION BWFUNC(WVLN,TMPTR,SALINITY)
USE GLOBAL_DATA, only : DEPOL_O
USE RTUTILITY, ONLY : PI
IMPLICIT NONE

REAL*8 WVLN,TMPTR,SALINITY
REAL*8 WVLN2,WVLN4,WVLNM,WVLNM4,TEM2,BETA90,TMPABSLT,BOLZMANK,BETAT, &
       INDX,INDXDP,INDXDP20,INDXDP633,INDXDPDNM

BOLZMANK=1.38054D-23
TMPABSLT=TMPTR+273.15D0
WVLNM=WVLN*1.0E-9 
WVLNM4=WVLNM**4
WVLN2=WVLN*WVLN
WVLN4=WVLN2*WVLN2
TEM2=TMPTR*TMPTR
BETAT=(5.062271D0-0.03179D0*TMPTR+0.000407D0*TEM2)*1.0D-10
INDX=1.3247D0+3300.0D0/WVLN2-3.2D7/WVLN4-2.5D-6*TEM2 !&
! +(5.0D0-0.02D0*TMPTR)*4.0D-5*SALINITY
INDXDP20=(-0.000156d0*WVLN+1.5989D0)*1.0D-10
INDXDP633=(1.61857D0-0.005785*TMPTR)*1.0D-10
INDXDPDNM=(-0.000156d0*633.0D0+1.5989D0)*1.0D-10
!INDXDPDNM=1.5014D-010
INDXDP=INDXDP20*INDXDP633/INDXDPDNM
!write(*,*)'INDXDP=',INDXDP20,INDXDP633,INDXDPDNM,INDXDP
BETA90=2.0D0*PI*PI*BOLZMANK/WVLNM4/BETAT*TMPABSLT*INDX*INDX*          &
INDXDP*INDXDP*6.0D0*(1.0D0+DEPOL_O)/(6.0D0-7.0D0*DEPOL_O)
!write(*,*)'BETA90=',BETA90
BWFUNC=8.0D0*PI/3.0D0*BETA90*(2.0D0+DEPOL_O)/(1.0D0+DEPOL_O)
BWFUNC=BWFUNC*(1.0d0+0.3d0*SALINITY/37.0D0)

END FUNCTION BWFUNC

      REAL*8 FUNCTION rtsec(func,BB,x1,x2,xacc)
      INTEGER MAXIT
      real*8 x1,x2,xacc,func,BB
      EXTERNAL func
      PARAMETER (MAXIT=30)
      INTEGER j
      real*8 dx,f,fl,swap,xl
      fl=func(x1,BB)
      f=func(x2,BB)
	  if(f*fl>1.0e-12)stop'root not bracketed'
      if(abs(fl).lt.abs(f))then
        rtsec=x1
        xl=x2
        swap=fl
        fl=f
        f=swap
      else
        xl=x1
        rtsec=x2
      endif
      do 11 j=1,MAXIT
        dx=(xl-rtsec)*f/(f-fl)
        xl=rtsec
        fl=f
        rtsec=rtsec+dx
        f=func(rtsec,BB)
        if(abs(dx).lt.xacc.or.f.eq.0.)return
11    continue
      STOP 'rtsec exceed maximum iterations'
      END


SUBROUTINE PARTICLEMODELSELECTION(CLOUDFLAG,IAEROSOL,IRH,IOPT,              &
                WAVELENGTH_MICRON,NUMMIEUSE,NTLYERA,ALT_LYRA,PNDLY,              &
                REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2,ARSLND1,ARSLND2)
USE GLOBAL_DATA
USE AEROSOL_MICROPHYSICAL_MODEL
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE

LOGICAL,INTENT(IN) :: CLOUDFLAG

INTEGER,INTENT(IN) :: IAEROSOL,IRH,IOPT
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON

INTEGER,INTENT(IN) :: NUMMIEUSE,NTLYERA
REAL*8,DIMENSION(NUMMIEUSE),INTENT(OUT)::REFF1,VEFF1,REFF2, &
                                    VEFF2,MRR1,MRI1,MRR2,MRI2
REAL*8,DIMENSION(NTLYERA+1),INTENT(INOUT) :: ALT_LYRA
REAL*8,DIMENSION(NTLYERA),INTENT(INOUT) :: ARSLND1,ARSLND2,PNDLY

REAL*8, DIMENSION(1) :: WAVELENGTH_MICRON_LOCAL
INTEGER :: IWV

! MIE SCATTERING DEFINITION
INTEGER :: NDISTR,NANGMIE_LOCAL,ICOM
REAL*8 :: AA1,BB1,AA2,BB2,GAMMAI,REFFO,VEFFO,AREA,CEXT,CEXT1,CSCAT
REAL*8,DIMENSION(NUMMIEANGMAX,0:6)::PHMXMIE_LOCAL

REAL*8 :: RTMP, RTMP1

CALL ARSL_VERP_INIT(NTLYERA,ALT_LYRA,PNDLY)

IF(CLOUDFLAG) THEN
  sngmode=.true.
  ARSLND1=1.0*PNDLY
  ARSLND2=0.0
  CALL CLOUDMODELSELECTION(WV_REF,NUMMIEUSE,  &
            REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2)

 ! CONVERT TO EFFECT RADIUS AND VARIANCE BEFORE CALL SPHER_INTERFACE
  VEFF1=VEFF1*VEFF1
  VEFF2=VEFF2*VEFF2
      
  REFF1=REFF1*EXP(2.5D0*VEFF1) 
  REFF2=REFF2*EXP(2.5D0*VEFF2)
  VEFF1=EXP(VEFF1)-1.0D0
  VEFF2=EXP(VEFF2)-1.0D0

  NDISTR=2

  CALL SPHER_INTERFACE(NDISTR,REFF1(1),VEFF1(1),WV_REF,MRR1(1),MRI1(1),&
        AA1,BB1,AA2,BB2,GAMMAI,REFFO,VEFFO,AREA,CEXT,CSCAT,NANGMIE_LOCAL,PHMXMIE_LOCAL)
  IF(.NOT.sngmode)THEN
    CALL SPHER_INTERFACE(NDISTR,REFF2(1),VEFF2(1),WV_REF,MRR2(1),MRI2(1),&
        AA1,BB1,AA2,BB2,GAMMAI,REFFO,VEFFO,AREA,CEXT1,CSCAT,NANGMIE_LOCAL,PHMXMIE_LOCAL)
  ELSE
    CEXT1=0.0D0
  ENDIF
  RTMP=SUM(ARSLND1)*CEXT+SUM(ARSLND2)*CEXT1
  ARSLND1=ARSLND1/RTMP*TAU550(IOPT) 
  ARSLND2=ARSLND2/RTMP*TAU550(IOPT)

  CALL CLOUDMODELSELECTION(WAVELENGTH_MICRON,NUMMIEUSE,  &
            REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2)

  VEFF1=VEFF1*VEFF1
  VEFF2=VEFF2*VEFF2
      
  REFF1=REFF1*EXP(2.5D0*VEFF1) 
  REFF2=REFF2*EXP(2.5D0*VEFF2)
  VEFF1=EXP(VEFF1)-1.0D0
  VEFF2=EXP(VEFF2)-1.0D0

ELSE

  IF(IAEROSOL==10) THEN
     sngmode=.true.
  ELSE
     sngmode=.FALSE.
  ENDIF
  WAVELENGTH_MICRON_LOCAL=WAVELENGTH_MICRON
  CALL ARSL_INDX_INIT(1, WAVELENGTH_MICRON_LOCAL)
  IF(IAEROSOL==1)THEN
       REFF1(:)=RTROPOSPHERE(IRH)
       REFF2(:)=RRURALC(IRH)
  ELSEIF(IAEROSOL<=6)THEN
       REFF1(:)=RURBANF(IRH)
       REFF2(:)=RURBANC(IRH)
  ELSEIF(IAEROSOL<=9)THEN
       REFF1(:)=RTROPOSPHERE(IRH)
       REFF2(:)=ROCEANIC(IRH)
  ELSEIF(IAEROSOL==10)THEN
       REFF1(:)=RTROPOSPHERE(IRH)
       REFF2(:)=0.0D0
  ELSEIF(IAEROSOL>10)THEN
       REFF1(:)=exp(log(RZIAF(IRH))-3.0*SIGF_ZIA*SIGF_ZIA) 
            ! Rg in number space read Eq.3a in Ahmad 2000 for details
       REFF2(:)=exp(log(RZIAC(IRH))-3.0*SIGC_ZIA*SIGC_ZIA)
  ENDIF
  IF(IAEROSOL<=10)THEN
     VEFF1(:)=SIGF_SF
     VEFF2(:)=SIGC_SF
  ELSE
     VEFF1(:)=SIGF_ZIA
     VEFF2(:)=SIGC_ZIA
  ENDIF

  IF(IAEROSOL<7)THEN
     ARSLND1=0.999875*PNDLY
     ARSLND2=0.000125*PNDLY
  ELSEIF(IAEROSOL==7)THEN
     ARSLND1=0.99*PNDLY
     ARSLND2=0.01*PNDLY
  ELSEIF(IAEROSOL==8)THEN
     ARSLND1=0.995*PNDLY
     ARSLND2=0.005*PNDLY
  ELSEIF(IAEROSOL==9)THEN
     ARSLND1=0.998*PNDLY
     ARSLND2=0.002*PNDLY
  ELSEIF(IAEROSOL==10)THEN
     ARSLND1=PNDLY
     ARSLND2=0.0D0
  ELSE
     RTMP=4.0D0*PI*(REFF1(1)**3)/3.0D0
     RTMP=RATIO_FINE_MODE_ZIA(IAEROSOL-10)/RTMP*EXP(-4.5D0*VEFF1(1)*VEFF1(1))
     RTMP1=4.0D0*PI*(REFF2(1)**3)/3.0D0
     RTMP1=(1.0D0-RATIO_FINE_MODE_ZIA(IAEROSOL-10))/RTMP1*EXP(-4.5D0*VEFF2(1)*VEFF2(1))
     RTMP=RTMP/(RTMP+RTMP1)
     ARSLND1=RTMP*PNDLY
     ARSLND2=(1.0D0-RTMP)*PNDLY
!     WRITE(*,*)'FINE MODE FRACTION=',RTMP
  ENDIF
  IWV=1
  IF(IAEROSOL==1)THEN !rural 
       MRR1(:)=MR_TRPOSPHERE(IWV+1,IRH)
       MRI1(:)=MI_TRPOSPHERE(IWV+1,IRH)
       MRR2(:)=MR_RURALC(IWV+1,IRH)
       MRI2(:)=MI_RURALC(IWV+1,IRH)
  ELSEIF(IAEROSOL==2)THEN ! URBAN
       MRR1(:)=MR_URBANF(IWV+1,IRH)
       MRI1(:)=MI_URBANF(IWV+1,IRH)
       MRR2(:)=MR_URBANC(IWV+1,IRH)
       MRI2(:)=MI_URBANC(IWV+1,IRH)
  ELSEIF(IAEROSOL==3)THEN ! URBAN A
       MRR1(:)=MR_URBANAF(IWV+1,IRH)
       MRI1(:)=MI_URBANAF(IWV+1,IRH)
       MRR2(:)=MR_URBANAC(IWV+1,IRH)
       MRI2(:)=MI_URBANAC(IWV+1,IRH)
  ELSEIF(IAEROSOL==4)THEN  ! URBAN A1
       MRR1(:)=MR_URBANA1F(IWV+1,IRH)
       MRI1(:)=MI_URBANA1F(IWV+1,IRH)
       MRR2(:)=MR_URBANA1C(IWV+1,IRH)
       MRI2(:)=MI_URBANA1C(IWV+1,IRH)
    ELSEIF(IAEROSOL==5)THEN! URBAN A2
       MRR1(:)=MR_URBANA2F(IWV+1,IRH)
       MRI1(:)=MI_URBANA2F(IWV+1,IRH)
       MRR2(:)=MR_URBANA2C(IWV+1,IRH)
       MRI2(:)=MI_URBANA2C(IWV+1,IRH)
    ELSEIF(IAEROSOL==6)THEN! URBAN A3
       MRR1(:)=MR_URBANA3F(IWV+1,IRH)
       MRI1(:)=MI_URBANA3F(IWV+1,IRH)
       MRR2(:)=MR_URBANA3C(IWV+1,IRH)
       MRI2(:)=MI_URBANA3C(IWV+1,IRH)
    ELSEIF(IAEROSOL>=7 .AND. IAEROSOL<=9)THEN! MARINETIME
       MRR1(:)=MR_TRPOSPHERE(IWV+1,IRH)
       MRI1(:)=MI_TRPOSPHERE(IWV+1,IRH)
       MRR2(:)=MR_OCEANIC(IWV+1,IRH)
       MRI2(:)=MI_OCEANIC(IWV+1,IRH)
    ELSEIF(IAEROSOL==10)THEN
       MRR1(:)=MR_TRPOSPHERE(IWV+1,IRH)
       MRI1(:)=MI_TRPOSPHERE(IWV+1,IRH)
       MRR2(:)=1.0
       MRI2(:)=0.0
    ELSEIF(IAEROSOL>10)THEN
       MRR1(:)=MR_ZIAF(IWV+1,IRH)
       MRI1(:)=MI_ZIAF(IWV+1,IRH)
       MRR2(:)=MR_ZIAC(IWV+1,IRH)
       MRI2(:)=MI_ZIAC(IWV+1,IRH)
    ENDIF

 ! CONVERT TO EFFECT RADIUS AND VARIANCE BEFORE CALL SPHER_INTERFACE
  VEFF1=VEFF1*VEFF1
  VEFF2=VEFF2*VEFF2
      
  REFF1=REFF1*EXP(2.5D0*VEFF1) 
  REFF2=REFF2*EXP(2.5D0*VEFF2)
  VEFF1=EXP(VEFF1)-1.0D0
  VEFF2=EXP(VEFF2)-1.0D0

  NDISTR=2

  CALL SPHER_INTERFACE(NDISTR,REFF1(1),VEFF1(1),WV_REF,MRR1(1),MRI1(1),&
        AA1,BB1,AA2,BB2,GAMMAI,REFFO,VEFFO,AREA,CEXT,CSCAT,NANGMIE_LOCAL,PHMXMIE_LOCAL)
  IF(.NOT.sngmode)THEN
    CALL SPHER_INTERFACE(NDISTR,REFF2(1),VEFF2(1),WV_REF,MRR2(1),MRI2(1),&
        AA1,BB1,AA2,BB2,GAMMAI,REFFO,VEFFO,AREA,CEXT1,CSCAT,NANGMIE_LOCAL,PHMXMIE_LOCAL)
  ELSE
    CEXT1=0.0D0
  ENDIF
  RTMP=SUM(ARSLND1)*CEXT+SUM(ARSLND2)*CEXT1
  ARSLND1=ARSLND1/RTMP*TAU550(IOPT) 
  ARSLND2=ARSLND2/RTMP*TAU550(IOPT) 

  IF(IAEROSOL==1)THEN !rural 
       MRR1(:)=MR_TRPOSPHERE(IWV,IRH)
       MRI1(:)=MI_TRPOSPHERE(IWV,IRH)
       MRR2(:)=MR_RURALC(IWV,IRH)
       MRI2(:)=MI_RURALC(IWV,IRH)
  ELSEIF(IAEROSOL==2)THEN ! URBAN
       MRR1(:)=MR_URBANF(IWV,IRH)
       MRI1(:)=MI_URBANF(IWV,IRH)
       MRR2(:)=MR_URBANC(IWV,IRH)
       MRI2(:)=MI_URBANC(IWV,IRH)
  ELSEIF(IAEROSOL==3)THEN ! URBAN A
       MRR1(:)=MR_URBANAF(IWV,IRH)
       MRI1(:)=MI_URBANAF(IWV,IRH)
       MRR2(:)=MR_URBANAC(IWV,IRH)
       MRI2(:)=MI_URBANAC(IWV,IRH)
  ELSEIF(IAEROSOL==4)THEN  ! URBAN A1
       MRR1(:)=MR_URBANA1F(IWV,IRH)
       MRI1(:)=MI_URBANA1F(IWV,IRH)
       MRR2(:)=MR_URBANA1C(IWV,IRH)
       MRI2(:)=MI_URBANA1C(IWV,IRH)
    ELSEIF(IAEROSOL==5)THEN! URBAN A2
       MRR1(:)=MR_URBANA2F(IWV,IRH)
       MRI1(:)=MI_URBANA2F(IWV,IRH)
       MRR2(:)=MR_URBANA2C(IWV,IRH)
       MRI2(:)=MI_URBANA2C(IWV,IRH)
    ELSEIF(IAEROSOL==6)THEN! URBAN A3
       MRR1(:)=MR_URBANA3F(IWV,IRH)
       MRI1(:)=MI_URBANA3F(IWV,IRH)
       MRR2(:)=MR_URBANA3C(IWV,IRH)
       MRI2(:)=MI_URBANA3C(IWV,IRH)
    ELSEIF(IAEROSOL>=7 .AND. IAEROSOL<=9)THEN! MARINETIME
       MRR1(:)=MR_TRPOSPHERE(IWV,IRH)
       MRI1(:)=MI_TRPOSPHERE(IWV,IRH)
       MRR2(:)=MR_OCEANIC(IWV,IRH)
       MRI2(:)=MI_OCEANIC(IWV,IRH)
    ELSEIF(IAEROSOL==10)THEN
       MRR1(:)=MR_TRPOSPHERE(IWV,IRH)
       MRI1(:)=MI_TRPOSPHERE(IWV,IRH)
       MRR2(:)=1.0
       MRI2(:)=0.0
    ELSEIF(IAEROSOL>10)THEN
       MRR1(:)=MR_ZIAF(IWV,IRH)
       MRI1(:)=MI_ZIAF(IWV,IRH)
       MRR2(:)=MR_ZIAC(IWV,IRH)
       MRI2(:)=MI_ZIAC(IWV,IRH)
    ENDIF
    CALL ARSL_INDX_DEALLO
ENDIF

END SUBROUTINE PARTICLEMODELSELECTION




SUBROUTINE CLOUDMODELSELECTION(WAVELENGTH_MICRON,NUMMIEUSE,           &
             REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2)
USE GLOBAL_DATA
USE RTUTILITY, ONLY : PI
IMPLICIT NONE

INTEGER,INTENT(IN) :: NUMMIEUSE
REAL*8,INTENT(IN)::WAVELENGTH_MICRON
REAL*8,DIMENSION(NUMMIEUSE),INTENT(OUT)::REFF1,VEFF1,REFF2, &
                                    VEFF2,MRR1,MRI1,MRR2,MRI2
REAL*8 :: RADIUS_CLOUDS=10.0D0,VARIANCE_CLOUDS=0.1D0,&
          TMPTR=-20.0D0,SALINITY=0.0D0,WVLN
REAL*8 :: RTMP,RTMP1,RINDX_WATERLOCAL
WVLN=WAVELENGTH_MICRON*1000.0d0
CALL WATER_REFRACTIVE_INDEX(WVLN,TMPTR,SALINITY,RINDX_WATERLOCAL)

REFF1(:)=RADIUS_CLOUDS
REFF2(:)=RADIUS_CLOUDS
VEFF1(:)=VARIANCE_CLOUDS
VEFF2(:)=VARIANCE_CLOUDS
MRR1(:)=RINDX_WATERLOCAL
MRI1(:)=RINDX_WATERLOCAL
MRR2(:)=0.0d0
MRI2(:)=0.0d0

END SUBROUTINE CLOUDMODELSELECTION

SUBROUTINE WATER_ABSORPTION_LEE_READ
USE GLOBAL_DATA
IMPLICIT NONE
INTEGER :: IREAD

OPEN(UNIT=1,FILE='aw_seawater.txt',STATUS='OLD',ACTION='READ')
DO IREAD=1,4
READ(1,*)
ENDDO
DO IREAD=1,NWV_AW_LEE_LUT
READ(1,*)WV_AW_LEE_LUT(IREAD),AW_LEE_LUT(IREAD)
ENDDO
CLOSE(1)
RETURN
ENDSUBROUTINE WATER_ABSORPTION_LEE_READ

SUBROUTINE WATER_ABSORPTION_READ
USE GLOBAL_DATA
IMPLICIT NONE
INTEGER :: IREAD

OPEN(UNIT=1,FILE='water_coef.txt',STATUS='OLD',ACTION='READ')
DO IREAD=1,30
  READ(1,*)
ENDDO
DO IREAD=1,NWV_PF_LUT
  READ(1,*)WV_PF_LUT(IREAD),AW_PF_LUT(IREAD),BW_PF_LUT(IREAD)
ENDDO
CLOSE(1)
RETURN
ENDSUBROUTINE WATER_ABSORPTION_READ

SUBROUTINE SOURCEF_FLUORESCENCE_INTEGRATION(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,LAMBDAEM)
USE IRRADSUNL
USE RAMANDATA
USE SAVE_OCEAN_MOD
USE FLUORESCENCEDATA
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
LOGICAL, INTENT(IN):: OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG
REAL*8, INTENT(IN) :: LAMBDAEM
REAL*8,PARAMETER :: IPAR_WV_BEG=400.0D0,IPAR_WV_END=700.0D0
REAL*8, PARAMETER :: PLANK_CONSTANT_TIMES_C=1.98644568D-16  ! UNIT (J nm)
REAL*8, PARAMETER :: Avogadro_Constant=6.02214085774D23
REAL*8 :: NPQ_ADJUST,PSII_RC_FRAC,QUANTUM_YIELD_CHLA_LOCAL,IPAR_AVG
REAL*8 :: INTWEIGHT
INTEGER :: IWVEX,ILAYERW

SOURCEFO_FLUORESCENCE_AGD=0.0D0
IF(OCEAN_FCDOM_FLAG)THEN
  DO IWVEX=1,NFLRSCGRID
    IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
      INTWEIGHT=0.5D0
    ELSE
      INTWEIGHT=1.0D0
    ENDIF
  DO ILAYERW=1,NWATER_DEPTH
     SOURCEFO_FLUORESCENCE_AGD(ILAYERW)= SOURCEFO_FLUORESCENCE_AGD(ILAYERW)+ &
          DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)*ABSORB_COEFF_CDOM_EX(IWVEX,ILAYERW)  &
              *fCDOMfuncjEX(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
  ENDDO
ENDDO
ENDIF

IF(OCEAN_FCHLA_FLAG)THEN

QUANTUM_YIELD_CHLA_PROFILE=0.0D0
IPAR_SCALAR=0.0D0
IF(NPQ_FLAG)THEN
  DO ILAYERW=1,NWATER_DEPTH
      DO IWVEX=1,NFLRSCGRID
         IF(LAMBDAEXFLRSC(IWVEX)<IPAR_WV_BEG .OR.  &
          LAMBDAEXFLRSC(IWVEX)>IPAR_WV_END)         CYCLE
         IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
           INTWEIGHT=0.5D0/1000.0D0 ! mean to conert irradiance unit from W/m^2/micron to W/m^2/nm
         ELSE
           INTWEIGHT=1.0D0/1000.0D0 ! mean to conert irradiance unit from W/m^2/micron to W/m^2/nm
         ENDIF
         IPAR_SCALAR(ILAYERW)=IPAR_SCALAR(ILAYERW) + DIIRAD_SCALAR_AGD(IWVEX, ILAYERW) * &
                            LAMBDAEXFLRSC(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
      ENDDO
  ENDDO
! IPAR_SCALAR UNIT=MICRO MOL QUANTA m^{-2} s^{-1}
  IPAR_SCALAR=IPAR_SCALAR/PLANK_CONSTANT_TIMES_C/Avogadro_Constant*1.0D6
  CALL PHOTOCHEMICAL_QUENCHING_IPAR_AVG_CAL(NWATER_DEPTH,WATER_DEPTH,IPAR_SCALAR,IPAR_AVG)
!  CALL PHOTOCHEMICAL_QUENCHING_ET_CAL(IPAR_AVG) ! SET QUANTUM_YIELD_CHLA_ET

ENDIF

DO ILAYERW=1,NWATER_DEPTH
    IF(NPQ_FLAG)THEN
! QUANTUM YIELD MODEL FOLLOWS: J. Ruairidh Morrison,
!    'In situ determination of the quantum yield of phytoplankton
!     chlorophyll a fluorescence: A simple algorithm, observations, and a model,'
!     Limnol. Oceanogr. Vol. 48, Page 618-631, (2003)

      PSII_RC_FRAC=EXP(-IPAR_SCALAR(ILAYERW)/QUANTUM_YIELD_CHLA_EK)
      QUANTUM_YIELD_CHLA_LOCAL=PSII_RC_FRAC  * QUANTUM_YIELD_CHLA_MIN + &
               (1.0D0-PSII_RC_FRAC) * QUANTUM_YIELD_CHLA_MAX
      NPQ_ADJUST=QUANTUM_YIELD_CHLA_QI*EXP(-IPAR_SCALAR(ILAYERW)/QUANTUM_YIELD_CHLA_ET)

      QUANTUM_YIELD_CHLA_LOCAL=QUANTUM_YIELD_CHLA_LOCAL*NPQ_ADJUST
    ELSE
      QUANTUM_YIELD_CHLA_LOCAL=0.02D0
    ENDIF

    DO IWVEX=1,NFLRSCGRID
      IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
        INTWEIGHT=0.5D0
      ELSE
        INTWEIGHT=1.0D0
      ENDIF

     SOURCEFO_FLUORESCENCE_AGD(ILAYERW)= SOURCEFO_FLUORESCENCE_AGD(ILAYERW)     + &
          DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)*ABSORB_COEFF_CHLA_EX(IWVEX,ILAYERW) * &
          QUANTUM_YIELD_CHLA_LOCAL *fCHLAfuncjEX(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
    ENDDO
  ENDDO


ENDIF
SOURCEFO_FLUORESCENCE_AGD=SOURCEFO_FLUORESCENCE_AGD/(4*PI) !phase function is isotropic

ENDSUBROUTINE SOURCEF_FLUORESCENCE_INTEGRATION

SUBROUTINE SOURCEF_EM_INTEGRATION(NQUADOINPUT,MU_IN)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: NQUADOINPUT
REAL*8,INTENT(IN) :: MU_IN
REAL*8 :: WAVELENGTH_MICRON
INTEGER :: IQUAD,MVAR,ICOM,ILAYERW

REAL*8 :: RTMP1
REAL*8,DIMENSION(:),ALLOCATABLE :: SOURCEOTMP

INTEGER :: IKPP,IWVEX
REAL*8 :: POLINT_SIMPLE

DO ICOM=1,4
   SOURCEFO_RAMAN_AGD(1:NQUADOINPUT+2,1:NWATER_DEPTH,0:2)%VRAD(ICOM)=0.0D0
ENDDO

ALLOCATE(SOURCEOTMP(NFLRSCGRID))
DO IQUAD=1,NQUADOINPUT+2
DO MVAR=0,2
DO ILAYERW=1,NWATER_DEPTH

DO ICOM=1,4

  DO IWVEX=1,NFLRSCGRID
    SOURCEOTMP(IWVEX)=SOURCEFO_RAMAN_AGD_LUT(IWVEX,IQUAD,ILAYERW,MVAR)%VRAD(ICOM)
  ENDDO
DO IKPP=1,NKGRID
  WAVELENGTH_MICRON=LAMBDAEX(IKPP)/1000.0D0
  IF(LAMBDAEX(IKPP)>LAMBDAEXFLRSC(1) .AND. LAMBDAEX(IKPP)<LAMBDAEXFLRSC(NFLRSCGRID))THEN
     RTMP1=POLINT_SIMPLE(NFLRSCGRID,LAMBDAEXFLRSC,SOURCEOTMP,LAMBDAEX(IKPP),2)
  ELSE
     RTMP1=0.0D0
  ENDIF
  SCATT_COEFF_RAMAN_EX=2.7d-4*(488.0d0/LAMBDAEX(IKPP))**5.3
  SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)= &
  SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)+ &
                       RTMP1*SCATT_COEFF_RAMAN_EX*fRfuncjEX(IKPP)*KppWeight(IKPP)

!if(mvar==0 .and. icom==1 .and. SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)<0.0d0) then
!  write(*,*)'source_em_integration_tsp1',ilayerw,LAMBDAEX(IKPP),RTMP1
!  DO IWVEX=1,NFLRSCGRID
!    write(*,*)'source_em_integration_tsp1,LAMBDAEXFLRSC,SOURCEOTMP ',&
!               LAMBDAEXFLRSC(IWVEX),SOURCEOTMP(IWVEX)
!  ENDDO
!endif

ENDDO

ENDDO

ENDDO
ENDDO
ENDDO

!testing Raman Scattering Source Integration
!DO ILAYERW=1,NWATER_DEPTH
!write(*,*)'tsp_Raman_Integration',WATER_DEPTH(ILAYERW),SOURCEFO_RAMAN_AGD(1,ILAYERW,0)%VRAD(1),&
!          SOURCEFO_RAMAN_AGD(NQUADOINPUT+2,ILAYERW,0)%VRAD(1)
!ENDDO

DEALLOCATE(SOURCEOTMP)

END SUBROUTINE SOURCEF_EM_INTEGRATION


SUBROUTINE OCEAN_RAMAN_SOURCE_LUT_STORE(IWVEX,NQUADOINPUT,WAVELENGTH_MICRON,MU_IN)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE GLOBAL_DATA, ONLY : ABSORPTION_TAU_REDUCE_FLAG,TAU_REDUCE_OCEAN_PRESERVE
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: IWVEX,NQUADOINPUT
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,MU_IN
INTEGER :: ITAU,IQUAD,MVAR,I,ICOM,ILAYERW
REAL*8 :: ESUN_EX

INTEGER :: IULO,MPL,KLO
REAL*8 :: RTMP,RTMP1,RTMP2
REAL*8,DIMENSION(:,:,:),ALLOCATABLE :: SOURCEOTMP
REAL*8,DIMENSION(3)::QSRC,ELCOEFF
REAL*8 :: SQRTSIGN,TAUDIFF,TAUDIFF1

!NUMTOTALTAUEX==NTTAU-OLYR(1)%ITAUS+1
!OITAU_EX==OITAU_PRSV
!IRRAD_SUN_EX==ESUN
!TAU_INELASTIC_EX(1:NUMTOTALTAUEX)==TAU_PRSV(OLYR(1)%ITAUS:NTTAU)-OITAU_PRSV

MPL=3
IULO=INT(FLOAT(NSUNL)*ABS((WAVELENGTH_MICRON-WVSUN(1))/(WVSUN(NSUNL)-WVSUN(1))))
call hunt(WVSUN,NSUNL,WAVELENGTH_MICRON,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NSUNL-MPL)
CALL POLINT(WVSUN(KLO),FSUN(KLO),MPL,WAVELENGTH_MICRON,ESUN_EX,RTMP)

ALLOCATE(SOURCEOTMP(1:NUMTOTALTAUEX,1:4,0:2))
DO IQUAD=1,NQUADOINPUT+2
DO MVAR=0,2
DO ICOM=1,4
DO ITAU=1,NUMTOTALTAUEX
   SOURCEOTMP(ITAU,ICOM,MVAR)=ESUN_EX*SOURCEFO_RAMAN_TGD(IQUAD,ITAU,MVAR)%VRAD(ICOM)/IRRAD_SUN_EX(1)
!   if(mvar==0 .and. icom==1 .and. SOURCEOTMP(ITAU,ICOM,MVAR)<0.0d0) &
!      write(*,*)'maintsp1',itau,SOURCEOTMP(ITAU,ICOM,MVAR)
ENDDO
ENDDO
ENDDO
DO MVAR=0,2
DO ILAYERW=1,NWATER_DEPTH
  IULO=INT(FLOAT(NUMTOTALTAUEX)*ABS((TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(1))/ &
                   (TAU_INELASTIC_EX(NUMTOTALTAUEX)-TAU_INELASTIC_EX(1))))
  call hunt(TAU_INELASTIC_EX,NUMTOTALTAUEX,TAU_INELASTIC_AGD(ILAYERW),IULO)
  KLO=min(max(IULO-(MPL-1)/2,1),NUMTOTALTAUEX-MPL)
  QSRC(1:3)=SOURCEOTMP(KLO:KLO+2,1,0)
  TAUDIFF=TAU_INELASTIC_EX(KLO+2)-TAU_INELASTIC_EX(KLO)
  RTMP2=(QSRC(2)/QSRC(3))**2-QSRC(1)/QSRC(3)
  IF(RTMP2<0.0D0)RTMP2=0.0D0

  IF(QSRC(1)<QSRC(2) .AND. QSRC(2)<QSRC(3))THEN
     SQRTSIGN=1.0D0
     ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
                                  SQRTSIGN*SQRT(RTMP2))
  ELSE IF(QSRC(1)>QSRC(2) .AND. QSRC(2)>QSRC(3))THEN
     SQRTSIGN=-1.0D0
     ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
                                  SQRTSIGN*SQRT(RTMP2))
  ELSE
     WRITE(*,*)'EM_INTEGRATION, QSRC=',QSRC
     ELCOEFF(1)=0.0d0
  ENDIF
  IF(ELCOEFF(1)>1.0D32)ELCOEFF(1)=0.0D0
  TAUDIFF1=TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(KLO)
  DO ICOM=1,4
     ELCOEFF(2)=SOURCEOTMP(KLO+2,ICOM,MVAR)*EXP(ELCOEFF(1)*TAUDIFF) - SOURCEOTMP(KLO,ICOM,MVAR)
     ELCOEFF(2)=ELCOEFF(2)/TAUDIFF
     ELCOEFF(3)=SOURCEOTMP(KLO,ICOM,MVAR)

     RTMP1=EXP(-ELCOEFF(1)*TAUDIFF1)*(ELCOEFF(3)+ELCOEFF(2)*TAUDIFF1)

! INTERPOLATED VALUE TIMES ABSORPTION DUE TO RESCALED OPTICAL DEPTH
     IF(ABSORPTION_TAU_REDUCE_FLAG)RTMP1=RTMP1*EXP(-TAU_REDUCE_OCEAN_PRESERVE(ILAYERW))
     SOURCEFO_RAMAN_AGD_LUT(IWVEX,IQUAD,ILAYERW,MVAR)%VRAD(ICOM) = RTMP1

!if(mvar==0 .and. icom==1 .and. RTMP1<0.0d0) then
!  write(*,*)'maintsp2',itau,rtmp1,QSRC
!  stop
!endif
   ENDDO

ENDDO
ENDDO
ENDDO

DEALLOCATE(SOURCEOTMP)

DEALLOCATE(PMORAMAN,SPMORAMAN,SOURCEFO_RAMAN_TGD)

END SUBROUTINE OCEAN_RAMAN_SOURCE_LUT_STORE


SUBROUTINE OCEAN_SCALAR_IRRAD_LUT_STORE(IWVEX,WAVELENGTH_MICRON,MU_IN)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE GLOBAL_DATA, ONLY : ABSORPTION_TAU_REDUCE_FLAG,TAU_REDUCE_OCEAN_PRESERVE
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: IWVEX
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,MU_IN
INTEGER :: ITAU,ILAYERW
REAL*8 :: ESUN_EX

INTEGER :: IULO,MPL,KLO
REAL*8 :: RTMP,RTMP1,RTMP2
REAL*8,DIMENSION(3)::QSRC,ELCOEFF
REAL*8 :: SQRTSIGN,TAUDIFF,TAUDIFF1

!NUMTOTALTAUEX==NTTAU-OLYR(1)%ITAUS+1
!OITAU_EX==OITAU_PRSV
!IRRAD_SUN_EX==ESUN
!TAU_INELASTIC_EX(1:NUMTOTALTAUEX)==TAU_PRSV(OLYR(1)%ITAUS:NTTAU)-OITAU_PRSV

MPL=3
IULO=INT(FLOAT(NSUNL)*ABS((WAVELENGTH_MICRON-WVSUN(1))/(WVSUN(NSUNL)-WVSUN(1))))
call hunt(WVSUN,NSUNL,WAVELENGTH_MICRON,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NSUNL-MPL)
CALL POLINT(WVSUN(KLO),FSUN(KLO),MPL,WAVELENGTH_MICRON,ESUN_EX,RTMP)

DIIRAD_SCALAR_TGD=ESUN_EX*DIIRAD_SCALAR_TGD/IRRAD_SUN_EX(1)

DO ILAYERW=1,NWATER_DEPTH
  IULO=INT(FLOAT(NUMTOTALTAUEX)*ABS((TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(1))/ &
     (TAU_INELASTIC_EX(NUMTOTALTAUEX)-TAU_INELASTIC_EX(1))))
  call hunt(TAU_INELASTIC_EX,NUMTOTALTAUEX,TAU_INELASTIC_AGD(ILAYERW),IULO)
  KLO=min(max(IULO-(MPL-1)/2,1),NUMTOTALTAUEX-MPL)
!  CALL POLINT(TAU_INELASTIC_EX(KLO),RARRAYTMP(KLO),MPL,TAU_INELASTIC_AGD(ILAYERW),RTMP1,RTMP)
  QSRC(1:3)=DIIRAD_SCALAR_TGD(KLO:KLO+2)
  TAUDIFF=TAU_INELASTIC_EX(KLO+2)-TAU_INELASTIC_EX(KLO)
  RTMP2=(QSRC(2)/QSRC(3))**2-QSRC(1)/QSRC(3)
  IF(RTMP2<0.0D0)RTMP2=0.0D0

  IF(QSRC(1)<QSRC(2) .AND. QSRC(2)<QSRC(3))THEN
    SQRTSIGN=1.0D0
    ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
             SQRTSIGN*SQRT(RTMP2))
  ELSE IF(QSRC(1)>QSRC(2) .AND. QSRC(2)>QSRC(3))THEN
    SQRTSIGN=-1.0D0
    ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
              SQRTSIGN*SQRT(RTMP2))
  ELSE
    WRITE(*,*)'IRRAD_LUT_STORE,QSRC=',QSRC
    ELCOEFF(1)=0.0d0
  ENDIF
  IF(ELCOEFF(1)>1.0D32)ELCOEFF(1)=0.0D0
  TAUDIFF1=TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(KLO)
  ELCOEFF(2)=DIIRAD_SCALAR_TGD(KLO+2)*EXP(ELCOEFF(1)*TAUDIFF) - DIIRAD_SCALAR_TGD(KLO)
  ELCOEFF(2)=ELCOEFF(2)/TAUDIFF
  ELCOEFF(3)=DIIRAD_SCALAR_TGD(KLO)

  RTMP1=EXP(-ELCOEFF(1)*TAUDIFF1)*(ELCOEFF(3)+ELCOEFF(2)*TAUDIFF1)
  IF(ABSORPTION_TAU_REDUCE_FLAG)RTMP1=RTMP1*EXP(-TAU_REDUCE_OCEAN_PRESERVE(ILAYERW))

  DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)= RTMP1
!if(RTMP1<0.0d0) then
!write(*,*)'maintsp3',ILAYERW,rtmp1,QSRC
!stop
!endif

ENDDO

DEALLOCATE(DIIRAD_SCALAR_TGD)

END SUBROUTINE OCEAN_SCALAR_IRRAD_LUT_STORE

SUBROUTINE WATER_DEPTH_SETUP
USE GLOBAL_DATA
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
IMPLICIT NONE

INTEGER :: INTTMP,IWVEX,IWV,IWVEXSTART
REAL*8 RTMP

WATER_DET_FREE_LOCATION=.false.

IF(WATER_DET_FREE_LOCATION)THEN
  DET_INWATER_REPORT_DEPTH_INCREMENT=4.0D0
  DO INTTMP=1,N_DET_INWATER_REPORT
    DET_INWATER_REPORT_DEPTH(INTTMP)=(INTTMP-1)*DET_INWATER_REPORT_DEPTH_INCREMENT
  ENDDO
ENDIF

WATER_DEPTH_MAX=200.d0

IF(WATER_DET_FREE_LOCATION .AND. DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT)>WATER_DEPTH_MAX) THEN
  WRITE(*,*) 'DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT),WATER_DEPTH_MAX=', &
  DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT),WATER_DEPTH_MAX
  WRITE(*,*) 'WARNING, DETECTOR DEPTH IS LARGER THAN WATER_DEPTH_MAX'
  WRITE(*,*) 'INCREASE WATER_DEPTH_MAX OR WATER_OD_MAX, AND RERUN'
  STOP
ENDIF
!WRITE(*,*)'NWATER_DEPTH,WATER_DEPTH_MAX=',NWATER_DEPTH,WATER_DEPTH_MAX

RTMP=WATER_DEPTH_MAX/(NWATER_DEPTH-1.0D0)
WATER_DEPTH(1)=0.0D0
DO INTTMP=2,NWATER_DEPTH
  WATER_DEPTH(INTTMP)=WATER_DEPTH(INTTMP-1)+RTMP
ENDDO

END SUBROUTINE WATER_DEPTH_SETUP

SUBROUTINE CHLAPROFILE(WATER_DEPTH_Val,CHLaVal,CHLaLOCAL)

USE GLOBAL_DATA, ONLY : CHLA_HOMOGENEITY,CHLA_C0,CHLA_Slope,CHLA_Cmax, &
                        CHLA_Etamax,CHLA_DeltaEta
IMPLICIT NONE

REAL*8,INTENT(IN) :: WATER_DEPTH_Val,CHLaVal
REAL*8,INTENT(OUT) :: CHLaLOCAL

REAL*8 :: ChlaZeu,ChlaZeuAvg,Zeu,ChlaD0,chla_eta,eta

IF(CHLaVal<1.0E-6 .OR. CHLA_HOMOGENEITY) THEN
   CHLaLOCAL=CHLaVal
   RETURN
ENDIF

CHLA_C0=0.471d0
CHLA_Slope=0.135d0
CHLA_Cmax=1.572d0
CHLA_Etamax=0.969d0
CHLA_DeltaEta=0.393d0


IF(CHLaVal<1.0d0)THEN
   ChlaZeu=36.1D0*CHLaVal**0.357D0
  !Table 4, Uitz et al, J. GEOPHYSICAL RESEARCH,
  ! VOL. 111, C08005, doi:10.1029/2005JC003207, 2006
ELSE
   ChlaZeu=37.7D0*CHLaVal**0.615D0
  ! Table 4, Uitz et al, J. GEOPHYSICAL RESEARCH,
  ! VOL. 111, C08005, doi:10.1029/2005JC003207, 2006
ENDIF
Zeu=568.2d0*ChlaZeu**(-0.746d0)
IF(Zeu>102.0D0)Zeu=200.D0*ChlaZeu**(-0.293D0);
eta=WATER_DEPTH_Val/Zeu;
ChlaZeuAvg=ChlaZeu/Zeu;
chla_eta=CHLA_C0-CHLA_Slope*eta+CHLA_Cmax*exp(-(eta-CHLA_Etamax)**2/CHLA_DeltaEta**2);
ChlaD0=CHLA_C0+CHLA_Cmax*exp(-CHLA_Etamax**2/CHLA_DeltaEta**2)
CHLaLOCAL=chla_eta/ChlaD0*CHLaVal
IF(CHLaLOCAL<0.0d0)CHLaLOCAL=0.0d0
!write(*,*)'WATER_DEPTH_Val,CHLaLOCAL=',WATER_DEPTH_Val,CHLaLOCAL
RETURN
END SUBROUTINE CHLAPROFILE

SUBROUTINE TAU_TG_INIT(NTLYERA,ALT_LYRA,WAVELENGTH_MICRON,TAU_TG)
USE GLOBAL_DATA, ONLY : NPGRID,P_GRID,Z_FIELD,TEM_FIELD,O2VMR_FIELD,         &
        H2OVMR_FIELD,NWV_GAS_ABS_TABLE,WV_GAS_ABS_TABLE,GAS_ABS_COEFF_TABLE, &
        NWV_CHANNEL_AVG,WV_CHANNEL_WIDTH,WV_AVG_RESOLUTION,ILS_PACE

IMPLICIT NONE

INTEGER,INTENT(IN) :: NTLYERA
REAL*8,DIMENSION(NTLYERA+1),INTENT(IN)::ALT_LYRA
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON
REAL*8,DIMENSION(NTLYERA),INTENT(OUT)::TAU_TG

REAL*8 :: POLINT_SIMPLE

REAL*8,DIMENSION(NPGRID) :: GAS_ABS_COEFF,TAU_ABS_GRID,TAU_ABS_CUMSUM

INTEGER :: INTTMP,ILAYER,IWV_AVG
REAL*8 :: RTMP,WV_TMP,GAS_ABS_TMP
REAL*8,DIMENSION(:),ALLOCATABLE :: RARRAYTMP

TAU_TG=0.0D0
IF(ALT_LYRA(1)>Z_FIELD(1))STOP 'WARNING, ALT_LYRA DATA RANGE LARGER THAN Z_FIELD'

! INTERPOLATE GAS_ABS_COEFF_TABLE TO GET GAS_ABS_COEFF
ALLOCATE(RARRAYTMP(NWV_GAS_ABS_TABLE))
DO INTTMP=1,NPGRID
  RARRAYTMP(1:NWV_GAS_ABS_TABLE)=GAS_ABS_COEFF_TABLE(1:NWV_GAS_ABS_TABLE,INTTMP)
  GAS_ABS_TMP=0.0D0
  DO IWV_AVG=1,NWV_CHANNEL_AVG
    WV_TMP=WAVELENGTH_MICRON-WV_CHANNEL_WIDTH/2.0D0+(IWV_AVG-1.0D0)*WV_AVG_RESOLUTION
    RTMP=POLINT_SIMPLE(NWV_GAS_ABS_TABLE,WV_GAS_ABS_TABLE,RARRAYTMP,WV_TMP,2)
    GAS_ABS_TMP=GAS_ABS_TMP+ILS_PACE(IWV_AVG)*RTMP
  ENDDO
  GAS_ABS_COEFF(INTTMP)=GAS_ABS_TMP
ENDDO
DEALLOCATE(RARRAYTMP)

! Z_FIELD IS IN KM
! MULTIPLY BY 1000 TO INTEGRATE AND GET TAU_ABS_GRID
TAU_ABS_CUMSUM=0.0D0
TAU_ABS_GRID(1)=0.0D0
DO INTTMP=2,NPGRID
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP-1)-Z_FIELD(INTTMP))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF(INTTMP-1)+GAS_ABS_COEFF(INTTMP))
  TAU_ABS_CUMSUM(INTTMP)=TAU_ABS_CUMSUM(INTTMP-1)+TAU_ABS_GRID(INTTMP)
ENDDO


DO INTTMP=1,NTLYERA
  TAU_TG(INTTMP)=POLINT_SIMPLE(NPGRID,Z_FIELD,TAU_ABS_CUMSUM,ALT_LYRA(INTTMP+1),3)
ENDDO

DO INTTMP=NTLYERA,2,-1
  TAU_TG(INTTMP)=TAU_TG(INTTMP)-TAU_TG(INTTMP-1)
ENDDO

ENDSUBROUTINE TAU_TG_INIT

SUBROUTINE SPECTRAL_AGENDA_READIN

USE GLOBAL_DATA, ONLY : NWV_GAS_ABS_TABLE, &
            NPGRID, WV_GAS_ABS_TABLE, GAS_ABS_COEFF_TABLE,                    &
            P_GRID,Z_FIELD,TEM_FIELD,O2VMR_FIELD,H2OVMR_FIELD
IMPLICIT NONE


INTEGER :: FILE_INDEX,IREAD,IOFLG
REAL*8,PARAMETER :: CSPEED=299792458.D0
CHARACTER(LEN=180) :: STRTMP,INFILE,DIRSTR,ABSFULLFILE,F_GRID_FULLFILE,P_GRID_FULLFILE,&
                     Z_FIELD_FULLFILE,T_FIELD_FULLFILE,VMR_FIELD_FULLFILE


INFILE='TestAbsCoeff_H2O.abs_coeff.xml'
DIRSTR='/Users/pwzhai/Research/RT/Case_Studies/PACE_Simulator/'
FILE_INDEX=INDEX(INFILE, '.')
ABSFULLFILE=TRIM(DIRSTR)//TRIM(INFILE)
F_GRID_FULLFILE=TRIM(DIRSTR)//TRIM(INFILE(1:FILE_INDEX))//'f_grid.xml'
P_GRID_FULLFILE=TRIM(DIRSTR)//TRIM(INFILE(1:FILE_INDEX))//'p_grid.xml'
Z_FIELD_FULLFILE=TRIM(DIRSTR)//TRIM(INFILE(1:FILE_INDEX))//'z_field.xml'
T_FIELD_FULLFILE=TRIM(DIRSTR)//TRIM(INFILE(1:FILE_INDEX))//'t_field.xml'
VMR_FIELD_FULLFILE=TRIM(DIRSTR)//TRIM(INFILE(1:FILE_INDEX))//'vmr_field.xml'

OPEN(UNIT=31,FILE=F_GRID_FULLFILE,STATUS='OLD',ACTION='READ')
IREAD=0
IOFLG=0
DO WHILE (IOFLG==0)
  READ(31,'(A7)',IOSTAT=IOFLG)STRTMP
  IREAD=IREAD+1
  IF(STRTMP(1:7) .EQ. '</arts>') EXIT
ENDDO
IF(IREAD>NWV_GAS_ABS_TABLE+5)STOP "CHECK f_grid.xml AND NWV_GAS_ABS_TABLE"
REWIND(31)

READ(31,*)
READ(31,*)
READ(31,*)
DO IREAD=1,NWV_GAS_ABS_TABLE
READ(31,*)WV_GAS_ABS_TABLE(IREAD)
ENDDO
CLOSE(31)
WV_GAS_ABS_TABLE=1.0E6*CSPEED/WV_GAS_ABS_TABLE

OPEN(UNIT=31,FILE=ABSFULLFILE,STATUS='OLD',ACTION='READ')
READ(31,*)
READ(31,*)
READ(31,*)
DO IREAD=1,NWV_GAS_ABS_TABLE
  READ(31,*)GAS_ABS_COEFF_TABLE(IREAD,NPGRID:1:-1)
ENDDO
CLOSE(31)

OPEN(UNIT=31,FILE=P_GRID_FULLFILE,STATUS='OLD',ACTION='READ')
READ(31,*)
READ(31,*)
READ(31,*)
DO IREAD=NPGRID,1,-1
READ(31,*)P_GRID(IREAD)
ENDDO
CLOSE(31)

OPEN(UNIT=31,FILE=Z_FIELD_FULLFILE,STATUS='OLD',ACTION='READ')
READ(31,*)
READ(31,*)
READ(31,*)
DO IREAD=NPGRID,1,-1
READ(31,*)Z_FIELD(IREAD)
ENDDO
CLOSE(31)

OPEN(UNIT=31,FILE=T_FIELD_FULLFILE,STATUS='OLD',ACTION='READ')
READ(31,*)
READ(31,*)
READ(31,*)
DO IREAD=NPGRID,1,-1
READ(31,*)TEM_FIELD(IREAD)
ENDDO
CLOSE(31)

OPEN(UNIT=31,FILE=VMR_FIELD_FULLFILE,STATUS='OLD',ACTION='READ')
READ(31,*)
READ(31,*)
READ(31,*)
!DO IREAD=NPGRID,1,-1
!  READ(31,*)O2VMR_FIELD(IREAD)
!ENDDO
DO IREAD=NPGRID,1,-1
  READ(31,*)H2OVMR_FIELD(IREAD)
ENDDO
CLOSE(31)


IF(Z_FIELD(NPGRID)>Z_FIELD(1))STOP 'WARNING,CHECK Z_FIELD'
IF(P_GRID(NPGRID)<P_GRID(1))STOP 'WARNING,CHECK P_GRID'

Z_FIELD=Z_FIELD/1000.0D0

END SUBROUTINE SPECTRAL_AGENDA_READIN

SUBROUTINE WV_PACE_SETUP
USE GLOBAL_DATA, ONLY :WV,NWV,NWV_SEG2,NWV_SEG3,WV_START,WV_CHANNEL_WIDTH, &
            WV_AVG_RESOLUTION,NWV_CHANNEL_AVG,ILS_PACE

IMPLICIT NONE
INTEGER :: IWV
IF(NWV_SEG2 /= 6)STOP 'CHECK NWV AND NWV_SEG2'

DO IWV=1,NWV-NWV_SEG2-NWV_SEG3
  WV(IWV)=WV_START+(IWV-1.0D0)*WV_CHANNEL_WIDTH
ENDDO
WV_AVG_RESOLUTION=WV_CHANNEL_WIDTH/NWV_CHANNEL_AVG
ILS_PACE=1.0D0/(1.0D0*NWV_CHANNEL_AVG)

WV(NWV-NWV_SEG2-NWV_SEG3+1)=0.94d0
WV(NWV-NWV_SEG2-NWV_SEG3+2)=1.24d0
WV(NWV-NWV_SEG2-NWV_SEG3+3)=1.38d0
WV(NWV-NWV_SEG2-NWV_SEG3+4)=1.64d0
WV(NWV-NWV_SEG2-NWV_SEG3+5)=2.13d0
WV(NWV-NWV_SEG2-NWV_SEG3+6)=2.25d0

WV(NWV-NWV_SEG3+1:NWV-NWV_SEG3+13)=&
  (/0.34d0, 0.354d0, 0.388d0, 0.4160d0, 0.4420d0, 0.4515d0, 0.47d0,  &
    0.551d0, 0.67d0, 0.765d0, 0.865d0,1.375d0, 2.21d0/)

END SUBROUTINE WV_PACE_SETUP

