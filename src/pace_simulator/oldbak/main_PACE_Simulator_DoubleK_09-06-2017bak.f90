! April 20, 2017 copied main_PACE_AC.f90 to main_PACE_Simulator.f90
! April 20, 2017 old main_PACE_Simulator has been deleted
! pay attention to PHIOUT in both STOKESOUT and MUPHIOUTASS
MODULE GLOBAL_DATA
INTEGER,PARAMETER :: NWV=34429,NWV_SEG1=27223,NWV_SEG2=7206
REAL*8,DIMENSION(NWV):: WV

LOGICAL :: SEG1ONLY,ILS_FLAG,SNG_SCAT_EXACT,DIFFUSE_TRANSMITTANCE
INTEGER :: NDET
INTEGER,PARAMETER :: NOPT=7,NWNDSPD=3,NCHLa=8

REAL*8,PARAMETER :: WV_PACE_REF=550.0D0
REAL*8 :: CEXT_REF
REAL*8,DIMENSION(NOPT) :: TAU550=(/0.0d0, 0.05d0, 0.10d0, 0.15D0, 0.2d0,0.30d0,0.5D0/)

INTEGER,PARAMETER :: NTHETA0=30,NFINEMODE=10
REAL*8,DIMENSION(NWV):: AW,BBW,BWRAMAN,BW
REAL*8,DIMENSION(NWV) ::BPTC,BBPTC,BBPTCfrac,APTC,ACDM
REAL*8,DIMENSION(NWV) ::BSTC,ASTC

INTEGER,PARAMETER ::NWV_PF_LUT=2250
REAL*8,DIMENSION(NWV_PF_LUT) :: WV_PF_LUT,AW_PF_LUT,BW_PF_LUT

INTEGER,PARAMETER :: NPGRID=50
REAL*8,DIMENSION(NPGRID) :: P_GRID,Z_FIELD,TEM_FIELD,            &
             NUMDEN_TOTAL_FIELD,VMR_OZONE_FIELD,VMR_OXYGEN_FIELD,&
             VMR_H2O_FIELD,VMR_CO2_FIELD,VMR_NO2_FIELD,       &
             VMR_CH4_FIELD
REAL*8,DIMENSION(NWV,NPGRID) :: GAS_ABS_COEFF
!REAL*8,DIMENSION(NCHLa) :: CHLa=(/0.0,0.03, 0.1, 0.3, 1.0, 1.35, 1.71, 1.65, 2.43, 3.0/)
REAL*8,DIMENSION(NCHLa) :: CHLa=(/0.0d0,0.03d0,0.05d0, 0.1d0, 0.3d0, 1.0d0, 3.0d0, 10.0d0/)
LOGICAL :: CHLA_HOMOGENEITY
REAL*8 :: CHLA_C0,CHLA_Slope,CHLA_Cmax, CHLA_Etamax,CHLA_DeltaEta
REAL*8 :: PHYTOPLANKTON_INDEX_REFRACTION,PHYTOPLANKTON_SPECTRAL_SLOPE, &
          SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE,        &
          SEDIMENT_CONCENTRATION,ACDM400

REAL*8,DIMENSION(NWV) :: RINDX_WATER
REAL*8,DIMENSION(NWNDSPD)::WNDSPD=(/0.0D0,5.0D0,10.0D0/)
REAL*8,DIMENSION(NTHETA0)::THETA0
REAL*8,PARAMETER :: DEPOL_A=0.0284D0, DEPOL_O=0.087D0
REAL*8,PARAMETER :: Xi_kok=25.6d0,Alpha_kok=4.0d0, T0_kok=0.25d0,Dpol90_Kok=0.67d0

!PURE SEA WATER Depolarization ratio value from Zhang X, OE, 2009,
    ! also see Jonasz and Fournier, 2007
REAL*8 :: NMBREINPUT,NMBIMINPUT
LOGICAL :: sngmode,OCEAN_RAMAN_FLAG,OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,&
           HYSPECTRAL_FLAG,OCEAN_PHMX_ONE

LOGICAL :: ABSORPTION_TAU_REDUCE_FLAG
REAL*8,DIMENSION(:), ALLOCATABLE ::TAU_REDUCE_ATMOS_PRESERVE,TAU_REDUCE_OCEAN_PRESERVE
REAL*8 :: ABSORPTION_TAU_REPLACE

LOGICAL :: WATER_DET_FREE_LOCATION
INTEGER,PARAMETER :: N_DET_INWATER_REPORT=21
REAL*8 :: DET_INWATER_REPORT_DEPTH_INCREMENT
REAL*8,DIMENSION(N_DET_INWATER_REPORT):: DET_INWATER_REPORT_DEPTH ! LARGEST WATER DETECT DEPTH REPORTED

INTEGER :: OCEAN_CASE_SELECT
                              !==0 no ocean water body
                              !==1 CASE 1 WATER IOPS
                              !==2 CASE 2 WATER IOPS
ENDMODULE GLOBAL_DATA

MODULE DOUBLEKPARA
IMPLICIT NONE
LOGICAL :: DOUBLEK_FLAG
REAL*8 DK1,DK2,DK3,GK1,GK2,GK3,EXPOFAC,ALPHAFAC,BETAFAC,GAMMAFAC,GAMMAFAC2
REAL*8, DIMENSION(3) :: BETAXI1,BETAXI2,IMS1,IMS2,IMS3,DKP1,DKP2,DKP3

CONTAINS

SUBROUTINE DOUBLEKPARA_EVALUATION(NWV_SUB_CAL,TAU_TG_MAX)
INTEGER, INTENT(IN) :: NWV_SUB_CAL
REAL*8, INTENT(IN) :: TAU_TG_MAX
REAL*8 :: rtsafe
REAL*8 :: ALPHALW,ALPHAHI,XACC
REAL*8, DIMENSION(3) :: IMS1ABS,IMS2ABS,IMS3ABS
INTEGER :: IDK_CAL

EXTERNAL :: FUNCALPHA,rtsafe

REAL*8 :: RADSUM1,RADSUM2,RADSUM3
REAL*8 :: RTMP, RTMP1,DRTMP

IMS1ABS=ABS(IMS1)
IMS2ABS=ABS(IMS2)
IMS3ABS=ABS(IMS3)

RADSUM1=SUM(IMS1ABS)
RADSUM2=SUM(IMS2ABS)
RADSUM3=SUM(IMS3ABS)

IF(RADSUM1<1.0D-10 .OR. RADSUM3<1.0D-10 .OR. RADSUM3<1.0D-10 )THEN
  DOUBLEK_FLAG=.FALSE.
  GAMMAFAC=IMS1(1)
  GAMMAFAC2=IMS2(1)
  ALPHAFAC=0.0d0  !-LOG(RADSUM1/RADSUM2)/(DK1-DK2)
  BETAFAC=0.0d0  !-LOG(RADSUM2/RADSUM3)/(DK2-DK3)
  BETAXI1=0.0D0
  BETAXI2=0.0D0
  RETURN
ENDIF

IF(NWV_SUB_CAL==3)THEN
    BETAXI1=0.0D0
    BETAXI2=0.0D0
ELSE

    BETAXI1=0.0D0
    BETAXI2=0.0D0

    DO IDK_CAL=1,NWV_SUB_CAL/3
        IF(ABS(DKP1(IDK_CAL)-DKP2(IDK_CAL))>1.0D-6 .AND. IMS1ABS(IDK_CAL)>1.0D-6 &
           .AND. IMS2ABS(IDK_CAL)>1.0D-6)THEN
          BETAXI1(IDK_CAL)=-LOG(IMS1ABS(IDK_CAL)/IMS2ABS(IDK_CAL)) /           &
                               (DKP1(IDK_CAL)-DKP2(IDK_CAL)   )
        ENDIF
        IF(ABS(DKP2(IDK_CAL)-DKP3(IDK_CAL))>1.0D-6 .AND. IMS2ABS(IDK_CAL)>1.0D-6 &
           .AND. IMS3ABS(IDK_CAL)>1.0D-6)THEN
          BETAXI2(IDK_CAL)=-LOG(IMS2ABS(IDK_CAL)/IMS3ABS(IDK_CAL)) /           &
                               (DKP2(IDK_CAL)-DKP3(IDK_CAL)   )
        ENDIF
    ENDDO !LOOP IDK_CAL
ENDIF
GK1=IMS1ABS(1) * EXP(BETAXI1(1) * DKP1(1))
GK2=IMS1ABS(2) * EXP(BETAXI1(2) * DKP1(2))
GK3=IMS1ABS(3) * EXP(BETAXI1(3) * DKP1(3))

!write(*,*)'Test DOUBLEKPARA_EVALUATION', DK1,DK2,DK3,GK1,GK2,GK3

EXPOFAC=LOG(GK1/GK2)/LOG(GK2/GK3)

ALPHALW=0.0D0
ALPHAHI=TAU_TG_MAX
XACC=1.0D-6

CALL FUNCALPHA(ALPHALW,RTMP,DRTMP)
CALL FUNCALPHA(ALPHAHI,RTMP1,DRTMP)

IF(RTMP*RTMP1<0.0D0)THEN
  DOUBLEK_FLAG=.TRUE.
  ALPHAFAC=rtsafe(FUNCALPHA,ALPHALW,ALPHAHI,XACC)
  BETAFAC=-LOG(GK1/GK2)/LOG((DK1+ALPHAFAC)/(DK2+ALPHAFAC))
  GAMMAFAC=IMS1(1) * EXP(BETAXI1(1) * DKP1(1))*(DK1+ALPHAFAC)**BETAFAC
ELSE
  DOUBLEK_FLAG=.FALSE.
  ALPHAFAC=-LOG(GK1/GK2)/(DK1-DK2)
  BETAFAC=-LOG(GK2/GK3)/(DK2-DK3)
  GAMMAFAC =IMS1(1)* EXP(BETAXI1(1) * DKP1(1))
  GAMMAFAC2=IMS2(1)* EXP(BETAXI1(2) * DKP1(2))
ENDIF


END SUBROUTINE DOUBLEKPARA_EVALUATION

REAL*8 FUNCTION DOUBLEKFUNC_EVALUATION(DK_VAL,DKP_VAL)
IMPLICIT NONE
REAL*8,INTENT(IN) :: DK_VAL,DKP_VAL

INTEGER :: IDK_CAL
REAL*8 :: BETAXI_VAL

IF(DK_VAL<0.5D0*(DK1+DK2))THEN
  IDK_CAL=1
ELSEIF(DK_VAL>0.5D0*(DK1+DK2) .AND. DK_VAL<0.5D0*(DK2+DK3))THEN
  IDK_CAL=2
ELSE
  IDK_CAL=3
ENDIF

IF(DKP_VAL<DKP2(IDK_CAL))THEN
  BETAXI_VAL=BETAXI1(IDK_CAL)
ELSE
  BETAXI_VAL=BETAXI2(IDK_CAL)
ENDIF

IF(DOUBLEK_FLAG)THEN
  DOUBLEKFUNC_EVALUATION=GAMMAFAC/((DK_VAL+ALPHAFAC)**BETAFAC)*EXP(-BETAXI_VAL*DKP_VAL)
ELSE
  IF(DK_VAL<DK2)THEN
    DOUBLEKFUNC_EVALUATION=GAMMAFAC*EXP(-ALPHAFAC*(DK_VAL-DK1))
  ELSE
    DOUBLEKFUNC_EVALUATION=GAMMAFAC2*EXP(-BETAFAC*(DK_VAL-DK2))
  ENDIF
ENDIF
END FUNCTION DOUBLEKFUNC_EVALUATION

ENDMODULE DOUBLEKPARA

SUBROUTINE FUNCALPHA(ALPHA_VAL,FUNCALPHA_VAL,DFUNCALPHA_VAL)
USE DOUBLEKPARA
USE nrtype
IMPLICIT NONE
REAL*8, INTENT(IN) :: ALPHA_VAL
REAL*8, INTENT(OUT) :: FUNCALPHA_VAL,DFUNCALPHA_VAL
FUNCALPHA_VAL=(DK2+ALPHA_VAL)**(EXPOFAC+1)-(DK1+ALPHA_VAL)*(DK3+ALPHA_VAL)**EXPOFAC
DFUNCALPHA_VAL= (EXPOFAC+1)*(DK2+ALPHA_VAL)**EXPOFAC-(DK3+ALPHA_VAL)**EXPOFAC &
              - EXPOFAC*(DK1+ALPHA_VAL)*(DK3+ALPHA_VAL)**(EXPOFAC-1)
!write(*,*)'Test FUNCALPHA', DK1,DK2,Dk3,ALPHA_VAL,EXPOFAC,FUNCALPHA_VAL,DFUNCALPHA_VAL

END SUBROUTINE FUNCALPHA

PROGRAM SOSINT
USE GLOBAL_DATA
USE MIE_PHMX_PACE
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE IRRADSUNL
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
USE US_Standard_Atmosphere
USE PACE_INSTRUMENT_DESIGN
USE DOUBLEKPARA
IMPLICIT NONE

REAL*8 :: LAMBDAEM
INTEGER:: Indx_Inelastic_Scattering ! index number to controll elastic or inelastic scattering calculations
!Indx_Inelastic_Scattering=0  ! elastic scattering calculation only
!Indx_Inelastic_Scattering=1  ! Raman scattering excitation field preparation only
!Indx_Inelastic_Scattering=2  ! Raman scattering emission field calculation.
!Indx_Inelastic_Scattering=3  ! Chla and CDOM flourescence excitation field preparation only
!Indx_Inelastic_Scattering=4  ! Chla and CDOM flourescence emission field calculation.
!Indx_Inelastic_Scattering=5  ! both Raman and "Chla and CDOM flourescence" emission field calculation.
!Indx_Inelastic_Scattering=6  ! both Raman and "Chla and CDOM flourescence" excitation field preparation.

INTEGER:: NTLYER,NTLYERA,NTLYERO,NLYRML
REAL*8, ALLOCATABLE,DIMENSION(:,:) :: TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,TAU_RAY_Save,TAU_TG_Save

REAL*8, ALLOCATABLE,DIMENSION(:) :: ALT_LYRA,TAUR,TAU_TG,PNDLY,ARSLND1_Save,ARSLND2_Save,&
                                    REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save
REAL*8, ALLOCATABLE,DIMENSION(:,:) ::MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save
! TAUR(ICALIPSO),  RAYLEIGH OPTICAL DEPTH AT WAVLENTGH WV(IWV) AT LAYER(ILAYER)
! TAU_TG(ILAYER): ABSORPTIVE OPTICAL DEPTH FOR TRACE GAS

! DATA TRANSFER TO RTSOS CALLABLE
INTEGER :: NREC,NCOLINPUT,NQUADAINPUT,NQUADOINPUT, &
           NUMMIEUSE,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,NWV_BAND_END
REAL*8 :: DELTATAUAINPUT,DELTATAUOINPUT
REAL*8,DIMENSION(:,:),ALLOCATABLE :: RECDATASTREAM
REAL*8,DIMENSION(:,:,:),ALLOCATABLE :: PHMXDATASTREAM !,COEFFDATASTREAM
INTEGER,DIMENSION(:),ALLOCATABLE :: NUMMIEANGINPUT

REAL*8 :: LBDO_LD,FLAM

INTEGER :: NTHETAOUT,NPHIOUT,ITHETA,ITHETA0,IPHI,IMIE,IDET,IDK_CAL,ILS_AVG
REAL*8 :: MU_IN,WAVELENGTH_MICRON,WAVELENGTH_NANOMETER,TEMPERTURE,SALINITY,&
          AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,       &
          BBPTCfracLOCAL,APTCLOCAL,BSTCLOCAL,ASTCLOCAL,ACDMLOCAL,&
          RINDX_WATERLOCAL

REAL*8,DIMENSION(:),ALLOCATABLE :: PHIOUT,MUOUT

LOGICAL :: WLR_FLAG_INPUT,WCFLG_INPUT,GAS_ABS_FLAG
INTEGER :: DELTAM_INPUT
REAL*8,DIMENSION(:,:) ,ALLOCATABLE:: DIRAD  ! DIRAD(:,1) DOWNWELLING IRADIANCE
                                            ! DIRAD(:,2) UPWELLING IRADIANCE
                                            ! First dimension is detector label
REAL*8,DIMENSION(:,:,:,:),ALLOCATABLE :: DSTOKES
! DSTOKES(NWV,       NTHETAOUT,       NPHIOUT,         4)
! ITH WAVELENGTH , theta out index, phi out index, stokes parameters I Q U V

REAL*8,DIMENSION(:,:,:) ,ALLOCATABLE:: DIRADFULL  ! DIRAD(:,1) DOWNWELLING IRADIANCE
                                            ! DIRAD(:,2) UPWELLING IRADIANCE
                                            ! First dimenSion is detector label
REAL*8,DIMENSION(:,:,:,:,:),ALLOCATABLE :: DSTOKESFULL
! DSTOKES(NWV,       NTHETAOUT,       NPHIOUT,         4)
! ITH WAVELENGTH , theta out index, phi out index, stokes parameters I Q U V

INTEGER :: INDEX_PRIME_SCATTERING
REAL*8 :: FSUN_BAND_AVG
REAL*8,DIMENSION(:),ALLOCATABLE :: TAU_TG_DK,TAU_TG_DKP
REAL*8,DIMENSION(:,:),ALLOCATABLE::TAU_ARSL_Ext_TMP,TAU_ARSL_Scat_TMP,TAU_RAY_TMP
REAL*8,DIMENSION(:,:,:),ALLOCATABLE::DIRADTMP
REAL*8,DIMENSION(:,:,:,:,:),ALLOCATABLE::DSTOKESTMP
REAL*8,DIMENSION(3) :: TAU_TG_DK_CAL,TAU_TG_INCR
REAL*8,DIMENSION(3) :: TAU_TG_DKP_STAT

REAL*8 :: TAU_TG_MAX,TAU_TG_MIN,DK_VAL,DKP_VAL,TAU_ABS_AVG
INTEGER :: NWV_SUB_CAL,NTAU_TG_DK,IWV_BAND,IWV_SUB_START,IWV_SUB_END
INTEGER,DIMENSION(:),ALLOCATABLE :: INDX_WV_CAL,TAU_TG_KFLAG


LOGICAL :: CLOUDFLAG

INTEGER :: N_AVG_SIZE
REAL*8,DIMENSION(NILS_PACE) :: XK,YK
REAL*8,DIMENSION(:),ALLOCATABLE :: XU,YU,ZU

REAL*8 :: POLINT_SIMPLE,ILS_INT_CONST,TRAPZOID

INTEGER,DIMENSION(1) ::LOCINDXTMP,LOCINDXTMP1
LOGICAL,DIMENSION(:),ALLOCATABLE :: MASKMINLOC
REAL*8 :: RTMP,RTMP1
!REAL,DIMENSION(5) :: RNDNMBR
INTEGER:: INTTMP,ICOM,IWV,IWV_CAL,IWV_SUB,IWVEX,IWVEXSTART,ILAYER,IPT, IAEROSOL,IRH, IOPT,IWNDSPD,&
          ICHLA,IULO,MPL,KLO,INDEX_TAUPRIME,NDK_CAL

LOGICAL :: file_e
integer time_array_0(8), time_array_1(8)
real start_time, finish_time

CHARACTER*160 :: CFILE1,CFILETMP

SEG1ONLY=.TRUE.
ILS_FLAG=.false.
SNG_SCAT_EXACT=.FALSE.
DIFFUSE_TRANSMITTANCE=.false.

CHLA_HOMOGENEITY=.true.
OCEAN_RAMAN_FLAG=.false.
OCEAN_FCHLA_FLAG=.false.
OCEAN_FCDOM_FLAG=.false.

OCEAN_CASE_SELECT=0
HYSPECTRAL_FLAG=.true.
NPQ_FLAG=.false.


PHYTOPLANKTON_INDEX_REFRACTION=1.06D0
PHYTOPLANKTON_SPECTRAL_SLOPE=4.D0
SEDIMENT_INDEX_REFRACTION=1.2D0
SEDIMENT_SPECTRAL_SLOPE=4.0D0
SEDIMENT_CONCENTRATION=10.0D0

ABSORPTION_TAU_REDUCE_FLAG=.true. ! IF TRUE, USE THINNER OCEAN LAYERS BELOW ABSORPTION OPTICAL DEPTH OF 10.
                    ! THIS WOULD EXPEDITE THE SIMULATION VERY MUCH WITHOUT SACRIFY THE ACCURACY AT TOO
OCEAN_PHMX_ONE=.true.  ! if true, only use one phase matrix for ocean waters
                       ! However, single scattering abeldo change is still kept
GAS_ABS_FLAG=.true.

CALL WV_LBL_SETUP
CALL WV_PACE_SETUP
CALL ILS_INIT

IF(GAS_ABS_FLAG) THEN
  CALL US_STD_ATMOS_READIN(NPGRID,P_GRID,Z_FIELD,TEM_FIELD,            &
                NUMDEN_TOTAL_FIELD,VMR_OZONE_FIELD,VMR_OXYGEN_FIELD,   &
                VMR_H2O_FIELD,VMR_CO2_FIELD,VMR_NO2_FIELD,VMR_CH4_FIELD)
  IF(Z_FIELD(NPGRID)>Z_FIELD(1))STOP 'WARNING,CHECK Z_FIELD'
  IF(P_GRID(NPGRID)<P_GRID(1))STOP 'WARNING,CHECK P_GRID'
  CALL ABS_COEFF_INIT
ENDIF

LBDO_LD=0.0D0
FLAM=1.0
TEMPERTURE=20.0D0
SALINITY=37.0D0
CLOUDFLAG=.false.

! ASSIGN RTSOS PARAMETERS

NTHETAOUT=45*2
NPHIOUT=37
ALLOCATE(MUOUT(NTHETAOUT),PHIOUT(NPHIOUT))
CALL MUPHIOUTASS(NTHETA0,NTHETAOUT,NPHIOUT,THETA0,MUOUT,PHIOUT)

NCOLINPUT=10
NQUADAINPUT=4
NQUADOINPUT=6

NUMMIEUSE=1
MAXLORDINPUT=NQUADAINPUT
NMBREINPUT=1.338
NMBIMINPUT=0.0
IF(DIFFUSE_TRANSMITTANCE)THEN
  NCOLINPUT=20
  MAXMORDINPUT=1
  LBDO_LD=1.0D0
  OCEAN_CASE_SELECT=0
  OCEAN_PHMX_ONE=.TRUE.
  OCEAN_RAMAN_FLAG=.false.
  OCEAN_FCHLA_FLAG=.false.
  OCEAN_FCDOM_FLAG=.FALSE.
  HYSPECTRAL_FLAG=.false.
ENDIF

WLR_FLAG_INPUT= .false.
WCFLG_INPUT = .true.
DELTAM_INPUT = 2

NDET=3
! One Layer of Rayleigh above a mix layer of Rayleigh and Aerosol
!NTLYERA=2
NTLYERA=10      ! use CALIPSIO vertical grids for the atmosphere
                ! aerosol profile will be given by Braslau, JAM, 1973
! NUMBER OF INPUT LINES INCLUDING DETECTORS AND ATMOSPEHRIC AND OCEANIC LAYERS,
! INTERFACE AND BOTTOM.
IF(OCEAN_CASE_SELECT==0)THEN
  NTLYERO=1
  OCEAN_PHMX_ONE=.TRUE.
  OCEAN_RAMAN_FLAG=.false.
  OCEAN_FCHLA_FLAG=.false.
  OCEAN_FCDOM_FLAG=.FALSE.
  HYSPECTRAL_FLAG=.false.
ELSE
  NTLYERO=NWATER_DEPTH-1
ENDIF

IF(NWATER_DEPTH<NTLYERO+1)STOP 'CHECK NTLYERO AND NWATER_DEPTH'

NTLYER=NTLYERA+NTLYERO

NREC=NTLYER+NDET+2

IF(OCEAN_PHMX_ONE)THEN
  NUMMIERT=NTLYERA+1
ELSE
  NUMMIERT=NTLYERA+NTLYERO
ENDIF

!write(*,*)'NREC,NUMMIERT=',NREC,NUMMIERT

ALLOCATE(TAUR(NTLYERA), ALT_LYRA(NTLYERA+1),TAU_TG(NTLYERA))
ALLOCATE(TAU_ARSL_Ext_Save(NWV,NTLYERA),TAU_ARSL_Scat_Save(NWV,NTLYERA),&
         TAU_RAY_Save(NWV,NTLYERA),TAU_TG_Save(NWV,NTLYERA))
ALLOCATE(NUMMIEANGINPUT(NUMMIERT),PHMXDATASTREAM(NUMMIERT,NUMMIEANGMAX,0:6))

ALLOCATE(DIRAD(NDET,2),DSTOKES(NDET,NTHETAOUT,NPHIOUT,4))
ALLOCATE(DIRADFULL(NDET,NWV,2),DSTOKESFULL(NDET,NWV,NTHETAOUT,NPHIOUT,4))

ALLOCATE(RECDATASTREAM(NREC,7),PNDLY(NTLYERA),                                  &
         REFF1_Save(NUMMIEUSE),REFF2_Save(NUMMIEUSE),VEFF1_Save(NUMMIEUSE),     &
         VEFF2_Save(NUMMIEUSE),ARSLND1_Save(NUMMIEUSE),ARSLND2_Save(NUMMIEUSE),&
         MRR1_Save(NUMMIEUSE,NWV_BAND),MRI1_Save(NUMMIEUSE,NWV_BAND),           &
         MRR2_Save(NUMMIEUSE,NWV_BAND),MRI2_Save(NUMMIEUSE,NWV_BAND))

ALT_LYRA=(/40.0d0,20.0D0,10.0D0,8.0D0,6.0D0,5.0D0,4.0D0,3.0D0,2.0D0,1.0D0,0.0D0/)

CALL SUNLREADIN

CALL WATER_ABSORPTION_READ

IRH=3
IAEROSOL=16
CALL Particle_PHMX_Assign(NUMMIEUSE,NWV_BAND,IAEROSOL,IRH,REFF1_Save,    &
          REFF2_Save,VEFF1_Save,VEFF2_Save,MRR1_Save,MRI1_Save,MRR2_Save,&
          MRI2_Save,ARSLND1_Save,ARSLND2_Save)
CALL ARSL_VERP_INIT(NTLYERA,ALT_LYRA,PNDLY)

DIRADFULL=0.0d0
DSTOKESFULL=0.0d0

DO IWNDSPD=1,1 !NWNDSPD
DO ITHETA0=16,16 !1,NTHETA0
   MU_IN=COS((180.0D0-THETA0(ITHETA0))/180.D0*PI)
DO IOPT=4,4 ! NOPT,2
DO ICHLA=2,2 !NCHLa,2

! check file existance
CALL FILENAMEOUTPUT(CFILE1,ILS_FLAG,DIFFUSE_TRANSMITTANCE,WLR_FLAG_INPUT,WNDSPD(IWNDSPD),&
                    MU_IN,CHLa(ICHLA),OCEAN_CASE_SELECT,SEDIMENT_CONCENTRATION, &
                    Dpol90_Kok,TAU550(IOPT),OCEAN_FCHLA_FLAG,NPQ_FLAG,          &
                    OCEAN_FCDOM_FLAG,OCEAN_RAMAN_FLAG)

INQUIRE(FILE=CFILE1, EXIST=file_e)
IF(file_e)CYCLE

  IF(OCEAN_FCDOM_FLAG)THEN
  ! N_FCDOM_TYPE=9 DEFIEND IN RTTYPE_SOS_RAO_DG.F90
  ! Hawes et al., SPIE Vol 1750, page 212-223, (1992).
  ! INCLUDES 9 SAMPLES: FA7, FA8, FA9, FA11, HA1, HA2, HA4, HA6, HA8.
  ! THIS IS ALSO THE ORDER OF MATRIX DATA IS ORGANIZED.
  ! HA5 AND HA10 ARE EXCLUDED BECAUSE OF MISSING DATA
  ! WEIGHT_CDOM_TYPE should be determined using Eq. 4 in
  ! Hawes et al., SPIE Vol 1750, page 212-223, (1992).
  ! I use 0.9 of FA7 and 0.1 of HA6, without specifing absorption coefficients
  ! of FA7 and HA6
      WEIGHT_CDOM_TYPE=(/0.9D0, 0.0D0, 0.0D0, 0.0D0, 0.0D0, &
                         0.0D0, 0.0D0,0.1D0,0.0D0/)
  ENDIF

  IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG .OR. OCEAN_RAMAN_FLAG) &
         CALL FFLRWVRGCAL(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,OCEAN_RAMAN_FLAG,HYSPECTRAL_FLAG)
  IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG) THEN
         ALLOCATE(DIIRAD_SCALAR_AGD(NFLRSCGRID,NWATER_DEPTH),         &
                  ABSORB_COEFF_CDOM_EX(NFLRSCGRID,NWATER_DEPTH),      &
                  ABSORB_COEFF_CHLA_EX(NFLRSCGRID,NWATER_DEPTH),      &
                  SOURCEFO_FLUORESCENCE_AGD(NWATER_DEPTH))
  ENDIF

  IF(OCEAN_RAMAN_FLAG .OR. OCEAN_FCHLA_FLAG  .OR. OCEAN_FCDOM_FLAG) &
        ALLOCATE(     TAU_INELASTIC_AGD(NWATER_DEPTH),              &
                      EXT_COEFF_INELASTIC_EM(NWATER_DEPTH)           )
  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    ALLOCATE(TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
    ALLOCATE(TAU_REDUCE_OCEAN_PRESERVE(NTLYERO+1))
  ENDIF

  IF(OCEAN_RAMAN_FLAG) THEN
     ALLOCATE(SOURCEFO_RAMAN_AGD_LUT(NFLRSCGRID,NQUADOINPUT+2,NWATER_DEPTH,0:2))
     ALLOCATE(SOURCEFO_RAMAN_AGD(NQUADOINPUT+2,NWATER_DEPTH,0:2))
  ENDIF

  CALL WATER_DEPTH_SETUP

  IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG .OR. OCEAN_RAMAN_FLAG)THEN
    DELTATAUAINPUT=0.05D0        ! ADJUST FOR ACCURATE OPTICAL INTEGRATION
    DELTATAUOINPUT=0.1D0

    DO IWVEX=1,NFLRSCGRID
       WAVELENGTH_NANOMETER=LAMBDAEXFLRSC(IWVEX)
       WAVELENGTH_MICRON=LAMBDAEXFLRSC(IWVEX)/1000.0D0

       CALL TAU_TG_INIT_INELASTIC(GAS_ABS_FLAG,NTLYERA,ALT_LYRA,WAVELENGTH_NANOMETER,TAU_TG)
       CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,ALT_LYRA,TAUR)


       IF (OCEAN_RAMAN_FLAG) THEN
          Indx_Inelastic_Scattering=1     ! RAMAN EXCITING FIELD PREPARISON
          CALL PMARAMANCAL(MU_IN, NQUADAINPUT,NQUADOINPUT,LAMBDAEXFLRSC(IWVEX),TEMPERTURE,SALINITY)
       ENDIF

       IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
            Indx_Inelastic_Scattering=3 ! FLUORESCENCE EXCITING FIELD PREPARISON

       IF(OCEAN_RAMAN_FLAG .AND. (OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG)) &
         Indx_Inelastic_Scattering=6     ! RAMAN and FLUORESCENCE EXCITING FIELD PREPARISON

       IF(OCEAN_RAMAN_FLAG)THEN
          MAXMORDINPUT=2
       ELSE
          MAXMORDINPUT=0
       ENDIF

       call date_and_time(values=time_array_0)
       start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                        + time_array_0 (7) + 0.001 * time_array_0 (8)

       CALL RTSOSINIT(IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWVEX,IOPT,WAVELENGTH_MICRON,&
          NREC,NTLYERA,NTLYERO,PNDLY,TAUR,TAU_TG,RECDATASTREAM,NTLYER,NUMMIEUSE,    &
          NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT,PHMXDATASTREAM,LBDO_LD,FLAM,   &
          TEMPERTURE,SALINITY)

       call date_and_time(values=time_array_1)
       finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                      + time_array_1 (7) + 0.001 * time_array_1 (8)
       write(*,*)'rtsosinit elapsed time =', finish_time-start_time

       CALL RTSOS(NREC,NDET,RECDATASTREAM,NCOLINPUT,NQUADAINPUT,NQUADOINPUT,     &
            DELTATAUAINPUT,DELTATAUOINPUT,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,    &
            NUMMIEANGINPUT,PHMXDATASTREAM,MU_IN,NTHETAOUT,                       &
            NPHIOUT,PHIOUT,MUOUT,DIRAD,DSTOKES,WLR_FLAG_INPUT,WCFLG_INPUT,DELTAM_INPUT)

       call date_and_time(values=time_array_0)
             start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                        + time_array_0 (7) + 0.001 * time_array_0 (8)
       write(*,*)'rtsos elapsed time =', start_time-finish_time

       IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
          CALL OCEAN_SCALAR_IRRAD_LUT_STORE(IWVEX,WAVELENGTH_MICRON,MU_IN)
       IF(OCEAN_RAMAN_FLAG) &
          CALL OCEAN_RAMAN_SOURCE_LUT_STORE(IWVEX,NQUADOINPUT,WAVELENGTH_MICRON,MU_IN)
       DEALLOCATE(TAU_INELASTIC_EX)
    ENDDO
  ENDIF

DELTATAUAINPUT=0.05D0        ! ADJUST FOR ACCURATE OPTICAL INTEGRATION
DELTATAUOINPUT=0.1D0

IF(SEG1ONLY) THEN
  NWV_BAND_END=NWV_BAND-NWV_BAND_SEG2-NWV_BAND_SEG3
ELSE
  NWV_BAND_END=NWV_BAND
ENDIF

DO IWV_BAND=1,NWV_BAND_END

  XK=ILS_DeltaWaveLength(IWV_BAND,:)
  YK=ILS_PACE(IWV_BAND,:)

  LOCINDXTMP= MINLOC(ABS(WV_BAND(IWV_BAND)-0.5D0*WV_BAND_WIDTH-WV))
  LOCINDXTMP1=MINLOC(ABS(WV_BAND(IWV_BAND)+0.5D0*WV_BAND_WIDTH-WV))

  IWV_SUB_START=LOCINDXTMP(1)
  IWV_SUB_END  =LOCINDXTMP1(1)

  WRITE(*,*)'IWV_BAND,IWV_SUB_START,IWV_SUB_END=',IWV_BAND,IWV_SUB_START,IWV_SUB_END

! PAY ATTENTION TO IWV_SUB_START AND IWV_SUB_END LATER, MAKE SURE COVERS THE WHOLE SPECTRUM.

  ALLOCATE(TAU_TG_DK(IWV_SUB_END-IWV_SUB_START+1),TAU_TG_DKP(IWV_SUB_END-IWV_SUB_START+1))

  WAVELENGTH_MICRON=WV_BAND(IWV_BAND)/1000.0D0
  CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,ALT_LYRA,TAUR)
  INDEX_TAUPRIME=INDEX_PRIME_SCATTERING(NTLYERA,TAUR,PNDLY,IOPT,IWV_BAND)
!  write(*,*)'INDEX_TAUPRIME INFO',INDEX_TAUPRIME,NTLYERA
  DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
    CALL TAU_TG_INIT(GAS_ABS_FLAG,NTLYERA,ALT_LYRA,WV(IWV_SUB),TAU_TG)
    TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)=SUM(TAU_TG)
    TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)=SUM(TAU_TG(1:INDEX_TAUPRIME))
    TAU_TG_Save(IWV_SUB,:)=TAU_TG(:)
  ENDDO
  TAU_TG_DKP=TAU_TG_DKP/TAU_TG_DK
  WRITE(*,*)'MINVAL(TAU_TG_DKP),INDEX_TAUPRIME,NTLYERA=',MINVAL(TAU_TG_DKP),INDEX_TAUPRIME,NTLYERA
  N_AVG_SIZE=IWV_SUB_END-IWV_SUB_START+1
  ALLOCATE(XU(N_AVG_SIZE),YU(N_AVG_SIZE),ZU(N_AVG_SIZE))
  XU(1:N_AVG_SIZE)=WV(IWV_SUB_START:IWV_SUB_END)-WV_BAND(IWV_BAND)

  DO ILS_AVG=1,N_AVG_SIZE
      YU(ILS_AVG)=POLINT_SIMPLE(NILS_PACE,XK,YK,XU(ILS_AVG),2)
      IF(YU(ILS_AVG)<0.0D0)YU(ILS_AVG)=0.0D0
      ZU(ILS_AVG)=POLINT_SIMPLE(NSUNL,WVSUN,FSUN,WV(ILS_AVG+IWV_SUB_START-1)/1000.0d0,2)
  ENDDO

  ILS_INT_CONST=TRAPZOID(N_AVG_SIZE,XU,YU)
  ZU=ZU*YU
  FSUN_BAND_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)
  FSUN_BAND_AVG=FSUN_BAND_AVG/ILS_INT_CONST

  ZU=EXP(-TAU_TG_DK)*YU
  TAU_ABS_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)
  TAU_ABS_AVG=TAU_ABS_AVG/ILS_INT_CONST
  TAU_ABS_AVG=-LOG(TAU_ABS_AVG)

  TAU_TG_MAX=MAXVAL(TAU_TG_DK)
  TAU_TG_MIN=MINVAL(TAU_TG_DK)

  NWV_SUB_CAL=1

  IF(TAU_ABS_AVG>0.01D0 .AND. TAU_TG_MIN<1.0D0 .AND. (TAU_TG_MAX-TAU_TG_MIN)>0.2D0)THEN
       NWV_SUB_CAL=9
       IF((MINVAL(TAU_TG_DKP)-1.0D0) <1.0D-6) NWV_SUB_CAL=3

       RTMP=MIN(TAU_TG_MAX, 1.0D0)

       TAU_TG_DK_CAL(1)=TAU_TG_MIN
       TAU_TG_DK_CAL(2)=TAU_TG_MIN+0.25D0*(RTMP-TAU_TG_MIN)
       TAU_TG_DK_CAL(3)=TAU_TG_MIN+0.75D0*(RTMP-TAU_TG_MIN)
!       TAU_TG_DK_CAL(4)=1.0D0
!       TAU_TG_DK_CAL(5)=1.0D0+MIN(0.25D0*(TAU_TG_MAX-1.0D0),0.25D0*(5.0d0-1.0D0))
!       TAU_TG_DK_CAL(6)=1.0D0+MIN(0.75D0*(TAU_TG_MAX-1.0D0),0.75D0*(5.0d0-1.0D0))

       ALLOCATE(MASKMINLOC(IWV_SUB_END-IWV_SUB_START+1))
       DO IDK_CAL=1,3 !6
         LOCINDXTMP= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK))
         IF(IDK_CAL==1) THEN
            TAU_TG_DK_CAL(1)=TAU_TG_DK(LOCINDXTMP(1))
         ELSEIF(ABS(TAU_TG_DK(LOCINDXTMP(1))-TAU_TG_DK_CAL(IDK_CAL-1))<1.0E-6) THEN
            MASKMINLOC=.TRUE.
            MASKMINLOC(LOCINDXTMP(1))=.FALSE.
            LOCINDXTMP1= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK),MASKMINLOC)
            IF(ABS(TAU_TG_DK(LOCINDXTMP1(1))-TAU_TG_DK_CAL(IDK_CAL-1))>1.0E-6)THEN
              TAU_TG_DK_CAL(IDK_CAL)=TAU_TG_DK(LOCINDXTMP1(1))
            ELSE
              MASKMINLOC(LOCINDXTMP1(1))=.FALSE.
              LOCINDXTMP1= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK),MASKMINLOC)
              IF(ABS(TAU_TG_DK(LOCINDXTMP1(1))-TAU_TG_DK_CAL(IDK_CAL-1))>1.0E-6)THEN
                 TAU_TG_DK_CAL(IDK_CAL)=TAU_TG_DK(LOCINDXTMP1(1))
              ELSE
                 NWV_SUB_CAL=1
              ENDIF
            ENDIF
         ELSE
            TAU_TG_DK_CAL(IDK_CAL)=TAU_TG_DK(LOCINDXTMP(1))
         ENDIF
       ENDDO
       DEALLOCATE(MASKMINLOC)

       DO IDK_CAL=2,3 !6
          IF(TAU_TG_DK_CAL(IDK_CAL)<TAU_TG_DK_CAL(IDK_CAL-1)) THEN
             WRITE(*,*)IDK_CAL,TAU_TG_MIN,TAU_TG_MAX,TAU_TG_DK_CAL(IDK_CAL-1),TAU_TG_DK_CAL(IDK_CAL)
             DO ILS_AVG=1,N_AVG_SIZE
                WRITE(*,*)WV(ILS_AVG+IWV_SUB_START-1),TAU_TG_DK(ILS_AVG)
             ENDDO
             STOP 'CHECK TAU_TG_DK_CAL'
          ENDIF
       ENDDO
       TAU_TG_INCR(1)=MIN(0.5d0*(TAU_TG_DK_CAL(2)-TAU_TG_DK_CAL(1)),0.1D0)
       TAU_TG_INCR(2)=MIN(0.5d0*(TAU_TG_DK_CAL(3)-TAU_TG_DK_CAL(2)),0.1D0)
       TAU_TG_INCR(3)=MIN(0.5d0*(1.0D0-TAU_TG_DK_CAL(3)),0.1D0)

!       TAU_TG_INCR(4)=MIN(0.5d0*(TAU_TG_DK_CAL(4)-TAU_TG_DK_CAL(3)),0.1D0)
!       TAU_TG_INCR(5)=MIN(0.5d0*(TAU_TG_DK_CAL(5)-TAU_TG_DK_CAL(4)),0.1D0)
!       TAU_TG_INCR(6)=MIN(0.5d0*(TAU_TG_DK_CAL(6)-TAU_TG_DK_CAL(5)),0.1D0)


       LOOP_IDK : DO IDK_CAL=1,3
            NTAU_TG_DK=0
            TAU_TG_DKP_STAT(2)=0.0d0
            DO ILS_AVG=1,N_AVG_SIZE
               IF(ABS(TAU_TG_DK(ILS_AVG)-TAU_TG_DK_CAL(IDK_CAL))>TAU_TG_INCR(IDK_CAL))CYCLE
               NTAU_TG_DK=NTAU_TG_DK+1
            ENDDO
            IF(NTAU_TG_DK<3) THEN
              NWV_SUB_CAL=3
              EXIT LOOP_IDK
            ENDIF
       ENDDO LOOP_IDK
  ENDIF
  WRITE(*,*)'NWV_SUB_CAL=',NWV_SUB_CAL

  ALLOCATE(INDX_WV_CAL(NWV_SUB_CAL))

  IF(NWV_SUB_CAL==1)THEN
     INDX_WV_CAL(1)=(IWV_SUB_START+IWV_SUB_END)/2
  ELSEIF(NWV_SUB_CAL==3)THEN
     DO IDK_CAL=1,3
       LOCINDXTMP= MINLOC(ABS(TAU_TG_DK_CAL(IDK_CAL)-TAU_TG_DK))
       INDX_WV_CAL(IDK_CAL)=LOCINDXTMP(1)+IWV_SUB_START-1
     ENDDO
  ELSE
     ALLOCATE(TAU_TG_KFLAG(1:N_AVG_SIZE))
     TAU_TG_KFLAG=0

     NDK_CAL=3
     DO IDK_CAL=1,NDK_CAL
        NTAU_TG_DK=0
        TAU_TG_DKP_STAT(2)=0.0d0
        DO ILS_AVG=1,N_AVG_SIZE
           IF(ABS(TAU_TG_DK(ILS_AVG)-TAU_TG_DK_CAL(IDK_CAL))>TAU_TG_INCR(IDK_CAL))CYCLE
           TAU_TG_KFLAG(ILS_AVG)=IDK_CAL
           NTAU_TG_DK=NTAU_TG_DK+1
           TAU_TG_DKP_STAT(2)=TAU_TG_DKP_STAT(2)+TAU_TG_DKP(ILS_AVG)
        ENDDO

        TAU_TG_DKP_STAT(2)=TAU_TG_DKP_STAT(2)/NTAU_TG_DK
        TAU_TG_DKP_STAT(1)=1.0D64
        TAU_TG_DKP_STAT(3)=0.0D0

        RTMP=1.0E32
        DO ILS_AVG=1,N_AVG_SIZE
           IF(TAU_TG_KFLAG(ILS_AVG) .NE. IDK_CAL)CYCLE
           IF(NWV_SUB_CAL==3)THEN
              INDX_WV_CAL(IDK_CAL)=ILS_AVG+IWV_SUB_START-1
!write(*,*)'indx info:',IDK_CAL,INDX_WV_CAL(IDK_CAL),WV(INDX_WV_CAL(IDK_CAL)),TAU_TG_DK(ILS_AVG)
           ELSE
               IF(TAU_TG_DKP(ILS_AVG)<TAU_TG_DKP_STAT(1))THEN
                  TAU_TG_DKP_STAT(1)=TAU_TG_DKP(ILS_AVG)
                  INDX_WV_CAL((IDK_CAL-1)*3+1)=ILS_AVG+IWV_SUB_START-1
               ENDIF

               IF(ABS(TAU_TG_DKP(ILS_AVG)-TAU_TG_DKP_STAT(2))<RTMP)THEN
                  RTMP=ABS(TAU_TG_DKP(ILS_AVG)-TAU_TG_DKP_STAT(2))
                  INDX_WV_CAL((IDK_CAL-1)*3+2)=ILS_AVG+IWV_SUB_START-1
               ENDIF
               IF(TAU_TG_DKP(ILS_AVG)>TAU_TG_DKP_STAT(3))THEN
                 TAU_TG_DKP_STAT(3)=TAU_TG_DKP(ILS_AVG)
                 INDX_WV_CAL((IDK_CAL-1)*3+3)=ILS_AVG+IWV_SUB_START-1
               ENDIF
           ENDIF
        ENDDO
!WRITE(*,*)IDK_CAL,TAU_TG_DK(INDX_WV_CAL((IDK_CAL-1)*3+1)-IWV_SUB_START+1 : &
!                            INDX_WV_CAL((IDK_CAL-1)*3+3)-IWV_SUB_START+1),&
!                  TAU_TG_DKP(INDX_WV_CAL((IDK_CAL-1)*3+1)-IWV_SUB_START+1 : &
!                             INDX_WV_CAL((IDK_CAL-1)*3+3)-IWV_SUB_START+1)
     ENDDO

  ENDIF

  ALLOCATE(TAU_ARSL_Ext_TMP(NWV_SUB_CAL,NTLYERA), &
           TAU_ARSL_Scat_TMP(NWV_SUB_CAL,NTLYERA),&
           TAU_RAY_TMP(NWV_SUB_CAL,NTLYERA))
  ALLOCATE(DIRADTMP(1:NDET,1:NWV_SUB_CAL,1:2),      &
           DSTOKESTMP(1:NDET,1:NWV_SUB_CAL,1:NTHETAOUT,1:NPHIOUT,1:4))

  DO IWV_CAL=1,NWV_SUB_CAL
        write(*,*)'SUB WAVELENGTH INFO',IWV_CAL,WV(INDX_WV_CAL(IWV_CAL)),TAU_TG_DK(INDX_WV_CAL(IWV_CAL)-IWV_SUB_START+1)
        WAVELENGTH_NANOMETER=WV(INDX_WV_CAL(IWV_CAL))
        WAVELENGTH_MICRON=WAVELENGTH_NANOMETER/1000.0D0
        IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG)THEN
            CALL FFLRfuncjEXCAL(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,WAVELENGTH_NANOMETER)
            CALL SOURCEF_FLUORESCENCE_INTEGRATION(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,WAVELENGTH_NANOMETER)
            IF(OCEAN_FCDOM_FLAG)DEALLOCATE(fCDOMfuncjEX)
            IF(OCEAN_FCHLA_FLAG)DEALLOCATE(fCHLAfuncjEX)
        ENDIF
        IF(OCEAN_RAMAN_FLAG)THEN
            CALL FRFUNCJCAL(WAVELENGTH_NANOMETER)
            CALL SOURCEF_EM_INTEGRATION(NQUADOINPUT,MU_IN)
        ENDIF

        CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,ALT_LYRA,TAUR)

        IF(NWV_SUB_CAL>1)THEN
             TAU_TG=TAU_TG_Save(INDX_WV_CAL(IWV_CAL),:)
        ELSE
             DO ILAYER=1,NTLYERA
                ZU=TAU_TG_Save(IWV_SUB_START:IWV_SUB_END,ILAYER)
                ZU=ZU*YU
                TAU_TG(ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)
             ENDDO
             TAU_TG=TAU_TG/ILS_INT_CONST
        ENDIF

        call date_and_time(values=time_array_0)
        start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
                   + time_array_0 (7) + 0.001 * time_array_0 (8)

        MAXMORDINPUT=MIN(30,NQUADAINPUT)
        Indx_Inelastic_Scattering=0      ! Elastic scattering only

        IF(OCEAN_RAMAN_FLAG) Indx_Inelastic_Scattering=2  ! ELASTIC PART AND RAMAN EMISSION WAVELENGTH
        IF(OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG) &
             Indx_Inelastic_Scattering=4 ! ELASTIC PART AND FLUORESCENCE EMISSION WAVELENGTH
        IF(OCEAN_RAMAN_FLAG .AND. (OCEAN_FCDOM_FLAG .OR. OCEAN_FCHLA_FLAG)) &
             Indx_Inelastic_Scattering=5
           ! ELASTIC PART; BOTH RAMAN AND FLUORESCENCE EMISSION WAVELENGTH
        IF(WAVELENGTH_MICRON>0.88) Indx_Inelastic_Scattering=0      ! Elastic scattering only

        CALL RTSOSINIT(IWNDSPD,ICHLA,Indx_Inelastic_Scattering,INDX_WV_CAL(IWV_CAL),&
           IOPT,WAVELENGTH_MICRON,NREC,NTLYERA,NTLYERO,PNDLY,TAUR,TAU_TG,       &
           RECDATASTREAM,NTLYER,NUMMIEUSE,NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT, &
           PHMXDATASTREAM,LBDO_LD,FLAM,TEMPERTURE,SALINITY)

        DO ILAYER=1,NTLYERA
           TAU_ARSL_Ext_TMP(IWV_CAL,ILAYER)=RECDATASTREAM(ILAYER+1,2)-TAUR(ILAYER)-TAU_TG(ILAYER)
           TAU_ARSL_Scat_TMP(IWV_CAL,ILAYER)=RECDATASTREAM(ILAYER+1,2)*RECDATASTREAM(ILAYER+1,3)-TAUR(ILAYER)
           TAU_RAY_TMP(IWV_CAL,ILAYER)=TAUR(ILAYER)
        ENDDO

        call date_and_time(values=time_array_1)
              finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                   + time_array_1 (7) + 0.001 * time_array_1 (8)
        write(*,*)'rtsosinit elapsed time =', finish_time-start_time

        CALL RTSOS(NREC,NDET,RECDATASTREAM,NCOLINPUT,NQUADAINPUT,NQUADOINPUT, &
             DELTATAUAINPUT,DELTATAUOINPUT,NUMMIERT,MAXLORDINPUT,MAXMORDINPUT,    &
             NUMMIEANGINPUT,PHMXDATASTREAM,MU_IN,NTHETAOUT,&
             NPHIOUT,PHIOUT,MUOUT,DIRAD,DSTOKES,WLR_FLAG_INPUT,WCFLG_INPUT,DELTAM_INPUT)

        call date_and_time(values=time_array_1)
              start_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                   + time_array_1 (7) + 0.001 * time_array_1 (8)
        write(*,*)'rtsos elapsed time =', start_time-finish_time

        RTMP1=FSUN_BAND_AVG/DIRAD(1,1)*abs(MU_IN)

        DIRADTMP(1:NDET,IWV_CAL,1:2)=DIRAD(1:NDET,1:2)*RTMP1
        DSTOKESTMP(1:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)= &
                                DSTOKES(1:NDET,1:NTHETAOUT,1:NPHIOUT,1:4)*RTMP1

        IF(NWV_SUB_CAL>1 .AND. SNG_SCAT_EXACT)THEN
            CALL RT_SINGLE_SCATTERING(NREC,NDET,RECDATASTREAM,DELTATAUAINPUT,&
                  DELTATAUOINPUT,NUMMIERT,NUMMIEANGINPUT,MAXLORDINPUT,       &
                  PHMXDATASTREAM,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,DIRAD,    &
                  DSTOKES,WCFLG_INPUT,DELTAM_INPUT)

        call date_and_time(values=time_array_1)
              finish_time = time_array_1 (5) * 3600 + time_array_1 (6) * 60 &
                   + time_array_1 (7) + 0.001 * time_array_1 (8)
        write(*,*)'rt_single_scattering elapsed time =', finish_time-start_time

!write(*,*)'WV,DIRADTMP=',WV(INDX_WV_CAL(IWV_CAL)),DIRADTMP(1,IWV_CAL,1:2),DIRAD(1,1:2),rtmp1

!            DIRADTMP(1:NDET,IWV_CAL,1:2)=DIRADTMP(1:NDET,IWV_CAL,1:2)-DIRAD(1:NDET,1:2)*RTMP1
            DSTOKESTMP(1:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)=&
                   DSTOKESTMP(1:NDET,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4) - &
                   DSTOKES(1:NDET,1:NTHETAOUT,1:NPHIOUT,1:4)*RTMP1

        ENDIF
        IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
        !  idet==1, detector at the top of the atmosphere, not impacted by the rescale scheme.
        !  idet==2, det at bottom of the atmosphere
        !  idet==3, det at top of the ocean
        !  both share the same absorption optical depth rescale.
          DIRADTMP(2:3,IWV_CAL,1:2)=DIRADTMP(2:3,IWV_CAL,1:2)*EXP(-TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
          DSTOKESTMP(2:3,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)= &
              DSTOKESTMP(2:3,IWV_CAL,1:NTHETAOUT,1:NPHIOUT,1:4)*EXP(-TAU_REDUCE_ATMOS_PRESERVE(NTLYERA+1))
        ENDIF

  ENDDO

  IF(NWV_SUB_CAL==1)THEN
     DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
         DIRADFULL(1:NDET,IWV_SUB,1:2)=DIRADTMP(1:NDET,1,1:2)
         DSTOKESFULL(1:NDET,IWV_SUB,1:NTHETAOUT,1:NPHIOUT,1:4)= &
                      DSTOKESTMP(1:NDET,1,1:NTHETAOUT,1:NPHIOUT,1:4)
         TAU_ARSL_Ext_Save(IWV_SUB,:)=TAU_ARSL_Ext_TMP(1,:)
         TAU_ARSL_Scat_Save(IWV_SUB,:)=TAU_ARSL_Scat_TMP(1,:)
         TAU_RAY_Save(IWV_SUB,:)=TAU_RAY_TMP(1,:)
     ENDDO
  ELSE

     DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
        WAVELENGTH_NANOMETER=WV(IWV_SUB)
        WAVELENGTH_MICRON=WAVELENGTH_NANOMETER/1000.0D0

        TAU_ARSL_Ext_Save(IWV_SUB,:)=TAU_ARSL_Ext_TMP(1,:)
        TAU_ARSL_Scat_Save(IWV_SUB,:)=TAU_ARSL_Scat_TMP(1,:)
        TAU_RAY_Save(IWV_SUB,:)=TAU_RAY_TMP(1,:)

        IF(SNG_SCAT_EXACT)THEN
          CALL TAURCAL(WAVELENGTH_MICRON,NTLYERA,ALT_LYRA,TAUR)
          TAU_TG=TAU_TG_Save(IWV_SUB,:)
          Indx_Inelastic_Scattering=0
          CALL RTSOSINIT(IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWV_SUB,&
            IOPT,WAVELENGTH_MICRON,NREC,NTLYERA,NTLYERO,PNDLY,TAUR,TAU_TG,      &
            RECDATASTREAM,NTLYER,NUMMIEUSE,NUMMIERT,MAXLORDINPUT,NUMMIEANGINPUT,&
            PHMXDATASTREAM,LBDO_LD,FLAM,TEMPERTURE,SALINITY)

          CALL RT_SINGLE_SCATTERING(NREC,NDET,RECDATASTREAM,DELTATAUAINPUT,  &
                DELTATAUOINPUT,NUMMIERT,NUMMIEANGINPUT,MAXLORDINPUT,         &
                PHMXDATASTREAM,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,DIRAD,   &
                DSTOKES,WCFLG_INPUT,DELTAM_INPUT)
          RTMP1=FSUN_BAND_AVG/DIRAD(1,1)*abs(MU_IN)
          DIRADFULL(1:NDET,IWV_SUB,1:2)=0.0d0 ! single scattering irradiance return is zero
          DIRADFULL(1,IWV_SUB,1)=DIRAD(1,1)*RTMP1 ! single scattering irradiance is exact for downwelling irradiance
          DSTOKESFULL(1:NDET,IWV_SUB,1:NTHETAOUT,1:NPHIOUT,1:4)= &
                        DSTOKES(1:NDET,1:NTHETAOUT,1:NPHIOUT,1:4)*RTMP1
        ELSE
          DIRADFULL(1,IWV_SUB,1)=DIRADTMP(1,1,1) ! no double k fitting for downwelling irradiance at TOA
        ENDIF

     ENDDO
     IF(NWV_SUB_CAL==3)THEN
          DK1=TAU_TG_DK(INDX_WV_CAL(1)-IWV_SUB_START+1)
          DK2=TAU_TG_DK(INDX_WV_CAL(2)-IWV_SUB_START+1)
          DK3=TAU_TG_DK(INDX_WV_CAL(3)-IWV_SUB_START+1)
          DKP1=1.0D0
          DKP2=1.0D0
          DKP3=1.0D0
     ELSE
          DK1=TAU_TG_DK(INDX_WV_CAL(1)-IWV_SUB_START+1)
          DK2=TAU_TG_DK(INDX_WV_CAL(4)-IWV_SUB_START+1)
          DK3=TAU_TG_DK(INDX_WV_CAL(7)-IWV_SUB_START+1)
          DO IDK_CAL=1,NWV_SUB_CAL/3
             DKP1(IDK_CAL)=TAU_TG_DKP(INDX_WV_CAL((IDK_CAL-1)*3+1)-IWV_SUB_START+1)
             DKP2(IDK_CAL)=TAU_TG_DKP(INDX_WV_CAL((IDK_CAL-1)*3+2)-IWV_SUB_START+1)
             DKP3(IDK_CAL)=TAU_TG_DKP(INDX_WV_CAL((IDK_CAL-1)*3+3)-IWV_SUB_START+1)
          ENDDO
     ENDIF
     DO IDET=1,NDET
     DO ICOM=1,2
        IF(IDET == 1 .AND. ICOM == 1)CYCLE

        IF(NWV_SUB_CAL==3)THEN
            DO IDK_CAL=1,NWV_SUB_CAL
                IMS1(IDK_CAL)=DIRADTMP(IDET,IDK_CAL,ICOM)
                IMS2(IDK_CAL)=DIRADTMP(IDET,IDK_CAL,ICOM)
                IMS3(IDK_CAL)=DIRADTMP(IDET,IDK_CAL,ICOM)
            ENDDO
        ELSE
            DO IDK_CAL=1,NWV_SUB_CAL/3
                IMS1(IDK_CAL)=DIRADTMP(IDET,(IDK_CAL-1)*3+1,ICOM)
                IMS2(IDK_CAL)=DIRADTMP(IDET,(IDK_CAL-1)*3+2,ICOM)
                IMS3(IDK_CAL)=DIRADTMP(IDET,(IDK_CAL-1)*3+3,ICOM)
            ENDDO
        ENDIF
!    WRITE(*,*)'idet,icom,IMS1=',idet,icom,IMS1(1:3)
!    WRITE(*,*)'idet,icom,IMS2=',idet,icom,IMS2(1:3)
!    WRITE(*,*)'idet,icom,IMS3=',idet,icom,IMS3(1:3)

        CALL DOUBLEKPARA_EVALUATION(NWV_SUB_CAL,TAU_TG_MAX)

        DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
           DK_VAL=TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)
           DKP_VAL=TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)
           RTMP=DOUBLEKFUNC_EVALUATION(DK_VAL,DKP_VAL)
           DIRADFULL(IDET,IWV_SUB,ICOM)=DIRADFULL(IDET,IWV_SUB,ICOM) + RTMP
!           WRITE(*,*)'DOUBLE K FIT:',WV(IWV_SUB),RTMP
        ENDDO
     ENDDO ! LOOP ICOM
     ENDDO ! LOOP NDET

     DO IDET=1,NDET
     DO ITHETA=1,NTHETAOUT
     DO IPHI=1,NPHIOUT
     DO ICOM=1,4
        IF(NWV_SUB_CAL==3)THEN
            DO IDK_CAL=1,3
                IMS1(IDK_CAL)=DSTOKESTMP(IDET,IDK_CAL,ITHETA,IPHI,ICOM)
                IMS2(IDK_CAL)=DSTOKESTMP(IDET,IDK_CAL,ITHETA,IPHI,ICOM)
                IMS3(IDK_CAL)=DSTOKESTMP(IDET,IDK_CAL,ITHETA,IPHI,ICOM)
            ENDDO
        ELSE
            DO IDK_CAL=1,NWV_SUB_CAL/3
                IMS1(IDK_CAL)=DSTOKESTMP(IDET,(IDK_CAL-1)*3+1,ITHETA,IPHI,ICOM)
                IMS2(IDK_CAL)=DSTOKESTMP(IDET,(IDK_CAL-1)*3+2,ITHETA,IPHI,ICOM)
                IMS3(IDK_CAL)=DSTOKESTMP(IDET,(IDK_CAL-1)*3+3,ITHETA,IPHI,ICOM)
            ENDDO
        ENDIF
        CALL DOUBLEKPARA_EVALUATION(NWV_SUB_CAL,TAU_TG_MAX)
        DO IWV_SUB=IWV_SUB_START,IWV_SUB_END
           DK_VAL=TAU_TG_DK(IWV_SUB-IWV_SUB_START+1)
           DKP_VAL=TAU_TG_DKP(IWV_SUB-IWV_SUB_START+1)
           RTMP=DOUBLEKFUNC_EVALUATION(DK_VAL,DKP_VAL)

           DSTOKESFULL(IDET,IWV_SUB,ITHETA,IPHI,ICOM)= &
                DSTOKESFULL(IDET,IWV_SUB,ITHETA,IPHI,ICOM)+RTMP
        ENDDO
     ENDDO
     ENDDO
     ENDDO
     ENDDO


  ENDIF


    call date_and_time(values=time_array_0)
    start_time = time_array_0 (5) * 3600 + time_array_0 (6) * 60 &
               + time_array_0 (7) + 0.001 * time_array_0 (8)
    write(*,*)'rtsos elapsed time =', start_time-finish_time
    IF(NWV_SUB_CAL>3)DEALLOCATE(TAU_TG_KFLAG)
    DEALLOCATE(TAU_TG_DK,TAU_TG_DKP,TAU_ARSL_Ext_TMP,TAU_ARSL_Scat_TMP, &
               TAU_RAY_TMP,DIRADTMP,DSTOKESTMP,INDX_WV_CAL)
    DEALLOCATE(XU,YU,ZU)
ENDDO ! WAVELENG LOOP


CALL STOKESOUT(CFILE1,ICHLA,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,             &
        DIRADFULL,DSTOKESFULL,ALT_LYRA,TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,  &
        TAU_RAY_Save,TAU_TG_Save,NTLYERA,ARSLND1_Save,ARSLND2_Save,NUMMIEUSE, &
        REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,                          &
        MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save,TEMPERTURE,SALINITY)
IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG .OR. OCEAN_RAMAN_FLAG) &
        DEALLOCATE(LAMBDAEXFLRSC)
IF(OCEAN_FCHLA_FLAG .OR. OCEAN_FCDOM_FLAG) &
  DEALLOCATE(DIIRAD_SCALAR_AGD,ABSORB_COEFF_CDOM_EX,  &
             ABSORB_COEFF_CHLA_EX,SOURCEFO_FLUORESCENCE_AGD)
IF(OCEAN_RAMAN_FLAG .OR. OCEAN_FCHLA_FLAG  .OR. OCEAN_FCDOM_FLAG) &
       DEALLOCATE(TAU_INELASTIC_AGD,EXT_COEFF_INELASTIC_EM)
IF(ABSORPTION_TAU_REDUCE_FLAG) &
       DEALLOCATE(TAU_REDUCE_ATMOS_PRESERVE,TAU_REDUCE_OCEAN_PRESERVE)

IF(OCEAN_RAMAN_FLAG)DEALLOCATE(SOURCEFO_RAMAN_AGD,SOURCEFO_RAMAN_AGD_LUT)

ENDDO ! NCHLa LOOP
ENDDO ! NOPT LOOP
ENDDO ! NTHETA0 LOOP
ENDDO ! NWNDSPD LOOP
CLOSE(55)
DEALLOCATE(DIRAD,DSTOKES,DIRADFULL,DSTOKESFULL,                                &
          PNDLY,ARSLND1_Save,ARSLND2_Save,REFF1_Save,REFF2_Save,               &
          VEFF1_Save,VEFF2_Save,MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save,       &
          TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,TAU_RAY_Save,TAU_TG_Save)
DEALLOCATE(PHIOUT,MUOUT,RECDATASTREAM,NUMMIEANGINPUT,PHMXDATASTREAM)
DEALLOCATE(TAUR,ALT_LYRA,TAU_TG)
CALL DEALL_SUNL

ENDPROGRAM SOSINT

SUBROUTINE  STOKESOUT(CFILE1,ICHLA,MU_IN,NTHETAOUT,NPHIOUT,PHIOUT,MUOUT,       &
        DIRADFULL,DSTOKESFULL,ALT_LYRA,TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,   &
        TAU_RAY_Save,TAU_TG_Save,NTLYERA,ARSLND1_Save,ARSLND2_Save,NUMMIEUSE,  &
        REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,             &
        MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save,TEMPERTURE,SALINITY)

USE GLOBAL_DATA
USE PACE_INSTRUMENT_DESIGN
USE SAVE_OCEAN_MOD,only:WATER_DEPTH,NWATER_DEPTH ! output water_depth
USE FLUORESCENCEDATA, only: QUANTUM_YIELD_CHLA_AVG,NPQ_FLAG
USE HDF5
USE ISO_C_BINDING

IMPLICIT none
CHARACTER*160 :: CFILE1

INTEGER :: ICHLA, NTHETAOUT,NPHIOUT,NTLYERA,NUMMIEUSE,ICOM

REAL*8,DIMENSION(NDET,NWV,2) :: DIRADFULL  ! DIRADFULL(:,1) DOWNWELLING IRADIANCE
                                   ! DIRAD(:,2) UPWELLING IRADIANCE
REAL*8,DIMENSION(NDET,NWV,NTHETAOUT,NPHIOUT,4) :: DSTOKESFULL

REAL*8,DIMENSION(NWV,NTLYERA) ::TAU_ARSL_Ext_Save,TAU_ARSL_Scat_Save,TAU_RAY_Save,TAU_TG_Save
REAL*8,DIMENSION(NTHETAOUT) :: MUOUT
REAL*8,DIMENSION(NPHIOUT) :: PHIOUT

REAL*8,DIMENSION(NTLYERA) ::ALT_LYRA
REAL*8,DIMENSION(NUMMIEUSE) ::REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,ARSLND1_Save,ARSLND2_Save
REAL*8,DIMENSION(NUMMIEUSE,NWV) ::MRR1_Save,MRR2_Save,MRI1_Save,MRI2_Save
REAL*8,INTENT(IN) :: TEMPERTURE,SALINITY

REAL*8,DIMENSION(NDET,NWV_BAND,2) :: DIRADFULL_AVG  ! DIRADFULL(:,1) DOWNWELLING IRADIANCE
! DIRAD(:,2) UPWELLING IRADIANCE
REAL*8,DIMENSION(NDET,NWV_BAND,NTHETAOUT,NPHIOUT,4) :: DSTOKESFULL_AVG
REAL*8,DIMENSION(NWV_BAND,NTLYERA) :: TAU_TG_AVG
REAL*8,DIMENSION(NWV_BAND,NTLYERA) ::TAU_ARSL_Ext_AVG,TAU_ARSL_Scat_AVG,TAU_RAY_AVG
REAL*8,DIMENSION(NWV_BAND) :: AW_AVG,BW_AVG,RINDX_WATER_AVG,APTC_AVG,BPTC_AVG,BBPTC_AVG, &
                              BBPTCfrac_AVG,BSTC_AVG,ASTC_AVG,ACDM_AVG
REAL*8 :: MU_IN,RTMP
LOGICAL :: MUFLG
REAL*8,PARAMETER :: PI=3.141592653589793d0
REAL*8,PARAMETER :: FACTOR=PI/180.0d0
INTEGER:: MPLIN,NDETOUT,ITHETA,IPHI,IWV,ILAYER,IDET,IMIE

! HDF 5 DEFINITION
! This should map to REAL*8 on most modern processors
INTEGER, PARAMETER :: real_kind_15 = SELECTED_REAL_KIND(Fortran_REAL_8)
CHARACTER(LEN=180) :: HDF5FILENAME
CHARACTER(LEN=20)  :: dataset
CHARACTER(LEN=20) , PARAMETER :: attribute = "A1"
INTEGER   :: dim0, dim1
INTEGER(HID_T)  :: file, space, dset, attr ! Handles
INTEGER :: hdferr
INTEGER(hsize_t),   DIMENSION(1:2) :: dims
INTEGER(hsize_t),DIMENSION(1) :: dimscl
INTEGER(HSIZE_T), DIMENSION(1:2) :: maxdims
TYPE(C_PTR) :: f_ptr
REAL*4,DIMENSION(1),TARGET :: HDF5RTMP
INTEGER,DIMENSION(1),TARGET :: HDF5ITMP
REAL*4,DIMENSION(:),TARGET,ALLOCATABLE :: HDF5RARR
REAL*4,DIMENSION(:,:),TARGET,ALLOCATABLE :: HDF5RARR2DIM

INTEGER(hsize_t), DIMENSION(1:4) :: dims4
INTEGER(HSIZE_T), DIMENSION(1:4) :: maxdims4
REAL*4,DIMENSION(:,:,:,:),TARGET,ALLOCATABLE :: HDF5RARR4DIM

INTEGER :: NWV_START,NWV_END,NWV_OUTPUT,IWV_AVG,ILS_AVG

REAL*8 :: WAVELENGTH_BAND_LO,WAVELENGTH_BAND_HI,WAVELENGTH_MICRON
REAL*8 :: AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,   &
          BBPTCfracLOCAL,APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL,ASTCLOCAL,BSTCLOCAL
INTEGER,DIMENSION(1) ::LOCINDXTMP,LOCINDXTMP1

INTEGER :: N_AVG_SIZE,MPL
REAL*8,DIMENSION(NILS_PACE) :: XK,YK
REAL*8,DIMENSION(:),ALLOCATABLE :: XU,YU,ZU
REAL*8 :: POLINT_SIMPLE,ILS_INT_CONST,TRAPZOID

NWV_START=1
IF(SEG1ONLY) THEN
  NWV_END=NWV_SEG1
ELSE
  NWV_END=NWV
ENDIF

IF(OCEAN_CASE_SELECT .NE.2)THEN
  ASTCLOCAL=0.0D0
  BSTCLOCAL=0.0D0
ENDIF

DO IWV_AVG=NWV_START,NWV_END
    WAVELENGTH_MICRON=WV(IWV_AVG)/1000.0d0
    CALL HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLa(ICHLA),TEMPERTURE,SALINITY,   &
               AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,   &
               BBPTCfracLOCAL,APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)
    IF(OCEAN_CASE_SELECT==2) THEN
      CALL NAP_PARA_INIT(WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION, &
                         SEDIMENT_SPECTRAL_SLOPE,ASTCLOCAL,BSTCLOCAL)
    ENDIF
    AW(IWV_AVG)=AWLOCAL
    BW(IWV_AVG)=BWLOCAL
    BBW(IWV_AVG)=BBWLOCAL
    BWRAMAN(IWV_AVG)=BWRAMANLOCAL
    BPTC(IWV_AVG)=BPTCLOCAL
    BBPTC(IWV_AVG)=BBPTCLOCAL
    BBPTCfrac(IWV_AVG)=BBPTCfracLOCAL
    APTC(IWV_AVG)=APTCLOCAL
    ACDM(IWV_AVG)=ACDMLOCAL
    ASTC(IWV_AVG)=ASTCLOCAL
    BSTC(IWV_AVG)=BSTCLOCAL
    RINDX_WATER(IWV_AVG)=RINDX_WATERLOCAL
ENDDO


IF(ILS_FLAG)THEN
!  CALL ILS_INIT
  NWV_START=1

  IF(SEG1ONLY) THEN
    NWV_END=NWV_BAND-NWV_BAND_SEG2-NWV_BAND_SEG3
  ELSE
    NWV_END=NWV_BAND
  ENDIF
  NWV_OUTPUT=NWV_END-NWV_START+1

  MPL=2
  DIRADFULL_AVG=0.0D0
  DSTOKESFULL_AVG=0.0D0
  TAU_TG_AVG=0.0D0
  DO IWV_AVG=NWV_START,NWV_END
     XK=ILS_DeltaWaveLength(IWV_AVG,:)
     YK=ILS_PACE(IWV_AVG,:)

     WAVELENGTH_BAND_LO=WV_BAND(IWV_AVG)-2.0D0*WV_BAND_WIDTH
     WAVELENGTH_BAND_HI=WV_BAND(IWV_AVG)+2.0D0*WV_BAND_WIDTH
     LOCINDXTMP =MINLOC(ABS(WAVELENGTH_BAND_LO-WV))
     LOCINDXTMP1=MINLOC(ABS(WAVELENGTH_BAND_HI-WV))
     N_AVG_SIZE=LOCINDXTMP1(1)-LOCINDXTMP(1)+1
     ALLOCATE(XU(N_AVG_SIZE),YU(N_AVG_SIZE),ZU(N_AVG_SIZE))
     XU(1:N_AVG_SIZE)=WV(LOCINDXTMP(1):LOCINDXTMP1(1))-WV_BAND(IWV_AVG)
     DO ILS_AVG=1,N_AVG_SIZE
        YU(ILS_AVG)=POLINT_SIMPLE(NILS_PACE,XK,YK,XU(ILS_AVG),MPL)
        IF(YU(ILS_AVG)<0.0D0)YU(ILS_AVG)=0.0D0
     ENDDO
     ILS_INT_CONST=TRAPZOID(N_AVG_SIZE,XU,YU)
     DO ILAYER=1,NTLYERA
        ZU(1:N_AVG_SIZE)=EXP(-TAU_TG_Save(LOCINDXTMP(1):LOCINDXTMP1(1),ILAYER))
        ZU=ZU*YU
        TAU_TG_AVG(IWV_AVG,ILAYER)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     ENDDO
     DO IDET=1,NDET
     DO ICOM=1,2
       ZU(1:N_AVG_SIZE)=DIRADFULL(IDET,LOCINDXTMP(1):LOCINDXTMP1(1),ICOM)
       ZU=ZU*YU
       DIRADFULL_AVG(IDET,IWV_AVG,ICOM)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     ENDDO
     ENDDO

     DO IDET=1,NDET
     DO ICOM=1,4
     DO ITHETA=1,NTHETAOUT
     DO IPHI=1,NPHIOUT
       ZU(1:N_AVG_SIZE)=DSTOKESFULL(IDET,LOCINDXTMP(1):LOCINDXTMP1(1),ITHETA,IPHI,ICOM)
       ZU=ZU*YU
       DSTOKESFULL_AVG(IDET,IWV_AVG,ITHETA,IPHI,ICOM)=TRAPZOID(N_AVG_SIZE,XU,ZU)
     ENDDO
     ENDDO
     ENDDO
     ENDDO

     ZU(1:N_AVG_SIZE)=AW(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     AW_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=BW(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BW_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=RINDX_WATER(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     RINDX_WATER_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=APTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     APTC_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=BPTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BPTC_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=BBPTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BBPTC_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=BBPTCfrac(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BBPTCfrac_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=BSTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     BSTC_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=ASTC(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     ASTC_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     ZU(1:N_AVG_SIZE)=ACDM(LOCINDXTMP(1):LOCINDXTMP1(1))
     ZU=ZU*YU
     ACDM_AVG=TRAPZOID(N_AVG_SIZE,XU,ZU)

     TAU_TG_AVG(IWV_AVG,:)=TAU_TG_AVG(IWV_AVG,:)/ILS_INT_CONST
     TAU_TG_AVG(IWV_AVG,:)=-LOG(TAU_TG_AVG(IWV_AVG,:))

     DIRADFULL_AVG(:,IWV_AVG,:)=DIRADFULL_AVG(:,IWV_AVG,:)/ILS_INT_CONST
     DSTOKESFULL_AVG(:,IWV_AVG,:,:,:)=DSTOKESFULL_AVG(:,IWV_AVG,:,:,:) &
                                      /ILS_INT_CONST

     LOCINDXTMP =MINLOC(ABS(WV_BAND(IWV_AVG)-WV))
     TAU_ARSL_Ext_AVG(IWV_AVG,:)=TAU_ARSL_Ext_Save(LOCINDXTMP(1),:)
     TAU_ARSL_Scat_AVG(IWV_AVG,:)=TAU_ARSL_Scat_Save(LOCINDXTMP(1),:)
     TAU_RAY_AVG(IWV_AVG,:)=TAU_RAY_Save(LOCINDXTMP(1),:)
     DEALLOCATE(XU,YU,ZU)
  ENDDO

ELSE
  NWV_START=1
  IF(SEG1ONLY) THEN
    NWV_END=NWV-NWV_SEG2
  ELSE
    NWV_END=NWV
  ENDIF
ENDIF

NWV_OUTPUT=NWV_END-NWV_START+1
IMIE=1

CALL h5open_f(hdferr)
CALL h5fcreate_f(CFILE1, H5F_ACC_TRUNC_F, file, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'MU_SOLAR', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=MU_IN
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_BAND /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WaveLength_PACE', H5T_IEEE_F32LE, space, dset, hdferr)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR=WV_BAND
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
DEALLOCATE(HDF5RARR)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_OUTPUT /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'WaveLength_Simulation', H5T_IEEE_F32LE, space, dset, hdferr)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR(1:NWV_OUTPUT)=WV_BAND(NWV_START:NWV_END)
ELSE
  HDF5RARR(1:NWV_OUTPUT)=WV(NWV_START:NWV_END)
ENDIF
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
DEALLOCATE(HDF5RARR)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Rf', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF1_Save(IMIE)+1.0)
HDF5RTMP=REFF1_Save(IMIE)*EXP(-2.5*RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Vf', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF1_Save(IMIE)+1.0)
HDF5RTMP=SQRT(RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Rc', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF2_Save(IMIE)+1.0)
HDF5RTMP=REFF2_Save(IMIE)*EXP(-2.5*RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Vc', H5T_IEEE_F32LE, space, dset, hdferr)
RTMP=LOG(VEFF2_Save(IMIE)+1.0)
HDF5RTMP=SQRT(RTMP)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRR1_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mrf', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRI1_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mif', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRR2_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mrc', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_BAND /)
ALLOCATE(HDF5RARR(NWV_BAND))
HDF5RARR(1:NWV_BAND)=MRI2_Save(IMIE,1:NWV_BAND)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Mic', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_ARSL_Ext_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_ARSL_Ext_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Aerosol_Extinction', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_ARSL_Scat_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_ARSL_Scat_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Aerosol_Scattering', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)


dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_RAY_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_RAY_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Rayleigh_Extinction', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)

dims= (/NWV_OUTPUT,NTLYERA /)
ALLOCATE(HDF5RARR2DIM(NWV_OUTPUT,NTLYERA ))
IF(ILS_FLAG)THEN
  HDF5RARR2DIM=TAU_TG_AVG(NWV_START:NWV_END,1:NTLYERA)
ELSE
  HDF5RARR2DIM=TAU_TG_Save(NWV_START:NWV_END,1:NTLYERA)
ENDIF
CALL h5screate_simple_f(2, dims, space, hdferr)
CALL h5dcreate_f(file, 'Tau_Trace_Gas_Absorption', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR2DIM(1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR2DIM)


dimscl=(/ NTLYERA /)
ALLOCATE(HDF5RARR(NTLYERA ))
HDF5RARR=ALT_LYRA
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Atmosphere_Layer_Altitudes', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
ALLOCATE(HDF5RARR(1 ))
HDF5RARR=ARSLND1_Save
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Number_Density_FineMode', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

ALLOCATE(HDF5RARR(1))
HDF5RARR=ARSLND2_Save
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Aerosol_Number_Density_CoarseMode', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=AW_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=AW(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'aw_Ocean_Water_Absorption_Coefficient', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BW_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BW(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bw_Ocean_Water_Scattering_Coefficient', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=RINDX_WATER_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=RINDX_WATER(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Refractive_Index_Ocean_Water', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Chla_Surface', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=CHLa(ICHLA)
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)


dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=APTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=APTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ap_Phytoplankton_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BPTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BPTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bp_Phytoplankton_Scattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BBPTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BBPTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bbp_Phytoplankton_Backscattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BBPTCfrac_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BBPTCfrac(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Bbp_Phytoplankton_Backscattering_fraction_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=BSTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=BSTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'bp_SEDIMENT_Scattering_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=ASTC_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=ASTC(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ap_SEDIMENT_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=ACDM_AVG(NWV_START:NWV_END)
ELSE
  HDF5RARR=ACDM(NWV_START:NWV_END)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ay_CDOM_Absorption_Coefficient_TopLayer', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'DEPOL90_KOK', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=Dpol90_Kok
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

IF(.not. OCEAN_FCHLA_FLAG)QUANTUM_YIELD_CHLA_AVG=0.0d0
dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'QUANTUM_YIELD_CHLA_AVG', H5T_IEEE_F32LE, space, dset, hdferr)
HDF5RTMP=QUANTUM_YIELD_CHLA_AVG
f_ptr=C_LOC(HDF5RTMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ABSORPTION_OPTICAL_DEPTH_REDUCTION_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'NonPhotochemicalQuenching_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(NPQ_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_FCHLA_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_FCHLA_FLAG)THEN
HDF5ITMP=1
ELSE
HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_FCDOM_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_FCDOM_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'OCEAN_RAMAN_FLAG', H5T_IEEE_F32LE, space, dset, hdferr)
IF(OCEAN_RAMAN_FLAG)THEN
  HDF5ITMP=1
ELSE
  HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ 1 /)
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'CHLA_HOMOGENEITY', H5T_IEEE_F32LE, space, dset, hdferr)
IF(CHLA_HOMOGENEITY)THEN
HDF5ITMP=1
ELSE
HDF5ITMP=0
ENDIF
f_ptr=C_LOC(HDF5ITMP(1))
CALL h5dwrite_f(dset,H5T_NATIVE_INTEGER,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(1,NWV_START:NWV_END,1)
ELSE
  HDF5RARR=DIRADFULL(1,NWV_START:NWV_END,1)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOA_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(1,NWV_START:NWV_END,2)
ELSE
  HDF5RARR=DIRADFULL(1,NWV_START:NWV_END,2)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOA_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)


dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(2,NWV_START:NWV_END,1)
ELSE
  HDF5RARR=DIRADFULL(2,NWV_START:NWV_END,1)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_BOA_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(2,NWV_START:NWV_END,2)
ELSE
  HDF5RARR=DIRADFULL(2,NWV_START:NWV_END,2)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_BOA_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(3,NWV_START:NWV_END,1)
ELSE
  HDF5RARR=DIRADFULL(3,NWV_START:NWV_END,1)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOO_Downwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NWV_OUTPUT /)
ALLOCATE(HDF5RARR(NWV_OUTPUT))
IF(ILS_FLAG)THEN
  HDF5RARR=DIRADFULL_AVG(3,NWV_START:NWV_END,2)
ELSE
  HDF5RARR=DIRADFULL(3,NWV_START:NWV_END,2)
ENDIF
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'Irradiance_TOO_Upwelling', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NTHETAOUT /)
ALLOCATE(HDF5RARR(NTHETAOUT))
HDF5RARR=ACOS(MUOUT)/PI*180.D0
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'ThetaV', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dimscl=(/ NPHIOUT /)
ALLOCATE(HDF5RARR(NPHIOUT))
HDF5RARR=PHIOUT*180.0d0/PI
CALL h5screate_simple_f(1, dimscl, space, hdferr)
CALL h5dcreate_f(file, 'PhiV', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR(1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
IF(ILS_FLAG)THEN
  HDF5RARR4DIM=DSTOKESFULL_AVG(1,NWV_START:NWV_END,:,:,:)
ELSE
  HDF5RARR4DIM=DSTOKESFULL(1,NWV_START:NWV_END,:,:,:)
ENDIF
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_TOA', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
IF(ILS_FLAG)THEN
  HDF5RARR4DIM=DSTOKESFULL_AVG(2,NWV_START:NWV_END,:,:,:)
ELSE
  HDF5RARR4DIM=DSTOKESFULL(2,NWV_START:NWV_END,:,:,:)
ENDIF
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_BOA', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)

dims4 = (/NWV_OUTPUT,NTHETAOUT,NPHIOUT,4/)
ALLOCATE(HDF5RARR4DIM(NWV_OUTPUT,NTHETAOUT,NPHIOUT,4))
IF(ILS_FLAG)THEN
  HDF5RARR4DIM=DSTOKESFULL_AVG(3,NWV_START:NWV_END,:,:,:)
ELSE
  HDF5RARR4DIM=DSTOKESFULL(3,NWV_START:NWV_END,:,:,:)
ENDIF
CALL h5screate_simple_f(4, dims4, space, hdferr)
CALL h5dcreate_f(file, 'Stokes_Vector_TOO', H5T_IEEE_F32LE, space, dset, hdferr)
CALL h5dwrite_f(dset, H5T_NATIVE_REAL,C_LOC(HDF5RARR4DIM(1,1,1,1)), hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
DEALLOCATE(HDF5RARR4DIM)


CALL h5fclose_f(file , hdferr)
CALL h5close_f(hdferr)

RETURN

END SUBROUTINE  STOKESOUT


SUBROUTINE MUPHIOUTASS(NTHETA0,NTHETAOUT,NPHIOUT,THETA0,MUOUT,PHIOUT)
INTEGER :: NTHETA0,NTHETAOUT,NPHIOUT
REAL*8,DIMENSION(NTHETA0) :: THETA0
REAL*8,DIMENSION(NTHETAOUT) :: MUOUT
REAL*8,DIMENSION(NPHIOUT) :: PHIOUT
REAL*8,DIMENSION(:),ALLOCATABLE ::THETAOUT_FREE
INTEGER :: IANG
REAL*8 RTMP
ALLOCATE(THETAOUT_FREE(NTHETAOUT))

RTMP=180.0D0/(1.0D0*NTHETAOUT)
DO IANG=1,NTHETAOUT/2
  THETAOUT_FREE(IANG)=(IANG-1)*RTMP
  THETAOUT_FREE(NTHETAOUT-IANG+1)=180.0D0-THETAOUT_FREE(IANG)
ENDDO

RTMP=90.0D0/(1.0D0*NTHETA0)
DO IANG=1,NTHETA0
  THETA0(IANG)=(IANG-1)*RTMP
ENDDO

RTMP=180.0d0/(NPHIOUT-1.0d0)
DO IANG=1,NPHIOUT
   PHIOUT(IANG)=(IANG-1)*RTMP
ENDDO

MUOUT=COS(THETAOUT_FREE/180.*3.141592653589793d0)
PHIOUT=PHIOUT*3.141592653589793d0/180.0D0

DEALLOCATE(THETAOUT_FREE)

ENDSUBROUTINE MUPHIOUTASS


INTEGER FUNCTION INDEX_PRIME_SCATTERING(NTLYERA,TAUR,PNDLY,IOPT,IWV_BAND)
USE MIE_PHMX_PACE, ONLY : CSCAT_ARSL_BAND
USE GLOBAL_DATA, ONLY : CEXT_REF,TAU550
IMPLICIT NONE

INTEGER,INTENT(IN) :: NTLYERA,IOPT,IWV_BAND
REAL*8,DIMENSION(NTLYERA),INTENT(IN) :: TAUR,PNDLY
REAL*8:: TAU_SCAT_TOTAL

INTEGER :: ITLYERA
REAL*8,DIMENSION(:),ALLOCATABLE :: TAULYR
REAL*8 :: TAUTMP,TAU_UPPER_LIM
ALLOCATE(TAULYR(NTLYERA))

DO ITLYERA=1,NTLYERA
  TAULYR(ITLYERA)=PNDLY(ITLYERA)*TAU550(IOPT)*CSCAT_ARSL_BAND(IWV_BAND)/CEXT_REF + &
                    TAUR(ITLYERA)
ENDDO
TAU_SCAT_TOTAL=SUM(TAULYR)

IF(TAU_SCAT_TOTAL > 2.0D0) THEN
  TAU_UPPER_LIM=1.0D0
ELSE
  TAU_UPPER_LIM=0.5D0*TAU_SCAT_TOTAL
ENDIF

TAUTMP=0.0D0
DO ITLYERA=1,NTLYERA
   TAUTMP=TAUTMP+TAULYR(ITLYERA)
   IF(TAUTMP>=TAU_UPPER_LIM) EXIT
ENDDO
INDEX_PRIME_SCATTERING=ITLYERA
!WRITE(*,*)'INDEX_PRIME_SCATTERING INFO',INDEX_PRIME_SCATTERING,TAUTMP,NTLYERA,TAU_SCAT_TOTAL
DEALLOCATE(TAULYR)
END FUNCTION INDEX_PRIME_SCATTERING


SUBROUTINE RTSOSINIT(IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWVSAVE,IOPT,WAVELENGTH_MICRON,&
       NREC,NTLYERA,NTLYERO,PNDLY,TAUR,TAU_TG,RECDATASTREAM,NTLYER,NUMMIEUSE,NUMMIERT,  &
       MAXLORDINPUT,NUMMIEANGINPUT,PHMXDATASTREAM,LBDO_LD,FLAM,TEMPERTURE,SALINITY)

USE GLOBAL_DATA
USE SAVE_OCEAN_MOD
USE RTUTILITY, ONLY : NUMMIEANGMAX,PI
USE PACE_INSTRUMENT_DESIGN,ONLY : NWV_BAND,WV_BAND
USE MIE_PHMX_PACE, ONLY : NUM_SCAT_ANG,CEXT_ARSL_BAND,CSCAT_ARSL_BAND,&
                          PHMXMIE_ARSL_PACE,REFF_MINERAL,AREA_MINERAL,&
                          CSCAT_Mineral_BAND,PHMXMIE_Plankton_PACE,PHMXMIE_Mineral_PACE
IMPLICIT none

INTEGER,INTENT(IN) :: IWNDSPD,ICHLA,Indx_Inelastic_Scattering,IWVSAVE,IOPT,NREC,NTLYER,&
                      NUMMIEUSE,NUMMIERT,MAXLORDINPUT,NTLYERA,NTLYERO
REAL*8,INTENT(IN)::WAVELENGTH_MICRON

REAL*8,DIMENSION(NTLYERA),INTENT(IN) :: TAUR,TAU_TG,PNDLY

INTEGER,DIMENSION(NUMMIERT),INTENT(OUT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6),INTENT(OUT) ::PHMXDATASTREAM

REAL*8,DIMENSION(NREC,7),INTENT(OUT) :: RECDATASTREAM

REAL*8,INTENT(IN):: LBDO_LD,FLAM,TEMPERTURE,SALINITY

REAL*8 :: WAVELENGTH_NANOMETER,CHLaLOCAL,AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,&
      BBPTCLOCAL,BBPTCfracLOCAL,APTCLOCAL,BSTCLOCAL,BSTC665LOCAL,        &
      ASTCLOCAL,ASTC443LOCAL,ACDMLOCAL,RINDX_WATERLOCAL,TAURfracLOCAL,SEDIMENT_DENSITY

REAL*8,DIMENSION(:),ALLOCATABLE :: TAURfrac,TAULYR,LBDOLYR

!TAURfrac(ILAYER), RAYLEIGH SCATTERING FRACTION
!TAULYR(ILAYER): TOTAL OPTICAL DEPTH  AT WAVLENTGH WV(IWV) AT LAYER(ILAYER) 
!LBDOLYR(ILAYER): EFFECTIVE SINGLE SCATTERING ALBEDO

REAL*8:: BLANK
INTEGER ::INDXDETECTOR,INDXLAMB,INDXOCEAN,INDXOCEAN1

INTEGER :: IMIE, NANGMIE_LOCAL,IANG
INTEGER,DIMENSION(1) ::LOCINDXTMP

!integer time_array_0(8), time_array_1(8)
!real start_time, finish_time
      
INTEGER :: ITLYERA,ITLYER,ITLYERW,IWV_BAND
REAL*8 :: RTMP,RTMP1,AEROSOL_ABSORB_FAC,AEROSOL_ALBEDO,OCEAN_ALBEDO, &
        ABSORPTION_TAU,SCATTERING_TAU,ABSORPTION_TAU_CUMMU,ABSORPTION_TAU_CUTOFF,&
        finemoderatio,LAYER_DEPTH_TMP,OCEAN_TAU_TMP,CSCAT_MINERAL

LOGICAL :: EMISSION_FLAG

WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0d0
LOCINDXTMP =MINLOC(ABS(WAVELENGTH_NANOMETER-WV_BAND))
IWV_BAND=LOCINDXTMP(1)

! SYSTEM PARAMETER DEFINITIONS
BLANK=0.0
INDXDETECTOR=-1000
INDXLAMB=-200
INDXOCEAN=-100
INDXOCEAN1=-101
ABSORPTION_TAU_CUTOFF=10.0D0
ABSORPTION_TAU_REPLACE=0.1D0

! SYSTEM PARAMETER DEFINITION OVER

RECDATASTREAM=BLANK
PHMXDATASTREAM=0.0D0

IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  TAU_REDUCE_OCEAN_PRESERVE=0.0D0
  TAU_REDUCE_ATMOS_PRESERVE=0.0D0
ENDIF

ALLOCATE(TAURfrac(NTLYERA),TAULYR(NTLYERA),LBDOLYR(NTLYERA))

AEROSOL_ALBEDO=CSCAT_ARSL_BAND(IWV_BAND)/CEXT_ARSL_BAND(IWV_BAND)
AEROSOL_ABSORB_FAC=1.0D0-AEROSOL_ALBEDO

IF(AEROSOL_ABSORB_FAC<0.0D0)THEN
   WRITE(*,*)'AEROSOL_ABSORB_FAC=',AEROSOL_ABSORB_FAC
   STOP 'CHECK AEROSOL_ABSORB_FAC'
ENDIF
! BELOW THIS LINE I HAVE ASSUMED ONE MIE FOR ALL LAYERS
! OTHERWISE NEED TO DO APPROPERIATE CHANGES !!!!!!!!!!!!!!!!

ABSORPTION_TAU_CUMMU=0.0D0

!DETECTOR AT THE TOA
RECDATASTREAM(1,1)=INDXDETECTOR
NUMMIEANGINPUT=NUM_SCAT_ANG(1)

IMIE=1
DO ITLYERA=1,NTLYERA
   TAULYR(ITLYERA)=PNDLY(ITLYERA)*TAU550(IOPT)*CEXT_ARSL_BAND(IWV_BAND)/CEXT_REF
   IF(TAULYR(ITLYERA)<1.0D-6)THEN
      RECDATASTREAM(ITLYERA+1,1)=1
   ELSE
      RECDATASTREAM(ITLYERA+1,1)=ITLYERA
   ENDIF
! total optical depth=aerosol+rayleigh+gas absorption
   ABSORPTION_TAU=TAU_TG(ITLYERA)+TAULYR(ITLYERA)*AEROSOL_ABSORB_FAC
   SCATTERING_TAU=TAUR(ITLYERA)+TAULYR(ITLYERA)*AEROSOL_ALBEDO

   TAULYR(ITLYERA)=SCATTERING_TAU+ABSORPTION_TAU
   LBDOLYR(ITLYERA)=SCATTERING_TAU/TAULYR(ITLYERA)
   TAURfrac(ITLYERA)=TAUR(ITLYERA)/SCATTERING_TAU

   RECDATASTREAM(ITLYERA+1,2)=TAULYR(ITLYERA)

  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    IF(ABSORPTION_TAU_CUMMU >= ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(ITLYERA+1,2)=ABSORPTION_TAU_REPLACE
       TAU_REDUCE_ATMOS_PRESERVE(ITLYERA+1)=ABSORPTION_TAU - &
                             ABSORPTION_TAU_REPLACE*(1.0D0-LBDOLYR(ITLYERA))
    ELSEIF(ABSORPTION_TAU_CUMMU + ABSORPTION_TAU>ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(ITLYERA+1,2) = &
              (ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)/(1.0D0-LBDOLYR(ITLYERA))
       IF(RECDATASTREAM(ITLYERA+1,2)<0.0D0) STOP 'CHECK REDUCE TAU ATMOS I'
       TAU_REDUCE_ATMOS_PRESERVE(ITLYERA+1)= ABSORPTION_TAU - &
                    (ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)
       IF(TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)<0.0D0) THEN
          WRITE(*,*)ABSORPTION_TAU,ABSORPTION_TAU_CUMMU,ABSORPTION_TAU_CUTOFF
          STOP'CHECK REDUCE TAU ATMOS II'
       ENDIF
    ENDIF
  ENDIF
  ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU + ABSORPTION_TAU

  RECDATASTREAM(ITLYERA+1,3)= LBDOLYR(ITLYERA)     ! ALBEDOR
  RECDATASTREAM(ITLYERA+1,4)=WAVELENGTH_MICRON
  RECDATASTREAM(ITLYERA+1,5)=TEMPERTURE
  RECDATASTREAM(ITLYERA+1,6)=0
  NUMMIEANGINPUT(ITLYERA)=NUM_SCAT_ANG(1)
  PHMXDATASTREAM(ITLYERA,1:NUMMIEANGMAX,0)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,0)

  IF(RECDATASTREAM(ITLYERA+1,1)==1 .OR. abs(1.0d0-TAURfrac(ITLYERA))<1.0e-8)THEN
    CALL RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,ITLYERA)
  ELSE
    PHMXDATASTREAM(ITLYERA,1:NUMMIEANGMAX,1:6)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,1:6)
    CALL PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYERA,TAURfrac(ITLYERA),DEPOL_A)
  ENDIF

ENDDO ! LAYER LOOP

CALL WATER_REFRACTIVE_INDEX(WAVELENGTH_NANOMETER,TEMPERTURE,SALINITY,RINDX_WATERLOCAL)

! detector just above ocean surface
    RECDATASTREAM(NTLYERA+2,1)=INDXDETECTOR
    RECDATASTREAM(NTLYERA+2,2)=BLANK
    RECDATASTREAM(NTLYERA+2,3)=BLANK
! OCEAN INTERFACE 
    RECDATASTREAM(NTLYERA+3,1)=INDXOCEAN
    RECDATASTREAM(NTLYERA+3,2)=WNDSPD(IWNDSPD)
    RECDATASTREAM(NTLYERA+3,3)=RINDX_WATERLOCAL

! Dectector just below OCEAN INTERFACE
RECDATASTREAM(NTLYERA+4,1)=INDXDETECTOR
RECDATASTREAM(NTLYERA+4,2)=BLANK
RECDATASTREAM(NTLYERA+4,3)=BLANK
DEALLOCATE(TAURfrac,TAULYR,LBDOLYR)

EMISSION_FLAG=(Indx_Inelastic_Scattering == 0) .OR. &
              (Indx_Inelastic_Scattering == 2) .OR. &
              (Indx_Inelastic_Scattering == 4) .OR. &
              (Indx_Inelastic_Scattering == 5)
! hydrosol LAYERS
IF(Indx_Inelastic_Scattering>0)TAU_INELASTIC_AGD=0.0d0
IF(OCEAN_CASE_SELECT==0) ABSORPTION_TAU_REPLACE=1.0D-12

!LOOP_LAYERS: DO ITLYERW=1,NWATER_DEPTH
LOOP_LAYERS: DO ITLYERW=1,NTLYERO+1
  CALL CHLAPROFILE(WATER_DEPTH(ITLYERW),CHLa(ICHLA),CHLaLOCAL)
  CALL HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLaLOCAL,TEMPERTURE,SALINITY,   &
               AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL, &
               BBPTCfracLOCAL,APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)

  IF(OCEAN_CASE_SELECT==2 .AND. ITLYERW==1)THEN
      CALL NAP_PARA_INIT(WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION, &
                         SEDIMENT_SPECTRAL_SLOPE,ASTCLOCAL,BSTCLOCAL)
  ENDIF

  RTMP= BWLOCAL + BPTCLOCAL
  RTMP1=AWLOCAL + APTCLOCAL + ACDMLOCAL

  IF(OCEAN_CASE_SELECT==2)THEN
    RTMP= RTMP+BSTCLOCAL
    RTMP1=RTMP1+ASTCLOCAL
  ENDIF

  IF(ITLYERW==NWATER_DEPTH) THEN
    IF(Indx_Inelastic_Scattering>0)THEN
        EXT_COEFF_INELASTIC_EM(ITLYERW)=RTMP+RTMP1
        IF(Indx_Inelastic_Scattering==3 .or. Indx_Inelastic_Scattering==6) THEN
           ABSORB_COEFF_CDOM_EX(IWVSAVE,ITLYERW)=ACDMLOCAL
           ABSORB_COEFF_CHLA_EX(IWVSAVE,ITLYERW)=APTCLOCAL
        ENDIF
    ENDIF
    EXIT LOOP_LAYERS
  ENDIF

  OCEAN_ALBEDO=RTMP/(RTMP+RTMP1)

  IF(OCEAN_PHMX_ONE) THEN
    RECDATASTREAM(NTLYERA+4+ITLYERW,1)=NTLYERA+1
  ELSE
    RECDATASTREAM(NTLYERA+4+ITLYERW,1)=NTLYERA+ITLYERW
  ENDIF

  ABSORPTION_TAU=RTMP1*(WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW))
  LAYER_DEPTH_TMP=WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW)
  RECDATASTREAM(NTLYERA+4+ITLYERW,2)= LAYER_DEPTH_TMP * (RTMP+RTMP1) ! TAU testing

  IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
    IF(ABSORPTION_TAU_CUMMU >= ABSORPTION_TAU_CUTOFF)THEN
       RECDATASTREAM(NTLYERA+4+ITLYERW,2)= ABSORPTION_TAU_REPLACE
       LAYER_DEPTH_TMP=ABSORPTION_TAU_REPLACE/(RTMP+RTMP1)
    ELSEIF(ABSORPTION_TAU_CUMMU+ABSORPTION_TAU>ABSORPTION_TAU_CUTOFF)THEN
       LAYER_DEPTH_TMP=(ABSORPTION_TAU_CUTOFF-ABSORPTION_TAU_CUMMU)/RTMP1
       IF(LAYER_DEPTH_TMP<0.0D0)STOP 'WARNING, CHECK LAYER_DEPTH_TMP'
       RECDATASTREAM(NTLYERA+4+ITLYERW,2)= LAYER_DEPTH_TMP * (RTMP+RTMP1) ! TAU testing
    ENDIF
    OCEAN_TAU_TMP=(WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW)-LAYER_DEPTH_TMP)*RTMP1
    IF(OCEAN_TAU_TMP<0.0D0)THEN
         WRITE(*,*)ABSORPTION_TAU_CUMMU,ABSORPTION_TAU,ABSORPTION_TAU_CUTOFF,RTMP1
         WRITE(*,*)WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW),LAYER_DEPTH_TMP,RTMP1,OCEAN_TAU_TMP
         STOP 'MAIN_PACE_Simulator.F90 CHECK OCEAN_TAU_TMP'
    ENDIF
    IF(ITLYERW<=NTLYERO) &
    TAU_REDUCE_OCEAN_PRESERVE(ITLYERW+1)=TAU_REDUCE_OCEAN_PRESERVE(ITLYERW) &
                                        +OCEAN_TAU_TMP
  ENDIF
  ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+RTMP1* &
                       (WATER_DEPTH(ITLYERW+1)-WATER_DEPTH(ITLYERW))

  IF(OCEAN_CASE_SELECT==0)THEN
    RECDATASTREAM(NTLYERA+4+ITLYERW,3)=0.0D0           ! ALBEDOO
  ELSE
    RECDATASTREAM(NTLYERA+4+ITLYERW,3)=RTMP/(RTMP+RTMP1)           ! ALBEDOO
  ENDIF
  RECDATASTREAM(NTLYERA+4+ITLYERW,4)=WAVELENGTH_MICRON
  RECDATASTREAM(NTLYERA+4+ITLYERW,5)=TEMPERTURE
  RECDATASTREAM(NTLYERA+4+ITLYERW,6)=Indx_Inelastic_Scattering

  IF(Indx_Inelastic_Scattering>0) THEN
     EXT_COEFF_INELASTIC_EM(ITLYERW)=RTMP+RTMP1
     TAU_INELASTIC_AGD(ITLYERW+1)=TAU_INELASTIC_AGD(ITLYERW) &
                                    + RECDATASTREAM(NTLYERA+4+ITLYERW,2)

     SCATT_COEFF_RAMAN_EX=BWRAMANLOCAL
  ENDIF

  IF(Indx_Inelastic_Scattering==3 .or. Indx_Inelastic_Scattering==6) THEN
    ABSORB_COEFF_CDOM_EX(IWVSAVE,ITLYERW)=ACDMLOCAL
    ABSORB_COEFF_CHLA_EX(IWVSAVE,ITLYERW)=APTCLOCAL
  ENDIF

  IF(OCEAN_PHMX_ONE .AND. ITLYERW>1)CYCLE
  IF(OCEAN_CASE_SELECT==0)THEN
     NUMMIEANGINPUT(NTLYERA+1)=NUM_SCAT_ANG(1)
     PHMXDATASTREAM(NTLYERA+1,1:NUMMIEANGMAX,0)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,0)

     CALL RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,NTLYERA+1)
  ELSEIF(OCEAN_CASE_SELECT==1)THEN
     NUMMIEANGINPUT(NTLYERA+ITLYERW)=NUM_SCAT_ANG(1)
     PHMXDATASTREAM(NTLYERA+ITLYERW,1:NUMMIEANGMAX,0)=PHMXMIE_ARSL_PACE(IWV_BAND,1:NUMMIEANGMAX,0)
     CALL HYDRSL_PHMX_ASSIGN(CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL,NTLYERA,&
            NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,ITLYERW,PHMXDATASTREAM)
  ELSE
     PHMXDATASTREAM(NTLYERA+ITLYERW,1:NUMMIEANGMAX,0)=PHMXMIE_Plankton_PACE(IWV_BAND,1:NUMMIEANGMAX,0)
     finemoderatio=BPTCLOCAL/(BPTCLOCAL+BSTCLOCAL)
     PHMXDATASTREAM(NTLYERA+ITLYERW,1:NUMMIEANGMAX,1:6)=&
                   (1.0d0-finemoderatio)*PHMXMIE_Mineral_PACE(IWV_BAND,1:NUMMIEANGMAX,1:6)&
                         +finemoderatio *PHMXMIE_Plankton_PACE(IWV_BAND,1:NUMMIEANGMAX,1:6)
     TAURfracLOCAL=BWLOCAL/(BPTCLOCAL+BSTCLOCAL+BWLOCAL)
     ITLYER=NTLYERA+ITLYERW
     NUMMIEANGINPUT(ITLYER)=NUM_SCAT_ANG(2)
     CALL PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYER,TAURfracLOCAL,DEPOL_O)
  ENDIF
ENDDO LOOP_LAYERS

IF(ABSORPTION_TAU_REDUCE_FLAG)THEN
  ABSORPTION_TAU_CUMMU=0.0D0
  DO ITLYERA =1,NTLYERA+1
    ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)
    TAU_REDUCE_ATMOS_PRESERVE(ITLYERA)=ABSORPTION_TAU_CUMMU
  ENDDO

  DO ITLYERW=1,NTLYERO+1
    ABSORPTION_TAU_CUMMU=ABSORPTION_TAU_CUMMU+TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)
    TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)=ABSORPTION_TAU_CUMMU
!     write(*,*)'tsp_TAU_INELASTIC_AGD',WATER_DEPTH(ITLYERW),&
!                            TAU_INELASTIC_AGD(ITLYERW),&
!                            TAU_REDUCE_OCEAN_PRESERVE(ITLYERW)
  ENDDO
ENDIF

! BOTTOM LAYERS
RECDATASTREAM(NTLYERA+5+NTLYERO,1)=INDXLAMB
RECDATASTREAM(NTLYERA+5+NTLYERO,2)=LBDO_LD
RECDATASTREAM(NTLYERA+5+NTLYERO,3)=FLAM
RECDATASTREAM(NTLYERA+5+NTLYERO,4)=NMBREINPUT
RECDATASTREAM(NTLYERA+5+NTLYERO,5)=NMBIMINPUT

END SUBROUTINE RTSOSINIT


SUBROUTINE TAURCAL(WVLENGTH,NLAYER,ALT_LYRA,TAUR)
IMPLICIT NONE
REAL*8,INTENT(IN) :: WVLENGTH
INTEGER,INTENT(IN)::NLAYER
REAL*8,DIMENSION(NLAYER+1), INTENT(IN) ::ALT_LYRA
REAL*8,DIMENSION(NLAYER), INTENT(OUT) ::TAUR

REAL*8 MOLEXT
INTEGER,PARAMETER :: N_ALT_MOL=30  ! do not use the two levels below sea surface
real*8,DIMENSION(N_ALT_MOL+1) :: ALT_MOL_PROFILE=(/39.7957,37.9994,35.9037,33.8080,32.0117, &
                        29.9760,28.0000,26.0241,24.0482,21.8926,20.0365,19.0785,   &
                        18.0606,17.0427,16.0248,15.0667,14.0489,13.0310,12.0729,   &
                        11.0550,10.0371,9.0791,8.0762,7.0583,6.0703,5.0824,4.0645, &
                        3.0466,2.0586,1.0407,0.0528/), &
MOLND_PROFILE=(/5.5629665058380875e+22,7.1144259529897572e+22,9.5963916831909919e+22, &
             1.3309563639241767e+23,1.7852263518577093e+23,2.5435797469192681e+23, &
             3.6294257195399695e+23,5.2257918195840461e+23,7.5338750993963792e+23, &
             1.1245916291652714e+24,1.5746098947913931e+24,1.8645787324568639e+24, &
             2.2195233438182151e+24,2.6392448499159020e+24,3.1016911770161213e+24, &
             3.6114510968223964e+24,4.2168196264715797e+24,4.9237651523626446e+24, &
             5.7105314692429076e+24,6.6968517812087991e+24,7.8683295574322933e+24, &
             9.1299375487391800e+24,1.0589030617491678e+25,1.2187198877962643e+25, &
             1.3845407831629019e+25,1.5668705921383059e+25,1.7738628908952063e+25, &
             2.0089060004434922e+25,2.2839358865360574e+25,2.5917599330742616e+25, &
             3.0919125003365726e+25 /)
REAL*8,DIMENSION(:),ALLOCATABLE :: MOLND_tmp,AEXPFACMOL,BEXPFACMOL

INTEGER:: ILYERA,IHEIGHT
REAL*8 :: ALTMID

ALLOCATE(MOLND_tmp(NLAYER),AEXPFACMOL(N_ALT_MOL),BEXPFACMOL(N_ALT_MOL))

! EQUATION (4.17) CALIPSO ATBD RELEASE 1.0
MOLEXT=4.5102D-27*(WVLENGTH/0.550D0)**(-4.025D0-0.05627D0*(WVLENGTH/0.550D0)**(-1.647D0))*1.0D-4

DO IHEIGHT=1,N_ALT_MOL
  AEXPFACMOL(IHEIGHT)=-LOG(MOLND_PROFILE(IHEIGHT)/MOLND_PROFILE(IHEIGHT+1)) &
             /(ALT_MOL_PROFILE(IHEIGHT)-ALT_MOL_PROFILE(IHEIGHT+1))
  BEXPFACMOL(IHEIGHT)=MOLND_PROFILE(IHEIGHT+1)
  IF(AEXPFACMOL(IHEIGHT)<0) then
    WRITE(*,*)IHEIGHT,AEXPFACMOL(IHEIGHT),LOG(MOLND_PROFILE(IHEIGHT)/MOLND_PROFILE(IHEIGHT+1))
    STOP 'CHECK AEXPFACMOL'
  ENDIF
ENDDO

DO ILYERA=1,NLAYER
 ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
 IF(ALTMID>ALT_MOL_PROFILE(1)) THEN
   MOLND_tmp(ILYERA)=BEXPFACMOL(1)*EXP(-AEXPFACMOL(1)*(ALTMID-ALT_MOL_PROFILE(2)))
 ELSE IF(ALTMID>ALT_MOL_PROFILE(N_ALT_MOL+1)) THEN
   DO IHEIGHT=1,N_ALT_MOL
     IF(ALTMID<ALT_MOL_PROFILE(IHEIGHT) .AND. ALTMID>ALT_MOL_PROFILE(IHEIGHT+1)) EXIT
   ENDDO
   MOLND_tmp(ILYERA)=BEXPFACMOL(IHEIGHT)*EXP(-AEXPFACMOL(IHEIGHT)*(ALTMID-ALT_MOL_PROFILE(IHEIGHT+1)))
 ELSE
   STOP 'WARNING ALTMID<0' 
 ENDIF
! WRITE(*,*)ALTMID,MOLND_tmp(ILYERA)
ENDDO

DO ILYERA=1,NLAYER
  MOLND_tmp(ILYERA)=MOLND_tmp(ILYERA)*(ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1))*1000.0D0
  TAUR(ILYERA)=MOLND_tmp(ILYERA)*MOLEXT
ENDDO
DEALLOCATE(MOLND_tmp,AEXPFACMOL,BEXPFACMOL)

END SUBROUTINE TAURCAL

SUBROUTINE ARSL_VERP_INIT(NTLYERA,ALT_LYRA,PNDLY)
USE GLOBAL_DATA, ONLY : WV_PACE_REF,CEXT_REF
USE PACE_INSTRUMENT_DESIGN,ONLY : NWV_BAND,WV_BAND
USE MIE_PHMX_PACE, ONLY : CEXT_ARSL_BAND
IMPLICIT NONE

INTEGER :: NTLYERA
REAL*8,DIMENSION(NTLYERA+1),INTENT(IN)::ALT_LYRA
REAL*8,DIMENSION(NTLYERA),INTENT(OUT)::PNDLY
!REAL*8,DIMENSION(8) ::   &
!  PND=(/0.0013,0.0727,0.6761,0.8619,0.3735,0.3769,0.9235,193.7308/),&
!  HEIGHT=(/45.2205,25.1867,21.8404,20.3539,12.0843,8.0429,4.9380,0./)
REAL*8,DIMENSION(8) ::   &
PND=(/0.0013,0.0727,0.6761,0.8619,0.3735,100.0,0.9235,0.8/),&
HEIGHT=(/45.2205,25.1867,21.8404,20.3539,12.0843,8.0429,4.9380,0./)

REAL*8,DIMENSION(7) :: AEXPFAC,BEXPFAC
REAL*8 :: ALTMID,TAU_REF
INTEGER :: ILYERA,IHEIGHT

INTEGER,DIMENSION(1) ::LOCINDXTMP


DO IHEIGHT=1,7
  AEXPFAC(IHEIGHT)=-LOG(PND(IHEIGHT)/PND(IHEIGHT+1))/(HEIGHT(IHEIGHT)-HEIGHT(IHEIGHT+1))
  BEXPFAC(IHEIGHT)=PND(IHEIGHT+1)
!  IF(AEXPFAC(IHEIGHT)<0) then
!    WRITE(*,*)IHEIGHT,AEXPFAC(IHEIGHT),LOG(PND(IHEIGHT)/PND(IHEIGHT+1))
!    STOP 'CHECK AEXPFAC'
!  endif
ENDDO

DO ILYERA=1,NTLYERA
 ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
 IF(ALTMID>HEIGHT(1)) THEN
   PNDLY(ILYERA)=BEXPFAC(1)*EXP(-AEXPFAC(1)*(ALTMID-HEIGHT(2)))
 ELSE IF(ALTMID>HEIGHT(8)) THEN
   DO IHEIGHT=1,7
     IF(ALTMID<HEIGHT(IHEIGHT) .AND. ALTMID>HEIGHT(IHEIGHT+1)) EXIT
   ENDDO
   PNDLY(ILYERA)=BEXPFAC(IHEIGHT)*EXP(-AEXPFAC(IHEIGHT)*(ALTMID-HEIGHT(IHEIGHT+1)))
 ELSE
   STOP 'WARNING ALTMID<0' 
 ENDIF
!  WRITE(*,*)ALTMID,PNDLY(ILYERA)
ENDDO

DO ILYERA=1,NTLYERA
  PNDLY(ILYERA)=PNDLY(ILYERA)*(ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1))
ENDDO

LOCINDXTMP =MINLOC(ABS(WV_PACE_REF-WV_BAND))
CEXT_REF=CEXT_ARSL_BAND(LOCINDXTMP(1))
TAU_REF=SUM(PNDLY*CEXT_REF)
PNDLY=PNDLY/TAU_REF
! in the unit of #/micron^2, which is the column number concentration
      !  = (Number of aerosols)/micron^2/km *km where km is the unit of altitude.
!WRITE(*,*)'LAYER INTEGRATED NUMBER DENSITY'
!DO ILYERA=1,NTLYERA
!   ALTMID=(ALT_LYRA(ILYERA)+ALT_LYRA(ILYERA+1))/2.0
!   WRITE(*,*)ALTMID,PNDLY(ILYERA),ALT_LYRA(ILYERA)-ALT_LYRA(ILYERA+1)
!ENDDO

END SUBROUTINE ARSL_VERP_INIT

SUBROUTINE RAYPHMXASSIGN(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,ITLYER)
USE RTUTILITY,ONLY : FACTOR
USE GLOBAL_DATA,ONLY : DEPOL_A
IMPLICIT NONE
INTEGER ::    NUMMIERT, NUMMIEANGMAX,ITLYER,ISCATANG
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM

REAL*8 :: MUF,DELTA_DEPOL,DELTA_DEPOLP

DELTA_DEPOL=(1.0D0-DEPOL_A)/(1.0D0+DEPOL_A/2.0D0)
DELTA_DEPOLP=(1.0D0-2.0D0*DEPOL_A)/(1.0D0-DEPOL_A)
   
DO ISCATANG=1,NUMMIEANGINPUT(ITLYER)
  MUF=COS(PHMXDATASTREAM(ITLYER,ISCATANG,0)*FACTOR)
  PHMXDATASTREAM(ITLYER,ISCATANG,1)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF) &
                                    +1.0D0-DELTA_DEPOL
  PHMXDATASTREAM(ITLYER,ISCATANG,2)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)
  PHMXDATASTREAM(ITLYER,ISCATANG,3)=1.5D0*DELTA_DEPOL*MUF
  PHMXDATASTREAM(ITLYER,ISCATANG,4)=1.5D0*DELTA_DEPOL*DELTA_DEPOLP*MUF
  
  PHMXDATASTREAM(ITLYER,ISCATANG,5)=-0.75D0*DELTA_DEPOL*(1.0D0-MUF*MUF)
  PHMXDATASTREAM(ITLYER,ISCATANG,6)=0.0D0
ENDDO

END SUBROUTINE RAYPHMXASSIGN

SUBROUTINE PHMXMIXING(NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,PHMXDATASTREAM,&
                     ITLYER,TAURfracLOCAL,DEPOL_LOCAL)
USE RTUTILITY,ONLY : FACTOR
IMPLICIT NONE
INTEGER ::    NUMMIERT, NUMMIEANGMAX,ITLYER,ISCATANG
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM
REAL*8 :: TAURfracLOCAL

REAL*8 :: DEPOL_LOCAL,MUF,DELTA_DEPOL,DELTA_DEPOLP
REAL*8,DIMENSION(6):: RAYPHMX_LOCAL

DELTA_DEPOL=(1.0D0-DEPOL_LOCAL)/(1.0D0+DEPOL_LOCAL/2.0D0)
DELTA_DEPOLP=(1.0D0-2.0D0*DEPOL_LOCAL)/(1.0D0-DEPOL_LOCAL)

DO ISCATANG=1,NUMMIEANGINPUT(ITLYER)
  MUF=COS(PHMXDATASTREAM(ITLYER,ISCATANG,0)*FACTOR)
  RAYPHMX_LOCAL(1)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)+1.0D0-DELTA_DEPOL

  RAYPHMX_LOCAL(2)=0.75D0*DELTA_DEPOL*(1.0D0+MUF*MUF)
  RAYPHMX_LOCAL(3)=1.5D0*DELTA_DEPOL*MUF
  RAYPHMX_LOCAL(4)=1.5D0*DELTA_DEPOL*DELTA_DEPOLP*MUF
  
  RAYPHMX_LOCAL(5)=-0.75D0*DELTA_DEPOL*(1.0D0-MUF*MUF)
  RAYPHMX_LOCAL(6)=0.0D0
  PHMXDATASTREAM(ITLYER,ISCATANG,1:6)=TAURfracLOCAL*RAYPHMX_LOCAL(1:6) + &
              (1.0D0-TAURfracLOCAL)*PHMXDATASTREAM(ITLYER,ISCATANG,1:6)
ENDDO

END SUBROUTINE PHMXMIXING


SUBROUTINE NAP_PARA_INIT(WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION, &
                         SEDIMENT_SPECTRAL_SLOPE,ASTCLOCAL,BSTCLOCAL)
USE PACE_INSTRUMENT_DESIGN,ONLY : NWV_BAND,WV_BAND
USE MIE_PHMX_PACE, ONLY : AREA_MINERAL,REFF_MINERAL,CSCAT_Mineral_BAND
USE GLOBAL_DATA, ONLY : SEDIMENT_INDEX_REFRACTION
IMPLICIT NONE

REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,SEDIMENT_CONCENTRATION,SEDIMENT_SPECTRAL_SLOPE
REAL*8,INTENT(OUT):: ASTCLOCAL,BSTCLOCAL

REAL*8 :: ASTC443LOCAL,SEDIMENT_DENSITY,CSCAT_MINERAL,BSTC665LOCAL,WAVELENGTH_NANOMETER
INTEGER,DIMENSION(1) ::LOCINDXTMP

!Babin et al., JGR, Vol. 108, 3211, 2003, Table 5
! Variations in the light absorption coefficients of phytoplankton,
! nonalgal particles, and dissolved organic matterin coastal waters around Europe

WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0D0
ASTC443LOCAL=0.041D0*SEDIMENT_CONCENTRATION
ASTCLOCAL=ASTC443LOCAL*0.75d0*EXP(-0.0123d0*(WAVELENGTH_NANOMETER-443.0d0))
SEDIMENT_DENSITY=6.779D6*SEDIMENT_INDEX_REFRACTION+5.232D6

LOCINDXTMP =MINLOC(ABS(665.0d0-WV_BAND))
CSCAT_MINERAL=CSCAT_Mineral_BAND(LOCINDXTMP(1))

BSTC665LOCAL=1.5D0*CSCAT_MINERAL/AREA_MINERAL/(REFF_MINERAL*1.D-6)/ &
             SEDIMENT_DENSITY*SEDIMENT_CONCENTRATION
BSTCLOCAL=BSTC665LOCAL*(WAVELENGTH_MICRON/0.665D0)**(-(SEDIMENT_SPECTRAL_SLOPE-3)) &
          -ASTCLOCAL*(1.0D0-TANH(0.5D0*(SEDIMENT_SPECTRAL_SLOPE-3)**2))

END SUBROUTINE NAP_PARA_INIT


SUBROUTINE HYDRSL_PARA_INIT(WAVELENGTH_MICRON,CHLaVal,TMPTR,SALINITY,         &
    AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,BBPTCfracLOCAL,&
    APTCLOCAL,ACDMLOCAL,RINDX_WATERLOCAL)
USE GLOBAL_DATA
IMPLICIT NONE
LOGICAL :: FCDOM_ACOEF_FREE
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,CHLaVal,TMPTR,SALINITY
REAL*8,INTENT(OUT)::AWLOCAL,BWLOCAL,BBWLOCAL,BWRAMANLOCAL,BPTCLOCAL,BBPTCLOCAL,&
                    BBPTCfracLOCAL,APTCLOCAL,   &
                    ACDMLOCAL,RINDX_WATERLOCAL
INTEGER,PARAMETER :: NWV_Aph1_ZPLee=81,NWV_AP_BIOSOPE=226,NWV_AP_COMPONENTS=151
REAL*8 :: BPTC_exp_coeff,BPTC660,Ap_Bricaud,Ep_Bricaud
REAL*8 :: S_cdm,WAVELENGTH_NANOMETER,BWFUNC,APTC440,ACDM440, CPTC550, CPTCLOCAL

INTEGER :: IREAD
REAL*8 :: RTMP,RTMP1,RTMP2
REAL,DIMENSION(5) :: RNDNMBR
! Ap_Bricaud and Ep_Bricaud are obtained through interpolation of 
! Bricaud's table values See
!Bricaud A,Morel A,Babin M,Allali K,Claustre H. Variations of light
!absorption by suspended particles with chlorophylla concentration
!in oceanic(case1) waters: analysis and implications for bio-optical
!models. J Geophys Res 1998;103:31033–4

INTEGER :: I_AP_UV ! =1, USE ZP LEE'S UV DATA, AS IT WAS IN ZHAI ET AL. OE, 2015
                   ! =2, USE BRICAUD BIOSCOPE 20 PERCENTILE
                   ! =3, USE BRICAUD BIOSCOPE 50 PERCENTILE
                   ! =4, USE BRICAUD BIOSCOPE 80 PERCENTILE

REAL*8,DIMENSION(NWV_Aph1_ZPLee),PARAMETER :: WV_Aph1_ZPLee=(/350.0d0,355.0d0,360.0d0,  &
             365.0d0,370.0d0,375.0d0,380.0d0,385.0d0,390.0d0,395.0d0,400.0d0, &
             405.0d0,410.0d0,415.0d0,420.0d0,425.0d0,430.0d0,435.0d0,440.0d0, &
             445.0d0,450.0d0,455.0d0,460.0d0,465.0d0,470.0d0,475.0d0,480.0d0, &
             485.0d0,490.0d0,495.0d0,500.0d0,505.0d0,510.0d0,515.0d0,520.0d0, &
             525.0d0,530.0d0,535.0d0,540.0d0,545.0d0,550.0d0,555.0d0,560.0d0, &
             565.0d0,570.0d0,575.0d0,580.0d0,585.0d0,590.0d0,595.0d0,600.0d0, &
             605.0d0,610.0d0,615.0d0,620.0d0,625.0d0,630.0d0,635.0d0,640.0d0, &
             645.0d0,650.0d0,655.0d0,660.0d0,665.0d0,670.0d0,675.0d0,680.0d0, &
             685.0d0,690.0d0,695.0d0,700.0d0,705.0d0,710.0d0,715.0d0,720.0d0, &
             725.0d0,730.0d0,735.0d0,740.0d0,745.0d0,750.0d0/)

REAL*8,DIMENSION(NWV_Aph1_ZPLee),PARAMETER :: Aph1_ZPLee=(/0.001555842d0,0.00181407d0,  &
             0.001888311d0,0.001929814d0,0.002001448d0,0.002095922d0,0.002190711d0,&
             0.002272435d0,0.002343792d0,0.002420293d0,0.002518258d0,0.002641678d0,&
             0.002780294d0,0.002921886d0,0.003062716d0,0.003200315d0,0.003319054d0,&
             0.003392452d0,0.003404776d0,0.003365358d0,0.003295404d0,0.003205327d0,&
             0.003091601d0,0.00295154d0,0.002793768d0,0.002632409d0,0.002472467d0, &
             0.002303613d0,0.002110266d0,0.00188762d0,0.001647957d0,0.001413061d0, &
             0.001201222d0,0.001019811d0,0.000867002d0,0.000737812d0,0.000628256d0,&
             0.000535732d0,0.000458072d0,0.000393474d0,0.000340909d0,0.000300215d0,&
             0.000271662d0,0.000255023d0,0.000248825d0,0.000250241d0,0.000255381d0,&
             0.000259823d0,0.000260164d0,0.000256607d0,0.000253508d0,0.000255765d0,&
             0.000264538d0,0.000277018d0,0.000289617d0,0.00030019d0,0.000307799d0, &
             0.000312941d0,0.000320181d0,0.000341222d0,0.000394337d0,0.000494746d0,&
             0.000635514d0,0.000774211d0,0.000846711d0,0.000806908d0,0.000660216d0,&
             0.000459487d0,0.000268371d0,0.00012758d0,0.00012758d0,0.00012758d0,   &
             0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0,     &
             0.00012758d0,0.00012758d0,0.00012758d0,0.00012758d0/)

REAL*8, DIMENSION(NWV_AP_BIOSOPE) :: WV_AP_BIOSOPE,AP_BIOSOPE_UV20P,AP_BIOSOPE_UV50P,&
                                     AP_BIOSOPE_UV80P,AP_BIOSOPE_USE
REAL*8, DIMENSION(NWV_AP_COMPONENTS) :: WV_AP_COMPONENTS, AP_PICO_BASE, AP_MICRO_BASE
REAL*8 :: SF_COEFF,AP_PICO_SPECIFIC676NM=0.023D0,AP_MICRO_SPECIFIC676NM=0.0086D0
REAL*8 :: POLINT_SIMPLE

WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0d0
CALL RANDOM_SEED()
CALL RANDOM_NUMBER(RNDNMBR)

I_AP_UV=3
IF(WAVELENGTH_NANOMETER<350.0D0 .and. I_AP_UV==1)THEN
  WRITE(*,*) 'warning, WAVELENGTH_NANOMETER=',WAVELENGTH_NANOMETER,'RANGE OUT OF APH ABSORPTION TABLE FROM ZP Lee'
  STOP
ENDIF

IF(WAVELENGTH_NANOMETER<300.0D0 .and. I_AP_UV>1)THEN
  write(*,*)'warning, WAVELENGTH_NANOMETER=',WAVELENGTH_NANOMETER,'RANGE OUT OF APH ABSORPTION TABLE FROM biosope'
  write(*,*)'extrapolation is used instead'
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN

  CALL AP_BRICAUD_LUT_SEARCH(440.0D0,CHLaVal, APTC440)

ELSEIF(OCEAN_CASE_SELECT==2)THEN
!SF_Coff options from Ciotti, Lewis, and Cullen, LO, 47(2) 404-417, 2002
!    Assessment of the relationships between dominant cell size in
!    natural phytoplankton communities and the spectral shape of
!    the absorption coefficient
! 1.000 0.663 0.598 0.369 0.558 0.491 0.664 0.287
! 0.370 0.266 0.151 0.442 0.002 0.014 0.025 0.000

  SF_COEFF=0.287d0
  OPEN(UNIT=1,FILE='ap_PicoMicro.txt',STATUS='OLD',ACTION='READ')
  READ(1,*)
  DO IREAD=1,NWV_AP_COMPONENTS
     READ(1,*)WV_AP_COMPONENTS(IREAD), AP_PICO_BASE(IREAD), AP_MICRO_BASE(IREAD)
  ENDDO
  CLOSE(1)
  RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,676.0D0,2)
  RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,676.0D0,2)
  AP_PICO_BASE=AP_PICO_BASE/RTMP1*AP_PICO_SPECIFIC676NM
  AP_MICRO_BASE=AP_MICRO_BASE/RTMP2*AP_MICRO_SPECIFIC676NM

  RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,440.0D0,2)
  RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,440.0D0,2)
  APTC440=CHLaVal*(SF_COEFF*RTMP1+(1.0D0-SF_COEFF)*RTMP2)
ELSE
  APTC440=1.0d-6  ! no ocean body, does not matter
ENDIF

IF(WAVELENGTH_NANOMETER<400.0D0)THEN
    IF(I_AP_UV==1)THEN
      APTCLOCAL=POLINT_SIMPLE(NWV_Aph1_ZPLee,WV_Aph1_ZPLee,Aph1_ZPLee,WAVELENGTH_NANOMETER,2)
      RTMP =    POLINT_SIMPLE(NWV_Aph1_ZPLee,WV_Aph1_ZPLee,Aph1_ZPLee,440.0d0,2)
      APTCLOCAL=APTCLOCAL/RTMP*APTC440
    ELSE
      OPEN(UNIT=1,FILE='ap_UV_biosope.dat',STATUS='OLD',ACTION='READ')
      DO IREAD=1,5
        READ(1,*)
      ENDDO
      DO IREAD=1,NWV_AP_BIOSOPE
         READ(1,*)WV_AP_BIOSOPE(IREAD),AP_BIOSOPE_UV20P(IREAD),AP_BIOSOPE_UV50P(IREAD),AP_BIOSOPE_UV80P(IREAD)
      ENDDO
      CLOSE(1)
      IF(I_AP_UV==2)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV20P
      ELSEIF(I_AP_UV==3)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV50P
      ELSEIF(I_AP_UV==4)THEN
         AP_BIOSOPE_USE=AP_BIOSOPE_UV80P
      ENDIF

      APTCLOCAL=POLINT_SIMPLE(NWV_AP_BIOSOPE,WV_AP_BIOSOPE,AP_BIOSOPE_USE,WAVELENGTH_NANOMETER,2)
      RTMP=POLINT_SIMPLE(NWV_AP_BIOSOPE,WV_AP_BIOSOPE,AP_BIOSOPE_USE,440.0D0,2)
      APTCLOCAL=APTCLOCAL/RTMP*APTC440
    ENDIF

ELSEIF(WAVELENGTH_NANOMETER<700.0D0)THEN

  IF(OCEAN_CASE_SELECT==1)THEN
    CALL AP_BRICAUD_LUT_SEARCH(WAVELENGTH_NANOMETER,CHLaVal, APTCLOCAL)
  ELSE IF(OCEAN_CASE_SELECT==2)THEN! USE CASE 2 AP MODEL
    RTMP1=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_PICO_BASE,WAVELENGTH_NANOMETER,2)
    RTMP2=POLINT_SIMPLE(NWV_AP_COMPONENTS,WV_AP_COMPONENTS, AP_MICRO_BASE,WAVELENGTH_NANOMETER,2)
    APTCLOCAL=CHLaVal*(SF_COEFF*RTMP1+(1.0D0-SF_COEFF)*RTMP2)
  ELSE ! no ocean water body
    APTCLOCAL=1.0d-6
  ENDIF

ELSE
  APTCLOCAL=0.0d0 ! negligible absorption for ap at wavelength > 700 nm
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN
! Testing the random number bio-optical model scheme with RNDNMBR-0.5d0
  RNDNMBR=0.5d0
  RTMP=(0.6D0-0.06D0)*RNDNMBR(1)+0.06D0
  CPTC550=RTMP*CHLaVal**0.57D0  ! EQ. 11 in lee_data.pdf
  RTMP1=-0.4D0+(1.6D0+1.2D0*RNDNMBR(2))/(1.0D0+SQRT(CHLaVal))
  CPTCLOCAL=CPTC550*(550.0D0/WAVELENGTH_NANOMETER)**RTMP1
ELSEIF(OCEAN_CASE_SELECT==2)THEN
!K. J. Voss, “A spectral model of the beam attenuation coefficient
!       in the ocean and coastal areas,” Limnol. Oceanogr. 37, 501-509 (1992).
  CPTC550=0.3D0*CHLaVal**0.62D0
  CPTCLOCAL=CPTC550*(550.0D0/WAVELENGTH_NANOMETER)**(PHYTOPLANKTON_SPECTRAL_SLOPE-3.0D0)
ELSE
  CPTCLOCAL=1.001d0*APTCLOCAL
ENDIF

BPTCLOCAL=CPTCLOCAL-APTCLOCAL

IF(BPTCLOCAL<0.0D0) THEN
    WRITE(*,*)'WARNING CPTCLOCAL<APTCLOCAL'
    WRITE(*,*)'CPTCLOCAL,APTCLOCAL=',CPTCLOCAL,APTCLOCAL
    WRITE(*,*)'SWTICH TO BIOOPTICAL MODEL CPTCLOCAL=BPTCLOCAL+APTCLOCAL'
    ! See Eq.14 in Morel and Maritorena, JGR, 2001
    IF(CHLaVal>2 .OR. CHLaVal<0.001D0)THEN
         BPTC_exp_coeff=0.0D0
    ELSE
         BPTC_exp_coeff=0.5*(LOG10(CHLaVal)-0.3)
    ENDIF
    ! See Eq.12 in Morel and Maritorena, JGR, 2001
    !  BPTC550(ICHLA)=0.416*CHLa(ICHLA)**0.766
    BPTC660=0.347*CHLaVal**0.766
    ! See Eq.13 in Morel and Maritorena, JGR, 2001
    BPTCLOCAL=BPTC660*(WAVELENGTH_MICRON/0.66)**BPTC_exp_coeff
    CPTCLOCAL=BPTCLOCAL+APTCLOCAL
ENDIF

IF(OCEAN_CASE_SELECT==1)THEN
    IF(abs(CHLaVal)<0.001D0)THEN
      BBPTCfracLOCAL=0.0d0
      BBPTCLOCAL=0.0d0
    ELSE
      BBPTCfracLOCAL=0.002+0.01*(0.5-0.25*log10(CHLaVal))
    IF(BBPTCfracLOCAL<1E-6)THEN
      WRITE(*,*)'CHLaVal,BBPTCfracLOCAL=',CHLaVal,BBPTCfracLOCAL
      STOP
    ENDIF
    !BBPTCfracLOCAL=0.01d0; ! used in Westberry, Boss, and Lee 2013
      BBPTCLOCAL=BBPTCfracLOCAL*BPTCLOCAL
    ENDIF
ELSE
    BBPTCfracLOCAL=0.0D0 ! NOT USED IN CASE 2 WATER BIOOPTICAL MODELS
    BBPTCLOCAL=0.0D0     ! NOT USED IN CASE 2 WATER BIOOPTICAL MODELS
ENDIF

!S_cdm is suggested by Morel and Gentili, RSE, 2009.
S_cdm=0.018

FCDOM_ACOEF_FREE=.true.
IF(FCDOM_ACOEF_FREE)THEN
    CALL RANDOM_NUMBER(RNDNMBR)
    RNDNMBR=0.5d0 !testing random number bio-optical model algorithm
    RTMP=0.3D0+5.7D0*RNDNMBR(1)*APTC440/(0.02D0+APTC440) ! EQ.9 in lee_data.pdf
    ACDM440=RTMP*APTC440
    ACDMLOCAL=ACDM440*exp(-S_cdm*(WAVELENGTH_MICRON-0.44d0)*1000.)
ELSE
! See Eq.1 in Morel and Gentili, RSE, 2009
    ACDM400=0.065*CHLaVal**0.63
    ACDMLOCAL=ACDM400*exp(-S_cdm*(WAVELENGTH_MICRON-0.40d0)*1000.)
ENDIF

!IULO=INT(FLOAT(NWV_PF_LUT)*ABS((WAVELENGTH_NANOMETER-WV_PF_LUT(1))/(WV_PF_LUT(NWV_PF_LUT)-WV_PF_LUT(1))))
!call hunt(WV_PF_LUT,NWV_PF_LUT,WAVELENGTH_NANOMETER,IULO)
!KLO=min(max(IULO-(MPL-1)/2,1),NWV_PF_LUT-MPL)
!CALL POLINT(WV_PF_LUT(KLO),AW_PF_LUT(KLO),MPL,WAVELENGTH_NANOMETER,AWLOCAl,RTMP)

AWLOCAl=  POLINT_SIMPLE(NWV_PF_LUT,WV_PF_LUT,AW_PF_LUT,WAVELENGTH_NANOMETER,2)

BWLOCAL=0.00193D0*(550.0d0/WAVELENGTH_NANOMETER)**4.32  !BWFUNC(WAVELENGTH_NANOMETER,TMPTR,SALINITY)
BBWLOCAL=0.5D0*BWLOCAl
!BWRAMANLOCAL=2.6d-4*(488.0d0/WAVELENGTH_NANOMETER)**5.5
!BWRAMANLOCAL=2.6d-4*(488.0d0/WAVELENGTH_NANOMETER)**4.8
BWRAMANLOCAL=2.7d-4*(488.0d0/WAVELENGTH_NANOMETER)**5.3

IF(OCEAN_CASE_SELECT==0)THEN
  CPTCLOCAL=APTCLOCAL
  BPTCLOCAL=0.0D0
  BBPTCfracLOCAL=0.0D0 ! BLACK OCEAN
  BBPTCLOCAL=0.0D0     ! BLACK OCEAN
  AWLOCAL=1.0D-6
  BWLOCAL=0.0D0
  BBWLOCAL=0.0D0
ENDIF

CALL WATER_REFRACTIVE_INDEX(WAVELENGTH_NANOMETER,TMPTR,SALINITY,RINDX_WATERLOCAL)

END SUBROUTINE HYDRSL_PARA_INIT

SUBROUTINE AP_BRICAUD_LUT_SEARCH(WAVELENGTH_NM,CHLaVal,AP)
IMPLICIT NONE
REAL*8, INTENT(IN) :: WAVELENGTH_NM,CHLaVal
REAL*8, INTENT(OUT) :: AP

INTEGER,PARAMETER :: NWV_Bricaud=151
REAL*8,DIMENSION(NWV_Bricaud),PARAMETER :: &
WV_Bricaud=(/400.0d0,402.0d0,404.0d0,406.0d0,408.0d0,410.0d0,412.0d0,&
             414.0d0,416.0d0,418.0d0,420.0d0,422.0d0,424.0d0,426.0d0,&
             428.0d0,430.0d0,432.0d0,434.0d0,436.0d0,438.0d0,440.0d0,&
             442.0d0,444.0d0,446.0d0,448.0d0,450.0d0,452.0d0,454.0d0,&
             456.0d0,458.0d0,460.0d0,462.0d0,464.0d0,466.0d0,468.0d0,&
             470.0d0,472.0d0,474.0d0,476.0d0,478.0d0,480.0d0,482.0d0,&
             484.0d0,486.0d0,488.0d0,490.0d0,492.0d0,494.0d0,496.0d0,&
             498.0d0,500.0d0,502.0d0,504.0d0,506.0d0,508.0d0,510.0d0,&
             512.0d0,514.0d0,516.0d0,518.0d0,520.0d0,522.0d0,524.0d0,&
             526.0d0,528.0d0,530.0d0,532.0d0,534.0d0,536.0d0,538.0d0,&
             540.0d0,542.0d0,544.0d0,546.0d0,548.0d0,550.0d0,552.0d0,&
             554.0d0,556.0d0,558.0d0,560.0d0,562.0d0,564.0d0,566.0d0,&
             568.0d0,570.0d0,572.0d0,574.0d0,576.0d0,578.0d0,580.0d0,&
             582.0d0,584.0d0,586.0d0,588.0d0,590.0d0,592.0d0,594.0d0,&
             596.0d0,598.0d0,600.0d0,602.0d0,604.0d0,606.0d0,608.0d0,&
             610.0d0,612.0d0,614.0d0,616.0d0,618.0d0,620.0d0,622.0d0,&
             624.0d0,626.0d0,628.0d0,630.0d0,632.0d0,634.0d0,636.0d0,&
             638.0d0,640.0d0,642.0d0,644.0d0,646.0d0,648.0d0,650.0d0,&
             652.0d0,654.0d0,656.0d0,658.0d0,660.0d0,662.0d0,664.0d0,&
             666.0d0,668.0d0,670.0d0,672.0d0,674.0d0,676.0d0,678.0d0,&
             680.0d0,682.0d0,684.0d0,686.0d0,688.0d0,690.0d0,692.0d0,&
             694.0d0,696.0d0,698.0d0,700.0d0/), &
Ap_Bricaud_LUT=(/0.043321d0,0.043805d0,0.044307d0,0.045064d0,0.045812d0,&
             0.046699d0,0.047328d0,0.047969d0,0.048595d0,0.049069d0,&
             0.049477d0,0.049611d0,0.049713d0,0.050096d0,0.050561d0,&
             0.051299d0,0.051568d0,0.051726d0,0.051950d0,0.052003d0,&
             0.052019d0,0.051398d0,0.050464d0,0.049508d0,0.048558d0,&
             0.047932d0,0.047111d0,0.046229d0,0.045566d0,0.044945d0,&
             0.044552d0,0.043937d0,0.043282d0,0.042681d0,0.042065d0,&
             0.041530d0,0.040727d0,0.039861d0,0.039079d0,0.038357d0,&
             0.037742d0,0.037013d0,0.036276d0,0.035576d0,0.034834d0,&
             0.034124d0,0.033205d0,0.032170d0,0.031089d0,0.029954d0,&
             0.028819d0,0.027624d0,0.026434d0,0.025281d0,0.024201d0,&
             0.023181d0,0.022189d0,0.021248d0,0.020406d0,0.019624d0,&
             0.018943d0,0.018252d0,0.017583d0,0.017065d0,0.016484d0,&
             0.015987d0,0.015469d0,0.014994d0,0.014524d0,0.014103d0,&
             0.013722d0,0.013316d0,0.012954d0,0.012554d0,0.012194d0,&
             0.011825d0,0.011423d0,0.011049d0,0.010677d0,0.010317d0,&
             0.010031d0,0.0097641d0,0.0094984d0,0.0092848d0,0.0091161d0,&
             0.0090396d0,0.0089222d0,0.0088270d0,0.0087804d0,0.0087719d0,&
             0.0088089d0,0.0088272d0,0.0088963d0,0.0089011d0,0.0089057d0,&
             0.0089436d0,0.0088958d0,0.0088117d0,0.0087399d0,0.0086249d0,&
             0.0085428d0,0.0084855d0,0.0084262d0,0.0084156d0,0.0084456d0,&
             0.0085282d0,0.0086012d0,0.0087063d0,0.0087977d0,0.0088983d0,&
             0.0089570d0,0.0089865d0,0.0090377d0,0.0091362d0,0.0091923d0,&
             0.0093245d0,0.0094377d0,0.0095348d0,0.0096250d0,0.0096807d0,&
             0.0097295d0,0.0098384d0,0.0098896d0,0.0100020d0,0.0100940d0,&
             0.0102980d0,0.0105460d0,0.0109600d0,0.0115510d0,0.0123180d0,&
             0.0133350d0,0.0145240d0,0.0159410d0,0.0174420d0,0.0188000d0,&
             0.0198900d0,0.0205370d0,0.0206550d0,0.0203380d0,0.0195500d0,&
             0.0183000d0,0.0165610d0,0.0145490d0,0.0124000d0,0.0103630d0,&
             0.0086832d0,0.0072437d0,0.0060441d0,0.0051813d0,0.0044349d0,&
             0.0039342d0/), &
Ep_Bricaud_LUT=(/0.70264700d0,0.70008400d0,0.69713200d0,0.69402600d0,0.69163300d0,&
             0.68817200d0,0.68624500d0,0.68156700d0,0.67822900d0,0.67464400d0,&
             0.67119500d0,0.66492600d0,0.65893100d0,0.65573900d0,0.65366800d0,&
             0.65427700d0,0.64998700d0,0.64512700d0,0.64008100d0,0.63579800d0,&
             0.63496500d0,0.62975200d0,0.62319900d0,0.61863100d0,0.61437300d0,&
             0.61509600d0,0.61305600d0,0.61005500d0,0.60961700d0,0.60956400d0,&
             0.61235800d0,0.61281800d0,0.61205500d0,0.61191600d0,0.61194100d0,&
             0.61293800d0,0.61114800d0,0.60839400d0,0.60664900d0,0.60518700d0,&
             0.60653300d0,0.60642900d0,0.60721900d0,0.60974100d0,0.61350600d0,&
             0.62002600d0,0.62504300d0,0.63075200d0,0.63776800d0,0.64575000d0,&
             0.65574300d0,0.66499400d0,0.67451100d0,0.68439000d0,0.69450800d0,&
             0.70600400d0,0.71550900d0,0.72468700d0,0.73496500d0,0.74470400d0,&
             0.75513100d0,0.76437800d0,0.77428800d0,0.77583700d0,0.78423400d0,&
             0.79197900d0,0.79929700d0,0.80430600d0,0.81154700d0,0.81623700d0,&
             0.82177600d0,0.82706000d0,0.83034000d0,0.83412900d0,0.83580700d0,&
             0.83854200d0,0.84213100d0,0.84192300d0,0.84380100d0,0.84359000d0,&
             0.84125400d0,0.83924600d0,0.83881500d0,0.83976200d0,0.84005900d0,&
             0.83642500d0,0.83564600d0,0.83547000d0,0.83259200d0,0.82952900d0,&
             0.82763100d0,0.82648500d0,0.81994200d0,0.82021400d0,0.81737600d0,&
             0.81172600d0,0.81085800d0,0.80851800d0,0.80388600d0,0.80434600d0,&
             0.80494400d0,0.80574300d0,0.81047500d0,0.81555500d0,0.82024700d0,&
             0.82480800d0,0.83032200d0,0.83401100d0,0.83820100d0,0.83972600d0,&
             0.84380800d0,0.84618200d0,0.84668000d0,0.84434200d0,0.84656800d0,&
             0.84554300d0,0.84563600d0,0.84497200d0,0.84295600d0,0.84116400d0,&
             0.83738800d0,0.82956800d0,0.82599800d0,0.81902800d0,0.81820600d0,&
             0.81423600d0,0.81486100d0,0.81376400d0,0.81490400d0,0.82011500d0,&
             0.82296500d0,0.82755100d0,0.82416800d0,0.81972200d0,0.81759900d0,&
             0.81774200d0,0.81659000d0,0.81882300d0,0.82229100d0,0.82725000d0,&
             0.83522900d0,0.85007600d0,0.86755500d0,0.88844400d0,0.91245670d0,&
             0.93138840d0,0.94421240d0,0.96783410d0,0.98167950d0,1.00265734d0,&
             1.0131636d0/)

INTEGER :: IULO,MPL,KLO
REAL*8 :: Ap_Bricaud,Ep_Bricaud,RTMP

IF(WAVELENGTH_NM<400.0D0 .OR. WAVELENGTH_NM>700.0D0)THEN
  STOP 'WAVELENGTH OUT RANGE OF BRICAUD TABLE'
ENDIF

MPL=3
IULO=INT(FLOAT(NWV_Bricaud)*ABS((WAVELENGTH_NM-WV_Bricaud(1))/(WV_Bricaud(NWV_Bricaud)-WV_Bricaud(1))))

call hunt(WV_Bricaud,NWV_Bricaud,WAVELENGTH_NM,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NWV_Bricaud-MPL)
CALL POLINT(WV_Bricaud(KLO),Ap_Bricaud_LUT(KLO),MPL,WAVELENGTH_NM,Ap_Bricaud,RTMP)
CALL POLINT(WV_Bricaud(KLO),Ep_Bricaud_LUT(KLO),MPL,WAVELENGTH_NM,Ep_Bricaud,RTMP)
AP=Ap_Bricaud*CHLaVal**Ep_Bricaud

ENDSUBROUTINE AP_BRICAUD_LUT_SEARCH


SUBROUTINE HYDRSL_PHMX_ASSIGN(CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL, &
       NTLYERA,NUMMIERT,NUMMIEANGMAX,NUMMIEANGINPUT,ITLYERW,PHMXDATASTREAM)
USE RTUTILITY, ONLY : PI
USE GLOBAL_DATA, ONLY : DEPOL_A, DEPOL_O, Xi_kok, Alpha_kok, T0_kok,Dpol90_Kok
IMPLICIT NONE

REAL*8 :: CHLaLOCAL,BBPTCfracLOCAL,BWLOCAL,BPTCLOCAL
INTEGER :: NTLYERA,NUMMIERT, NUMMIEANGMAX,ITLYERW
INTEGER,DIMENSION(NUMMIERT) :: NUMMIEANGINPUT
REAL*8,DIMENSION(NUMMIERT,NUMMIEANGMAX,0:6) ::PHMXDATASTREAM

INTEGER :: IANG
REAL*8 :: RTMP,RTMP1,ANGLE,NU,DLT90,XW,MUF,NORM,FFPH

IF(CHLaLOCAL>0.001D0)CALL FFPFCOEFF(BBPTCfracLOCAL,NU,DLT90)
DO IANG=1,NUMMIEANGINPUT(NTLYERA+ITLYERW)
  ANGLE=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,0)
  XW=(1.0D0-DEPOL_O)/(1.0D0+DEPOL_O)
  NORM=3.0D0/(3.0D0+XW)
  MUF=cos(ANGLE*pi/180.0d0)
  RTMP=NORM*(1.0D0+XW*MUF*MUF)
  IF(CHLaLOCAL>0.001D0) THEN
     RTMP1=FFPH(NU,DLT90,ANGLE)
     PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)= (BWLOCAL*RTMP +  &
       BPTCLOCAL*RTMP1)/ &
      (BWLOCAL + BPTCLOCAL)
  ELSE
     PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)= RTMP
  ENDIF
  RTMP1=Xi_kok*EXP(-Alpha_kok*ANGLE/180.0D0*PI)
  RTMP=1.0D0+Dpol90_Kok*(cos(ANGLE/180.0D0*PI-T0_kok))**2 + RTMP1
  
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2)= &
     (Dpol90_Kok*(1.0D0+(cos(ANGLE/180.0D0*PI-T0_kok))**2) + RTMP1)/RTMP
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)= &
     (2.0D0*Dpol90_Kok*MUF + RTMP1)/(1.0D0+Dpol90_Kok*MUF*MUF + RTMP1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5)=- Dpol90_Kok*((sin(ANGLE/180.0D0*PI))**2) &
          /(1.0d0+Dpol90_Kok*MUF*MUF)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6)=0.0d0

  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,2) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,3) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,4) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,5) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
  PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6)=PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,6) * &
              PHMXDATASTREAM(NTLYERA+ITLYERW,IANG,1)
ENDDO


END SUBROUTINE HYDRSL_PHMX_ASSIGN

MODULE FOURNIER_FORAND
IMPLICIT NONE
REAL*8 :: BACKSCATTERING_FRACTION
END MODULE

SUBROUTINE FFPFCOEFF(BB,NU,DLT90)
USE FOURNIER_FORAND, ONLY : BACKSCATTERING_FRACTION
USE RTSEC_WRAPPER
IMPLICIT NONE
real*8 BB,NU,DLT90
real*8 NURTLW,NURTHI,XACC,RTMP
real*8 FNU
EXTERNAL FNU
BACKSCATTERING_FRACTION=BB
NURTLW=-1.0D0
NURTHI=0.0D0
XACC=1.0E-12
NU=rtsec(FNU,NURTLW,NURTHI,XACC)
RTMP=(0.01D0-0.3084D0*NU)*(0.01D0-0.3084D0*NU)
DLT90=2.0D0/3.0D0/RTMP
END SUBROUTINE

REAL*8 FUNCTION FNU(NU)
USE FOURNIER_FORAND
IMPLICIT NONE
real*8 NU,BB
real*8 DLTTMP,RTMP,DLTPNU
BB=BACKSCATTERING_FRACTION
RTMP=(0.01D0-0.3084D0*NU)**2
DLTTMP=2.0D0/3.0D0/RTMP
DLTPNU=DLTTMP**NU
FNU=1.0D0-BB-(0.5D0-DLTTMP*DLTPNU+0.5D0*DLTPNU)/(DLTPNU-DLTTMP*DLTPNU)
END FUNCTION FNU

REAL*8 FUNCTION FFPH(NU,DLT90,ANG)
IMPLICIT NONE
real*8 NU,DLT90,ANG
real*8 ANGTMP,ANGD2,SINANGD2,COSANG,DLT,DLTPNU,OMDLT,OMDLTPNU
real*8 FCT1,TRM1,TRM2,DLT180,DLT180PNU,OMDLT180,OMDLT180PNU

ANGTMP=ANG/180.d0*3.1415926535897932d0
IF(ANGTMP<1.0E-4)ANGTMP=1.0E-4
ANGD2=0.5d0*ANGTMP
SINANGD2=SIN(ANGD2)
SINANGD2=SINANGD2*SINANGD2
COSANG=COS(ANGTMP)

DLT180=2.0d0*DLT90
DLT=DLT180*SINANGD2
DLTPNU=DLT**NU
OMDLT=1.0d0-DLT
OMDLTPNU=1.0d0-DLTPNU
FCT1=1.0d0/OMDLT/OMDLT/DLTPNU
TRM1=NU*OMDLT-OMDLTPNU
TRM2=DLT*OMDLTPNU-NU*OMDLT

DLT180PNU=DLT180**NU
OMDLT180=1.0d0-DLT180
OMDLT180PNU=1.0D0-DLT180PNU
FFPH=FCT1*(TRM1+TRM2/SINANGD2)-  &
       0.25d0*OMDLT180PNU/OMDLT180/DLT180PNU*(3.0d0*COSANG*COSANG-1.0d0)
END FUNCTION FFPH

!SEA WATER SCATTERING COEFFICIENTS BASED ON BUITEVELD 1994 OOXII
REAL*8 FUNCTION BWFUNC(WAVELENGTH_NANOMETER,TMPTR,SALINITY)
USE GLOBAL_DATA, only : DEPOL_O
USE RTUTILITY, ONLY : PI
IMPLICIT NONE

REAL*8 WAVELENGTH_NANOMETER,TMPTR,SALINITY
REAL*8 WAVELENGTH_NANOMETER2,WAVELENGTH_NANOMETER4,WAVELENGTH_NANOMETERM,&
       WAVELENGTH_NANOMETERM4,TEM2,BETA90,TMPABSLT,BOLZMANK,BETAT, &
       INDX,INDXDP,INDXDP20,INDXDP633,INDXDPDNM

BOLZMANK=1.38054D-23
TMPABSLT=TMPTR+273.15D0
WAVELENGTH_NANOMETERM=WAVELENGTH_NANOMETER*1.0E-9 
WAVELENGTH_NANOMETERM4=WAVELENGTH_NANOMETERM**4
WAVELENGTH_NANOMETER2=WAVELENGTH_NANOMETER*WAVELENGTH_NANOMETER
WAVELENGTH_NANOMETER4=WAVELENGTH_NANOMETER2*WAVELENGTH_NANOMETER2
TEM2=TMPTR*TMPTR
BETAT=(5.062271D0-0.03179D0*TMPTR+0.000407D0*TEM2)*1.0D-10
INDX=1.3247D0+3300.0D0/WAVELENGTH_NANOMETER2-3.2D7/WAVELENGTH_NANOMETER4-2.5D-6*TEM2 !&
! +(5.0D0-0.02D0*TMPTR)*4.0D-5*SALINITY
INDXDP20=(-0.000156d0*WAVELENGTH_NANOMETER+1.5989D0)*1.0D-10
INDXDP633=(1.61857D0-0.005785*TMPTR)*1.0D-10
INDXDPDNM=(-0.000156d0*633.0D0+1.5989D0)*1.0D-10
!INDXDPDNM=1.5014D-010
INDXDP=INDXDP20*INDXDP633/INDXDPDNM
!write(*,*)'INDXDP=',INDXDP20,INDXDP633,INDXDPDNM,INDXDP
BETA90=2.0D0*PI*PI*BOLZMANK/WAVELENGTH_NANOMETERM4/BETAT*TMPABSLT*INDX*INDX*          &
INDXDP*INDXDP*6.0D0*(1.0D0+DEPOL_O)/(6.0D0-7.0D0*DEPOL_O)
!write(*,*)'BETA90=',BETA90
BWFUNC=8.0D0*PI/3.0D0*BETA90*(2.0D0+DEPOL_O)/(1.0D0+DEPOL_O)
BWFUNC=BWFUNC*(1.0d0+0.3d0*SALINITY/37.0D0)

END FUNCTION BWFUNC

SUBROUTINE CLOUDMODELSELECTION(WAVELENGTH_MICRON,NUMMIEUSE,           &
             REFF1,VEFF1,REFF2,VEFF2,MRR1,MRI1,MRR2,MRI2)
USE GLOBAL_DATA
USE RTUTILITY, ONLY : PI
IMPLICIT NONE

INTEGER,INTENT(IN) :: NUMMIEUSE
REAL*8,INTENT(IN)::WAVELENGTH_MICRON
REAL*8,DIMENSION(NUMMIEUSE),INTENT(OUT)::REFF1,VEFF1,REFF2, &
                                    VEFF2,MRR1,MRI1,MRR2,MRI2
REAL*8 :: RADIUS_CLOUDS=10.0D0,VARIANCE_CLOUDS=0.1D0,&
          TMPTR=-20.0D0,SALINITY=0.0D0,WAVELENGTH_NANOMETER
REAL*8 :: RTMP,RTMP1,RINDX_WATERLOCAL
WAVELENGTH_NANOMETER=WAVELENGTH_MICRON*1000.0d0
CALL WATER_REFRACTIVE_INDEX(WAVELENGTH_NANOMETER,TMPTR,SALINITY,RINDX_WATERLOCAL)

REFF1(:)=RADIUS_CLOUDS
REFF2(:)=RADIUS_CLOUDS
VEFF1(:)=VARIANCE_CLOUDS
VEFF2(:)=VARIANCE_CLOUDS
MRR1(:)=RINDX_WATERLOCAL
MRI1(:)=0.0d0
MRR2(:)=0.0d0
MRI2(:)=0.0d0

END SUBROUTINE CLOUDMODELSELECTION



SUBROUTINE WATER_ABSORPTION_READ
USE GLOBAL_DATA
IMPLICIT NONE
INTEGER :: IREAD

OPEN(UNIT=1,FILE='water_coef.txt',STATUS='OLD',ACTION='READ')
DO IREAD=1,30
  READ(1,*)
ENDDO
DO IREAD=1,NWV_PF_LUT
  READ(1,*)WV_PF_LUT(IREAD),AW_PF_LUT(IREAD),BW_PF_LUT(IREAD)
ENDDO
CLOSE(1)
RETURN
ENDSUBROUTINE WATER_ABSORPTION_READ

SUBROUTINE SOURCEF_FLUORESCENCE_INTEGRATION(OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG,LAMBDAEM)
USE IRRADSUNL
USE RAMANDATA
USE SAVE_OCEAN_MOD
USE FLUORESCENCEDATA
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
LOGICAL, INTENT(IN):: OCEAN_FCHLA_FLAG,OCEAN_FCDOM_FLAG
REAL*8, INTENT(IN) :: LAMBDAEM
REAL*8,PARAMETER :: IPAR_WV_BEG=400.0D0,IPAR_WV_END=700.0D0
REAL*8, PARAMETER :: PLANK_CONSTANT_TIMES_C=1.98644568D-16  ! UNIT (J nm)
REAL*8, PARAMETER :: Avogadro_Constant=6.02214085774D23
REAL*8 :: IPAR_SCALAR,NPQ_ADJUST,PSII_RC_FRAC,QUANTUM_YIELD_CHLA_LOCAL,TRANS_CHLA_AVG
REAL*8 :: INTWEIGHT
INTEGER :: IWVEX,ILAYERW

SOURCEFO_FLUORESCENCE_AGD=0.0D0
IF(OCEAN_FCDOM_FLAG)THEN
  DO IWVEX=1,NFLRSCGRID
    IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
      INTWEIGHT=0.5D0
    ELSE
      INTWEIGHT=1.0D0
    ENDIF
  DO ILAYERW=1,NWATER_DEPTH
     SOURCEFO_FLUORESCENCE_AGD(ILAYERW)= SOURCEFO_FLUORESCENCE_AGD(ILAYERW)+ &
          DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)*ABSORB_COEFF_CDOM_EX(IWVEX,ILAYERW)  &
              *fCDOMfuncjEX(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
  ENDDO
ENDDO
ENDIF

IF(OCEAN_FCHLA_FLAG)THEN

QUANTUM_YIELD_CHLA_AVG=0.0D0
TRANS_CHLA_AVG=0.0D0
  DO ILAYERW=1,NWATER_DEPTH
    IF(NPQ_FLAG)THEN
      IPAR_SCALAR=0.0D0
      DO IWVEX=1,NFLRSCGRID
         IF(LAMBDAEXFLRSC(IWVEX)<IPAR_WV_BEG .OR.  &
          LAMBDAEXFLRSC(IWVEX)>IPAR_WV_END)         CYCLE
         IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
           INTWEIGHT=0.5D0/1000.0D0 ! mean to conert irradiance unit from W/m^2/micron to W/m^2/nm
         ELSE
           INTWEIGHT=1.0D0/1000.0D0 ! mean to conert irradiance unit from W/m^2/micron to W/m^2/nm
         ENDIF
         IPAR_SCALAR=IPAR_SCALAR + DIIRAD_SCALAR_AGD(IWVEX, ILAYERW) * &
                            LAMBDAEXFLRSC(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
! write(*,*)TAU_INELASTIC_AGD(ILAYERW),LAMBDAEXFLRSC(IWVEX),DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)
      ENDDO
! IPAR_SCALAR UNIT=MICRO MOL QUANTA m^{-2} s^{-1}
!    WRITE(*,*)'IPAR_SCALAR=',IPAR_SCALAR,'W m^{-2} nm *(hc in J nm)'
      IPAR_SCALAR=IPAR_SCALAR/PLANK_CONSTANT_TIMES_C/Avogadro_Constant*1.0D6
!    WRITE(*,*)'IPAR_SCALAR=',IPAR_SCALAR,'MICRO MOL QUANTA m^{-2} s^{-1}'

! QUANTUM YIELD MODEL FOLLOWS: J. Ruairidh Morrison,
!    'In situ determination of the quantum yield of phytoplankton
!     chlorophyll a fluorescence: A simple algorithm, observations, and a model,'
!     Limnol. Oceanogr. Vol. 48, Page 618-631, (2003)

      PSII_RC_FRAC=EXP(-IPAR_SCALAR/QUANTUM_YIELD_CHLA_EK)
      QUANTUM_YIELD_CHLA_LOCAL=PSII_RC_FRAC  * QUANTUM_YIELD_CHLA_MIN + &
               (1.0D0-PSII_RC_FRAC) * QUANTUM_YIELD_CHLA_MAX
      NPQ_ADJUST=QUANTUM_YIELD_CHLA_QI*EXP(-IPAR_SCALAR/QUANTUM_YIELD_CHLA_ET)

      QUANTUM_YIELD_CHLA_LOCAL=QUANTUM_YIELD_CHLA_LOCAL*NPQ_ADJUST
    ELSE
      QUANTUM_YIELD_CHLA_LOCAL=0.02D0
    ENDIF

    QUANTUM_YIELD_CHLA_AVG = QUANTUM_YIELD_CHLA_AVG +               &
           QUANTUM_YIELD_CHLA_LOCAL*EXP(-TAU_INELASTIC_AGD(ILAYERW))
    TRANS_CHLA_AVG=TRANS_CHLA_AVG+EXP(-TAU_INELASTIC_AGD(ILAYERW))

    DO IWVEX=1,NFLRSCGRID
      IF(IWVEX==1 .OR. IWVEX==NFLRSCGRID)THEN
        INTWEIGHT=0.5D0
      ELSE
        INTWEIGHT=1.0D0
      ENDIF

     SOURCEFO_FLUORESCENCE_AGD(ILAYERW)= SOURCEFO_FLUORESCENCE_AGD(ILAYERW)     + &
          DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)*ABSORB_COEFF_CHLA_EX(IWVEX,ILAYERW) * &
          QUANTUM_YIELD_CHLA_LOCAL *fCHLAfuncjEX(IWVEX)*DELTALAMBDAEXFLRSC*INTWEIGHT
    ENDDO
  ENDDO

QUANTUM_YIELD_CHLA_AVG=QUANTUM_YIELD_CHLA_AVG/TRANS_CHLA_AVG

ENDIF

ENDSUBROUTINE SOURCEF_FLUORESCENCE_INTEGRATION

SUBROUTINE SOURCEF_EM_INTEGRATION(NQUADOINPUT,MU_IN)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: NQUADOINPUT
REAL*8,INTENT(IN) :: MU_IN
REAL*8 :: WAVELENGTH_MICRON
INTEGER :: IQUAD,MVAR,ICOM,ILAYERW

REAL*8 :: RTMP1
REAL*8,DIMENSION(:),ALLOCATABLE :: SOURCEOTMP

INTEGER :: IKPP,IWVEX
REAL*8 :: POLINT_SIMPLE

DO ICOM=1,4
   SOURCEFO_RAMAN_AGD(1:NQUADOINPUT+2,1:NWATER_DEPTH,0:2)%VRAD(ICOM)=0.0D0
ENDDO

ALLOCATE(SOURCEOTMP(NFLRSCGRID))
DO IQUAD=1,NQUADOINPUT+2
DO MVAR=0,2
DO ILAYERW=1,NWATER_DEPTH

DO ICOM=1,4

  DO IWVEX=1,NFLRSCGRID
    SOURCEOTMP(IWVEX)=SOURCEFO_RAMAN_AGD_LUT(IWVEX,IQUAD,ILAYERW,MVAR)%VRAD(ICOM)
  ENDDO
DO IKPP=1,NKGRID
  WAVELENGTH_MICRON=LAMBDAEX(IKPP)/1000.0D0
  IF(LAMBDAEX(IKPP)>LAMBDAEXFLRSC(1) .AND. LAMBDAEX(IKPP)<LAMBDAEXFLRSC(NFLRSCGRID))THEN
     RTMP1=POLINT_SIMPLE(NFLRSCGRID,LAMBDAEXFLRSC,SOURCEOTMP,LAMBDAEX(IKPP),2)
  ELSE
     RTMP1=0.0D0
  ENDIF
  SCATT_COEFF_RAMAN_EX=2.7d-4*(488.0d0/LAMBDAEX(IKPP))**5.3
  SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)= &
  SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)+ &
                       RTMP1*SCATT_COEFF_RAMAN_EX*fRfuncjEX(IKPP)*KppWeight(IKPP)

!if(mvar==0 .and. icom==1 .and. SOURCEFO_RAMAN_AGD(IQUAD,ILAYERW,MVAR)%VRAD(ICOM)<0.0d0) then
!  write(*,*)'source_em_integration_tsp1',ilayerw,LAMBDAEX(IKPP),RTMP1
!  DO IWVEX=1,NFLRSCGRID
!    write(*,*)'source_em_integration_tsp1,LAMBDAEXFLRSC,SOURCEOTMP ',&
!               LAMBDAEXFLRSC(IWVEX),SOURCEOTMP(IWVEX)
!  ENDDO
!endif

ENDDO

ENDDO

ENDDO
ENDDO
ENDDO

!testing Raman Scattering Source Integration
!DO ILAYERW=1,NWATER_DEPTH
!write(*,*)'tsp_Raman_Integration',WATER_DEPTH(ILAYERW),SOURCEFO_RAMAN_AGD(1,ILAYERW,0)%VRAD(1),&
!          SOURCEFO_RAMAN_AGD(NQUADOINPUT+2,ILAYERW,0)%VRAD(1)
!ENDDO

DEALLOCATE(SOURCEOTMP)

END SUBROUTINE SOURCEF_EM_INTEGRATION


SUBROUTINE OCEAN_RAMAN_SOURCE_LUT_STORE(IWVEX,NQUADOINPUT,WAVELENGTH_MICRON,MU_IN)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE GLOBAL_DATA, ONLY : ABSORPTION_TAU_REDUCE_FLAG,TAU_REDUCE_OCEAN_PRESERVE
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: IWVEX,NQUADOINPUT
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,MU_IN
INTEGER :: ITAU,IQUAD,MVAR,I,ICOM,ILAYERW
REAL*8 :: ESUN_EX

INTEGER :: IULO,MPL,KLO
REAL*8 :: RTMP,RTMP1,RTMP2
REAL*8,DIMENSION(:,:,:),ALLOCATABLE :: SOURCEOTMP
REAL*8,DIMENSION(3)::QSRC,ELCOEFF
REAL*8 :: SQRTSIGN,TAUDIFF,TAUDIFF1

!NUMTOTALTAUEX==NTTAU-OLYR(1)%ITAUS+1
!OITAU_EX==OITAU_PRSV
!IRRAD_SUN_EX==ESUN
!TAU_INELASTIC_EX(1:NUMTOTALTAUEX)==TAU_PRSV(OLYR(1)%ITAUS:NTTAU)-OITAU_PRSV

MPL=3
IULO=INT(FLOAT(NSUNL)*ABS((WAVELENGTH_MICRON-WVSUN(1))/(WVSUN(NSUNL)-WVSUN(1))))
call hunt(WVSUN,NSUNL,WAVELENGTH_MICRON,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NSUNL-MPL)
CALL POLINT(WVSUN(KLO),FSUN(KLO),MPL,WAVELENGTH_MICRON,ESUN_EX,RTMP)

ALLOCATE(SOURCEOTMP(1:NUMTOTALTAUEX,1:4,0:2))
DO IQUAD=1,NQUADOINPUT+2
DO MVAR=0,2
DO ICOM=1,4
DO ITAU=1,NUMTOTALTAUEX
   SOURCEOTMP(ITAU,ICOM,MVAR)=ESUN_EX*SOURCEFO_RAMAN_TGD(IQUAD,ITAU,MVAR)%VRAD(ICOM)/IRRAD_SUN_EX(1)
!   if(mvar==0 .and. icom==1 .and. SOURCEOTMP(ITAU,ICOM,MVAR)<0.0d0) &
!      write(*,*)'maintsp1',itau,SOURCEOTMP(ITAU,ICOM,MVAR)
ENDDO
ENDDO
ENDDO
DO MVAR=0,2
DO ILAYERW=1,NWATER_DEPTH
  IULO=INT(FLOAT(NUMTOTALTAUEX)*ABS((TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(1))/ &
                   (TAU_INELASTIC_EX(NUMTOTALTAUEX)-TAU_INELASTIC_EX(1))))
  call hunt(TAU_INELASTIC_EX,NUMTOTALTAUEX,TAU_INELASTIC_AGD(ILAYERW),IULO)
  KLO=min(max(IULO-(MPL-1)/2,1),NUMTOTALTAUEX-MPL)
  QSRC(1:3)=SOURCEOTMP(KLO:KLO+2,1,0)
  TAUDIFF=TAU_INELASTIC_EX(KLO+2)-TAU_INELASTIC_EX(KLO)
  RTMP2=(QSRC(2)/QSRC(3))**2-QSRC(1)/QSRC(3)
  IF(RTMP2<0.0D0)RTMP2=0.0D0

  IF(QSRC(1)<QSRC(2) .AND. QSRC(2)<QSRC(3))THEN
     SQRTSIGN=1.0D0
     ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
                                  SQRTSIGN*SQRT(RTMP2))
  ELSE IF(QSRC(1)>QSRC(2) .AND. QSRC(2)>QSRC(3))THEN
     SQRTSIGN=-1.0D0
     ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
                                  SQRTSIGN*SQRT(RTMP2))
  ELSE
     WRITE(*,*)'EM_INTEGRATION, QSRC=',QSRC
     ELCOEFF(1)=0.0d0
  ENDIF
  IF(ELCOEFF(1)>1.0D32)ELCOEFF(1)=0.0D0
  TAUDIFF1=TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(KLO)
  DO ICOM=1,4
     ELCOEFF(2)=SOURCEOTMP(KLO+2,ICOM,MVAR)*EXP(ELCOEFF(1)*TAUDIFF) - SOURCEOTMP(KLO,ICOM,MVAR)
     ELCOEFF(2)=ELCOEFF(2)/TAUDIFF
     ELCOEFF(3)=SOURCEOTMP(KLO,ICOM,MVAR)

     RTMP1=EXP(-ELCOEFF(1)*TAUDIFF1)*(ELCOEFF(3)+ELCOEFF(2)*TAUDIFF1)

! INTERPOLATED VALUE TIMES ABSORPTION DUE TO RESCALED OPTICAL DEPTH
     IF(ABSORPTION_TAU_REDUCE_FLAG)RTMP1=RTMP1*EXP(-TAU_REDUCE_OCEAN_PRESERVE(ILAYERW))
     SOURCEFO_RAMAN_AGD_LUT(IWVEX,IQUAD,ILAYERW,MVAR)%VRAD(ICOM) = RTMP1

!if(mvar==0 .and. icom==1 .and. RTMP1<0.0d0) then
!  write(*,*)'maintsp2',itau,rtmp1,QSRC
!  stop
!endif
   ENDDO

ENDDO
ENDDO
ENDDO

DEALLOCATE(SOURCEOTMP)

DEALLOCATE(PMORAMAN,SPMORAMAN,SOURCEFO_RAMAN_TGD)

END SUBROUTINE OCEAN_RAMAN_SOURCE_LUT_STORE


SUBROUTINE OCEAN_SCALAR_IRRAD_LUT_STORE(IWVEX,WAVELENGTH_MICRON,MU_IN)
USE IRRADSUNL
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
USE GLOBAL_DATA, ONLY : ABSORPTION_TAU_REDUCE_FLAG,TAU_REDUCE_OCEAN_PRESERVE
USE RTUTILITY, ONLY : PI,FACTOR,NUMMIEANGMAX
IMPLICIT NONE
INTEGER, INTENT(IN) :: IWVEX
REAL*8,INTENT(IN) :: WAVELENGTH_MICRON,MU_IN
INTEGER :: ITAU,ILAYERW
REAL*8 :: ESUN_EX

INTEGER :: IULO,MPL,KLO
REAL*8 :: RTMP,RTMP1,RTMP2
REAL*8,DIMENSION(3)::QSRC,ELCOEFF
REAL*8 :: SQRTSIGN,TAUDIFF,TAUDIFF1

!NUMTOTALTAUEX==NTTAU-OLYR(1)%ITAUS+1
!OITAU_EX==OITAU_PRSV
!IRRAD_SUN_EX==ESUN
!TAU_INELASTIC_EX(1:NUMTOTALTAUEX)==TAU_PRSV(OLYR(1)%ITAUS:NTTAU)-OITAU_PRSV

MPL=3
IULO=INT(FLOAT(NSUNL)*ABS((WAVELENGTH_MICRON-WVSUN(1))/(WVSUN(NSUNL)-WVSUN(1))))
call hunt(WVSUN,NSUNL,WAVELENGTH_MICRON,IULO)
KLO=min(max(IULO-(MPL-1)/2,1),NSUNL-MPL)
CALL POLINT(WVSUN(KLO),FSUN(KLO),MPL,WAVELENGTH_MICRON,ESUN_EX,RTMP)

DIIRAD_SCALAR_TGD=ESUN_EX*DIIRAD_SCALAR_TGD/IRRAD_SUN_EX(1)

DO ILAYERW=1,NWATER_DEPTH
  IULO=INT(FLOAT(NUMTOTALTAUEX)*ABS((TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(1))/ &
     (TAU_INELASTIC_EX(NUMTOTALTAUEX)-TAU_INELASTIC_EX(1))))
  call hunt(TAU_INELASTIC_EX,NUMTOTALTAUEX,TAU_INELASTIC_AGD(ILAYERW),IULO)
  KLO=min(max(IULO-(MPL-1)/2,1),NUMTOTALTAUEX-MPL)
!  CALL POLINT(TAU_INELASTIC_EX(KLO),RARRAYTMP(KLO),MPL,TAU_INELASTIC_AGD(ILAYERW),RTMP1,RTMP)
  QSRC(1:3)=DIIRAD_SCALAR_TGD(KLO:KLO+2)
  TAUDIFF=TAU_INELASTIC_EX(KLO+2)-TAU_INELASTIC_EX(KLO)
  RTMP2=(QSRC(2)/QSRC(3))**2-QSRC(1)/QSRC(3)
  IF(RTMP2<0.0D0)RTMP2=0.0D0

  IF(QSRC(1)<QSRC(2) .AND. QSRC(2)<QSRC(3))THEN
    SQRTSIGN=1.0D0
    ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
             SQRTSIGN*SQRT(RTMP2))
  ELSE IF(QSRC(1)>QSRC(2) .AND. QSRC(2)>QSRC(3))THEN
    SQRTSIGN=-1.0D0
    ELCOEFF(1)=2.0/TAUDIFF * LOG(QSRC(2)/QSRC(3) + &
              SQRTSIGN*SQRT(RTMP2))
  ELSE
    WRITE(*,*)'IRRAD_LUT_STORE,QSRC=',QSRC
    ELCOEFF(1)=0.0d0
  ENDIF
  IF(ELCOEFF(1)>1.0D32)ELCOEFF(1)=0.0D0
  TAUDIFF1=TAU_INELASTIC_AGD(ILAYERW)-TAU_INELASTIC_EX(KLO)
  ELCOEFF(2)=DIIRAD_SCALAR_TGD(KLO+2)*EXP(ELCOEFF(1)*TAUDIFF) - DIIRAD_SCALAR_TGD(KLO)
  ELCOEFF(2)=ELCOEFF(2)/TAUDIFF
  ELCOEFF(3)=DIIRAD_SCALAR_TGD(KLO)

  RTMP1=EXP(-ELCOEFF(1)*TAUDIFF1)*(ELCOEFF(3)+ELCOEFF(2)*TAUDIFF1)
  IF(ABSORPTION_TAU_REDUCE_FLAG)RTMP1=RTMP1*EXP(-TAU_REDUCE_OCEAN_PRESERVE(ILAYERW))

  DIIRAD_SCALAR_AGD(IWVEX, ILAYERW)= RTMP1
!if(RTMP1<0.0d0) then
!write(*,*)'maintsp3',ILAYERW,rtmp1,QSRC
!stop
!endif

ENDDO

DEALLOCATE(DIIRAD_SCALAR_TGD)

END SUBROUTINE OCEAN_SCALAR_IRRAD_LUT_STORE

SUBROUTINE WATER_DEPTH_SETUP
USE GLOBAL_DATA
USE RAMANDATA
USE FLUORESCENCEDATA
USE SAVE_OCEAN_MOD
IMPLICIT NONE

INTEGER :: INTTMP,IWVEX,IWV,IWVEXSTART
REAL*8 RTMP

WATER_DET_FREE_LOCATION=.false.

IF(WATER_DET_FREE_LOCATION)THEN
  DET_INWATER_REPORT_DEPTH_INCREMENT=4.0D0
  DO INTTMP=1,N_DET_INWATER_REPORT
    DET_INWATER_REPORT_DEPTH(INTTMP)=(INTTMP-1)*DET_INWATER_REPORT_DEPTH_INCREMENT
  ENDDO
ENDIF

WATER_DEPTH_MAX=200.d0

IF(WATER_DET_FREE_LOCATION .AND. DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT)>WATER_DEPTH_MAX) THEN
  WRITE(*,*) 'DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT),WATER_DEPTH_MAX=', &
  DET_INWATER_REPORT_DEPTH(N_DET_INWATER_REPORT),WATER_DEPTH_MAX
  WRITE(*,*) 'WARNING, DETECTOR DEPTH IS LARGER THAN WATER_DEPTH_MAX'
  WRITE(*,*) 'INCREASE WATER_DEPTH_MAX OR WATER_OD_MAX, AND RERUN'
  STOP
ENDIF
!WRITE(*,*)'NWATER_DEPTH,WATER_DEPTH_MAX=',NWATER_DEPTH,WATER_DEPTH_MAX

RTMP=WATER_DEPTH_MAX/(NWATER_DEPTH-1.0D0)
WATER_DEPTH(1)=0.0D0
DO INTTMP=2,NWATER_DEPTH
  WATER_DEPTH(INTTMP)=WATER_DEPTH(INTTMP-1)+RTMP
ENDDO

END SUBROUTINE WATER_DEPTH_SETUP

SUBROUTINE CHLAPROFILE(WATER_DEPTH_Val,CHLaVal,CHLaLOCAL)

USE GLOBAL_DATA, ONLY : CHLA_HOMOGENEITY,CHLA_C0,CHLA_Slope,CHLA_Cmax, &
                        CHLA_Etamax,CHLA_DeltaEta
IMPLICIT NONE

REAL*8,INTENT(IN) :: WATER_DEPTH_Val,CHLaVal
REAL*8,INTENT(OUT) :: CHLaLOCAL

REAL*8 :: ChlaZeu,ChlaZeuAvg,Zeu,ChlaD0,chla_eta,eta

IF(CHLaVal<1.0E-6 .OR. CHLA_HOMOGENEITY) THEN
   CHLaLOCAL=CHLaVal
   RETURN
ENDIF

CHLA_C0=0.471d0
CHLA_Slope=0.135d0
CHLA_Cmax=1.572d0
CHLA_Etamax=0.969d0
CHLA_DeltaEta=0.393d0


IF(CHLaVal<1.0d0)THEN
   ChlaZeu=36.1D0*CHLaVal**0.357D0
  !Table 4, Uitz et al, J. GEOPHYSICAL RESEARCH,
  ! VOL. 111, C08005, doi:10.1029/2005JC003207, 2006
ELSE
   ChlaZeu=37.7D0*CHLaVal**0.615D0
  ! Table 4, Uitz et al, J. GEOPHYSICAL RESEARCH,
  ! VOL. 111, C08005, doi:10.1029/2005JC003207, 2006
ENDIF
Zeu=568.2d0*ChlaZeu**(-0.746d0)
IF(Zeu>102.0D0)Zeu=200.D0*ChlaZeu**(-0.293D0);
eta=WATER_DEPTH_Val/Zeu;
ChlaZeuAvg=ChlaZeu/Zeu;
chla_eta=CHLA_C0-CHLA_Slope*eta+CHLA_Cmax*exp(-(eta-CHLA_Etamax)**2/CHLA_DeltaEta**2);
ChlaD0=CHLA_C0+CHLA_Cmax*exp(-CHLA_Etamax**2/CHLA_DeltaEta**2)
CHLaLOCAL=chla_eta/ChlaD0*CHLaVal
IF(CHLaLOCAL<0.0d0)CHLaLOCAL=0.0d0
!write(*,*)'WATER_DEPTH_Val,CHLaLOCAL=',WATER_DEPTH_Val,CHLaLOCAL
RETURN
END SUBROUTINE CHLAPROFILE

SUBROUTINE ABS_COEFF_INIT
USE GLOBAL_DATA, ONLY :NWV,WV,NPGRID,P_GRID,Z_FIELD,TEM_FIELD,             &
                NUMDEN_TOTAL_FIELD,VMR_OZONE_FIELD,VMR_OXYGEN_FIELD,&
                VMR_H2O_FIELD,VMR_CO2_FIELD,VMR_NO2_FIELD,       &
                VMR_CH4_FIELD,GAS_ABS_COEFF
USE H2O_ABS_DATA
USE CO2_ABS_DATA
USE CH4_ABS_DATA
USE OXYGEN2_ABS_DATA
USE OZONE_ABS_DATA
USE NO2_ABS_DATA
USE O4_ABS_DATA
IMPLICIT NONE

INTEGER,DIMENSION(7) :: GAS_INDX_FLAG=(/1,1,1,1,1,1,1/)

!integer :: iwv,ipgrid
!real*8 :: rtmp
GAS_ABS_COEFF=0.0D0
IF(GAS_INDX_FLAG(1)>0)THEN
  CALL H2O_ABS_READIN
  CALL H2O_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_H2O_FIELD,GAS_ABS_COEFF)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init H2O'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init H2O'
!ENDIF
!enddo
!enddo


IF(GAS_INDX_FLAG(2)>0)THEN
  CALL CO2_ABS_READIN
  CALL CO2_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_CO2_FIELD,GAS_ABS_COEFF)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CO2'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CO2'
!ENDIF
!enddo
!enddo


IF(GAS_INDX_FLAG(3)>0)THEN
  CALL CH4_ABS_READIN
  CALL CH4_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_CH4_FIELD,GAS_ABS_COEFF)
ENDIF
!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CH4'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init CH4'
!ENDIF
!enddo
!enddo

IF(GAS_INDX_FLAG(4)>0)THEN
  CALL OXYGEN2_ABS_READIN
  CALL OXYGEN2_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_OXYGEN_FIELD,GAS_ABS_COEFF)
ENDIF

!rtmp=0.0d0
!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O2'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O2'
!ENDIF
!rtmp=rtmp+GAS_ABS_COEFF(iwv,ipgrid)
!enddo
!enddo

IF(GAS_INDX_FLAG(5)>0)THEN
  CALL OZONE_ABS_READIN
  CALL OZONE_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_OZONE_FIELD,GAS_ABS_COEFF)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init OZONE'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init OZONE'
!ENDIF
!
!enddo
!enddo


IF(GAS_INDX_FLAG(6)>0)THEN
  CALL NO2_ABS_READIN
  CALL NO2_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_NO2_FIELD,GAS_ABS_COEFF)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init NO2'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init NO2'
!ENDIF
!enddo
!enddo

IF(GAS_INDX_FLAG(7)>0)THEN
  CALL O4_ABS_SEARCH(NPGRID,NWV,WV,P_GRID,TEM_FIELD,       &
              NUMDEN_TOTAL_FIELD,VMR_OXYGEN_FIELD,GAS_ABS_COEFF)
ENDIF

!do iwv=1,NWV
!do ipgrid=1,npgrid
!if(GAS_ABS_COEFF(iwv,ipgrid)<0.0 .or.GAS_ABS_COEFF(iwv,ipgrid)>1e30) then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O4'
!ENDIF
!if(isnan(GAS_ABS_COEFF(iwv,ipgrid)))then
!write(*,*)wv(iwv),P_GRID(ipgrid),GAS_ABS_COEFF(iwv,ipgrid)
!stop 'check abs_coeff_init O4'
!ENDIF
!enddo
!enddo



END SUBROUTINE ABS_COEFF_INIT


SUBROUTINE TAU_TG_INIT_INELASTIC(GAS_ABS_FLAG,NTLYERA,ALT_LYRA,WAVELENGTH_NANOMETER,TAU_TG)
USE GLOBAL_DATA, ONLY :NWV,WV,NPGRID,Z_FIELD,GAS_ABS_COEFF
USE FLUORESCENCEDATA,ONLY : DELTALAMBDAEXFLRSC
IMPLICIT NONE
LOGICAL, INTENT(IN) :: GAS_ABS_FLAG
INTEGER,INTENT(IN) :: NTLYERA
REAL*8,DIMENSION(NTLYERA+1),INTENT(IN)::ALT_LYRA
REAL*8,INTENT(IN) :: WAVELENGTH_NANOMETER
REAL*8,DIMENSION(NTLYERA),INTENT(OUT)::TAU_TG

INTEGER :: N_INT_SIZE
REAL*8 :: POLINT_SIMPLE,ILS_INT_CONST,TRAPZOID
REAL*8,DIMENSION(:),ALLOCATABLE :: XU,YU

REAL*8,DIMENSION(:,:),ALLOCATABLE :: TAU_ABS_GRID

INTEGER :: INTTMP,ILAYER,IWV_AVG,IWV_START,IWV_END
INTEGER,DIMENSION(:),ALLOCATABLE ::LOCINDX
INTEGER,DIMENSION(1) ::LOCINDXTMP,LOCINDXTMP1
REAL*8 :: RTMP,WV_TMP,GAS_ABS_TMP
REAL*8,DIMENSION(:),ALLOCATABLE :: RARRAYTMP

IF(.NOT. GAS_ABS_FLAG)THEN
  TAU_TG=0.0D0
  RETURN
ENDIF


LOCINDXTMP=MINLOC(ABS(WAVELENGTH_NANOMETER-0.5D0*DELTALAMBDAEXFLRSC-WV))
LOCINDXTMP1=MINLOC(ABS(WAVELENGTH_NANOMETER+0.5D0*DELTALAMBDAEXFLRSC-WV))

IWV_START=LOCINDXTMP(1)
IWV_END  =LOCINDXTMP1(1)
IF(IWV_END<=IWV_END)THEN
   WRITE(*,*)WV(1),WV(NWV),WAVELENGTH_NANOMETER,DELTALAMBDAEXFLRSC
   STOP 'CHECK WV AND WAVELENGTH_NANOMETER AND DELTALAMBDAEXFLRSC'
ENDIF

N_INT_SIZE=IWV_END-IWV_START+1
ALLOCATE(TAU_ABS_GRID(IWV_START:IWV_END,1:NPGRID),XU(N_INT_SIZE),YU(N_INT_SIZE))
XU(1:N_INT_SIZE)=WV(IWV_START:IWV_END)


ALLOCATE(LOCINDX(NTLYERA))

TAU_TG=0.0D0
IF(ALT_LYRA(1)>Z_FIELD(1))STOP 'WARNING, ALT_LYRA DATA RANGE LARGER THAN Z_FIELD'

! Z_FIELD IS IN KM
! MULTIPLY BY 1000 TO INTEGRATE AND GET TAU_ABS_GRID
DO INTTMP=1,NPGRID-1
  TAU_ABS_GRID(IWV_START:IWV_END,INTTMP)= (Z_FIELD(INTTMP)-Z_FIELD(INTTMP+1))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF(IWV_START:IWV_END,INTTMP) + GAS_ABS_COEFF(IWV_START:IWV_END,INTTMP+1))
ENDDO


DO INTTMP=1,NTLYERA
  LOCINDXTMP=MINLOC(ABS(Z_FIELD-ALT_LYRA(INTTMP)))
  IF(ALT_LYRA(INTTMP)<Z_FIELD(LOCINDXTMP(1)))THEN
    LOCINDX(INTTMP)=LOCINDXTMP(1)
  ELSE
    LOCINDX(INTTMP)=LOCINDXTMP(1)-1
  ENDIF
ENDDO

DO INTTMP=1,LOCINDX(1)
  YU(1:N_INT_SIZE)=EXP(-TAU_ABS_GRID(IWV_START:IWV_END,INTTMP) )
  GAS_ABS_TMP=TRAPZOID(N_INT_SIZE,XU,YU)
  TAU_TG(1)=TAU_TG(1) + GAS_ABS_TMP
ENDDO

RTMP=(ALT_LYRA(1)-Z_FIELD(LOCINDX(1)+1))/ &
     (Z_FIELD(LOCINDX(1))-Z_FIELD(LOCINDX(1)+1))
TAU_TG(1)=TAU_TG(1)-GAS_ABS_TMP*RTMP

DO ILAYER=2,NTLYERA-1
  DO INTTMP=LOCINDX(ILAYER-1),LOCINDX(ILAYER)
    YU(1:N_INT_SIZE)=EXP(-TAU_ABS_GRID(IWV_START:IWV_END,INTTMP) )
    GAS_ABS_TMP=TRAPZOID(N_INT_SIZE,XU,YU)
    TAU_TG(ILAYER)=TAU_TG(ILAYER)+GAS_ABS_TMP
  ENDDO
  RTMP=(ALT_LYRA(ILAYER)-Z_FIELD(LOCINDX(ILAYER)+1))/ &
       (Z_FIELD(LOCINDX(ILAYER))-Z_FIELD(LOCINDX(ILAYER)+1))
  TAU_TG(ILAYER)=TAU_TG(ILAYER)-GAS_ABS_TMP*RTMP
ENDDO

RTMP =     (ALT_LYRA(NTLYERA)-Z_FIELD(LOCINDX(NTLYERA)+1))/ &
   (Z_FIELD(LOCINDX(NTLYERA))-Z_FIELD(LOCINDX(NTLYERA)+1))

YU(1:N_INT_SIZE)=EXP(-TAU_ABS_GRID(IWV_START:IWV_END,LOCINDX(NTLYERA)) )
GAS_ABS_TMP=TRAPZOID(N_INT_SIZE,XU,YU)
TAU_TG(NTLYERA)=TAU_TG(NTLYERA)+GAS_ABS_TMP*RTMP

DO INTTMP=LOCINDX(NTLYERA)+1,NPGRID-1
  YU(1:N_INT_SIZE)=EXP(-TAU_ABS_GRID(IWV_START:IWV_END,INTTMP) )
  GAS_ABS_TMP=TRAPZOID(N_INT_SIZE,XU,YU)
  TAU_TG(NTLYERA)=TAU_TG(NTLYERA)+GAS_ABS_TMP
ENDDO

TAU_TG=TAU_TG/(WV(IWV_END)-WV(IWV_START))
TAU_TG=-LOG(TAU_TG)

DEALLOCATE(LOCINDX,TAU_ABS_GRID,XU,YU)


ENDSUBROUTINE TAU_TG_INIT_INELASTIC


SUBROUTINE TAU_TG_INIT(GAS_ABS_FLAG,NTLYERA,ALT_LYRA,WAVELENGTH_NANOMETER,TAU_TG)
USE GLOBAL_DATA, ONLY :NWV,WV,NPGRID,Z_FIELD,GAS_ABS_COEFF

IMPLICIT NONE
LOGICAL, INTENT(IN) :: GAS_ABS_FLAG
INTEGER,INTENT(IN) :: NTLYERA
REAL*8,DIMENSION(NTLYERA+1),INTENT(IN)::ALT_LYRA
REAL*8,INTENT(IN) :: WAVELENGTH_NANOMETER
REAL*8,DIMENSION(NTLYERA),INTENT(OUT)::TAU_TG

REAL*8 :: POLINT_SIMPLE

REAL*8,DIMENSION(NPGRID) ::TAU_ABS_GRID

INTEGER :: INTTMP,ILAYER,IWV_INDX
INTEGER,DIMENSION(:),ALLOCATABLE ::LOCINDX
INTEGER,DIMENSION(1) ::LOCINDXTMP
REAL*8 :: RTMP

IF(.NOT. GAS_ABS_FLAG)THEN
  TAU_TG=0.0D0
  RETURN
ENDIF

ALLOCATE(LOCINDX(NTLYERA))

TAU_TG=0.0D0
IF(ALT_LYRA(1)>Z_FIELD(1))STOP 'WARNING, ALT_LYRA DATA RANGE LARGER THAN Z_FIELD'

LOCINDXTMP=MINLOC(ABS(WAVELENGTH_NANOMETER-WV))
IWV_INDX=LOCINDXTMP(1)
! Z_FIELD IS IN KM
! MULTIPLY BY 1000 TO INTEGRATE AND GET TAU_ABS_GRID
DO INTTMP=1,NPGRID-1
  TAU_ABS_GRID(INTTMP)= (Z_FIELD(INTTMP)-Z_FIELD(INTTMP+1))*1000.0D0 * &
     0.5D0*(GAS_ABS_COEFF(IWV_INDX,INTTMP)+GAS_ABS_COEFF(IWV_INDX,INTTMP+1))
ENDDO

DO INTTMP=1,NTLYERA
  LOCINDXTMP=MINLOC(ABS(Z_FIELD-ALT_LYRA(INTTMP)))
  IF(ALT_LYRA(INTTMP)<Z_FIELD(LOCINDXTMP(1)))THEN
    LOCINDX(INTTMP)=LOCINDXTMP(1)
  ELSE
    LOCINDX(INTTMP)=LOCINDXTMP(1)-1
  ENDIF
ENDDO

DO INTTMP=1,LOCINDX(1)
  TAU_TG(1)=TAU_TG(1)+TAU_ABS_GRID(INTTMP)
ENDDO
RTMP=(ALT_LYRA(1)-Z_FIELD(LOCINDX(1)+1))/ &
     (Z_FIELD(LOCINDX(1))-Z_FIELD(LOCINDX(1)+1))
TAU_TG(1)=TAU_TG(1)-TAU_ABS_GRID(LOCINDX(1))*RTMP
DO ILAYER=2,NTLYERA-1
  DO INTTMP=LOCINDX(ILAYER-1),LOCINDX(ILAYER)
    TAU_TG(ILAYER)=TAU_TG(ILAYER)+TAU_ABS_GRID(INTTMP)
  ENDDO
  RTMP=(ALT_LYRA(ILAYER)-Z_FIELD(LOCINDX(ILAYER)+1))/ &
       (Z_FIELD(LOCINDX(ILAYER))-Z_FIELD(LOCINDX(ILAYER)+1))
  TAU_TG(ILAYER)=TAU_TG(ILAYER)-TAU_ABS_GRID(LOCINDX(ILAYER))*RTMP
ENDDO
RTMP=(ALT_LYRA(NTLYERA)-Z_FIELD(LOCINDX(NTLYERA)+1))/ &
     (Z_FIELD(LOCINDX(NTLYERA))-Z_FIELD(LOCINDX(NTLYERA)+1))
TAU_TG(NTLYERA)=TAU_TG(NTLYERA)+TAU_ABS_GRID(LOCINDX(NTLYERA))*RTMP
DO INTTMP=LOCINDX(NTLYERA)+1,NPGRID-1
  TAU_TG(NTLYERA)=TAU_TG(NTLYERA)+TAU_ABS_GRID(INTTMP)
ENDDO
DEALLOCATE(LOCINDX)


ENDSUBROUTINE TAU_TG_INIT


SUBROUTINE WV_LBL_SETUP
USE GLOBAL_DATA, ONLY : NWV, WV
IMPLICIT NONE
INTEGER,PARAMETER :: N_BAND_INDX=20
REAL*8, DIMENSION(N_BAND_INDX):: WAVELENGTH_STEP=(/1.0d0,0.5d0, 0.01d0,0.5d0,0.005d0,0.5d0,   &
                                          0.01d0,0.5d0,0.005d0,0.01d0,0.5d0,   &
                                          0.005d0,0.01d0,0.2d0,0.01d0,0.02d0,  &
                                          0.01d0,0.02d0,0.02d0,0.1d0/)
REAL*8, DIMENSION(N_BAND_INDX):: WAVELENGTH_BAND_START=                                 &
                                   (/299.0d0,349.5d0, 586.D0,606.0D0,627.0D0,637.0d0  ,&
                                     641.0D0, 666.0D0,686.0D0,700.0D0,751.0D0, &
                                     758.0D0,780.0D0,856.0D0,930.0D0,1230.0D0, &
                                     1370.0D0,1630.0D0,2120.0D0,2240.0D0/)
INTEGER, DIMENSION(N_BAND_INDX):: WAVELENGTH_BAND_SIZE=(/50,474,2000,42,2000,8,2500,40, &
                                    2800,5100,14,4400,7600,195,2001,1001,   &
                                    2001,1001,1001,201/)

INTEGER :: IWV,I_BAND_INDX,I_WV_DSPLC

I_WV_DSPLC=0
DO I_BAND_INDX=1,N_BAND_INDX
  IF(I_BAND_INDX>1)I_WV_DSPLC=I_WV_DSPLC+WAVELENGTH_BAND_SIZE(I_BAND_INDX-1)
  DO IWV=1,WAVELENGTH_BAND_SIZE(I_BAND_INDX)
    WV(I_WV_DSPLC+IWV)=WAVELENGTH_BAND_START(I_BAND_INDX) + &
                         IWV*WAVELENGTH_STEP(I_BAND_INDX)
  ENDDO
ENDDO

IF(I_WV_DSPLC+WAVELENGTH_BAND_SIZE(N_BAND_INDX) .NE. NWV)STOP 'CHECK WV ASSIGNMENT'
END SUBROUTINE WV_LBL_SETUP

SUBROUTINE Particle_PHMX_Assign(NUMMIEUSE,NWV_PHMX,IAEROSOL,IRH,REFF1_Save,    &
                 REFF2_Save,VEFF1_Save,VEFF2_Save,MRR1_Save,MRI1_Save,MRR2_Save,&
                 MRI2_Save,ARSLND1_Save,ARSLND2_Save)
USE MIE_PHMX_PACE
USE GLOBAL_DATA,ONLY : OCEAN_CASE_SELECT,                                   &
                PHYTOPLANKTON_INDEX_REFRACTION,PHYTOPLANKTON_SPECTRAL_SLOPE,&
                SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE
IMPLICIT NONE
INTEGER, INTENT(IN)::NUMMIEUSE,NWV_PHMX,IAEROSOL,IRH
REAL*8,DIMENSION(NUMMIEUSE),INTENT(OUT) :: REFF1_Save,REFF2_Save,VEFF1_Save,VEFF2_Save,&
                                           ARSLND1_Save,ARSLND2_Save
REAL*8,DIMENSION(NUMMIEUSE,NWV_PHMX),INTENT(OUT) ::MRR1_Save,MRI1_Save,MRR2_Save,MRI2_Save

REAL*8::REFF1_LOCAL,VEFF1_LOCAL,REFF2_LOCAL,VEFF2_LOCAL,ARSLND1_LOCAL,ARSLND2_LOCAL
REAL*8,DIMENSION(:),ALLOCATABLE::MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL

INTEGER :: FREEFORMFLAG
FREEFORMFLAG=1

IF(NWV_PHMX .NE. NWV_BAND)STOP 'CHECK NWV_PHMX'
ALLOCATE(MRR1_LOCAL(NWV_PHMX),MRI1_LOCAL(NWV_PHMX),MRR2_LOCAL(NWV_PHMX),MRI2_LOCAL(NWV_PHMX))

IF(FREEFORMFLAG==0)THEN
    REFF1_LOCAL=0.1D0
    REFF2_LOCAL=0.1D0
    VEFF1_LOCAL=1.D0
    VEFF2_LOCAL=0.5D0
    MRR1_LOCAL=1.45D0
    MRI1_LOCAL=0.0D0
    MRR2_LOCAL=1.45D0
    MRI2_LOCAL=0.0D0
    ARSLND1_LOCAL=0.99d0
    ARSLND2_LOCAL=0.01d0
ENDIF

CALL PHMXMIE_PACE_INIT(FREEFORMFLAG,IAEROSOL,IRH,REFF1_LOCAL,VEFF1_LOCAL,      &
          REFF2_LOCAL,VEFF2_LOCAL,MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL, &
          ARSLND1_LOCAL,ARSLND2_LOCAL,PHYTOPLANKTON_INDEX_REFRACTION,&
          PHYTOPLANKTON_SPECTRAL_SLOPE,SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE)

REFF1_Save=REFF1_LOCAL
REFF2_Save=REFF2_LOCAL
VEFF1_Save=VEFF1_LOCAL
VEFF2_Save=VEFF2_LOCAL
ARSLND1_Save=ARSLND1_LOCAL
ARSLND2_Save=ARSLND2_LOCAL

MRR1_Save(1,:)=MRR1_LOCAL
MRI1_Save(1,:)=MRI1_LOCAL
MRR2_Save(1,:)=MRR2_LOCAL
MRI2_Save(1,:)=MRI2_LOCAL

IF(OCEAN_CASE_SELECT==2)THEN
  DO FREEFORMFLAG=2,3
    CALL PHMXMIE_PACE_INIT(FREEFORMFLAG,IAEROSOL,IRH,REFF1_LOCAL,VEFF1_LOCAL,  &
          REFF2_LOCAL,VEFF2_LOCAL,MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL, &
          ARSLND1_LOCAL,ARSLND2_LOCAL,PHYTOPLANKTON_INDEX_REFRACTION,&
          PHYTOPLANKTON_SPECTRAL_SLOPE,SEDIMENT_INDEX_REFRACTION,SEDIMENT_SPECTRAL_SLOPE)
  ENDDO
ENDIF
DEALLOCATE(MRR1_LOCAL,MRI1_LOCAL,MRR2_LOCAL,MRI2_LOCAL)

END SUBROUTINE Particle_PHMX_Assign

SUBROUTINE FILENAMEOUTPUT(CFILE1,ILS_FLAG,DIFFUSE_TRANSMITTANCE,WLR_FLAG_INPUT,WNDSPD_VAL,&
                          MU_IN,CHLa_VAL,OCEAN_CASE_SELECT,SEDIMENT_CONCENTRATION, &
                          Dpol90_Kok,TAU550_VAL,OCEAN_FCHLA_FLAG,NPQ_FLAG,          &
                          OCEAN_FCDOM_FLAG,OCEAN_RAMAN_FLAG)
USE RTUTILITY, ONLY : PI
IMPLICIT NONE
CHARACTER*160,INTENT(OUT) :: CFILE1
LOGICAL, INTENT(IN)::ILS_FLAG,DIFFUSE_TRANSMITTANCE,WLR_FLAG_INPUT,OCEAN_FCHLA_FLAG,NPQ_FLAG,&
OCEAN_FCDOM_FLAG,OCEAN_RAMAN_FLAG
INTEGER,INTENT(IN) :: OCEAN_CASE_SELECT
REAL*8, INTENT(IN) :: WNDSPD_VAL,MU_IN,CHLa_VAL,SEDIMENT_CONCENTRATION,Dpol90_Kok,TAU550_VAL

CHARACTER*160 :: CFILETMP

IF(DIFFUSE_TRANSMITTANCE)THEN
  WRITE(CFILE1,'(A5)')'DFTN_'
ELSE
  WRITE(CFILE1,'(A5)')'RFOC_'
ENDIF

IF(WLR_FLAG_INPUT)THEN
  WRITE(CFILETMP,'(A16,I1,A4)')'PACE_AC_wlr_Case',OCEAN_CASE_SELECT,'_WND'
ELSE
  WRITE(CFILETMP,'(A16,I1,A4)')'PACE_AC_ttr_Case',OCEAN_CASE_SELECT,'_WND'
ENDIF
CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)

IF(WNDSPD_VAL<10.0D0)THEN
  WRITE(CFILETMP,'(f3.1)')WNDSPD_VAL
ELSE
  WRITE(CFILETMP,'(f4.1)')WNDSPD_VAL
ENDIF
CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'TS'
IF(ACOS(abs(MU_IN))/PI*180.<10.)THEN
  WRITE(CFILETMP,'(f4.2)')ACOS(abs(MU_IN))/PI*180.
ELSE
  WRITE(CFILETMP,'(f5.2)')ACOS(abs(MU_IN))/PI*180.
ENDIF
CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'Chla'
IF(CHLa_VAL>9.999)THEN
  WRITE(CFILETMP,'(f4.1)')CHLa_VAL
ELSE
  WRITE(CFILETMP,'(f4.2)')CHLa_VAL
ENDIF

IF(OCEAN_CASE_SELECT==2)THEN
  CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'SEDIMENTC_'
  IF(SEDIMENT_CONCENTRATION>9.999)THEN
    WRITE(CFILETMP,'(f4.1)')SEDIMENT_CONCENTRATION
  ELSE
    WRITE(CFILETMP,'(f4.2)')SEDIMENT_CONCENTRATION
  ENDIF
ENDIF

CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'Dpol90_Kok_'
WRITE(CFILETMP,'(f4.2)')Dpol90_Kok

IF(TAU550_VAL<10.0D0)THEN
 CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'TAU0'
 WRITE(CFILETMP,'(f4.2)')TAU550_VAL
ELSE
 CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)//'TAU'
 WRITE(CFILETMP,'(f4.1)')TAU550_VAL
ENDIF
CFILE1=TRIM(CFILE1)//TRIM(CFILETMP)


IF(OCEAN_FCHLA_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wFCHLA'
ELSE
  CFILE1=TRIM(CFILE1)//'noFCHLA'
ENDIF

IF(NPQ_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wNPQ'
ELSE
  CFILE1=TRIM(CFILE1)//'noNPQ'
ENDIF

IF(OCEAN_FCDOM_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wFCDOM'
ELSE
  CFILE1=TRIM(CFILE1)//'noFCDOM'
ENDIF

IF(OCEAN_RAMAN_FLAG) THEN
  CFILE1=TRIM(CFILE1)//'wRAMAN'
ELSE
  CFILE1=TRIM(CFILE1)//'noRAMAN'
ENDIF

IF(ILS_FLAG)THEN
  CFILE1=TRIM(CFILE1)//'wILS_DK.h5'
ELSE
  CFILE1=TRIM(CFILE1)//'noILS_DK.h5'
ENDIF

ENDSUBROUTINE FILENAMEOUTPUT
