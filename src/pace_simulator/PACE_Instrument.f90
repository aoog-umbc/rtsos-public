MODULE PACE_INSTRUMENT_DESIGN
USE HDF5
USE MAP_INSTRUMENT_DESIGN
INTEGER,PARAMETER :: NWV_BAND_SEG1=232, NWV_BAND_SEG2=7,&
                     NWV_BAND_SEG1P2=239,NWV_BAND_SEG3=109

! NWV_BAND_SEG1: OCI UV+Visible+NIR
! NWV_BAND_SEG2: OCI SWIR
! NWV_BAND_SEG3: SPEXone
! NWV_BAND_SEG4: HARP-2 or other MAP with discrete wavelengths
!
!REAL*8,PARAMETER :: WV_START=340D0 !,WV_END=1000.D0
INTEGER :: NWV_BAND
REAL*8,DIMENSION(:),ALLOCATABLE :: WV_BAND,PACE_FWHM

REAL*8,PARAMETER :: OCI_SEG1_RESO_HYPO=5.0D0
!REAL*8,DIMENSION(NWV_BAND_HYPO):: WV_BAND_HYPO,PACE_FWHM_HYPO=0.0d0
!INTEGER,PARAMETER :: NWV_BAND_HYPO=239,NWV_BAND_SEG1_HYPO=119, &
!					 NWV_BAND_SEG1P2_HYPO=126
INTEGER :: NWV_BAND_HYPO,NWV_BAND_SEG1_HYPO,NWV_BAND_SEG1P2_HYPO
REAL*8,DIMENSION(:),ALLOCATABLE :: WV_BAND_HYPO,PACE_FWHM_HYPO

INTEGER,PARAMETER :: NILS_PACE_RAW=21200
REAL*8,DIMENSION(:),ALLOCATABLE :: ILS_WaveLength
REAL*8,DIMENSION(:,:),ALLOCATABLE :: ILS_DeltaWaveLength_RAW,ILS_PACE_RAW

INTEGER :: NILS_PACE
REAL*8,DIMENSION(:,:),ALLOCATABLE :: ILS_DeltaWaveLength,ILS_PACE

CONTAINS

SUBROUTINE WV_PACE_SETUP(aux_dir)
IMPLICIT NONE
INTEGER IWV,ILS_LINE,ILS_LINE_TEMP,NILS_MIN,NILS_MAX
REAL*8 Delta_Wavelength_Max,Delta_Wavelength_Sub,Factor

! HDF 5 DEFINITION
! This should map to REAL*8 on most modern processors
!INTEGER, PARAMETER :: real_kind_15 = SELECTED_REAL_KIND(Fortran_REAL_8)
CHARACTER(LEN=160),intent(in) :: aux_dir

CHARACTER(LEN=180) :: OCI_ILS_Filename

INTEGER(HID_T)  :: file, space, dset, attr ! Handles
INTEGER :: hdferr
INTEGER(hsize_t),   DIMENSION(1:2) :: dims
INTEGER(hsize_t),DIMENSION(1) :: dimscl
INTEGER(HSIZE_T), DIMENSION(1:2) :: maxdims
TYPE(C_PTR) :: f_ptr
REAL*4,DIMENSION(1),TARGET :: HDF5RTMP
INTEGER,DIMENSION(1),TARGET :: HDF5ITMP
REAL*4,DIMENSION(:),TARGET,ALLOCATABLE :: HDF5RARRD1
REAL*8,DIMENSION(:,:),TARGET,ALLOCATABLE :: HDF5RARR2DIM

NWV_BAND = NWV_BAND_SEG1+NWV_BAND_SEG2+NWV_BAND_SEG3+NWV_BAND_SEG4

IF(NWV_BAND_SEG2 /= 7)STOP 'CHECK NWV AND NWV_SEG2'
IF(NWV_BAND_SEG1P2 /= NWV_BAND_SEG1+NWV_BAND_SEG2) STOP 'CHECK NWV_BAND_SEG1P2'

ALLOCATE(WV_BAND(NWV_BAND),PACE_FWHM(NWV_BAND))
PACE_FWHM=0.0D0

ALLOCATE(ILS_WaveLength(NILS_PACE_RAW), &
         ILS_DeltaWaveLength_RAW(NWV_BAND,NILS_PACE_RAW), &
         ILS_PACE_RAW(NWV_BAND,NILS_PACE_RAW))

OCI_ILS_Filename=trim(aux_dir)//'/OCI_RSR_2.5nm_v7_convert2.h5'

CALL h5open_f(hdferr)
CALL h5fopen_f(OCI_ILS_Filename, H5F_ACC_RDONLY_F, file, hdferr)

ALLOCATE(HDF5RARRD1(NWV_BAND_SEG1P2))
CALL h5dopen_f (file, '/bandwidth', dset, hdferr)
CALL h5dget_space_f(dset,space, hdferr)
f_ptr = C_LOC(HDF5RARRD1(1))
CALL h5dread_f( dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
PACE_FWHM(1:NWV_BAND_SEG1P2)=HDF5RARRD1(1:NWV_BAND_SEG1P2)
!DEALLOCATE(HDF5RARRD1)
!WRITE(*,*)'TESTING, BANDWIDTH(1),BANDWIDTH(NWV_BAND_SEG1P2)=', &
!          PACE_FWHM(1),PACE_FWHM(NWV_BAND_SEG1P2)

!ALLOCATE(HDF5RARRD1(NWV_BAND_SEG1P2))
CALL h5dopen_f (file, '/centerwavelength', dset, hdferr)
CALL h5dget_space_f(dset,space, hdferr)
f_ptr = C_LOC(HDF5RARRD1(1))
CALL h5dread_f( dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
WV_BAND(1:NWV_BAND_SEG1P2)=HDF5RARRD1(1:NWV_BAND_SEG1P2)
DEALLOCATE(HDF5RARRD1)
!WRITE(*,*)'TESTING, WV_BAND(1),WV_BAND(NWV_BAND_SEG1P2)=', &
!WV_BAND(1),WV_BAND(NWV_BAND_SEG1P2)

ALLOCATE(HDF5RARRD1(NILS_PACE_RAW))
CALL h5dopen_f (file, '/rsrwave', dset, hdferr)
CALL h5dget_space_f(dset,space, hdferr)
f_ptr = C_LOC(HDF5RARRD1(1))
CALL h5dread_f( dset, H5T_NATIVE_REAL,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
ILS_WaveLength=HDF5RARRD1
DEALLOCATE(HDF5RARRD1)

!WRITE(*,*)'TESTING, ILS_WaveLength(1),ILS_WaveLength(NILS_PACE)=', &
!ILS_WaveLength(1),ILS_WaveLength(NILS_PACE)

ALLOCATE(HDF5RARR2DIM(NWV_BAND_SEG1P2,NILS_PACE_RAW))
CALL h5dopen_f (file, '/RSR', dset, hdferr)
CALL h5dget_space_f(dset,space, hdferr)
f_ptr = C_LOC(HDF5RARR2DIM(1,1))
CALL h5dread_f( dset, H5T_NATIVE_DOUBLE,f_ptr, hdferr)
CALL h5dclose_f(dset , hdferr)
CALL h5sclose_f(space, hdferr)
ILS_PACE_RAW(1:NWV_BAND_SEG1P2,1:NILS_PACE_RAW)=HDF5RARR2DIM(1:NWV_BAND_SEG1P2,1:NILS_PACE_RAW)
DEALLOCATE(HDF5RARR2DIM)

!WRITE(*,*)'TESTING, ILS_PACE(1,16),ILS_PACE(1,31),ILS_PACE(1,48)=', &
!  ILS_PACE(1,16),ILS_PACE(1,31),ILS_PACE(1,48)
!WRITE(*,*)'TESTING, ILS_PACE(239,19472)=',ILS_PACE(239,19472)

CALL h5fclose_f(file , hdferr)
CALL h5close_f(hdferr)

NILS_PACE=0
ILS_DeltaWaveLength_RAW=0.0d0
DO IWV=1,NWV_BAND_SEG1P2
NILS_MAX=0
DO ILS_LINE=1,NILS_PACE_RAW
   ILS_DeltaWaveLength_RAW(IWV,ILS_LINE)=ILS_WaveLength(ILS_LINE)-WV_BAND(IWV)
   IF(ILS_PACE_RAW(IWV,ILS_LINE)>1.0e-6) NILS_MAX=NILS_MAX+1
ENDDO
IF(NILS_MAX>NILS_PACE)NILS_PACE=NILS_MAX
ENDDO
!WRITE(*,*)'NILS_PACE=',NILS_PACE

ALLOCATE(ILS_DeltaWaveLength(NWV_BAND,NILS_PACE),ILS_PACE(NWV_BAND,NILS_PACE))
DO IWV=1,NWV_BAND_SEG1P2
	DO ILS_LINE=1,NILS_PACE_RAW
	   IF(ILS_PACE_RAW(IWV,ILS_LINE)>1.0e-6) EXIT
	ENDDO
	NILS_MAX=MIN(NILS_PACE_RAW,ILS_LINE+NILS_PACE-1)
	NILS_MIN=ILS_LINE

	ILS_LINE_TEMP=0
	DO ILS_LINE=NILS_MIN,NILS_MAX
	  ILS_LINE_TEMP=ILS_LINE_TEMP+1
	  ILS_DeltaWaveLength(IWV,ILS_LINE_TEMP) = ILS_DeltaWaveLength_RAW(IWV,ILS_LINE)
	  ILS_PACE(IWV,ILS_LINE_TEMP)=ILS_PACE_RAW(IWV,ILS_LINE)
	ENDDO

ENDDO

!write(*,*)'ILS_DeltaWaveLength(1,:)=',ILS_DeltaWaveLength(1,:)
!write(*,*)'ILS_PACE(1,:)=',ILS_PACE(1,:)

! assign spex wavelengths and fwhm
WV_BAND(NWV_BAND_SEG1P2+1:NWV_BAND_SEG1P2+NWV_BAND_SEG3)=(/      &
398.33292, 399.9715 , 401.88248, 403.79266, 405.9748 , 407.8833, &
409.79105, 411.698  , 413.87634, 415.78156, 417.95795, 419.86145,&
422.03586, 424.20917, 426.38144, 428.55258, 430.72266, 432.89166,&
435.0595 , 437.2263 , 439.66257, 441.82693, 444.26053, 446.4225 ,&
448.85336, 451.2828 , 453.71072, 456.1372 , 458.5622 , 460.98572,&
463.67673, 466.09705, 468.78455, 471.47015, 473.88556, 476.5676 ,&
479.2476 , 482.19348, 484.86945, 487.54352, 490.48267, 493.4194 ,&
496.08716, 499.01926, 501.949  , 505.14224, 508.06677, 511.25433,&
514.17365, 517.35547, 520.53424, 523.97455, 527.147  , 530.58026,&
533.7462 , 537.1725 , 540.5949 , 544.2766 , 547.69135, 551.36456,&
554.77136, 558.43604, 562.3574 , 566.0128 , 569.9241 , 573.83014,&
577.7309 , 581.62634, 585.77545, 589.9184 , 594.05505, 598.1855 ,&
602.5672 , 606.9416 , 611.3088 , 615.66864, 620.27686, 624.8768 ,&
629.46826, 634.0513 , 638.87946, 643.6982 , 648.7601 , 653.811  ,&
658.851  , 664.1311 , 669.39905, 674.6544 , 680.1468 , 685.62524,&
691.3377 , 697.0348 , 702.71625, 708.62805, 714.52264, 720.6441 ,&
726.7465 , 733.0726 , 739.6196 , 746.1436 , 752.8847 , 759.6006 ,&
766.5294 , 773.668  , 780.77686, 788.09076, 795.3721 , 803.0868 ,&
810.53174 /)

DO IWV=NWV_BAND_SEG1P2+1,NWV_BAND_SEG1P2+NWV_BAND_SEG3
   PACE_FWHM(IWV)=1.1E-05*WV_BAND(IWV)**2+0.00064*WV_BAND(IWV)-0.2
ENDDO
!WRITE(*,*)'SPEX FWHM,PACE_FWHM(124),PACE_FWHM(232)=',PACE_FWHM(124),PACE_FWHM(232)

! HARP2 FWHM AND WAVELENGTH
PACE_FWHM(NWV_BAND_SEG1P2+NWV_BAND_SEG3+1:NWV_BAND)=PACE_FWHM_SEG4(1:NWV_BAND_SEG4)
WV_BAND(NWV_BAND_SEG1P2+NWV_BAND_SEG3+1:NWV_BAND)= WV_BAND_SEG4(1:NWV_BAND_SEG4)

DO IWV=NWV_BAND_SEG1P2+1,NWV_BAND

Delta_Wavelength_Max=2.0d0*PACE_FWHM(IWV)
Delta_Wavelength_Sub=Delta_Wavelength_Max/(1.0d0*NILS_PACE)
Factor=4.0D0*log(2.0D0)/(PACE_FWHM(IWV)**2)

DO ILS_LINE=1,NILS_PACE
   ILS_DeltaWaveLength(IWV,ILS_LINE)=(ILS_LINE-NILS_PACE/2)*Delta_Wavelength_Sub
   ILS_PACE(IWV,ILS_LINE)=exp(-Factor*(ILS_DeltaWaveLength(IWV,ILS_LINE)**2));
ENDDO
ENDDO

!HARP 873 nm band FWHM of 43 is too wide to be approximated by a Gaussian function.
!I change it to be a boxcar type until better RSR/ILS is provided.
IWV=NWV_BAND
DO ILS_LINE=1,NILS_PACE
   IF(ABS(ILS_DeltaWaveLength(IWV,ILS_LINE))>PACE_FWHM(IWV)/2)THEN
      ILS_PACE(IWV,ILS_LINE)=0.0D0
   ELSE
      ILS_PACE(IWV,ILS_LINE)=1.0D0
   ENDIF
ENDDO
!! SETUP HYPOTHETICAL WAVELENGTH BANDS
NWV_BAND_SEG1_HYPO=(WV_BAND(NWV_BAND_SEG1)-WV_BAND(1))/OCI_SEG1_RESO_HYPO+2
NWV_BAND_SEG1P2_HYPO=NWV_BAND_SEG1_HYPO+NWV_BAND_SEG2
NWV_BAND_HYPO=NWV_BAND_SEG1P2_HYPO+NWV_BAND-NWV_BAND_SEG1P2
ALLOCATE(WV_BAND_HYPO(NWV_BAND_HYPO),PACE_FWHM_HYPO(NWV_BAND_HYPO))
PACE_FWHM_HYPO=0.0D0

DO IWV=1,NWV_BAND_SEG1_HYPO
   WV_BAND_HYPO(IWV)=WV_BAND(1)+(IWV-1)*OCI_SEG1_RESO_HYPO
   PACE_FWHM_HYPO(IWV)=OCI_SEG1_RESO_HYPO
ENDDO

DO IWV=NWV_BAND_SEG1_HYPO+1,NWV_BAND_HYPO
   WV_BAND_HYPO(IWV)=WV_BAND(IWV-NWV_BAND_SEG1_HYPO+NWV_BAND_SEG1)
   PACE_FWHM_HYPO(IWV)=PACE_FWHM(IWV-NWV_BAND_SEG1_HYPO+NWV_BAND_SEG1)
ENDDO

DEALLOCATE(ILS_WaveLength,ILS_DeltaWaveLength_RAW,ILS_PACE_RAW)

END SUBROUTINE WV_PACE_SETUP

SUBROUTINE PACE_FWHM_DEALLO
   DEALLOCATE(ILS_DeltaWaveLength,ILS_PACE,WV_BAND_HYPO,PACE_FWHM_HYPO)
   DEALLOCATE(WV_BAND,PACE_FWHM)
END SUBROUTINE PACE_FWHM_DEALLO


!SUBROUTINE PACE_FWHM_INIT
!IMPLICIT NONE
!PACE_FWHM(1:NWV_BAND_SEG1)=5.0d0
!
!PACE_FWHM(NWV_BAND_SEG1+1)=45.0D0
!PACE_FWHM(NWV_BAND_SEG1+2)=75.0D0
!PACE_FWHM(NWV_BAND_SEG1+3)=30.0D0
!PACE_FWHM(NWV_BAND_SEG1+4)=15.0D0
!PACE_FWHM(NWV_BAND_SEG1+5)=75.0D0
!PACE_FWHM(NWV_BAND_SEG1+6)=50.0D0
!PACE_FWHM(NWV_BAND_SEG1+7)=75.0D0
!
!PACE_FWHM(NWV_BAND_SEG1+NWV_BAND_SEG2+1:NWV_BAND)=10.0d0
!
!PACE_FWHM(NWV_BAND_SEG1+NWV_BAND_SEG2+3)=15.0d0
!PACE_FWHM(NWV_BAND_SEG1+NWV_BAND_SEG2+7)=12.0d0
!PACE_FWHM(NWV_BAND_SEG1+NWV_BAND_SEG2+9)=16.0d0
!PACE_FWHM(NWV_BAND_SEG1+NWV_BAND_SEG2+12)=43.0d0
!
!
!END SUBROUTINE PACE_FWHM_INIT

!SUBROUTINE ILS_INIT
!IMPLICIT NONE
!INTEGER IWV,ILS_LINE
!REAL*8 Delta_Wavelength_Max,Delta_Wavelength_Sub,Factor
!
!
!ILS_DeltaWaveLength=0.0d0
!DO IWV=1,NWV_BAND
!
!Delta_Wavelength_Max=2.0d0*PACE_FWHM(IWV)
!Delta_Wavelength_Sub=Delta_Wavelength_Max/(1.0d0*NILS_PACE)
!Factor=4.0D0*log(2.0D0)/(PACE_FWHM(IWV)**2)
!
!DO ILS_LINE=1,NILS_PACE
!   ILS_DeltaWaveLength(IWV,ILS_LINE)=(ILS_LINE-NILS_PACE/2)*Delta_Wavelength_Sub
!   ILS_PACE(IWV,ILS_LINE)=exp(-Factor*(ILS_DeltaWaveLength(IWV,ILS_LINE)**2));
!ENDDO
!ENDDO
!
!END SUBROUTINE ILS_INIT


END MODULE PACE_INSTRUMENT_DESIGN
